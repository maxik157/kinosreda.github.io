<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>–ö–∏–Ω–æ—Å—Ä–µ–¥–∞ ‚Äî –ì—Ä–∞—Ñ–∏–∫ –ø–æ–∫–∞–∫–æ–≤</title>
    <script>
        // Auth gate: keep page hidden until we know the user is logged in
        (function () {
            try {
                const cu = localStorage.getItem('currentUser');
                if (!cu) {
                    location.replace('login.html');
                    return;
                }
                document.documentElement.classList.add('authed');
            } catch (e) {
                location.replace('login.html');
            }
        })();
        // Theme gate: apply theme before first paint
        (function(){
            try {
                document.documentElement.dataset.theme = localStorage.getItem('siteTheme') || 'beer';
            } catch(_) {}
        })();
    </script>
    <style>
        html { -webkit-text-size-adjust: 100%; text-size-adjust: 100%; }

        html:not(.authed) body { visibility: hidden; }
    
        @media (max-width: 520px) {
            input[type="text"],
            input[type="number"],
            input[type="email"],
            input[type="password"],
            input[type="search"],
            input[type="tel"],
            input[type="url"],
            input[type="date"],
            input[type="time"],
            select,
            textarea {
                font-size: 16px !important;
            }
        }
</style>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect x='20' y='30' width='45' height='55' rx='5' fill='none' stroke='%23b45309' stroke-width='4'/%3E%3Crect x='22' y='45' width='41' height='38' rx='3' fill='%23f59e0b'/%3E%3Cellipse cx='42' cy='35' rx='24' ry='8' fill='%23fff'/%3E%3Ccircle cx='30' cy='33' r='5' fill='%23fff'/%3E%3Ccircle cx='45' cy='31' r='4' fill='%23fff'/%3E%3Ccircle cx='55' cy='34' r='4' fill='%23fff'/%3E%3Cpath d='M65 38 Q85 38 85 55 Q85 72 65 72' fill='none' stroke='%23b45309' stroke-width='5' stroke-linecap='round'/%3E%3C/svg%3E">
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        html:not(.logo-font-ready) .logo-text { opacity: 0; }
        .logo-text { transition: opacity 0.15s ease; }
        body {
            font-family: 'Comfortaa', cursive;
            background: #000;
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
        }
        @font-face {
            font-family: 'Egyptian Bold Extended';
            src: local('Egyptian Bold Extended'), local('Egyptian Bold Extended Regular');
            font-weight: 700;
            font-style: normal;
            font-display: swap;
        }
        :root {
            --logo-font: 'Rubik Wet Paint';
            --accent-200: #fde68a;
            --accent-300: #fcd34d;
            --accent-400: #f59e0b;
            --accent-500: #f59e0b;
            --accent-border-10: rgba(245,158,11,0.10);
            --accent-border-20: rgba(245,158,11,0.20);
            --accent-border-25: rgba(245,158,11,0.25);
            --accent-border-30: rgba(245,158,11,0.30);
            --accent-border-50: rgba(245,158,11,0.50);
            --accent-soft: rgba(245,158,11,0.12);
        }
        html[data-theme="white"] {
            --accent-200: #ffffff;
            --accent-300: #e5e7eb;
            --accent-400: #ffffff;
            --accent-500: #ffffff;
            --accent-border-10: rgba(255,255,255,0.18);
            --accent-border-20: rgba(255,255,255,0.26);
            --accent-border-25: rgba(255,255,255,0.30);
            --accent-border-30: rgba(255,255,255,0.34);
            --accent-border-50: rgba(255,255,255,0.55);
            --accent-soft: rgba(255,255,255,0.10);
        }
        .text-amber-400 { color: var(--accent-400) !important; }
        .text-amber-300 { color: var(--accent-300) !important; }
        .text-amber-200 { color: var(--accent-200) !important; }
        .text-amber-500 { color: var(--accent-500) !important; }
        .border-amber-500\/10 { border-color: var(--accent-border-10) !important; }
        .border-amber-500\/20 { border-color: var(--accent-border-20) !important; }
        .border-amber-500\/25 { border-color: var(--accent-border-25) !important; }
        .border-amber-500\/30 { border-color: var(--accent-border-30) !important; }
        .border-amber-500\/50 { border-color: var(--accent-border-50) !important; }
        .bg-amber-500\/10 { background-color: var(--accent-soft) !important; }
        .hover\\:bg-amber-500\\/10:hover { background-color: var(--accent-soft) !important; }
        #logoText { fill: var(--accent-500) !important; }
        .backdrop {
            position: fixed;
            inset: 0;
            background: radial-gradient(circle at 10% 20%, rgba(245,158,11,0.12), transparent 30%),
                        radial-gradient(circle at 80% 10%, rgba(79,70,229,0.12), transparent 30%),
                        radial-gradient(circle at 60% 80%, rgba(34,197,94,0.10), transparent 35%),
                        #050505;
            filter: saturate(110%);
            z-index: 0;
        }
        .glow {
            box-shadow: 0 0 0 1px rgba(245,158,11,0.12), 0 10px 60px rgba(245,158,11,0.08);
        }
        .card {
            background: rgba(10,10,10,0.7);
            border: 1px solid var(--accent-border-20);
            border-radius: 22px;
            backdrop-filter: blur(8px);
        }
        .time-wheel {
            position: relative;
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 12px;
            contain: layout paint;
        }
        .time-wheel--single { grid-template-columns: 1fr; }
        .time-wheel-col {
            position: relative;
            height: 48px;
            border-radius: 12px;
            border: 1px solid var(--accent-border-20);
            background: rgba(0,0,0,0.6);
            text-align: center;
            transform: translateZ(0);
            backface-visibility: hidden;
            will-change: transform;
        }
        .time-wheel-static {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 11px;
            color: #6b7280;
            font-weight: 600;
            letter-spacing: 0.02em;
            pointer-events: none;
            z-index: 1;
            min-width: 48px;
        }
        .time-wheel-list {
            height: 48px;
            overflow-y: auto;
            scroll-snap-type: y mandatory;
            scrollbar-width: none;
            touch-action: pan-y;
            padding-left: 76px;
            overscroll-behavior: contain;
            -webkit-overflow-scrolling: touch;
        }
        .time-wheel-list--nolabel { padding-left: 0; }
        .time-wheel-list::-webkit-scrollbar { width: 0; height: 0; }
        .time-wheel-item {
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            scroll-snap-align: center;
            color: #9ca3af;
            font-weight: 600;
            letter-spacing: 0.02em;
            opacity: 0;
            transition: color 0.15s ease, opacity 0.15s ease;
            text-align: center;
            width: 100%;
        }
        .time-wheel--single .time-wheel-item { justify-content: center; }
        .time-wheel-item.is-selected {
            color: #fcd34d;
            opacity: 1;
        }
        .time-field-header { position: relative; min-height: 18px; }
        .time-field-title { display: inline-block; padding-right: 100px; max-width: calc(100% - 100px); }
        .time-field-toggle {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .cs { position: relative; }
        .cs select,
        .cs .cs-native {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: 0;
            border: 0;
            opacity: 0;
            pointer-events: none;
        }
        .cs-btn {
            width: 100%;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            border-radius: 12px;
            background: rgba(0,0,0,0.6);
            color: #fef3c7;
            border: 1px solid var(--accent-border-20);
            padding: 0 16px;
            font-size: 0.875rem;
            line-height: 1.25rem;
            text-align: left;
        }
        .cs-btn:focus {
            outline: none;
            border-color: rgba(245, 158, 11, 0.6);
            box-shadow: 0 0 0 3px rgba(245,158,11,0.12);
        }
        .cs-label { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .cs-chevron { flex: 0 0 auto; width: 18px; height: 18px; color: #9ca3af; transition: transform 0.18s ease; }
        .cs.open .cs-chevron { transform: rotate(180deg); }
        .cs-menu {
            position: absolute;
            left: 0;
            right: 0;
            top: 100%;
            margin-top: 8px;
            z-index: 30;
            background: rgba(10, 10, 10, 0.98);
            border: 1px solid var(--accent-border-25);
            border-radius: 12px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.55);
            max-height: 260px;
            overflow: auto;
            display: none;
        }
        .cs.open .cs-menu { display: block; }
        .cs-opt {
            width: 100%;
            text-align: left;
            padding: 0.55rem 0.75rem;
            font-size: 0.875rem;
            color: rgba(229,231,235,0.95);
        }
        .cs-opt:hover { background: rgba(245, 158, 11, 0.12); color: #fff; }
        .cs-opt[aria-selected="true"] { background: rgba(245, 158, 11, 0.18); color: #fff; }
        .bristol-icon { width: 38px; height: 22px; }
        .bristol-icon path, .bristol-icon rect, .bristol-icon circle { stroke-linecap: round; stroke-linejoin: round; }
        .bristol-icon { display: block; }
        .toggle-on { background: rgba(245,158,11,0.35) !important; border-color: rgba(245,158,11,0.6) !important; }
        .anon-thumb { top: 50%; transform: translateY(-50%); }
        .toggle-on .anon-thumb { transform: translate(24px, -50%); background: rgba(245,158,11,0.8); }
        .time-mode-thumb { top: 50%; transform: translateY(-50%); }
        .toggle-on .time-mode-thumb { transform: translate(20px, -50%); background: rgba(245,158,11,0.8); }
        #timeModeToggle.toggle-on { background: rgba(0,0,0,0.6) !important; border-color: rgba(245,158,11,0.3) !important; }
        .reaction-menu { box-shadow: 0 10px 30px rgba(0,0,0,0.45); }
        .modal-scroll { -webkit-overflow-scrolling: touch; }
        .comment-card { position: relative; }
        .reaction-menu { display: flex; flex-wrap: nowrap; align-items: center; gap: 6px; overflow-x: auto; }
        @media (max-width: 640px) {
            .reaction-menu { display: grid; grid-template-columns: repeat(8, max-content); gap: 4px; overflow-x: visible; justify-content: start; }
            .reaction-menu button { min-width: auto; padding: 6px 8px; }
        }
        .reaction-menu button { min-width: 34px; text-align: center; white-space: nowrap; }
        .reaction-menu.hidden { display: none !important; }
        .comment-actions { position: absolute; bottom: 4px; right: 4px; display: flex; gap: 6px; align-items: center; transition: opacity 0.2s ease; }
        .comment-card.comment-editing .comment-actions { display: none; }
        .confirm-modal { background: rgba(0,0,0,0.85); }
        body.modal-open { overflow: hidden; position: fixed; width: 100%; }
        #poopModal {
            overscroll-behavior: contain;
            align-items: flex-start;
            padding-top: calc(env(safe-area-inset-top, 16px) + var(--modal-offset, 0px));
            transform: translateZ(0);
            backface-visibility: hidden;
            isolation: isolate;
            background: rgba(0,0,0,0.88);
            -webkit-backdrop-filter: none;
            backdrop-filter: none;
            contain: paint;
        }
        #poopExportModal {
            overscroll-behavior: contain;
            align-items: center;
            padding-top: 0;
            transform: translateZ(0);
            backface-visibility: hidden;
            isolation: isolate;
            background: rgba(0,0,0,0.88);
            -webkit-backdrop-filter: none;
            backdrop-filter: none;
            contain: paint;
        }
        .modal-card {
            max-height: calc(var(--modal-vh, 100vh) - 2rem);
            transform: translateZ(0);
            backface-visibility: hidden;
        }
        @media (max-width: 640px) {
            .export-field { min-width: 0; }
            .export-field span {
                flex: 1;
                min-width: 0;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
        }
        .game-canvas {
            width: 100%;
            max-width: 100%;
            background: #000;
            border: 1px solid var(--accent-border-20);
            border-radius: 18px;
            display: block;
            touch-action: none;
        }
        .game-shell { display: flex; flex-direction: column; gap: 12px; }
        .game-hint { font-size: 12px; color: #9ca3af; }
        .poop-scale { display: flex; align-items: flex-end; gap: 4px; touch-action: pan-y; user-select: none; contain: layout paint; }
        .poop-seg { flex: 1 1 0; cursor: pointer; }
        .poop-seg input { pointer-events: none; }
        .poop-dot {
            position: relative;
            display: block;
            width: 100%;
            height: 12px;
            border-radius: 999px 999px 800px 800px;
            background: linear-gradient(180deg, rgba(146,74,0,0.95), rgba(95,45,0,0.95));
            border: 1px solid rgba(86,41,0,0.7);
            box-shadow: inset 0 -2px 0 rgba(0,0,0,0.3), inset 0 2px 2px rgba(255,255,255,0.12);
            transition: background 0.15s ease, border-color 0.15s ease, box-shadow 0.15s ease;
        }
        .poop-dot::after {
            content: '';
            position: absolute;
            right: 10%;
            top: 15%;
            width: 22%;
            height: 55%;
            border-radius: 999px;
            background: rgba(255,205,90,0.12);
            transform: rotate(-12deg);
        }
        .poop-scale .poop-seg:nth-child(1) .poop-dot { height: 9px; }
        .poop-scale .poop-seg:nth-child(2) .poop-dot { height: 10px; }
        .poop-scale .poop-seg:nth-child(3) .poop-dot { height: 12px; }
        .poop-scale .poop-seg:nth-child(4) .poop-dot { height: 14px; }
        .poop-scale .poop-seg:nth-child(5) .poop-dot { height: 16px; }
        .poop-scale .poop-seg:nth-child(6) .poop-dot { height: 18px; }
        .poop-scale .poop-seg:nth-child(7) .poop-dot { height: 20px; }
        .poop-scale .poop-seg:nth-child(8) .poop-dot { height: 22px; }
        .poop-scale .poop-seg:nth-child(9) .poop-dot { height: 24px; }
        .poop-scale .poop-seg:nth-child(10) .poop-dot { height: 28px; }
        .poop-scale .poop-seg:nth-child(1) .poop-dot { border-radius: 999px 999px 420px 420px; transform: rotate(-1.5deg); }
        .poop-scale .poop-seg:nth-child(2) .poop-dot { border-radius: 999px 700px 600px 500px; transform: rotate(0.8deg); }
        .poop-scale .poop-seg:nth-child(3) .poop-dot { border-radius: 850px 999px 600px 650px; transform: rotate(-0.8deg); }
        .poop-scale .poop-seg:nth-child(4) .poop-dot { border-radius: 700px 900px 420px 520px; transform: rotate(1.2deg); }
        .poop-scale .poop-seg:nth-child(5) .poop-dot { border-radius: 900px 700px 520px 420px; transform: rotate(-1deg); }
        .poop-scale .poop-seg:nth-child(6) .poop-dot { border-radius: 650px 950px 520px 620px; transform: rotate(0.6deg); }
        .poop-scale .poop-seg:nth-child(7) .poop-dot { border-radius: 999px 800px 520px 700px; transform: rotate(-0.6deg); }
        .poop-scale .poop-seg:nth-child(8) .poop-dot { border-radius: 900px 999px 600px 420px; transform: rotate(0.9deg); }
        .poop-scale .poop-seg:nth-child(9) .poop-dot { border-radius: 720px 980px 560px 420px; transform: rotate(-1.2deg); }
        .poop-scale .poop-seg:nth-child(10) .poop-dot { border-radius: 999px 760px 620px 520px; transform: rotate(0.5deg); }
        .poop-seg.is-active .poop-dot,
        .poop-seg.is-hover .poop-dot {
            background: linear-gradient(180deg, rgba(170,88,0,0.98), rgba(112,52,0,0.98));
            border-color: rgba(245,158,11,0.9);
            box-shadow: 0 0 10px rgba(245,158,11,0.35), inset 0 -2px 0 rgba(0,0,0,0.35);
        }
        .emoji-scale {
            display: flex;
            align-items: flex-end;
            gap: 4px;
            contain: layout paint;
            touch-action: pan-y;
            user-select: none;
        }
        .emoji-seg { flex: 1 1 0; cursor: pointer; text-align: center; }
        .emoji-seg input { pointer-events: none; }
        .emoji-dot {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 26px;
            line-height: 1;
            opacity: 0.55;
            border-radius: 0;
            border: none;
            background: transparent;
            box-shadow: none;
            filter: brightness(1.2);
            text-shadow:
                1px 0 0 rgba(245,158,11,0.6),
               -1px 0 0 rgba(245,158,11,0.6),
                0 1px 0 rgba(245,158,11,0.6),
                0 -1px 0 rgba(245,158,11,0.6),
                1px 1px 0 rgba(245,158,11,0.35),
               -1px -1px 0 rgba(245,158,11,0.35);
            transition: opacity 0.15s ease, transform 0.15s ease, filter 0.15s ease, border-color 0.15s ease, background 0.15s ease;
        }
        .emoji-dot--feather { filter: grayscale(1) brightness(1.8); }
        @media (max-width: 420px) {
            .header-action-label { display: none; }
            .header-actions { flex-wrap: wrap; justify-content: flex-end; gap: 6px; }
            .header-actions > * { flex: 0 0 auto; }
        }
        @media (max-width: 520px) {
            .flex, .grid { min-width: 0; max-width: 100%; }
            .card, .container { max-width: 100%; }
            .calendar-controls { flex-wrap: wrap; justify-content: flex-start; }
            .calendar-controls > * { min-width: 0; }
            .author-filter { min-width: 0; max-width: 100%; }
        }
        @media (max-width: 520px) {
            .container { padding-left: 16px !important; padding-right: 16px !important; max-width: 100%; box-sizing: border-box; }
        }
        .emoji-seg.is-active .emoji-dot,
        .emoji-seg.is-hover .emoji-dot {
            opacity: 1;
            filter: brightness(1.35);
            transform: translateY(-1px) scale(1.04);
            text-shadow:
                1px 0 0 rgba(245,158,11,0.9),
               -1px 0 0 rgba(245,158,11,0.9),
                0 1px 0 rgba(245,158,11,0.9),
                0 -1px 0 rgba(245,158,11,0.9),
                2px 0 0 rgba(245,158,11,0.45),
               -2px 0 0 rgba(245,158,11,0.45),
                0 2px 0 rgba(245,158,11,0.45),
                0 -2px 0 rgba(245,158,11,0.45);
        }
        .scale-value { display: inline-block; min-width: 18px; text-align: right; }
        .emoji-seg.is-active .emoji-dot--feather,
        .emoji-seg.is-hover .emoji-dot--feather { filter: grayscale(1) brightness(2); }
        .emoji-scale .emoji-seg:nth-child(1) .emoji-dot { font-size: 12px; }
        .emoji-scale .emoji-seg:nth-child(2) .emoji-dot { font-size: 13px; }
        .emoji-scale .emoji-seg:nth-child(3) .emoji-dot { font-size: 14px; }
        .emoji-scale .emoji-seg:nth-child(4) .emoji-dot { font-size: 15px; }
        .emoji-scale .emoji-seg:nth-child(5) .emoji-dot { font-size: 16px !important; }
        .emoji-scale .emoji-seg:nth-child(6) .emoji-dot { font-size: 17px; }
        .emoji-scale .emoji-seg:nth-child(7) .emoji-dot { font-size: 18px; }
        .emoji-scale .emoji-seg:nth-child(8) .emoji-dot { font-size: 19px; }
        .emoji-scale .emoji-seg:nth-child(9) .emoji-dot { font-size: 20px; }
        .emoji-scale .emoji-seg:nth-child(10) .emoji-dot { font-size: 22px; }
        @media (max-width: 640px) {
            .game-controls { flex-wrap: nowrap; }
            .game-controls button { flex: 1 1 0; text-align: center; }
        }
    </style>
</head>
<body class="relative">
    <div class="backdrop"></div>
    <div class="relative z-10 min-h-screen flex flex-col">
        <header class="container mx-auto px-4 pt-6">
            <div class="flex items-center justify-between flex-wrap gap-3">
                <div class="flex items-center gap-3">
                    <a href="index.html" class="inline-flex items-center gap-2 text-sm text-amber-300 hover:text-amber-200 transition px-3 py-2 rounded-xl border border-amber-500/20 bg-amber-500/10">
                        <span class="text-lg">‚Üê</span>
                        <span>–ù–∞ –≥–ª–∞–≤–Ω—É—é</span>
                    </a>
                    <div>
                        <h1 class="text-2xl md:text-3xl font-bold text-amber-400 mt-1">–ì—Ä–∞—Ñ–∏–∫ –ø–æ–∫–∞–∫–æ–≤</h1>
                    </div>
                </div>
                <div class="flex items-center gap-2 header-actions">
                    <button id="poopExportBtn" type="button" class="inline-flex items-center gap-2 px-3 py-2 text-amber-200 hover:text-white hover:bg-amber-500/10 rounded-xl transition text-sm">
                        <span class="text-base">üì§</span>
                        <span class="font-semibold header-action-label">–í—ã–≥—Ä—É–∑–∫–∞</span>
                    </button>
                    <button id="poopGameBtn" type="button" class="inline-flex items-center gap-2 px-3 py-2 text-amber-200 hover:text-white hover:bg-amber-500/10 rounded-xl transition text-sm">
                        <span class="text-base">üïπÔ∏è</span>
                        <span class="font-semibold header-action-label">–ì–æ–≤–Ω–æ–∏–¥</span>
                    </button>
                    <span class="text-xs text-gray-400">–ê–Ω–æ–Ω–∏–º–Ω–æ—Å—Ç—å</span>
                    <button id="anonToggle" type="button" class="relative inline-flex items-center w-14 h-8 rounded-full border border-amber-500/30 bg-black/60 transition focus:outline-none">
                        <span class="absolute left-1 anon-thumb w-6 h-6 rounded-full bg-amber-500/40 border border-amber-500/40 transition-transform"></span>
                    </button>
                </div>
            </div>
        </header>

        <main class="container mx-auto px-4 py-8 flex-1 w-full">
            <div class="grid gap-6 lg:grid-cols-[1.1fr_1fr] items-start">
                <section class="card glow p-5">
                    <div class="flex items-center justify-between gap-3 flex-wrap">
                        <div>
                            <p class="text-sm text-gray-400">–í—ã–±–µ—Ä–∏ –¥–µ–Ω—å, —á—Ç–æ–±—ã –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—é</p>
                            <h2 class="text-xl font-bold text-amber-400 mt-1" id="rangeTitle"></h2>
                        </div>
                        <div class="flex items-center gap-2 calendar-controls">
                            <div class="inline-flex rounded-xl border border-amber-500/30 bg-black/50 p-1">
                                <button id="weekModeBtn" class="px-3 py-2 rounded-lg text-amber-300 hover:text-white hover:bg-amber-500/10 transition font-semibold">–ù–µ–¥–µ–ª—è</button>
                                <button id="monthModeBtn" class="px-3 py-2 rounded-lg text-gray-300 hover:text-white hover:bg-amber-500/10 transition">–ú–µ—Å—è—Ü</button>
                            </div>
                            <button id="prevRangeBtn" class="px-3 py-2 rounded-xl border border-amber-500/25 bg-amber-500/10 text-amber-300 hover:text-white hover:border-amber-500/40 transition">‚Üê –ü—Ä–µ–¥.</button>
                            <button id="nextRangeBtn" class="px-3 py-2 rounded-xl border border-amber-500/25 bg-amber-500/10 text-amber-300 hover:text-white hover:border-amber-500/40 transition">–°–ª–µ–¥. ‚Üí</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-4 sm:grid-cols-7 gap-2 mt-4 text-center text-[11px] text-gray-500 uppercase tracking-wide">
                        <span>–ü–Ω</span><span>–í—Ç</span><span>–°—Ä</span><span>–ß—Ç</span><span>–ü—Ç</span><span>–°–±</span><span>–í—Å</span>
                    </div>
                    <div id="calendarGrid" class="grid grid-cols-4 sm:grid-cols-7 gap-3 mt-3"></div>
                </section>

                <section class="card glow p-5" id="dayPanel">
                    <div class="flex items-center justify-between gap-3 flex-wrap mb-4">
                        <div>
                            <p class="text-sm text-gray-400">–í—ã–±—Ä–∞–Ω–Ω—ã–π –¥–µ–Ω—å</p>
                            <h2 class="text-xl font-bold text-amber-400" id="selectedDateLabel"></h2>
                        </div>
                        <div class="flex flex-col gap-1 relative">
                            <span class="text-xs text-gray-400">–ê–≤—Ç–æ—Ä –ø–æ–∫–∞–∫–∞</span>
                            <div class="relative">
                                <button id="authorFilterBtn" type="button" class="author-filter flex items-center gap-2 px-3 py-2 rounded-lg border border-amber-500/30 bg-black/60 text-sm text-amber-200 hover:border-amber-500/50 transition min-w-[160px] relative pr-9">
                                    <span id="authorFilterLabel">–í—Å–µ</span>
                                    <svg class="w-4 h-4 text-amber-300 absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                    </svg>
                                </button>
                                <div id="authorDropdown" class="hidden absolute right-0 mt-2 min-w-[160px] bg-black/90 border border-amber-500/25 rounded-xl shadow-lg z-10">
                                    <div id="authorOptions" class="max-h-56 overflow-y-auto divide-y divide-amber-500/10"></div>
                                </div>
                            </div>
                        </div>
                        <button id="addPoopBtn" class="px-4 py-2 rounded-xl bg-amber-500/20 border border-amber-500/40 text-amber-300 hover:text-white hover:bg-amber-500/30 transition flex items-center gap-2">
                            <span class="text-lg">Ôºã</span>
                            <span class="font-semibold">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–∫–∞–∫</span>
                        </button>
                    </div>

                    <div id="entriesList" class="space-y-3">
                        <div class="text-gray-400 text-sm">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –∑–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å. –î–æ–±–∞–≤—å –ø–µ—Ä–≤—É—é.</div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Modal -->
    <div id="poopModal" class="fixed inset-0 bg-black/70 backdrop-blur-sm hidden items-start sm:items-center justify-center px-4 z-20 overflow-y-auto py-6 modal-scroll">
        <div class="relative w-full max-w-3xl card glow p-6 overflow-y-auto modal-scroll min-h-0 modal-card">
            <button aria-label="–ó–∞–∫—Ä—ã—Ç—å" id="closeModalBtn" class="absolute top-3 right-3 text-gray-400 hover:text-white transition">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
            <h3 class="text-xl font-bold text-amber-400 mb-4">–ù–æ–≤—ã–π –ø–æ–∫–∞–∫</h3>
            <form id="poopForm" class="grid gap-4">
                <div class="grid gap-4 md:grid-cols-2">
                    <div class="block text-sm text-gray-300">
                        <div class="time-field-header mb-2">
                            <span class="time-field-title">–í—Ä–µ–º—è –ø–æ–∫–∞–∫–∞</span>
                            <div class="time-field-toggle text-[11px] text-gray-400">
                                <span id="timeModeLabel">–ö–æ–ª–µ—Å–æ</span>
                                <button id="timeModeToggle" type="button" class="relative inline-flex items-center w-11 h-6 rounded-full border border-amber-500/30 bg-black/60 transition focus:outline-none" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º –≤—Ä–µ–º–µ–Ω–∏">
                                    <span class="absolute left-1 time-mode-thumb w-4 h-4 rounded-full bg-amber-500/40 border border-amber-500/40 transition-transform"></span>
                                </button>
                            </div>
                        </div>
                        <div class="grid gap-3">
                            <input type="hidden" name="time" id="timeInput">
                            <div id="timeWheelWrap" class="grid gap-3">
                                <div id="timeWheel" class="time-wheel" aria-label="–í—ã–±–æ—Ä –≤—Ä–µ–º–µ–Ω–∏">
                                    <div class="time-wheel-col" data-part="hour" aria-label="–ß–∞—Å—ã">
                                        <span class="time-wheel-static">–ß–∞—Å—ã</span>
                                        <div class="time-wheel-list"></div>
                                    </div>
                                    <div class="time-wheel-col" data-part="minute" aria-label="–ú–∏–Ω—É—Ç—ã">
                                        <span class="time-wheel-static">–ú–∏–Ω—É—Ç—ã</span>
                                        <div class="time-wheel-list"></div>
                                    </div>
                                </div>
                            </div>
                            <div id="timeSelectWrap" class="grid gap-3 hidden">
                                <select id="timeSelect" class="w-full px-4 py-3 bg-black/60 border border-amber-500/30 rounded-xl focus:border-amber-500/60 focus:outline-none text-amber-100"></select>
                            </div>
                        </div>
                    </div>
                    <div class="block text-sm text-gray-300">
                        <span class="block mb-2">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</span>
                        <div class="grid gap-3">
                            <input type="hidden" name="duration" id="durationInput">
                            <input type="hidden" name="durationSeconds" id="durationSecondsInput">
                            <div id="durationWheel" class="time-wheel" aria-label="–í—ã–±–æ—Ä –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏">
                                <div class="time-wheel-col" data-part="minute" aria-label="–ú–∏–Ω—É—Ç—ã">
                                    <span class="time-wheel-static">–ú–∏–Ω—É—Ç—ã</span>
                                    <div class="time-wheel-list"></div>
                                </div>
                                <div class="time-wheel-col" data-part="second" aria-label="–°–µ–∫—É–Ω–¥—ã">
                                    <span class="time-wheel-static">–°–µ–∫—É–Ω–¥—ã</span>
                                    <div class="time-wheel-list"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="grid gap-4 md:grid-cols-2">
                    <div class="block text-sm text-gray-300">
                        <span class="block mb-2">–ö–æ–ª-–≤–æ –∫—É—Å–∫–æ–≤ –±—É–º–∞–≥–∏, —à—Ç</span>
                        <div class="grid gap-3">
                            <input type="hidden" name="paper" id="paperInput">
                            <div id="paperWheel" class="time-wheel time-wheel--single" aria-label="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±—É–º–∞–≥–∏">
                                <div class="time-wheel-col" data-part="paper" aria-label="–ë—É–º–∞–≥–∞">
                                    <div class="time-wheel-list time-wheel-list--nolabel"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="block text-sm text-gray-300">
                        <span class="block mb-2">–õ—ë–≥–∫–æ—Å—Ç—å –æ—á–∏—Å—Ç–∫–∏: <span id="easeValueLabel" class="text-amber-200 scale-value">‚Äî</span></span>
                        <div id="easeScale" class="emoji-scale mt-8">
                            <label class="emoji-seg" data-scale-value="1" title="–õ—ë–≥–∫–æ—Å—Ç—å 1">
                                <input class="sr-only" type="radio" name="ease" value="1" required>
                                <span class="emoji-dot emoji-dot--feather">ü™∂</span>
                            </label>
                            <label class="emoji-seg" data-scale-value="2" title="–õ—ë–≥–∫–æ—Å—Ç—å 2">
                                <input class="sr-only" type="radio" name="ease" value="2">
                                <span class="emoji-dot emoji-dot--feather">ü™∂</span>
                            </label>
                            <label class="emoji-seg" data-scale-value="3" title="–õ—ë–≥–∫–æ—Å—Ç—å 3">
                                <input class="sr-only" type="radio" name="ease" value="3">
                                <span class="emoji-dot emoji-dot--feather">ü™∂</span>
                            </label>
                            <label class="emoji-seg" data-scale-value="4" title="–õ—ë–≥–∫–æ—Å—Ç—å 4">
                                <input class="sr-only" type="radio" name="ease" value="4">
                                <span class="emoji-dot emoji-dot--feather">ü™∂</span>
                            </label>
                            <label class="emoji-seg" data-scale-value="5" title="–õ—ë–≥–∫–æ—Å—Ç—å 5">
                                <input class="sr-only" type="radio" name="ease" value="5">
                                <span class="emoji-dot emoji-dot--feather">ü™∂</span>
                            </label>
                            <label class="emoji-seg" data-scale-value="6" title="–õ—ë–≥–∫–æ—Å—Ç—å 6">
                                <input class="sr-only" type="radio" name="ease" value="6">
                                <span class="emoji-dot emoji-dot--feather">ü™∂</span>
                            </label>
                            <label class="emoji-seg" data-scale-value="7" title="–õ—ë–≥–∫–æ—Å—Ç—å 7">
                                <input class="sr-only" type="radio" name="ease" value="7">
                                <span class="emoji-dot emoji-dot--feather">ü™∂</span>
                            </label>
                            <label class="emoji-seg" data-scale-value="8" title="–õ—ë–≥–∫–æ—Å—Ç—å 8">
                                <input class="sr-only" type="radio" name="ease" value="8">
                                <span class="emoji-dot emoji-dot--feather">ü™∂</span>
                            </label>
                            <label class="emoji-seg" data-scale-value="9" title="–õ—ë–≥–∫–æ—Å—Ç—å 9">
                                <input class="sr-only" type="radio" name="ease" value="9">
                                <span class="emoji-dot emoji-dot--feather">ü™∂</span>
                            </label>
                            <label class="emoji-seg" data-scale-value="10" title="–õ—ë–≥–∫–æ—Å—Ç—å 10">
                                <input class="sr-only" type="radio" name="ease" value="10">
                                <span class="emoji-dot emoji-dot--feather">ü™∂</span>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="grid gap-4 md:grid-cols-2">
                    <div class="block text-sm text-gray-300">
                        <span class="block mb-2">–£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç—å –ø–æ–∫–∞–∫–æ–º: <span id="satisfactionValueLabel" class="text-amber-200 scale-value">‚Äî</span></span>
                        <div id="satisfactionScale" class="emoji-scale mt-8">
                            <label class="emoji-seg" data-scale-value="1" title="–£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç—å 1">
                                <input class="sr-only" type="radio" name="satisfaction" value="1" required>
                                <span class="emoji-dot">ü§©</span>
                            </label>
                            <label class="emoji-seg" data-scale-value="2" title="–£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç—å 2">
                                <input class="sr-only" type="radio" name="satisfaction" value="2">
                                <span class="emoji-dot">ü§©</span>
                            </label>
                            <label class="emoji-seg" data-scale-value="3" title="–£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç—å 3">
                                <input class="sr-only" type="radio" name="satisfaction" value="3">
                                <span class="emoji-dot">ü§©</span>
                            </label>
                            <label class="emoji-seg" data-scale-value="4" title="–£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç—å 4">
                                <input class="sr-only" type="radio" name="satisfaction" value="4">
                                <span class="emoji-dot">ü§©</span>
                            </label>
                            <label class="emoji-seg" data-scale-value="5" title="–£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç—å 5">
                                <input class="sr-only" type="radio" name="satisfaction" value="5">
                                <span class="emoji-dot">ü§©</span>
                            </label>
                            <label class="emoji-seg" data-scale-value="6" title="–£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç—å 6">
                                <input class="sr-only" type="radio" name="satisfaction" value="6">
                                <span class="emoji-dot">ü§©</span>
                            </label>
                            <label class="emoji-seg" data-scale-value="7" title="–£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç—å 7">
                                <input class="sr-only" type="radio" name="satisfaction" value="7">
                                <span class="emoji-dot">ü§©</span>
                            </label>
                            <label class="emoji-seg" data-scale-value="8" title="–£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç—å 8">
                                <input class="sr-only" type="radio" name="satisfaction" value="8">
                                <span class="emoji-dot">ü§©</span>
                            </label>
                            <label class="emoji-seg" data-scale-value="9" title="–£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç—å 9">
                                <input class="sr-only" type="radio" name="satisfaction" value="9">
                                <span class="emoji-dot">ü§©</span>
                            </label>
                            <label class="emoji-seg" data-scale-value="10" title="–£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç—å 10">
                                <input class="sr-only" type="radio" name="satisfaction" value="10">
                                <span class="emoji-dot">ü§©</span>
                            </label>
                        </div>
                    </div>
                    <div class="block text-sm text-gray-300">
                        <span class="block mb-2">–†–∞–∑–º–µ—Ä: <span id="sizeValueLabel" class="text-amber-200 scale-value">‚Äî</span></span>
                        <div id="sizeScale" class="poop-scale mt-6">
                            <label class="poop-seg" data-size="1" title="–†–∞–∑–º–µ—Ä 1">
                                <input class="sr-only" type="radio" name="size" value="1" required>
                                <span class="poop-dot"></span>
                            </label>
                            <label class="poop-seg" data-size="2" title="–†–∞–∑–º–µ—Ä 2">
                                <input class="sr-only" type="radio" name="size" value="2">
                                <span class="poop-dot"></span>
                            </label>
                            <label class="poop-seg" data-size="3" title="–†–∞–∑–º–µ—Ä 3">
                                <input class="sr-only" type="radio" name="size" value="3">
                                <span class="poop-dot"></span>
                            </label>
                            <label class="poop-seg" data-size="4" title="–†–∞–∑–º–µ—Ä 4">
                                <input class="sr-only" type="radio" name="size" value="4">
                                <span class="poop-dot"></span>
                            </label>
                            <label class="poop-seg" data-size="5" title="–†–∞–∑–º–µ—Ä 5">
                                <input class="sr-only" type="radio" name="size" value="5">
                                <span class="poop-dot"></span>
                            </label>
                            <label class="poop-seg" data-size="6" title="–†–∞–∑–º–µ—Ä 6">
                                <input class="sr-only" type="radio" name="size" value="6">
                                <span class="poop-dot"></span>
                            </label>
                            <label class="poop-seg" data-size="7" title="–†–∞–∑–º–µ—Ä 7">
                                <input class="sr-only" type="radio" name="size" value="7">
                                <span class="poop-dot"></span>
                            </label>
                            <label class="poop-seg" data-size="8" title="–†–∞–∑–º–µ—Ä 8">
                                <input class="sr-only" type="radio" name="size" value="8">
                                <span class="poop-dot"></span>
                            </label>
                            <label class="poop-seg" data-size="9" title="–†–∞–∑–º–µ—Ä 9">
                                <input class="sr-only" type="radio" name="size" value="9">
                                <span class="poop-dot"></span>
                            </label>
                            <label class="poop-seg" data-size="10" title="–†–∞–∑–º–µ—Ä 10">
                                <input class="sr-only" type="radio" name="size" value="10">
                                <span class="poop-dot"></span>
                            </label>
                        </div>
                    </div>
                    <div class="block text-sm text-gray-300 md:col-span-2">
                        <span class="block mb-2">–ë—Ä–∏—Å—Ç–æ–ª—å—Å–∫–∞—è —à–∫–∞–ª–∞ (1‚Äì7)</span>
                        <div id="bristolOptions" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2 w-full"></div>
                    </div>
                </div>
                <label class="block text-sm text-gray-300">
                    <span class="block mb-2">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</span>
                    <textarea name="comment" rows="2" class="w-full px-4 py-3 bg-black/60 border border-amber-500/30 rounded-xl focus:border-amber-500/60 focus:outline-none text-amber-100 resize-none" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, —á—Ç–æ –µ–ª –∏–ª–∏ –∫–∞–∫ —Å–µ–±—è —á—É–≤—Å—Ç–≤–æ–≤–∞–ª"></textarea>
                </label>
                <input type="hidden" name="drawing" id="drawingInput">
                <div class="space-y-2">
                    <button type="button" id="drawingToggle" aria-expanded="false" class="text-xs text-amber-200 underline hover:text-amber-100 transition">üé® –ù–∞—Ä–∏—Å–æ–≤–∞—Ç—å –∫–∞–ª</button>
                    <div id="drawingPanel" class="hidden mt-2 p-4 border border-amber-500/25 rounded-2xl bg-black/50 space-y-3">
                        <div class="flex flex-wrap items-center justify-between gap-3">
                            <div class="flex items-center gap-2 text-xs text-gray-200">
                                <button type="button" data-drawing-tool="pencil" class="px-3 py-1 rounded-full border border-amber-500/40 bg-black/60 hover:border-amber-500/60 transition text-amber-100 flex items-center gap-1">
                                    ‚úèÔ∏è –ö–∞—Ä–∞–Ω–¥–∞—à
                                </button>
                                <button type="button" data-drawing-tool="marker" class="px-3 py-1 rounded-full border border-amber-500/40 bg-black/60 hover:border-amber-500/60 transition text-amber-100 flex items-center gap-1">
                                    üñã –ú–∞—Ä–∫–µ—Ä
                                </button>
                                <button type="button" data-drawing-tool="fill" class="px-3 py-1 rounded-full border border-amber-500/40 bg-black/60 hover:border-amber-500/60 transition text-amber-100 flex items-center justify-center" aria-label="–ó–∞–ª–∏–≤–∫–∞">
                                    <span class="text-lg leading-none">üñåÔ∏è</span>
                                </button>
                                <button type="button" data-drawing-tool="eraser" class="px-3 py-1 rounded-full border border-amber-500/40 bg-black/60 hover:border-amber-500/60 transition text-amber-100 flex items-center justify-center" aria-label="–õ–∞—Å—Ç–∏–∫">
                                    <span class="text-lg leading-none">üßΩ</span>
                                </button>
                            </div>
                            <div class="flex flex-wrap items-center gap-2 text-xs text-gray-200">
                                <span>–¶–≤–µ—Ç:</span>
                                <button type="button" class="drawing-color w-6 h-6 rounded-full border border-amber-500/40" data-color="#3d1f0a" style="background:#3d1f0a" aria-label="–ì–ª—É–±–æ–∫–∏–π —à–æ–∫–æ–ª–∞–¥–Ω—ã–π"></button>
                                <button type="button" class="drawing-color w-6 h-6 rounded-full border border-amber-500/40" data-color="#5d3a1a" style="background:#5d3a1a" aria-label="–¢—ë–º–Ω–æ-–∫–æ—Ä–∏—á–Ω–µ–≤—ã–π"></button>
                                <button type="button" class="drawing-color w-6 h-6 rounded-full border border-amber-500/40" data-color="#7c4f22" style="background:#7c4f22" aria-label="–ö–æ—Ä–∏—á–Ω–µ–≤—ã–π"></button>
                                <button type="button" class="drawing-color w-6 h-6 rounded-full border border-amber-500/40" data-color="#4a2e15" style="background:#4a2e15" aria-label="–ì–ª—É–±–æ–∫–∏–π –∫–æ—Ä–∏—á–Ω–µ–≤—ã–π"></button>
                                <button type="button" class="drawing-color w-6 h-6 rounded-full border border-amber-500/40" data-color="#8b5a2b" style="background:#8b5a2b" aria-label="–°–≤–µ—Ç–ª–æ-–∫–æ—Ä–∏—á–Ω–µ–≤—ã–π"></button>
                                <button type="button" class="drawing-color w-6 h-6 rounded-full border border-amber-500/40" data-color="#a8550e" style="background:#a8550e" aria-label="–ú–µ–¥–æ–≤–æ-–∫–æ—Ä–∏—á–Ω–µ–≤—ã–π"></button>
                                <button type="button" class="drawing-color w-6 h-6 rounded-full border border-amber-500/40" data-color="#c2782a" style="background:#c2782a" aria-label="–ö–∞—Ä–∞–º–µ–ª—å–Ω—ã–π"></button>
                                <button type="button" class="drawing-color w-6 h-6 rounded-full border border-amber-500/40" data-color="#b56b2d" style="background:#b56b2d" aria-label="–¢—ë–ø–ª–æ-—Ç–µ—Ä—Ä–∞–∫–æ—Ç–æ–≤—ã–π"></button>
                                <button type="button" id="drawingClear" class="px-2 py-1 rounded-lg border border-amber-500/30 text-amber-200 text-[11px] hover:border-amber-500/50 transition">–û—á–∏—Å—Ç–∏—Ç—å</button>
                            </div>
                            <div id="eraserSizePanel" class="hidden flex items-center gap-2 text-xs text-gray-200">
                                <span>–†–∞–∑–º–µ—Ä –ª–∞—Å—Ç–∏–∫–∞:</span>
                                <button type="button" data-eraser-size="8" class="px-2 py-1 rounded-full border border-amber-500/30 hover:border-amber-500/50 transition">8</button>
                                <button type="button" data-eraser-size="12" class="px-2 py-1 rounded-full border border-amber-500/30 hover:border-amber-500/50 transition">12</button>
                                <button type="button" data-eraser-size="20" class="px-2 py-1 rounded-full border border-amber-500/30 hover:border-amber-500/50 transition">20</button>
                                <button type="button" data-eraser-size="28" class="px-2 py-1 rounded-full border border-amber-500/30 hover:border-amber-500/50 transition">28</button>
                            </div>
                        </div>
                        <div class="rounded-2xl bg-black/60 overflow-hidden relative">
                            <div class="relative w-full" style="aspect-ratio: 504 / 308;">
                                <canvas id="drawingCanvas" width="504" height="308" class="absolute inset-0 w-full h-full game-canvas"></canvas>
                            </div>
                        </div>
                        <p class="text-[11px] text-gray-400 text-right">–°–æ—Ö—Ä–∞–Ω–∏ —Ä–∏—Å—É–Ω–æ–∫, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –ø–æ–∫–∞–∑–∞—Ç—å –¥—Ä—É–∑—å—è–º.</p>
                    </div>
                </div>
                <div class="flex justify-end gap-3 pt-2">
                    <button type="button" id="cancelModalBtn" class="px-4 py-3 rounded-xl border border-amber-500/20 text-gray-300 hover:text-white hover:border-amber-500/40 transition">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="px-4 py-3 rounded-xl bg-amber-500/20 border border-amber-500/40 text-amber-100 hover:text-white hover:bg-amber-500/30 transition font-semibold">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–∫–∞–∫</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Game Modal -->
    <div id="poopGameModal" class="fixed inset-0 bg-black/75 backdrop-blur-sm hidden items-start sm:items-center justify-center px-4 z-30 overflow-y-auto py-6 modal-scroll">
        <div class="relative w-full max-w-5xl card glow p-6 overflow-y-auto modal-scroll min-h-0 modal-card">
            <button aria-label="–ó–∞–∫—Ä—ã—Ç—å –∏–≥—Ä—É" id="closeGameModalBtn" class="absolute top-4 right-4 text-gray-400 hover:text-white transition z-10">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
            <div class="flex items-center justify-between gap-3 flex-wrap mb-4 pr-12">
                <div>
                    <h3 class="text-xl font-bold text-amber-400">–ì–æ–≤–Ω–æ–∏–¥</h3>
                    <p class="text-xs text-gray-400 mt-1">–£–±–∏–≤–∞–π –≥–æ–≤–Ω–æ –∏ –∑–∞–Ω–æ—Å–∏ –Ω–æ–≤—ã–π –ø–æ–∫–∞–∫.</p>
                </div>
                <div class="flex items-center gap-3 flex-wrap game-controls">
                    <div class="flex items-center gap-3 text-xs text-amber-200">
                        <span class="px-2 py-1 rounded-lg border border-amber-500/25 bg-black/40">–°—á—ë—Ç: <span id="gameScoreLabel">0</span></span>
                        <span class="px-2 py-1 rounded-lg border border-amber-500/25 bg-black/40">–ñ–∏–∑–Ω–∏: <span id="gameLivesLabel">3</span></span>
                    </div>
                    <button id="gameStartBtn" type="button" class="px-3 py-2 rounded-xl border border-amber-500/25 bg-amber-500/10 text-amber-200 hover:text-white hover:border-amber-500/40 transition text-sm font-semibold">–°—Ç–∞—Ä—Ç</button>
                    <button id="gameResetBtn" type="button" class="px-3 py-2 rounded-xl border border-amber-500/25 text-gray-300 hover:text-white hover:border-amber-500/40 transition text-sm">–ó–∞–Ω–æ–≤–æ</button>
                </div>
            </div>
            <div class="game-shell">
                <canvas id="poopGameCanvas" class="game-canvas" aria-label="–ì–æ–≤–Ω–æ–∏–¥ —Å –ª–∞–¥–æ–Ω—å—é –∏ –±—É–º–∞–≥–æ–π"></canvas>
                <div class="game-hint">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: ‚Üê ‚Üí –∏–ª–∏ A/D, –º—ã—à—å/–ø–∞–ª–µ—Ü –ø–æ –ø–æ–ª—é. –ü–∞—É–∑–∞ ‚Äî –∫–Ω–æ–ø–∫–∞ ¬´–°—Ç–∞—Ä—Ç¬ª.</div>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div id="poopExportModal" class="fixed inset-0 bg-black/85 hidden items-center justify-center px-4 z-30 overflow-y-auto py-6 modal-scroll">
        <div class="relative w-full max-w-3xl card glow p-6 overflow-y-auto modal-scroll min-h-0 modal-card">
            <button aria-label="–ó–∞–∫—Ä—ã—Ç—å –≤—ã–≥—Ä—É–∑–∫—É" id="closeExportModalBtn" class="absolute top-3 right-3 text-gray-400 hover:text-white transition">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
            <h3 class="text-xl font-bold text-amber-400 mb-2">–í—ã–≥—Ä—É–∑–∫–∞ CSV</h3>
            <p class="text-xs text-gray-400 mb-4">–î–∞–Ω–Ω—ã–µ –≤—ã–≥—Ä—É–∂–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ —Ç–≤–æ–∏–º –ø–æ–∫–∞–∫–∞–º.</p>
            <form id="exportForm" class="grid gap-4">
                <div class="grid gap-4 md:grid-cols-2">
                    <label class="block text-sm text-gray-300">
                        <span class="block mb-2">–° –¥–∞—Ç—ã</span>
                        <input type="date" id="exportFrom" class="w-full px-4 py-3 bg-black/60 border border-amber-500/30 rounded-xl focus:border-amber-500/60 focus:outline-none text-amber-100">
                    </label>
                    <label class="block text-sm text-gray-300">
                        <span class="block mb-2">–ü–æ –¥–∞—Ç—É</span>
                        <input type="date" id="exportTo" class="w-full px-4 py-3 bg-black/60 border border-amber-500/30 rounded-xl focus:border-amber-500/60 focus:outline-none text-amber-100">
                    </label>
                </div>
                <div class="block text-sm text-gray-300">
                    <span class="block mb-2">–ü–æ–ª—è –¥–ª—è –≤—ã–≥—Ä—É–∑–∫–∏</span>
                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-2">
                        <label class="export-field flex items-center gap-2 px-3 py-2 rounded-lg border border-amber-500/20 bg-black/50">
                            <input type="checkbox" name="exportField" value="date" checked>
                            <span>–î–∞—Ç–∞</span>
                        </label>
                        <label class="export-field flex items-center gap-2 px-3 py-2 rounded-lg border border-amber-500/20 bg-black/50">
                            <input type="checkbox" name="exportField" value="time" checked>
                            <span>–í—Ä–µ–º—è</span>
                        </label>
                        <label class="export-field flex items-center gap-2 px-3 py-2 rounded-lg border border-amber-500/20 bg-black/50">
                            <input type="checkbox" name="exportField" value="duration" checked>
                            <span>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</span>
                        </label>
                        <label class="export-field flex items-center gap-2 px-3 py-2 rounded-lg border border-amber-500/20 bg-black/50">
                            <input type="checkbox" name="exportField" value="paper" checked>
                            <span>–ë—É–º–∞–≥–∞</span>
                        </label>
                        <label class="export-field flex items-center gap-2 px-3 py-2 rounded-lg border border-amber-500/20 bg-black/50">
                            <input type="checkbox" name="exportField" value="ease" checked>
                            <span>–õ—ë–≥–∫–æ—Å—Ç—å</span>
                        </label>
                        <label class="export-field flex items-center gap-2 px-3 py-2 rounded-lg border border-amber-500/20 bg-black/50">
                            <input type="checkbox" name="exportField" value="satisfaction" checked>
                            <span>–£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç—å</span>
                        </label>
                        <label class="export-field flex items-center gap-2 px-3 py-2 rounded-lg border border-amber-500/20 bg-black/50">
                            <input type="checkbox" name="exportField" value="size" checked>
                            <span>–†–∞–∑–º–µ—Ä</span>
                        </label>
                        <label class="export-field flex items-center gap-2 px-3 py-2 rounded-lg border border-amber-500/20 bg-black/50">
                            <input type="checkbox" name="exportField" value="bristol" checked>
                            <span>–ë—Ä–∏—Å—Ç–æ–ª—å</span>
                        </label>
                        <label class="export-field flex items-center gap-2 px-3 py-2 rounded-lg border border-amber-500/20 bg-black/50">
                            <input type="checkbox" name="exportField" value="comment" checked>
                            <span>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</span>
                        </label>
                    </div>
                </div>
                <div id="exportStatus" class="text-xs text-gray-400"></div>
                <div class="flex justify-end gap-3 pt-2">
                    <button type="button" id="cancelExportBtn" class="px-4 py-3 rounded-xl border border-amber-500/20 text-gray-300 hover:text-white hover:border-amber-500/40 transition">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="px-4 py-3 rounded-xl bg-amber-500/20 border border-amber-500/40 text-amber-100 hover:text-white hover:bg-amber-500/30 transition font-semibold">–°–∫–∞—á–∞—Ç—å CSV</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div id="confirmModal" class="fixed inset-0 hidden flex items-center justify-center px-4 z-40 confirm-modal">
        <div class="bg-black/85 border border-amber-500/30 rounded-xl p-5 w-full max-w-sm text-sm text-gray-200">
            <div class="font-semibold text-amber-200 mb-2">–£–¥–∞–ª–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π?</div>
            <div class="text-gray-400 mb-4">–î–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.</div>
            <div class="flex justify-end gap-2">
                <button id="confirmCancel" class="px-3 py-2 rounded-lg border border-amber-500/25 text-gray-300 hover:border-amber-500/40 transition">–û—Ç–º–µ–Ω–∞</button>
                <button id="confirmOk" class="px-3 py-2 rounded-lg bg-red-500/20 border border-red-500/40 text-red-200 hover:bg-red-500/30 transition">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        // Logo font gate: avoid logo flash + load selected Google Font
        (function(){
            const html = document.documentElement;
            const KEY = 'logoFontFamily';
            const DEFAULT = 'Rubik Wet Paint';
            const LINK_ID = 'logoFontGF';

            function familyToHref(fam){
                const q = encodeURIComponent(fam).replace(/%20/g, '+');
                return `https://fonts.googleapis.com/css2?family=${q}&display=swap`;
            }

            function ensureStylesheet(fam){
                const family = (fam || DEFAULT).trim();
                if (!family) return;
                const href = familyToHref(family);
                let link = document.getElementById(LINK_ID);
                if (!link) {
                    link = document.createElement('link');
                    link.id = LINK_ID;
                    link.rel = 'stylesheet';
                    document.head.appendChild(link);
                }
                if (link.getAttribute('href') !== href) link.setAttribute('href', href);
            }

            function markReady(){
                html.classList.add('logo-font-ready');
                html.classList.remove('logo-font-loading');
            }

            function waitForFont(fam){
                const family = (fam || DEFAULT).trim();
                if (!family) return markReady();

                ensureStylesheet(family);

                html.classList.add('logo-font-loading');
                html.classList.remove('logo-font-ready');
                try {
                    if (document.fonts && document.fonts.load) {
                        document.fonts.load(`1em "${family}"`).then(markReady, markReady);
                    } else {
                        setTimeout(markReady, 1);
                    }
                } catch (_) {
                    markReady();
                }
            }

            try {
                const fam = localStorage.getItem(KEY) || DEFAULT;
                html.style.setProperty('--logo-font', `'${fam}'`);
                window.__loadLogoFont = waitForFont;
                waitForFont(fam);
            } catch(_) {
                window.__loadLogoFont = waitForFont;
                markReady();
            }
        })();

        (function(){
            const dayNames = ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'];
            const rangeTitle = document.getElementById('rangeTitle');
            const calendarGrid = document.getElementById('calendarGrid');
            const selectedDateLabel = document.getElementById('selectedDateLabel');
            const entriesList = document.getElementById('entriesList');
            const addPoopBtn = document.getElementById('addPoopBtn');
            const modal = document.getElementById('poopModal');
            const timeInput = document.getElementById('timeInput');
            const timeWheel = document.getElementById('timeWheel');
            const timeWheelWrap = document.getElementById('timeWheelWrap');
            const timeSelectWrap = document.getElementById('timeSelectWrap');
            const timeSelect = document.getElementById('timeSelect');
            const timeModeToggle = document.getElementById('timeModeToggle');
            const timeModeLabel = document.getElementById('timeModeLabel');
            const durationInput = document.getElementById('durationInput');
            const durationSecondsInput = document.getElementById('durationSecondsInput');
            const durationWheel = document.getElementById('durationWheel');
            const paperInput = document.getElementById('paperInput');
            const paperWheel = document.getElementById('paperWheel');
            const easeScale = document.getElementById('easeScale');
            const satisfactionScale = document.getElementById('satisfactionScale');
            const easeValueLabel = document.getElementById('easeValueLabel');
            const satisfactionValueLabel = document.getElementById('satisfactionValueLabel');
            const sizeValueLabel = document.getElementById('sizeValueLabel');
            const form = document.getElementById('poopForm');
            const weekModeBtn = document.getElementById('weekModeBtn');
            const monthModeBtn = document.getElementById('monthModeBtn');
            const prevRangeBtn = document.getElementById('prevRangeBtn');
            const nextRangeBtn = document.getElementById('nextRangeBtn');
            const bristolOptions = document.getElementById('bristolOptions');
            const authorFilterBtn = document.getElementById('authorFilterBtn');
            const authorFilterLabel = document.getElementById('authorFilterLabel');
            const authorDropdown = document.getElementById('authorDropdown');
            const authorOptions = document.getElementById('authorOptions');
            const anonToggle = document.getElementById('anonToggle');
            const drawingToggle = document.getElementById('drawingToggle');
            const drawingPanel = document.getElementById('drawingPanel');
            const drawingCanvas = document.getElementById('drawingCanvas');
            const drawingClear = document.getElementById('drawingClear');
            const drawingInput = document.getElementById('drawingInput');
            const drawingToolButtons = document.querySelectorAll('[data-drawing-tool]');
            const eraserSizePanel = document.getElementById('eraserSizePanel');
            const eraserSizeButtons = document.querySelectorAll('[data-eraser-size]');
            const sizeScale = document.getElementById('sizeScale');
            const exportBtn = document.getElementById('poopExportBtn');
            const exportModal = document.getElementById('poopExportModal');
            const exportForm = document.getElementById('exportForm');
            const exportFrom = document.getElementById('exportFrom');
            const exportTo = document.getElementById('exportTo');
            const exportStatus = document.getElementById('exportStatus');
            const closeExportBtn = document.getElementById('closeExportModalBtn');
            const cancelExportBtn = document.getElementById('cancelExportBtn');
            const gameBtn = document.getElementById('poopGameBtn');
            const gameModal = document.getElementById('poopGameModal');
            const gameCanvas = document.getElementById('poopGameCanvas');
            const gameStartBtn = document.getElementById('gameStartBtn');
            const gameResetBtn = document.getElementById('gameResetBtn');
            const gameCloseBtn = document.getElementById('closeGameModalBtn');
            const gameScoreLabel = document.getElementById('gameScoreLabel');
            const gameLivesLabel = document.getElementById('gameLivesLabel');

            const AUTHOR_FILTER_LS_KEY = 'gpPoopAuthorFilter';
            const ANON_LS_KEY = 'gpAnonMode';
            const VIEW_MODE_LS_KEY = 'gpViewMode';
            const TIME_MODE_LS_KEY = 'gpTimeMode';
            const firebaseConfig = {
                apiKey: "AIzaSyBwp4ZNbJuUM5sY0qMffvZTHr2PDvc2iLc",
                authDomain: "kinosreda-ce8ef.firebaseapp.com",
                databaseURL: "https://kinosreda-ce8ef-default-rtdb.europe-west1.firebasedatabase.app",
                projectId: "kinosreda-ce8ef",
                storageBucket: "kinosreda-ce8ef.firebasestorage.app",
                messagingSenderId: "889337905300",
                appId: "1:889337905300:web:325aea2f3fb3c6b44a7481",
                measurementId: "G-MGW6GF67H3"
            };

            const BRISTOL = {
                1: { title: '–û—Ç–¥–µ–ª—å–Ω—ã–µ —Ç–≤—ë—Ä–¥—ã–µ –∫–æ–º–æ—á–∫–∏', slug: '–∫–æ–º–æ—á–∫–∏', icon: bristolIcon('1') },
                2: { title: '–ö–æ–º–∫–æ–≤–∞—Ç–∞—è –∫–æ–ª–±–∞—Å–∫–∞', slug: '–∫–æ–º–∫–æ–≤–∞—Ç–∞—è –∫–æ–ª–±–∞—Å–∫–∞', icon: bristolIcon('2') },
                3: { title: '–ö–æ–ª–±–∞—Å–∫–∞ —Å —Ç—Ä–µ—â–∏–Ω–∞–º–∏', slug: '—Ç—Ä–µ—â–∏–Ω—ã –Ω–∞ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏', icon: bristolIcon('3') },
                4: { title: '–ì–ª–∞–¥–∫–∞—è –∫–æ–ª–±–∞—Å–∫–∞', slug: '–≥–ª–∞–¥–∫–∞—è –∫–æ–ª–±–∞—Å–∫–∞', icon: bristolIcon('4') },
                5: { title: '–ú—è–≥–∫–∏–µ –∫–æ–º–∫–∏', slug: '–º—è–≥–∫–∏–µ –∫–æ–º–∫–∏', icon: bristolIcon('5') },
                6: { title: '–ö–∞—à–∏—Ü–µ–æ–±—Ä–∞–∑–Ω—ã–π —Å—Ç—É–ª', slug: '–∫–∞—à–∏—Ü–µ–æ–±—Ä–∞–∑–Ω—ã–π', icon: bristolIcon('6') },
                7: { title: '–í–æ–¥—è–Ω–∏—Å—Ç—ã–π –±–µ–∑ —Ç–≤—ë—Ä–¥—ã—Ö —á–∞—Å—Ç–∏—Ü', slug: '–≤–æ–¥—è–Ω–∏—Å—Ç—ã–π', icon: bristolIcon('7') }
            };
            const EXPORT_FIELDS = {
                date: { label: '–î–∞—Ç–∞', get: (entry, dateKey) => dateKey },
                time: { label: '–í—Ä–µ–º—è', get: (entry) => entry.time || '' },
                duration: { label: '–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å', get: (entry) => formatDuration(getDurationSeconds(entry)) },
                paper: { label: '–ë—É–º–∞–≥–∞, —à—Ç', get: (entry) => entry.paper ?? '' },
                ease: { label: '–õ—ë–≥–∫–æ—Å—Ç—å', get: (entry) => entry.ease ?? '' },
                satisfaction: { label: '–£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç—å', get: (entry) => entry.satisfaction ?? '' },
                size: { label: '–†–∞–∑–º–µ—Ä', get: (entry) => entry.size ?? '' },
                bristol: {
                    label: '–ë—Ä–∏—Å—Ç–æ–ª—å',
                    get: (entry) => {
                        const meta = BRISTOL[entry.bristol];
                        return meta ? `–¢–∏–ø ${entry.bristol}: ${meta.title}` : (entry.bristol ?? '');
                    }
                },
                comment: { label: '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π', get: (entry) => entry.comment || '' }
            };

            let db = null;
            let useFirebase = false;
            let entries = {};
            let selectedDate = new Date();
            let weekStart = getWeekStart(selectedDate);
            let monthCursor = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1);
            let editingEntry = null;
            let currentUser = null;
            let viewMode = loadViewMode();
            let selectedAuthor = loadSelectedAuthor();
            let anonymityOn = loadAnonMode();
            let timeInputMode = loadTimeInputMode();
            const CHAT_REACTIONS = ['üëç','üòÇ','üòç','üòÆ','üò¢','üî•','ü§Æ','ü§ì','üëä','üòé','üò®','üëÄ','üôè','ü§ù','ü´°','üç∫'];
            const TIME_WHEEL_ITEM_HEIGHT = 48;
            const DURATION_MAX_MINUTES = 180;
            const PAPER_MAX_COUNT = 100;
            const DRAWING_COLORS = ['#3d1f0a','#5d3a1a','#7c4f22','#4a2e15','#8b5a2b','#a8550e','#c2782a','#b56b2d'];
            const DRAWING_TOOLS = {
                pencil: { width: 4, opacity: 1 },
                marker: { width: 12, opacity: 0.75 },
                fill: { width: 1, opacity: 1 },
                eraser: { width: 1, opacity: 1 }
            };
            const ERASER_SIZES = [8, 12, 20, 28];
            let drawingCtx = null;
            let drawingColor = DRAWING_COLORS[0];
            let drawingTool = 'pencil';
            let eraserSize = ERASER_SIZES[1];
            let drawingActive = false;
            let drawingHasContent = false;
            let drawingPos = null;
            let pendingDelete = null;
            let timeValue = '';
            let durationValue = 0;
            let paperValue = 1;
            let sizeValue = null;
            let sizeHover = 0;
            let easeValue = null;
            let easeHover = 0;
            let satisfactionValue = null;
            let satisfactionHover = 0;
            const GAME_EMOJI = {
                hand: 'ü´¥',
                paper: 'üßª',
                poop: 'üí©'
            };
            const gameState = {
                running: false,
                paused: true,
                over: false,
                win: false,
                score: 0,
                lives: 3,
                width: 0,
                height: 0,
                ball: { x: 0, y: 0, r: 12, vx: 0, vy: 0, speed: 5 },
                paddle: { x: 0, y: 0, width: 140, height: 24, speed: 8 },
                bricks: [],
                rows: 6,
                cols: 12,
                animationId: null,
                lastTime: 0,
                message: '–ù–∞–∂–º–∏ ¬´–°—Ç–∞—Ä—Ç¬ª'
            };
            let leftPressed = false;
            let rightPressed = false;
            let gameCtx = null;

            try {
                currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            } catch (_) {
                currentUser = null;
            }

            function pad(n){ return String(n).padStart(2,'0'); }
            function getWeekStart(date){
                const d = new Date(date);
                const day = (d.getDay() + 6) % 7; // Monday = 0
                d.setHours(0,0,0,0);
                d.setDate(d.getDate() - day);
                return d;
            }
            function formatDateKey(date){
                return `${date.getFullYear()}-${pad(date.getMonth()+1)}-${pad(date.getDate())}`;
            }
            function formatHumanDate(date){
                return date.toLocaleDateString('ru-RU', { weekday: 'long', day: 'numeric', month: 'long' });
            }
            function escapeHtml(str) {
                return String(str || '')
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;');
            }
            function isDrawingData(value){
                return typeof value === 'string' && value.startsWith('data:image/');
            }
            function updateModalVh(){
                const vv = window.visualViewport;
                const h = vv ? vv.height : window.innerHeight;
                const offset = vv ? vv.offsetTop : 0;
                document.documentElement.style.setProperty('--modal-vh', `${h}px`);
                document.documentElement.style.setProperty('--modal-offset', `${offset}px`);
            }
            function roundRectPath(ctx, x, y, w, h, r){
                const radius = Math.min(r, w / 2, h / 2);
                if (ctx.roundRect) {
                    ctx.roundRect(x, y, w, h, radius);
                    return;
                }
                ctx.moveTo(x + radius, y);
                ctx.lineTo(x + w - radius, y);
                ctx.quadraticCurveTo(x + w, y, x + w, y + radius);
                ctx.lineTo(x + w, y + h - radius);
                ctx.quadraticCurveTo(x + w, y + h, x + w - radius, y + h);
                ctx.lineTo(x + radius, y + h);
                ctx.quadraticCurveTo(x, y + h, x, y + h - radius);
                ctx.lineTo(x, y + radius);
                ctx.quadraticCurveTo(x, y, x + radius, y);
            }
            function setupGameCanvas(){
                if (!gameCanvas) return;
                const rect = gameCanvas.getBoundingClientRect();
                const ratio = window.devicePixelRatio || 1;
                const maxWidth = Math.max(240, Math.round(window.innerWidth - 48));
                const baseWidth = rect.width > 0 ? rect.width : maxWidth;
                const width = Math.max(240, Math.min(maxWidth, Math.round(baseWidth)));
                const height = Math.min(560, Math.max(320, Math.round(width * 0.7)));
                gameCanvas.width = Math.round(width * ratio);
                gameCanvas.height = Math.round(height * ratio);
                gameCanvas.style.width = '100%';
                gameCanvas.style.height = `${height}px`;
                gameCtx = gameCanvas.getContext('2d');
                if (gameCtx) gameCtx.setTransform(ratio, 0, 0, ratio, 0, 0);
                gameState.width = width;
                gameState.height = height;
                resetGame(true);
            }
            function resetGame(full){
                if (gameState.animationId) {
                    cancelAnimationFrame(gameState.animationId);
                    gameState.animationId = null;
                }
                if (full) {
                    gameState.score = 0;
                    gameState.lives = 3;
                    gameState.over = false;
                    gameState.win = false;
                    gameState.bricks = buildBricks();
                }
                resetRound();
                gameState.paused = true;
                gameState.running = false;
                gameState.message = '–ù–∞–∂–º–∏ ¬´–°—Ç–∞—Ä—Ç¬ª';
                updateGameButton();
                updateGameHud();
                drawGame();
            }
            function updateGameHud(){
                if (gameScoreLabel) gameScoreLabel.textContent = String(gameState.score);
                if (gameLivesLabel) gameLivesLabel.textContent = String(gameState.lives);
            }
            function resetRound(){
                const width = gameState.width;
                const speedFactor = width < 420 ? 0.65 : 1;
                const base = Math.max(3.2, (width / 200) * speedFactor);
                gameState.ball.r = Math.max(11, Math.min(16, Math.round(gameState.width / 60)));
                gameState.ball.speed = base;
                gameState.ball.x = gameState.width / 2;
                gameState.ball.y = gameState.height - 80;
                gameState.ball.vx = base * (Math.random() > 0.5 ? 1 : -1);
                gameState.ball.vy = -base * 1.2;
                const isMobile = gameState.width < 640;
                const handScale = isMobile ? 0.16 : 0.12;
                const handSize = Math.max(isMobile ? 52 : 44, Math.round(gameState.width * handScale));
                gameState.paddle.width = handSize;
                gameState.paddle.height = handSize;
                gameState.paddle.x = (gameState.width - gameState.paddle.width) / 2;
                gameState.paddle.y = gameState.height - handSize;
                gameState.paddle.speed = Math.max(6, gameState.width / 110);
            }
            function buildBricks(){
                const list = [];
                const padding = Math.max(8, Math.round(gameState.width * 0.015));
                const offsetTop = 18;
                const brickW = (gameState.width - padding * (gameState.cols + 1)) / gameState.cols;
                const maxArea = gameState.height * 0.5 - offsetTop;
                const idealH = Math.round(gameState.height * 0.065);
                const brickH = Math.max(18, Math.min(idealH, (maxArea - padding * (gameState.rows - 1)) / gameState.rows));
                for (let r = 0; r < gameState.rows; r++) {
                    for (let c = 0; c < gameState.cols; c++) {
                        list.push({
                            x: padding + c * (brickW + padding),
                            y: offsetTop + r * (brickH + padding),
                            w: brickW,
                            h: brickH,
                            alive: true
                        });
                    }
                }
                return list;
            }
            function updateGameButton(){
                if (!gameStartBtn) return;
                if (gameState.over || gameState.win) {
                    gameStartBtn.textContent = '–°–Ω–æ–≤–∞';
                    return;
                }
                gameStartBtn.textContent = gameState.paused ? '–°—Ç–∞—Ä—Ç' : '–ü–∞—É–∑–∞';
            }
            function setGameMessage(msg){
                gameState.message = msg || '';
            }
            function openGameModal(){
                if (!gameModal) return;
                gameModal.classList.remove('hidden');
                gameModal.classList.add('flex');
                document.body.classList.add('modal-open');
                updateModalVh();
                setupGameCanvas();
            }
            function closeGameModal(){
                if (!gameModal) return;
                gameModal.classList.add('hidden');
                gameModal.classList.remove('flex');
                document.body.classList.remove('modal-open');
                leftPressed = false;
                rightPressed = false;
                stopGameLoop();
            }
            function stopGameLoop(){
                if (gameState.animationId) {
                    cancelAnimationFrame(gameState.animationId);
                    gameState.animationId = null;
                }
                gameState.running = false;
                gameState.paused = true;
                updateGameButton();
            }
            function toggleGame(){
                if (gameState.over || gameState.win) {
                    resetGame(true);
                    startGame();
                    return;
                }
                if (gameState.paused) {
                    startGame();
                } else {
                    pauseGame();
                }
            }
            function startGame(){
                gameState.running = true;
                gameState.paused = false;
                setGameMessage('');
                updateGameButton();
                if (!gameState.animationId) {
                    gameState.lastTime = 0;
                    gameState.animationId = requestAnimationFrame(gameLoop);
                }
            }
            function pauseGame(){
                gameState.paused = true;
                if (!gameState.over && !gameState.win) setGameMessage('–ü–∞—É–∑–∞');
                updateGameButton();
            }
            function gameLoop(ts){
                if (!gameState.running) return;
                if (!gameState.lastTime) gameState.lastTime = ts;
                const delta = Math.min((ts - gameState.lastTime) / 16.67, 2);
                gameState.lastTime = ts;
                if (!gameState.paused && !gameState.over && !gameState.win) {
                    updateGame(delta);
                }
                drawGame();
                gameState.animationId = requestAnimationFrame(gameLoop);
            }
            function updateGame(step){
                const ball = gameState.ball;
                const paddle = gameState.paddle;
                if (leftPressed) paddle.x -= paddle.speed * step;
                if (rightPressed) paddle.x += paddle.speed * step;
                paddle.x = Math.max(0, Math.min(gameState.width - paddle.width, paddle.x));

                ball.x += ball.vx * step;
                ball.y += ball.vy * step;

                if (ball.x - ball.r <= 0) {
                    ball.x = ball.r;
                    ball.vx = Math.abs(ball.vx);
                } else if (ball.x + ball.r >= gameState.width) {
                    ball.x = gameState.width - ball.r;
                    ball.vx = -Math.abs(ball.vx);
                }
                if (ball.y - ball.r <= 0) {
                    ball.y = ball.r;
                    ball.vy = Math.abs(ball.vy);
                }

                if (ball.y + ball.r >= gameState.height) {
                    gameState.lives -= 1;
                    if (gameState.lives <= 0) {
                        gameState.over = true;
                        setGameMessage('–†—É–∫–∞ –≤ –≥–æ–≤–Ω–µ\n–ü–∏–∑–¥—É–π –ø–æ–¥ —Å—Ç—Ä—É—é');
                        pauseGame();
                    } else {
                        resetRound();
                        pauseGame();
                        setGameMessage('–ñ–∏–∑–Ω—å –ø–æ—Ç–µ—Ä—è–Ω–∞');
                    }
                    updateGameHud();
                    return;
                }

                const hitSize = paddle.height * 0.72;
                const hitX = paddle.x + (paddle.width - hitSize) / 2;
                const hitY = paddle.y + paddle.height - hitSize;
                if (ball.y + ball.r >= hitY && ball.y - ball.r <= hitY + hitSize &&
                    ball.x >= hitX && ball.x <= hitX + hitSize && ball.vy > 0) {
                    const hit = (ball.x - (hitX + hitSize / 2)) / (hitSize / 2);
                    const speed = ball.speed * 1.35;
                    ball.vx = speed * hit;
                    ball.vy = -Math.abs(speed * (1 - Math.abs(hit) * 0.35));
                    ball.y = hitY - ball.r - 1;
                }

                for (let i = 0; i < gameState.bricks.length; i++) {
                    const b = gameState.bricks[i];
                    if (!b.alive) continue;
                    if (ball.x + ball.r > b.x && ball.x - ball.r < b.x + b.w &&
                        ball.y + ball.r > b.y && ball.y - ball.r < b.y + b.h) {
                        b.alive = false;
                        gameState.score += 10;
                        updateGameHud();
                        ball.vy = -ball.vy;
                        break;
                    }
                }

                const remaining = gameState.bricks.filter(b => b.alive).length;
                if (!remaining) {
                    gameState.win = true;
                    setGameMessage('–ü–æ–∫–∞–∫ —É—Å–ø–µ—à–µ–Ω');
                    pauseGame();
                }
            }
            function drawGame(){
                if (!gameCtx) return;
                gameCtx.clearRect(0, 0, gameState.width, gameState.height);
                gameCtx.fillStyle = 'rgba(0,0,0,1)';
                gameCtx.fillRect(0, 0, gameState.width, gameState.height);

                const brickFont = Math.max(18, Math.round(gameState.height * 0.055));
                gameCtx.textAlign = 'center';
                gameCtx.textBaseline = 'middle';
                gameCtx.font = `${brickFont}px "Comfortaa", "Apple Color Emoji", "Segoe UI Emoji", sans-serif`;
                gameState.bricks.forEach((b) => {
                    if (!b.alive) return;
                    gameCtx.fillText(GAME_EMOJI.poop, b.x + b.w / 2, b.y + b.h / 2 + 1);
                });

                const paddle = gameState.paddle;
                const handSize = paddle.height;
                gameCtx.font = `${handSize}px "Comfortaa", "Apple Color Emoji", "Segoe UI Emoji", sans-serif`;
                gameCtx.fillText(GAME_EMOJI.hand, paddle.x + paddle.width / 2, paddle.y + paddle.height / 2 + 2);

                const ball = gameState.ball;
                const ballSize = Math.max(22, Math.round(ball.r * 2.2));
                gameCtx.font = `${ballSize}px "Comfortaa", "Apple Color Emoji", "Segoe UI Emoji", sans-serif`;
                gameCtx.fillText(GAME_EMOJI.paper, ball.x, ball.y);

                if (gameState.message) {
                    const lines = String(gameState.message).split('\n');
                    const lineHeight = 26;
                    const blockHeight = lineHeight * lines.length + 22;
                    const top = gameState.height / 2 - blockHeight / 2;
                    gameCtx.fillStyle = 'rgba(0,0,0,0.55)';
                    gameCtx.fillRect(0, top, gameState.width, blockHeight);
                    gameCtx.fillStyle = '#fcd34d';
                    gameCtx.textAlign = 'center';
                    gameCtx.textBaseline = 'middle';
                    gameCtx.font = '22px "Comfortaa", sans-serif';
                    lines.forEach((line, idx) => {
                        const y = top + 11 + lineHeight * idx + lineHeight / 2;
                        gameCtx.fillText(line, gameState.width / 2, y);
                    });
                }
            }
            function timeToMinutes(t){
                const parts = String(t || '').split(':').map(Number);
                const h = parts[0] || 0;
                const m = parts[1] || 0;
                const s = parts[2] || 0;
                return h * 60 + m + s / 60;
            }
            function defaultTime(){
                const now = new Date();
                return `${pad(now.getHours())}:${pad(now.getMinutes())}`;
            }
            function parseTimeValue(val){
                const parts = String(val || '').split(':');
                const h = Math.min(23, Math.max(0, Number(parts[0]) || 0));
                const m = Math.min(59, Math.max(0, Number(parts[1]) || 0));
                return { h, m };
            }
            function formatTimeValue(h, m){
                return `${pad(h)}:${pad(m)}`;
            }
            function snapTimeToQuarter(val){
                const parsed = parseTimeValue(val);
                const rounded = Math.round(parsed.m / 15) * 15;
                let h = parsed.h;
                let m = rounded;
                if (m === 60) {
                    m = 0;
                    h = (h + 1) % 24;
                }
                return formatTimeValue(h, m);
            }
            function updateWheelSelection(col, forcedIndex){
                if (!col) return 0;
                const list = col.querySelector('.time-wheel-list');
                const max = Number(list?.dataset.max || 0);
                let index = typeof forcedIndex === 'number' ? forcedIndex : Math.round((list?.scrollTop || 0) / TIME_WHEEL_ITEM_HEIGHT);
                index = Math.max(0, Math.min(max - 1, index));
                if (col._selectedIndex === index) return index;
                if (col._selectedEl) col._selectedEl.classList.remove('is-selected');
                const el = list?.querySelector(`.time-wheel-item[data-value="${index}"]`);
                if (el) {
                    el.classList.add('is-selected');
                    col._selectedEl = el;
                }
                col._selectedIndex = index;
                return index;
            }
            function syncTimeFromWheel(){
                if (!timeWheel) return;
                const hourCol = timeWheel.querySelector('[data-part="hour"]');
                const minuteCol = timeWheel.querySelector('[data-part="minute"]');
                const h = updateWheelSelection(hourCol);
                const m = updateWheelSelection(minuteCol);
                if (timeInput) timeInput.value = formatTimeValue(h, m);
            }
            function buildWheelList(col, count, onPick, formatValue){
                if (!col) return;
                const list = col.querySelector('.time-wheel-list');
                if (!list) return;
                list.innerHTML = '';
                list.dataset.max = String(count);
                col._selectedIndex = null;
                col._selectedEl = null;
                const format = typeof formatValue === 'function' ? formatValue : pad;
                for (let i = 0; i < count; i++) {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'time-wheel-item';
                    btn.dataset.value = String(i);
                    btn.textContent = format(i);
                    btn.addEventListener('click', () => {
                        list.scrollTo({ top: i * TIME_WHEEL_ITEM_HEIGHT, behavior: 'smooth' });
                        updateWheelSelection(col, i);
                        if (onPick) onPick();
                    });
                    list.appendChild(btn);
                }
            }
            function buildTimeSelectOptions(){
                if (!timeSelect) return;
                timeSelect.innerHTML = '';
                for (let h = 0; h < 24; h++) {
                    for (let m = 0; m < 60; m += 15) {
                        const val = formatTimeValue(h, m);
                        const opt = document.createElement('option');
                        opt.value = val;
                        opt.textContent = val;
                        timeSelect.appendChild(opt);
                    }
                }
                syncCustomSelect(timeSelect);
            }
            function getChevronSvg(){
                return `
                    <svg class="cs-chevron" viewBox="0 0 20 20" fill="none" aria-hidden="true">
                        <path d="M5 7l5 6 5-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                `.trim();
            }
            function closeAllCustomSelects(exceptEl){
                document.querySelectorAll('.cs.open').forEach((cs) => {
                    if (exceptEl && cs === exceptEl) return;
                    cs.classList.remove('open');
                });
            }
            function syncCustomSelect(selectEl){
                if (!selectEl) return;
                const cs = selectEl.closest('.cs');
                if (!cs) return;
                const label = cs.querySelector('.cs-label');
                const menu = cs.querySelector('.cs-menu');
                const selected = selectEl.options[selectEl.selectedIndex];
                if (label) label.textContent = (selected ? selected.textContent : '').trim();
                if (menu) {
                    const val = String(selectEl.value);
                    menu.querySelectorAll('.cs-opt').forEach((btn) => {
                        btn.setAttribute('aria-selected', String(btn.dataset.value) === val ? 'true' : 'false');
                    });
                }
            }
            function scrollCustomSelectToValue(selectEl){
                if (!selectEl) return;
                const cs = selectEl.closest('.cs');
                if (!cs) return;
                const menu = cs.querySelector('.cs-menu');
                if (!menu) return;
                const val = String(selectEl.value || '');
                const target = menu.querySelector(`.cs-opt[data-value="${CSS.escape(val)}"]`);
                if (!target) return;
                const top = target.offsetTop - (menu.clientHeight / 2) + (target.offsetHeight / 2);
                menu.scrollTop = Math.max(0, top);
            }
            function makeCustomSelect(selectEl){
                if (!selectEl) return;
                if (selectEl.closest('.cs')) {
                    syncCustomSelect(selectEl);
                    return;
                }
                const cs = document.createElement('div');
                cs.className = 'cs';
                selectEl.parentNode.insertBefore(cs, selectEl);
                cs.appendChild(selectEl);

                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'cs-btn';
                btn.setAttribute('aria-haspopup', 'listbox');
                btn.innerHTML = `
                    <span class="cs-label"></span>
                    ${getChevronSvg()}
                `;
                cs.appendChild(btn);

                const menu = document.createElement('div');
                menu.className = 'cs-menu';
                menu.setAttribute('role', 'listbox');
                Array.from(selectEl.options).forEach((opt) => {
                    const item = document.createElement('button');
                    item.type = 'button';
                    item.className = 'cs-opt';
                    item.dataset.value = opt.value;
                    item.setAttribute('role', 'option');
                    item.textContent = opt.textContent;
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        selectEl.value = opt.value;
                        selectEl.dispatchEvent(new Event('change', { bubbles: true }));
                        syncCustomSelect(selectEl);
                        cs.classList.remove('open');
                    });
                    menu.appendChild(item);
                });
                cs.appendChild(menu);

                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const willOpen = !cs.classList.contains('open');
                    closeAllCustomSelects(cs);
                    cs.classList.toggle('open', willOpen);
                    syncCustomSelect(selectEl);
                    if (willOpen) {
                        scrollCustomSelectToValue(selectEl);
                    }
                });
                selectEl.addEventListener('change', () => syncCustomSelect(selectEl));
                syncCustomSelect(selectEl);
            }
            function buildTimeWheel(){
                if (!timeWheel) return;
                const hourCol = timeWheel.querySelector('[data-part="hour"]');
                const minuteCol = timeWheel.querySelector('[data-part="minute"]');
                buildWheelList(hourCol, 24, syncTimeFromWheel, pad);
                buildWheelList(minuteCol, 60, syncTimeFromWheel, pad);
            }
            function ensureTimeWheelReady(){
                if (!timeWheel) return;
                const hourList = timeWheel.querySelector('[data-part="hour"] .time-wheel-list');
                const minuteList = timeWheel.querySelector('[data-part="minute"] .time-wheel-list');
                if (!hourList || !minuteList || !hourList.children.length || !minuteList.children.length) {
                    buildTimeWheel();
                }
            }
            function setTime(val){
                ensureTimeWheelReady();
                const parsed = parseTimeValue(val);
                const formatted = formatTimeValue(parsed.h, parsed.m);
                if (timeWheel) {
                    const hourCol = timeWheel.querySelector('[data-part="hour"]');
                    const minuteCol = timeWheel.querySelector('[data-part="minute"]');
                    const hourList = hourCol?.querySelector('.time-wheel-list');
                    const minuteList = minuteCol?.querySelector('.time-wheel-list');
                    if (hourList) hourList.scrollTop = parsed.h * TIME_WHEEL_ITEM_HEIGHT;
                    if (minuteList) minuteList.scrollTop = parsed.m * TIME_WHEEL_ITEM_HEIGHT;
                    updateWheelSelection(hourCol, parsed.h);
                    updateWheelSelection(minuteCol, parsed.m);
                }
                timeValue = formatted;
                if (timeInput) timeInput.value = formatted;
                if (timeSelect) {
                    timeSelect.value = formatted;
                    syncCustomSelect(timeSelect);
                }
            }
            function setTimeInputMode(mode){
                timeInputMode = mode === 'list' ? 'list' : 'wheel';
                if (timeModeToggle) {
                    timeModeToggle.classList.toggle('toggle-on', timeInputMode === 'list');
                }
                if (timeModeLabel) {
                    timeModeLabel.textContent = timeInputMode === 'list' ? '–°–ø–∏—Å–æ–∫' : '–ö–æ–ª–µ—Å–æ';
                }
                if (timeWheelWrap) {
                    timeWheelWrap.classList.toggle('hidden', timeInputMode === 'list');
                }
                if (timeSelectWrap) {
                    timeSelectWrap.classList.toggle('hidden', timeInputMode !== 'list');
                }
                const current = (timeInput && timeInput.value) ? timeInput.value : (timeValue || defaultTime());
                const next = timeInputMode === 'list' ? snapTimeToQuarter(current) : current;
                setTime(next);
                saveTimeInputMode(timeInputMode);
            }
            function syncDurationFromWheel(){
                if (!durationWheel) return;
                const minuteCol = durationWheel.querySelector('[data-part="minute"]');
                const secondCol = durationWheel.querySelector('[data-part="second"]');
                const m = updateWheelSelection(minuteCol);
                const s = updateWheelSelection(secondCol);
                const total = m * 60 + s;
                if (durationSecondsInput) durationSecondsInput.value = String(total);
                if (durationInput) durationInput.value = String(m);
            }
            function buildDurationWheel(){
                if (!durationWheel) return;
                const minuteCol = durationWheel.querySelector('[data-part="minute"]');
                const secondCol = durationWheel.querySelector('[data-part="second"]');
                buildWheelList(minuteCol, DURATION_MAX_MINUTES + 1, syncDurationFromWheel, pad);
                buildWheelList(secondCol, 60, syncDurationFromWheel, pad);
            }
            function ensureDurationWheelReady(){
                if (!durationWheel) return;
                const minuteList = durationWheel.querySelector('[data-part="minute"] .time-wheel-list');
                const secondList = durationWheel.querySelector('[data-part="second"] .time-wheel-list');
                if (!minuteList || !secondList || !minuteList.children.length || !secondList.children.length) {
                    buildDurationWheel();
                }
            }
            function setDurationSeconds(totalSeconds){
                ensureDurationWheelReady();
                const safeSeconds = Math.max(0, Math.min(DURATION_MAX_MINUTES * 60 + 59, Number(totalSeconds) || 0));
                const m = Math.floor(safeSeconds / 60);
                const s = safeSeconds % 60;
                if (durationWheel) {
                    const minuteCol = durationWheel.querySelector('[data-part="minute"]');
                    const secondCol = durationWheel.querySelector('[data-part="second"]');
                    const minuteList = minuteCol?.querySelector('.time-wheel-list');
                    const secondList = secondCol?.querySelector('.time-wheel-list');
                    if (minuteList) minuteList.scrollTop = m * TIME_WHEEL_ITEM_HEIGHT;
                    if (secondList) secondList.scrollTop = s * TIME_WHEEL_ITEM_HEIGHT;
                    updateWheelSelection(minuteCol, m);
                    updateWheelSelection(secondCol, s);
                }
                durationValue = safeSeconds;
                if (durationSecondsInput) durationSecondsInput.value = String(safeSeconds);
                if (durationInput) durationInput.value = String(m);
            }
            function getDurationSeconds(entry){
                const rawSeconds = Number(entry?.durationSeconds);
                if (Number.isFinite(rawSeconds) && rawSeconds >= 0) return rawSeconds;
                const rawMinutes = Number(entry?.duration);
                if (Number.isFinite(rawMinutes) && rawMinutes >= 0) return Math.round(rawMinutes * 60);
                return 0;
            }
            function formatDuration(seconds){
                const total = Math.max(0, Number(seconds) || 0);
                const m = Math.floor(total / 60);
                const s = total % 60;
                return `${m}:${pad(s)}`;
            }
            function isSmallScreen(){
                return window.matchMedia && window.matchMedia('(max-width: 520px)').matches;
            }
            function safeFocus(el, options){
                if (!el || isSmallScreen()) return;
                try {
                    if (options) {
                        el.focus(options);
                    } else {
                        el.focus();
                    }
                } catch (_) {}
            }
            const viewportMeta = document.querySelector('meta[name="viewport"]');
            const viewportDefault = viewportMeta ? viewportMeta.getAttribute('content') || '' : '';
            const viewportNoZoom = 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover';
            function lockViewportScale(){
                if (!viewportMeta) return;
                if (viewportMeta.getAttribute('content') !== viewportNoZoom) {
                    viewportMeta.setAttribute('content', viewportNoZoom);
                }
            }
            function resetViewportScale(){
                if (!viewportMeta || !viewportDefault) return;
                if (isSmallScreen()) return;
                if (viewportMeta.getAttribute('content') !== viewportDefault) {
                    viewportMeta.setAttribute('content', viewportDefault);
                }
            }
            function normalizeViewportScale(){
                if (!viewportMeta || !window.visualViewport || !isSmallScreen()) return;
                if (window.visualViewport.scale > 1.01) {
                    lockViewportScale();
                    setTimeout(() => resetViewportScale(), 300);
                }
            }
            function syncPaperFromWheel(){
                if (!paperWheel) return;
                const paperCol = paperWheel.querySelector('[data-part="paper"]');
                const val = updateWheelSelection(paperCol);
                if (paperInput) paperInput.value = String(val);
            }
            function buildPaperWheel(){
                if (!paperWheel) return;
                const paperCol = paperWheel.querySelector('[data-part="paper"]');
                buildWheelList(paperCol, PAPER_MAX_COUNT + 1, syncPaperFromWheel, (n) => String(n));
            }
            function ensurePaperWheelReady(){
                if (!paperWheel) return;
                const paperList = paperWheel.querySelector('[data-part="paper"] .time-wheel-list');
                if (!paperList || !paperList.children.length) {
                    buildPaperWheel();
                }
            }
            function setPaperValue(val){
                ensurePaperWheelReady();
                const num = Number(val);
                const safe = Number.isFinite(num) ? Math.max(0, Math.min(PAPER_MAX_COUNT, Math.round(num))) : 1;
                if (paperWheel) {
                    const paperCol = paperWheel.querySelector('[data-part="paper"]');
                    const paperList = paperCol?.querySelector('.time-wheel-list');
                    if (paperList) paperList.scrollTop = safe * TIME_WHEEL_ITEM_HEIGHT;
                    updateWheelSelection(paperCol, safe);
                }
                paperValue = safe;
                if (paperInput) paperInput.value = String(safe);
            }
            function setSizeValue(val){
                const num = Number(val);
                sizeValue = Number.isFinite(num) && num > 0 ? num : null;
                if (sizeScale && sizeValue) {
                    const input = sizeScale.querySelector(`input[name="size"][value="${sizeValue}"]`);
                    if (input) input.checked = true;
                }
                renderSizeScale();
            }
            function renderSizeScale(){
                if (!sizeScale) return;
                sizeScale.querySelectorAll('[data-size]').forEach((seg) => {
                    const val = Number(seg.dataset.size);
                    seg.classList.toggle('is-active', sizeValue && val <= sizeValue);
                    seg.classList.toggle('is-hover', sizeHover && val <= sizeHover);
                });
                if (sizeValueLabel) sizeValueLabel.textContent = sizeValue ? String(sizeValue) : '‚Äî';
            }
            function renderEmojiScale(scaleEl, value, hover){
                if (!scaleEl) return;
                scaleEl.querySelectorAll('[data-scale-value]').forEach((seg) => {
                    const val = Number(seg.dataset.scaleValue);
                    seg.classList.toggle('is-active', value && val <= value);
                    seg.classList.toggle('is-hover', hover && val <= hover);
                });
            }
            function setEaseValue(val){
                const num = Number(val);
                easeValue = Number.isFinite(num) && num > 0 ? num : null;
                if (easeScale && easeValue) {
                    const input = easeScale.querySelector(`input[name="ease"][value="${easeValue}"]`);
                    if (input) input.checked = true;
                }
                renderEmojiScale(easeScale, easeValue, easeHover);
                if (easeValueLabel) easeValueLabel.textContent = easeValue ? String(easeValue) : '‚Äî';
            }
            function setSatisfactionValue(val){
                const num = Number(val);
                satisfactionValue = Number.isFinite(num) && num > 0 ? num : null;
                if (satisfactionScale && satisfactionValue) {
                    const input = satisfactionScale.querySelector(`input[name="satisfaction"][value="${satisfactionValue}"]`);
                    if (input) input.checked = true;
                }
                renderEmojiScale(satisfactionScale, satisfactionValue, satisfactionHover);
                if (satisfactionValueLabel) satisfactionValueLabel.textContent = satisfactionValue ? String(satisfactionValue) : '‚Äî';
            }
            function setExportStatus(message, isError){
                if (!exportStatus) return;
                exportStatus.textContent = message || '';
                exportStatus.classList.toggle('text-red-400', !!isError);
                exportStatus.classList.toggle('text-gray-400', !isError);
            }
            function openExportModal(){
                if (!exportModal) return;
                exportModal.classList.remove('hidden');
                exportModal.classList.add('flex');
                document.body.classList.add('modal-open');
                if (exportFrom && exportTo && currentUser && currentUser.username) {
                    const rows = collectExportRows('', '');
                    if (rows.length) {
                        const firstDate = rows[0].dateKey;
                        const lastDate = rows[rows.length - 1].dateKey;
                        exportFrom.value = firstDate;
                        exportTo.value = lastDate;
                    } else {
                        exportFrom.value = '';
                        exportTo.value = '';
                    }
                }
                setExportStatus('');
                updateModalVh();
            }
            function closeExportModal(){
                if (!exportModal) return;
                exportModal.classList.add('hidden');
                exportModal.classList.remove('flex');
                document.body.classList.remove('modal-open');
                setExportStatus('');
            }
            function csvEscape(val){
                const str = val == null ? '' : String(val);
                return /[",\n]/.test(str) ? `"${str.replace(/"/g, '""')}"` : str;
            }
            function collectExportRows(fromDate, toDate){
                const rows = [];
                if (!entries) return rows;
                Object.entries(entries).forEach(([dateKey, day]) => {
                    if (!day) return;
                    if (fromDate && dateKey < fromDate) return;
                    if (toDate && dateKey > toDate) return;
                    Object.entries(day).forEach(([id, entry]) => {
                        if (id === '__entry') return;
                        if (!entry || !currentUser || entry.author !== currentUser.username) return;
                        rows.push({ dateKey, entry });
                    });
                });
                return rows.sort((a, b) => {
                    const dateCmp = a.dateKey.localeCompare(b.dateKey);
                    if (dateCmp !== 0) return dateCmp;
                    return timeToMinutes(a.entry.time || '00:00') - timeToMinutes(b.entry.time || '00:00');
                });
            }
            function buildExportCsv(selectedKeys, rows){
                const fields = selectedKeys.map((key) => EXPORT_FIELDS[key]).filter(Boolean);
                const header = fields.map((field) => csvEscape(field.label)).join(',');
                const lines = rows.map((row) => fields
                    .map((field) => csvEscape(field.get(row.entry, row.dateKey)))
                    .join(','));
                return [header, ...lines].join('\n');
            }
            function downloadCsvFile(csv, filename){
                const blob = new Blob([`\uFEFF${csv}`], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                link.remove();
                setTimeout(() => URL.revokeObjectURL(url), 500);
            }
            function toggleAuthorDropdown(){
                const isOpen = !authorDropdown.classList.contains('hidden');
                if (isOpen) {
                    closeAuthorDropdown();
                } else {
                    authorDropdown.classList.remove('hidden');
                }
            }
            function closeAuthorDropdown(){
                authorDropdown.classList.add('hidden');
            }

            function bristolIcon(type){
                const base = 'stroke="rgba(245,158,11,0.7)" fill="rgba(245,158,11,0.35)" stroke-width="1.5"';
                switch (type) {
                    case '1': return `<svg class="bristol-icon" viewBox="0 0 48 28"><circle cx="12" cy="16" r="6" ${base}/><circle cx="23" cy="12" r="5.5" ${base}/><circle cx="32" cy="17" r="5.5" ${base}/></svg>`;
                    case '2': return `<svg class="bristol-icon" viewBox="0 0 48 28"><rect x="10" y="9" width="28" height="12" rx="6" ${base}/><path d="M16 11c2 2 0 5 3 6" ${base}/><path d="M30 12c-1 2 2 4 0 6" ${base}/></svg>`;
                    case '3': return `<svg class="bristol-icon" viewBox="0 0 48 28"><rect x="8" y="9" width="32" height="12" rx="6" ${base}/><path d="M16 11l3 5M26 10l-2 7M34 12l-1 6" ${base}/></svg>`;
                    case '4': return `<svg class="bristol-icon" viewBox="0 0 48 28"><rect x="8" y="8" width="32" height="12" rx="6" ${base.replace('0.35','0.45')}/></svg>`;
                    case '5': return `<svg class="bristol-icon" viewBox="0 0 48 28"><circle cx="15" cy="14" r="6" ${base}/><circle cx="25" cy="12" r="5" ${base}/><circle cx="32" cy="15" r="5.5" ${base}/></svg>`;
                    case '6': return `<svg class="bristol-icon" viewBox="0 0 48 28"><circle cx="8" cy="16" r="3" ${base}/><circle cx="14" cy="12" r="2.5" ${base}/><circle cx="20" cy="16" r="3" ${base}/><circle cx="26" cy="11" r="2.5" ${base}/><circle cx="30" cy="16" r="3" ${base}/><circle cx="36" cy="12" r="2.5" ${base}/><circle cx="40" cy="17" r="2.5" ${base}/><circle cx="23" cy="20" r="2.5" ${base}/></svg>`;
                    case '7': return `<svg class="bristol-icon" viewBox="0 0 48 28"><path d="M8 15c4-5 10 1 14-1s7-5 12-2 6 7 1 8-9-4-14-2-10 4-13-3z" ${base.replace('0.35','0.25')}/></svg>`;
                    default: return '';
                }
        }

        function renderBristolOptions(){
            bristolOptions.innerHTML = '';
            Object.entries(BRISTOL).forEach(([value, meta]) => {
                    const label = document.createElement('label');
                    label.className = 'relative block';
                    label.innerHTML = `
                        <input class="peer sr-only" type="radio" name="bristol" value="${value}" required>
                        <div class="flex items-center gap-3 px-4 py-4 rounded-xl border border-amber-500/20 bg-black/60 peer-checked:border-amber-400 peer-checked:bg-amber-500/10 transition min-h-[96px]">
                            <span class="inline-flex items-center justify-center w-14 h-12 rounded-lg bg-amber-500/10 border border-amber-500/25 shrink-0">${meta.icon}</span>
                            <span class="text-[13px] leading-snug text-left text-gray-100 w-full break-words">
                                <span class="font-semibold text-amber-200 block">–¢–∏–ø ${value}</span>
                                <span class="block">${meta.title}</span>
                            </span>
                        </div>
                    `;
                    bristolOptions.appendChild(label);
                });
            }

            function loadSelectedAuthor(){
                try {
                    return localStorage.getItem(AUTHOR_FILTER_LS_KEY) || 'all';
                } catch (_) {
                    return 'all';
                }
            }
            function saveSelectedAuthor(val){
                try {
                    localStorage.setItem(AUTHOR_FILTER_LS_KEY, val);
                } catch (_) {}
            }
            function loadAnonMode(){
                try {
                    return localStorage.getItem(ANON_LS_KEY) === '1';
                } catch (_) { return false; }
            }
            function saveAnonMode(val){
                try { localStorage.setItem(ANON_LS_KEY, val ? '1' : '0'); } catch(_) {}
            }
            function loadViewMode(){
                try { return localStorage.getItem(VIEW_MODE_LS_KEY) === 'month' ? 'month' : 'week'; }
                catch(_) { return 'week'; }
            }
            function saveViewMode(mode){
                try { localStorage.setItem(VIEW_MODE_LS_KEY, mode); } catch(_) {}
            }
            function loadTimeInputMode(){
                try { return localStorage.getItem(TIME_MODE_LS_KEY) === 'list' ? 'list' : 'wheel'; }
                catch(_) { return 'wheel'; }
            }
            function saveTimeInputMode(mode){
                try { localStorage.setItem(TIME_MODE_LS_KEY, mode); } catch(_) {}
            }
            function setAnonUI(){
                if (!anonToggle) return;
                if (anonymityOn) {
                    anonToggle.classList.add('toggle-on');
                } else {
                    anonToggle.classList.remove('toggle-on');
                }
            }
            function submitComment(dateKey, entryId, text){
                if (!db || !text.trim()) return;
                const path = `poopSchedule/${dateKey}/${entryId}/comments`;
                db.ref(path).push({
                    author: currentUser ? currentUser.username : '',
                    authorName: currentUser ? currentUser.name : '–ê–Ω–æ–Ω–∏–º',
                    text: text.trim(),
                    ts: Date.now()
                });
            }
            function renderComments(dateKey, entryId, holder){
                const entry = entries && entries[dateKey] && entries[dateKey][entryId];
                const commentsObj = entry && entry.comments ? entry.comments : {};
                const comments = Object.entries(commentsObj)
                    .filter(([id]) => id !== '__entry')
                    .map(([id, c]) => ({ id, ...c }));
                if (!comments.length) {
                    holder.innerHTML = '<div class="text-xs text-gray-500">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –Ω–µ—Ç</div>';
                    return;
                }
                holder.innerHTML = comments.sort((a,b)=> (a.ts||0) - (b.ts||0)).map(c => `
                    <div class="text-xs bg-black/30 border border-amber-500/10 rounded-lg px-3 py-2 text-gray-200 comment-card">
                        <div class="flex items-center justify-between gap-2">
                            <span class="font-semibold text-amber-200">${escapeHtml(c.authorName || '–ê–Ω–æ–Ω–∏–º')}</span>
                            <span class="text-[10px] text-gray-500">${c.ts ? new Date(c.ts).toLocaleTimeString('ru-RU',{hour:'2-digit', minute:'2-digit'}) : ''}</span>
                        </div>
                        <div class="mt-1">${escapeHtml(c.text || '')}</div>
                        <div class="comment-actions">
                            ${currentUser && c.author === currentUser.username ? `
                                <button type="button" class="px-2 py-1 rounded border border-amber-500/25 text-amber-200 hover:border-amber-500/40 transition" data-action="edit-comment" data-comment-id="${escapeHtml(c.id || '')}">‚úèÔ∏è</button>
                                <button type="button" class="px-2 py-1 rounded border border-red-500/30 text-red-300 hover:border-red-500/50 transition" data-action="delete-comment" data-comment-id="${escapeHtml(c.id || '')}">üóë</button>
                            ` : ''}
                            <button type="button" class="px-2 py-1 rounded border border-amber-500/25 text-amber-200 hover:border-amber-500/40 transition" data-action="open-comment-reactions" aria-label="–†–µ–∞–∫—Ü–∏–∏" data-comment-id="${escapeHtml(c.id || '')}">üòä</button>
                            <div class="reaction-menu hidden absolute right-0 top-full mt-1 bg-black/90 border border-amber-500/25 rounded-xl p-2 z-30" data-comment-menu data-comment-id="${escapeHtml(c.id || '')}"></div>
                        </div>
                        <div class="flex flex-wrap gap-1 mt-2" data-comment-reactions data-comment-id="${escapeHtml(c.id || '')}"></div>
                    </div>
                `).join('');
            }
            function toggleReaction(dateKey, entryId, emoji){
                if (!db || !currentUser || !emoji) return;
                const path = `poopSchedule/${dateKey}/${entryId}/reactions/${currentUser.username}`;
                const ref = db.ref(path);
                ref.get().then((snap) => {
                    const cur = snap.val();
                    if (cur && cur.emoji === emoji) {
                        ref.remove();
                    } else {
                        ref.set({ emoji, name: currentUser.name, ts: Date.now() });
                    }
                });
            }
            function toggleCommentReaction(dateKey, entryId, commentId, emoji){
                if (!db || !currentUser || !emoji || !commentId) return;
                normalizeCommentReactions(dateKey, entryId, commentId);
                const user = currentUser.username;
                const basePath = `poopSchedule/${dateKey}/${entryId}/comments/${commentId}/reactions/${emoji}/${user}`;
                const ref = db.ref(basePath);
                ref.get().then((snap) => {
                    if (snap.exists()) {
                        ref.remove();
                    } else {
                        ref.set({ name: currentUser.name, ts: Date.now() });
                    }
                });
            }
            function renderReactionSummary(dateKey, entryId, holder){
                const entry = entries && entries[dateKey] && entries[dateKey][entryId];
                const reactions = entry && entry.reactions ? entry.reactions : {};
                const summary = {};
                Object.values(reactions || {}).forEach(r => {
                    if (!r || !r.emoji) return;
                    summary[r.emoji] = (summary[r.emoji] || 0) + 1;
                });
                const chips = Object.entries(summary)
                    .filter(([,v]) => v > 0)
                    .map(([emoji, count]) => `<span class="px-2 py-1 rounded-lg border border-amber-500/25 bg-black/40">${emoji} ${count}</span>`)
                    .join('');
                holder.innerHTML = chips;
            }
            function buildReactionMenu(dateKey, entryId, menu){
                const entry = entries && entries[dateKey] && entries[dateKey][entryId];
                const reactions = entry && entry.reactions ? entry.reactions : {};
                const myEmoji = reactions[currentUser?.username]?.emoji;
                menu.innerHTML = CHAT_REACTIONS.map(e => {
                    const active = myEmoji === e ? 'border-amber-500/60 text-amber-200 bg-amber-500/10' : 'border-amber-500/20 text-gray-200';
                    return `<button type="button" data-emoji="${e}" class="px-2 py-1 rounded-lg border ${active} hover:border-amber-500/40 transition text-xs">${e}</button>`;
                }).join('');
            }
            function buildCommentReactionMenu(dateKey, entryId, commentId, menu){
                normalizeCommentReactions(dateKey, entryId, commentId);
                const comment = entries?.[dateKey]?.[entryId]?.comments?.[commentId];
                const reactions = comment && comment.reactions ? comment.reactions : {};
                const myEmojis = new Set(Object.entries(reactions).filter(([,u]) => u && u[currentUser?.username]).map(([emoji]) => emoji));
                menu.innerHTML = CHAT_REACTIONS.map(e => {
                    const active = myEmojis.has(e) ? 'border-amber-500/60 text-amber-200 bg-amber-500/10' : 'border-amber-500/20 text-gray-200';
                    return `<button type="button" data-emoji="${e}" class="px-2 py-1 rounded-lg border ${active} hover:border-amber-500/40 transition text-xs">${e}</button>`;
                }).join('');
            }
            function renderCommentReactions(dateKey, entryId, commentId, holder){
                normalizeCommentReactions(dateKey, entryId, commentId);
                const comment = entries?.[dateKey]?.[entryId]?.comments?.[commentId];
                const reactions = comment && comment.reactions ? comment.reactions : {};
                const summary = {};
                Object.entries(reactions).forEach(([emoji, users]) => {
                    const count = users ? Object.keys(users).length : 0;
                    if (count > 0) summary[emoji] = count;
                });
                holder.innerHTML = Object.entries(summary)
                    .map(([emoji, count]) => `<span class="px-2 py-1 rounded-lg border border-amber-500/25 bg-black/40">${emoji} ${count}</span>`)
                    .join('');
            }
            function closeAllReactionMenus(){
                document.querySelectorAll('[data-reaction-menu]').forEach(m => m.classList.add('hidden'));
            }
            function normalizeCommentReactions(dateKey, entryId, commentId){
                const comment = entries?.[dateKey]?.[entryId]?.comments?.[commentId];
                if (!comment || !comment.reactions) return;
                const legacyKeys = Object.keys(comment.reactions).filter(k => !CHAT_REACTIONS.includes(k));
                if (!legacyKeys.length) return;
                legacyKeys.forEach((userKey) => {
                    const data = comment.reactions[userKey];
                    if (!data || !data.emoji) return;
                    const newPath = `poopSchedule/${dateKey}/${entryId}/comments/${commentId}/reactions/${data.emoji}/${userKey}`;
                    db.ref(newPath).set({ name: data.name || '', ts: data.ts || Date.now() });
                    db.ref(`poopSchedule/${dateKey}/${entryId}/comments/${commentId}/reactions/${userKey}`).remove();
                });
            }
            function attachCommentReactions(dateKey, entryId, holder){
                holder.querySelectorAll('[data-comment-reactions]').forEach(div => {
                    const id = div.dataset.commentId;
                    renderCommentReactions(dateKey, entryId, id, div);
                });
                holder.querySelectorAll('[data-comment-menu]').forEach(menu => {
                    const id = menu.dataset.commentId;
                    buildCommentReactionMenu(dateKey, entryId, id, menu);
                });
                holder.querySelectorAll('[data-action="open-comment-reactions"]').forEach(btn => {
                    const id = btn.dataset.commentId;
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        document.querySelectorAll('[data-comment-menu]').forEach(m => {
                            if (m.dataset.commentId !== id) m.classList.add('hidden');
                        });
                        const menu = holder.querySelector(`[data-comment-menu][data-comment-id="${id}"]`);
                        if (menu) menu.classList.toggle('hidden');
                    });
                });
                holder.querySelectorAll('[data-comment-menu]').forEach(menu => {
                    menu.addEventListener('click', (e) => {
                        const btn = e.target.closest('[data-emoji]');
                        if (!btn) return;
                        const commentId = menu.dataset.commentId;
                        toggleCommentReaction(dateKey, entryId, commentId, btn.dataset.emoji);
                        menu.classList.add('hidden');
                    });
                });
                holder.querySelectorAll('[data-action="edit-comment"]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const commentId = btn.dataset.commentId;
                        const comment = entries?.[dateKey]?.[entryId]?.comments?.[commentId] || null;
                        if (!comment || !currentUser || comment.author !== currentUser.username) return;
                        const card = btn.closest('.comment-card');
                        if (!card || card.dataset.editing === '1') return;
                        card.dataset.editing = '1';
                        card.classList.add('comment-editing');
                        // inline edit
                        const textDiv = card.querySelector('.mt-1');
                        const actions = card.querySelector('.comment-actions');
                        const oldText = comment.text || '';
                        const editor = document.createElement('div');
                        editor.className = 'mt-2 flex flex-col gap-2';
                        editor.setAttribute('data-editor', '1');
                        editor.innerHTML = `
                            <textarea class="flex-1 max-w-[520px] px-3 py-2 rounded-lg bg-black/50 border border-amber-500/20 text-sm text-amber-100 focus:border-amber-500/50 focus:outline-none resize-none min-h-[88px]" rows="3">${escapeHtml(oldText)}</textarea>
                            <div class="text-xs text-red-400 hidden" data-edit-error>–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∏–º–≤–æ–ª–æ–≤ - 1</div>
                            <div class="flex gap-2">
                                <button type="button" class="px-3 py-2 rounded-lg bg-amber-500/20 border border-amber-500/40 text-amber-100 hover:bg-amber-500/30 transition text-sm" data-action="save-edit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                                <button type="button" class="px-3 py-2 rounded-lg border border-amber-500/25 text-gray-300 hover:border-amber-500/40 transition text-sm" data-action="cancel-edit">–û—Ç–º–µ–Ω–∞</button>
                            </div>
                        `;
                        if (textDiv) textDiv.classList.add('hidden');
                        if (actions) actions.classList.add('hidden');
                        card.appendChild(editor);
                        const ta = editor.querySelector('textarea');
                        safeFocus(ta);
                        const saveBtn = editor.querySelector('[data-action="save-edit"]');
                        const cancelBtn = editor.querySelector('[data-action="cancel-edit"]');
                        const cleanup = () => {
                            editor.remove();
                            if (textDiv) textDiv.classList.remove('hidden');
                            if (actions) actions.classList.remove('hidden');
                            delete card.dataset.editing;
                            card.classList.remove('comment-editing');
                        };
                        const errorEl = editor.querySelector('[data-edit-error]');
                        if (ta) {
                            const resize = () => {
                                ta.style.height = 'auto';
                                ta.style.height = `${ta.scrollHeight}px`;
                            };
                            ta.addEventListener('input', () => {
                                ta.classList.remove('border-red-500/50');
                                if (errorEl) errorEl.classList.add('hidden');
                                resize();
                            });
                            resize();
                        }
                        if (saveBtn && ta) {
                            saveBtn.addEventListener('click', () => {
                                const val = ta.value.trim();
                                if (!val) {
                                    ta.classList.add('border-red-500/50');
                                    if (errorEl) errorEl.classList.remove('hidden');
                                    safeFocus(ta);
                                    return;
                                }
                                db.ref(`poopSchedule/${dateKey}/${entryId}/comments/${commentId}/text`).set(val);
                                cleanup();
                            });
                        }
                        if (cancelBtn) {
                            cancelBtn.addEventListener('click', (evt) => {
                                evt.preventDefault();
                                cleanup();
                            });
                        }
                    });
                });
                holder.querySelectorAll('[data-action="delete-comment"]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const commentId = btn.dataset.commentId;
                        const comment = entries?.[dateKey]?.[entryId]?.comments?.[commentId] || null;
                        if (!comment || !currentUser || comment.author !== currentUser.username) return;
                        pendingDelete = { dateKey, entryId, commentId };
                        openConfirmModal();
                    });
                });
                holder.querySelectorAll('[data-comment-reactions]').forEach(div => {
                    div.addEventListener('click', (e) => {
                        const chip = e.target.closest('span');
                        if (!chip || !chip.textContent) return;
                        const emoji = chip.textContent.trim().split(' ')[0];
                        const commentId = div.dataset.commentId;
                        toggleCommentReaction(dateKey, entryId, commentId, emoji);
                    });
                });
                // Delegated cancel-edit fallback
                holder.addEventListener('click', (e) => {
                    const cancel = e.target.closest('[data-action="cancel-edit"]');
                    if (!cancel) return;
                    e.preventDefault();
                    const card = cancel.closest('.comment-card');
                    const editor = cancel.closest('[data-editor]');
                    if (editor) editor.remove();
                    if (card) {
                        const textDiv = card.querySelector('.mt-1');
                        const actions = card.querySelector('.comment-actions');
                        if (textDiv) textDiv.classList.remove('hidden');
                        if (actions) actions.classList.remove('hidden');
                        delete card.dataset.editing;
                    }
                });
            }

            // Confirm modal helpers
            function openConfirmModal(){
                const modal = document.getElementById('confirmModal');
                if (modal) modal.classList.remove('hidden');
            }
            function closeConfirmModal(){
                const modal = document.getElementById('confirmModal');
                if (modal) modal.classList.add('hidden');
                pendingDelete = null;
            }

            function renderAuthorFilter(authors){
                const opts = ['all', ...authors];
                if (selectedAuthor && selectedAuthor !== 'all' && !opts.includes(selectedAuthor)) {
                    opts.push(selectedAuthor);
                }
                if (!selectedAuthor) selectedAuthor = 'all';
                authorOptions.innerHTML = '';
                opts.forEach((a) => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    const label = a === 'all' ? '–í—Å–µ' : a;
                    btn.textContent = label;
                    btn.className = `w-full text-left px-4 py-2 hover:bg-amber-500/10 ${selectedAuthor === a ? 'text-amber-300 font-semibold' : 'text-gray-200'}`;
                    btn.addEventListener('click', () => {
                        selectedAuthor = a;
                        saveSelectedAuthor(selectedAuthor);
                        authorFilterLabel.textContent = label;
                        closeAuthorDropdown();
                        renderEntries();
                    });
                    authorOptions.appendChild(btn);
                });
                authorFilterLabel.textContent = selectedAuthor === 'all' ? '–í—Å–µ' : selectedAuthor;
            }

            function initDrawing(){
                if (!drawingCanvas) return;
                drawingCtx = drawingCanvas.getContext('2d');
                drawingCtx.strokeStyle = drawingColor;
                drawingCtx.lineCap = 'round';
                drawingCtx.lineJoin = 'round';
                applyDrawingTool();
                drawingCanvas.style.touchAction = 'none';
                const pointerDown = (e) => {
                    const pos = getCanvasPos(e);
                    if (drawingTool === 'fill') {
                        floodFillAt(Math.floor(pos.x), Math.floor(pos.y));
                        return;
                    }
                    drawingActive = true;
                    drawingHasContent = true;
                    drawingPos = pos;
                    drawingCtx.beginPath();
                    drawingCtx.moveTo(drawingPos.x, drawingPos.y);
                    drawingCanvas.setPointerCapture(e.pointerId);
                };
                const pointerMove = (e) => {
                    if (!drawingActive) return;
                    const pos = getCanvasPos(e);
                    drawingCtx.lineTo(pos.x, pos.y);
                    drawingCtx.strokeStyle = drawingColor;
                    drawingCtx.stroke();
                    drawingPos = pos;
                };
                const stop = (e) => {
                    if (!drawingActive) return;
                    drawingActive = false;
                    drawingCanvas.releasePointerCapture(e.pointerId);
                    updateDrawingInput();
                };
                drawingCanvas.addEventListener('pointerdown', pointerDown);
                drawingCanvas.addEventListener('pointermove', pointerMove);
                drawingCanvas.addEventListener('pointerup', stop);
                drawingCanvas.addEventListener('pointerleave', () => { drawingActive = false; });
                drawingCanvas.addEventListener('pointercancel', () => { drawingActive = false; });
            }

            function getCanvasPos(e){
                const rect = drawingCanvas.getBoundingClientRect();
                return {
                    x: (e.clientX - rect.left) * (drawingCanvas.width / rect.width),
                    y: (e.clientY - rect.top) * (drawingCanvas.height / rect.height)
                };
            }

            function setDrawingColor(color){
                drawingColor = color;
                if (drawingCtx) {
                    drawingCtx.strokeStyle = color;
                }
                document.querySelectorAll('.drawing-color').forEach(btn => {
                    const active = btn.dataset.color === color;
                    btn.classList.toggle('ring-2', active);
                    btn.classList.toggle('ring-amber-400', active);
                });
            }

            function applyDrawingTool(){
                const config = DRAWING_TOOLS[drawingTool] || DRAWING_TOOLS.pencil;
                if (drawingCtx) {
                    drawingCtx.strokeStyle = drawingColor;
                    drawingCtx.globalCompositeOperation = drawingTool === 'eraser' ? 'destination-out' : 'source-over';
                    if (drawingTool === 'fill') {
                        drawingCtx.lineWidth = 1;
                        drawingCtx.globalAlpha = 1;
                    } else if (drawingTool === 'eraser') {
                        drawingCtx.lineWidth = eraserSize;
                        drawingCtx.globalAlpha = 1;
                    } else {
                        drawingCtx.lineWidth = config.width;
                        drawingCtx.globalAlpha = config.opacity;
                    }
                }
                drawingToolButtons.forEach(btn => {
                    const active = btn.dataset.drawingTool === drawingTool;
                    btn.classList.toggle('ring-2', active);
                    btn.classList.toggle('ring-amber-400', active);
                    btn.classList.toggle('bg-amber-500/10', active);
                });
                updateEraserPanel();
            }

            function setDrawingTool(tool){
                drawingTool = DRAWING_TOOLS[tool] ? tool : 'pencil';
                applyDrawingTool();
            }

            function updateEraserPanel(){
                if (!eraserSizePanel) return;
                eraserSizePanel.classList.toggle('hidden', drawingTool !== 'eraser');
            }

            function setEraserSize(size){
                eraserSize = size;
                if (eraserSizeButtons.length) {
                    eraserSizeButtons.forEach(btn => {
                        const active = Number(btn.dataset.eraserSize) === size;
                        btn.classList.toggle('ring-2', active);
                        btn.classList.toggle('ring-amber-400', active);
                        btn.classList.toggle('bg-amber-500/10', active);
                    });
                }
                if (drawingTool === 'eraser') applyDrawingTool();
            }

            function hexToRgba(hex){
                let clean = (hex || '').replace('#', '').toLowerCase();
                if (clean.length === 3) {
                    clean = clean.split('').map(ch => ch + ch).join('');
                }
                const value = parseInt(clean, 16);
                if (Number.isNaN(value)) return { r: 0, g: 0, b: 0, a: 255 };
                return {
                    r: (value >> 16) & 255,
                    g: (value >> 8) & 255,
                    b: value & 255,
                    a: 255
                };
            }

            function colorsMatch(data, idx, colorArr){
                return data[idx] === colorArr[0]
                    && data[idx + 1] === colorArr[1]
                    && data[idx + 2] === colorArr[2]
                    && data[idx + 3] === colorArr[3];
            }

            function setColorAt(data, idx, color){
                data[idx] = color[0];
                data[idx + 1] = color[1];
                data[idx + 2] = color[2];
                data[idx + 3] = color[3];
            }

            function floodFillAt(x, y){
                if (!drawingCtx || !drawingCanvas) return;
                const width = drawingCanvas.width;
                const height = drawingCanvas.height;
                if (x < 0 || x >= width || y < 0 || y >= height) return;
                const imageData = drawingCtx.getImageData(0, 0, width, height);
                const data = imageData.data;
                const idx = (y * width + x) * 4;
                const targetColor = [data[idx], data[idx + 1], data[idx + 2], data[idx + 3]];
                const fillColorObj = hexToRgba(drawingColor);
                const fillColor = [fillColorObj.r, fillColorObj.g, fillColorObj.b, fillColorObj.a];
                if (colorsMatch(data, idx, fillColor)) return;
                const stack = [{ x, y }];
                while (stack.length) {
                    const { x: cx, y: cy } = stack.pop();
                    if (cx < 0 || cx >= width || cy < 0 || cy >= height) continue;
                    const currentIdx = (cy * width + cx) * 4;
                    if (!colorsMatch(data, currentIdx, targetColor)) continue;
                    setColorAt(data, currentIdx, fillColor);
                    stack.push({ x: cx + 1, y: cy });
                    stack.push({ x: cx - 1, y: cy });
                    stack.push({ x: cx, y: cy + 1 });
                    stack.push({ x: cx, y: cy - 1 });
                }
                drawingCtx.putImageData(imageData, 0, 0);
                drawingHasContent = true;
                updateDrawingInput();
            }

            function getExportCanvas(){
                if (!drawingCanvas) return null;
                const targetWidth = drawingCanvas.width;
                const targetHeight = drawingCanvas.height;
                const tmp = document.createElement('canvas');
                tmp.width = targetWidth;
                tmp.height = targetHeight;
                const ctx = tmp.getContext('2d');
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, targetWidth, targetHeight);
                ctx.drawImage(drawingCanvas, 0, 0, targetWidth, targetHeight);
                return tmp;
            }

            function updateDrawingInput(){
                if (!drawingInput) return;
                if (!drawingHasContent) {
                    drawingInput.value = '';
                    return;
                }
                const exportCanvas = getExportCanvas();
                drawingInput.value = exportCanvas ? exportCanvas.toDataURL('image/png') : '';
            }

            function clearDrawingCanvas(){
                if (!drawingCtx || !drawingCanvas) return;
                drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
                drawingHasContent = false;
                if (drawingInput) drawingInput.value = '';
            }

            function loadDrawing(data){
                if (!drawingCtx || !drawingCanvas) return;
                drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
                drawingHasContent = Boolean(data);
                if (!data) {
                    updateDrawingInput();
                    return;
                }
                const img = new Image();
                img.onload = () => {
                    drawingCtx.drawImage(img, 0, 0, drawingCanvas.width, drawingCanvas.height);
                    updateDrawingInput();
                };
                img.src = data;
            }

            function initFirebase(){
                try {
                    if (!firebase.apps.length) {
                        firebase.initializeApp(firebaseConfig);
                    }
                    db = firebase.database();
                    useFirebase = true;
                    db.ref('poopSchedule').on('value', (snapshot) => {
                        entries = snapshot.val() || {};
                        renderCalendar();
                        renderEntries();
                    });
                } catch (error) {
                    console.error('Firebase unavailable, –¥–∞–Ω–Ω—ã–µ –Ω–µ –±—É–¥—É—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã:', error);
                }
            }

            function getDayEntries(dateKey){
                const day = entries ? entries[dateKey] : null;
                if (!day) return [];
                return Object.entries(day).map(([id, entry]) => ({ id, ...entry }));
            }
            function getEntriesCount(dateKey){
                return getDayEntries(dateKey).length;
            }

            function renderCalendar(){
                if (viewMode === 'month') {
                    renderMonth();
                } else {
                    renderWeek();
                }
            }

            function renderWeek(){
                const end = new Date(weekStart);
                end.setDate(end.getDate() + 6);
                rangeTitle.textContent = `${weekStart.toLocaleDateString('ru-RU', { day: '2-digit', month: 'long' })} ‚Äî ${end.toLocaleDateString('ru-RU', { day: '2-digit', month: 'long' })}`;

                calendarGrid.innerHTML = '';
                for (let i = 0; i < 7; i++) {
                    const d = new Date(weekStart);
                    d.setDate(d.getDate() + i);
                    const key = formatDateKey(d);
                    const count = getEntriesCount(key);
                    const isSelected = formatDateKey(d) === formatDateKey(selectedDate);

                    const btn = document.createElement('button');
                    btn.className = `flex flex-col gap-1 p-3 rounded-xl border transition text-left ${isSelected ? 'border-amber-400 bg-amber-500/10 text-white' : 'border-amber-500/20 bg-black/50 text-gray-100 hover:border-amber-500/40'}`;
                    btn.innerHTML = `
                        <div class="flex items-center justify-between">
                            <span class="text-sm ${isSelected ? 'text-amber-200' : 'text-gray-400'}">${dayNames[i]}</span>
                            ${count ? `<span class="text-[10px] sm:text-[11px] px-1.5 sm:px-2 py-0.5 sm:py-1 rounded-full bg-amber-500/15 border border-amber-500/25 text-amber-200 leading-none ml-1 sm:ml-0">${count}</span>` : '<span class="text-[11px] text-transparent px-2 py-1">.</span>'}
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-2xl font-semibold">${d.getDate()}</span>
                        </div>
                    `;
                    btn.addEventListener('click', () => {
                        selectedDate = d;
                        renderCalendar();
                        renderEntries();
                    });
                    calendarGrid.appendChild(btn);
                }
            }

            function renderMonth(){
                const year = monthCursor.getFullYear();
                const month = monthCursor.getMonth();
                rangeTitle.textContent = monthCursor.toLocaleDateString('ru-RU', { month: 'long', year: 'numeric' });

                const start = new Date(year, month, 1);
                const offset = (start.getDay() + 6) % 7; // Monday start
                start.setDate(start.getDate() - offset);
                calendarGrid.innerHTML = '';

                for (let i = 0; i < 42; i++) {
                    const d = new Date(start);
                    d.setDate(start.getDate() + i);
                    const key = formatDateKey(d);
                    const count = getEntriesCount(key);
                    const isCurrentMonth = d.getMonth() === month;
                    const isSelected = formatDateKey(d) === formatDateKey(selectedDate);
                    const isToday = formatDateKey(d) === formatDateKey(new Date());

                    const btn = document.createElement('button');
                    btn.className = `flex flex-col gap-2 p-3 rounded-xl border transition text-left ${
                        isSelected ? 'border-amber-400 bg-amber-500/10 text-white' :
                        isCurrentMonth ? 'border-amber-500/20 bg-black/50 text-gray-100 hover:border-amber-500/40' :
                        'border-transparent bg-black/20 text-gray-600'
                    }`;
                    btn.innerHTML = `
                        <div class="flex items-center justify-between">
                            <span class="text-sm ${isCurrentMonth ? 'text-gray-400' : 'text-gray-600'}">${dayNames[(i % 7)]}</span>
                            ${count ? `<span class="text-[10px] sm:text-[11px] px-1.5 sm:px-2 py-0.5 sm:py-1 rounded-full bg-amber-500/15 border border-amber-500/25 text-amber-200 leading-none ml-1 sm:ml-0">${count}</span>` : '<span class="text-[11px] text-transparent px-2 py-1">.</span>'}
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-2xl font-semibold ${!isCurrentMonth ? 'opacity-60' : ''}">${d.getDate()}</span>
                            ${isToday ? '<span class="text-[9px] text-amber-300">‚óè</span>' : ''}
                        </div>
                    `;
                    btn.addEventListener('click', () => {
                        selectedDate = d;
                        renderEntries();
                        renderCalendar();
                    });
                    calendarGrid.appendChild(btn);
                }
            }

            function renderEntries(){
                const key = formatDateKey(selectedDate);
                const list = getDayEntries(key).sort((a,b) => timeToMinutes(a.time) - timeToMinutes(b.time));
                selectedDateLabel.textContent = formatHumanDate(selectedDate);
                const authors = Array.from(new Set(list.map((i) => i.authorName || '–ê–Ω–æ–Ω–∏–º')));
                renderAuthorFilter(authors);
                const filtered = selectedAuthor === 'all' ? list : list.filter((i) => (i.authorName || '–ê–Ω–æ–Ω–∏–º') === selectedAuthor);

                if (!filtered.length) {
                    entriesList.innerHTML = '<div class="text-gray-400 text-sm">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –∑–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å. –î–æ–±–∞–≤—å –ø–µ—Ä–≤—É—é.</div>';
                    return;
                }

                entriesList.innerHTML = '';
                filtered.forEach((item) => {
                    const meta = BRISTOL[item.bristol] || {};
                    const canModify = currentUser && item.author && currentUser.username === item.author;
                    const entryKey = key;
                    const card = document.createElement('div');
                    card.className = 'rounded-xl border border-amber-500/25 bg-black/50 p-4 flex flex-col gap-3';
                    const drawingMarkup = isDrawingData(item.drawing) ? `
                        <div class="space-y-2">
                            <button type="button" data-action="toggle-drawing" class="px-3 py-2 rounded-lg border border-amber-500/25 text-amber-200 hover:border-amber-500/40 transition text-sm bg-black/40">–ü–æ–∫–∞–∑–∞—Ç—å –∫–∞–ª</button>
                            <div class="hidden rounded-2xl border border-amber-500/20 overflow-hidden bg-black/30" data-drawing-panel>
                                <div class="relative w-full" style="aspect-ratio: 504 / 308;">
                                    <img src="${item.drawing}" alt="–†–∏—Å—É–Ω–æ–∫ –ø–æ–∫–∞–∫–∞ ${escapeHtml(item.time || '')}" class="absolute inset-0 w-full h-full object-contain bg-black/80">
                                </div>
                            </div>
                        </div>
                    ` : '';
                    card.innerHTML = `
                        <div class="flex items-center justify-between gap-3">
                            <div class="flex items-center gap-3 flex-wrap">
                                <span class="text-lg font-semibold text-amber-300">${escapeHtml(item.time || '')}</span>
                                <span class="inline-flex items-center gap-2 text-xs px-2 py-1 rounded-full bg-amber-500/15 border border-amber-500/30 text-amber-200">
                                    <span class="inline-flex items-center justify-center w-7 h-5">${meta.icon || ''}</span>
                                    <span>${meta.title || '–ë—Ä–∏—Å—Ç–æ–ª—å'}</span>
                                </span>
                                ${item.size ? `
                                <span class="inline-flex items-center gap-2 text-xs px-2 py-1 rounded-full bg-amber-500/15 border border-amber-500/30 text-amber-200">
                                    <span>üìè</span>
                                    <span>–†–∞–∑–º–µ—Ä: ${item.size}/10</span>
                                </span>
                                ` : ''}
                            </div>
                            <div class="flex items-center gap-2 flex-wrap justify-end text-xs">
                                <span class="text-gray-400">${item.authorName || '–ê–Ω–æ–Ω–∏–º'}</span>
                                ${canModify ? `
                                    <button class="px-2 py-1 rounded-lg border border-amber-500/25 text-amber-200 hover:border-amber-500/40 hover:text-white transition" data-action="edit" aria-label="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
                                    <button class="px-2 py-1 rounded-lg border border-red-500/30 text-red-300 hover:bg-red-500/10 transition" data-action="delete" aria-label="–£–¥–∞–ª–∏—Ç—å">üóë</button>
                                ` : ''}
                                <span class="text-gray-500">${item.createdAt ? new Date(item.createdAt).toLocaleTimeString('ru-RU',{hour:'2-digit', minute:'2-digit'}) : ''}</span>
                            </div>
                        </div>
                        <div class="grid sm:grid-cols-2 gap-2 text-sm text-gray-200">
                            <div class="flex items-center gap-2"><span class="text-amber-300">‚è±</span> ${formatDuration(getDurationSeconds(item))}</div>
                            <div class="flex items-center gap-2"><span class="text-amber-300">üßª</span> ${item.paper} —à—Ç</div>
                            <div class="flex items-center gap-2"><span class="text-amber-300">‚ú®</span> –õ—ë–≥–∫–æ—Å—Ç—å: ${item.ease}/10</div>
                            <div class="flex items-center gap-2"><span class="text-amber-300">ü§ù</span> –£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç—å: ${item.satisfaction}/10</div>
                        </div>
                        ${drawingMarkup}
                        ${item.comment ? `
                        <div class="text-sm text-gray-200 bg-black/40 border border-amber-500/10 rounded-lg px-3 py-2 relative">
                            üí¨ ${escapeHtml(item.comment)}
                            <div class="comment-actions">
                                <button type="button" class="px-2 py-1 rounded border border-amber-500/25 text-amber-200 hover:border-amber-500/40 transition" data-action="open-entry-reactions" data-entry-id="${entryKey}">üòä</button>
                                <div class="reaction-menu hidden absolute right-0 top-full mt-1 bg-black/90 border border-amber-500/25 rounded-xl p-2 z-30" data-entry-reaction-menu data-entry-id="${entryKey}"></div>
                            </div>
                            <div class="flex flex-wrap gap-1 mt-2" data-entry-reaction-summary data-entry-id="${entryKey}"></div>
                        </div>
                        ` : ''}
                        <div class="flex flex-col gap-2 relative">
                            <div class="flex items-center justify-between text-xs text-gray-400">
                                <span>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</span>
                                <button class="px-2 py-1 rounded border border-amber-500/25 text-amber-200 hover:border-amber-500/40 transition" data-action="add-comment">–î–æ–±–∞–≤–∏—Ç—å</button>
                            </div>
                            <div class="space-y-2" data-comments></div>
                            <div class="flex justify-end mt-1">
                                <div class="flex flex-wrap gap-1 text-xs text-amber-200" data-reaction-summary></div>
                            </div>
                        </div>
                    `;
                    const editBtn = card.querySelector('[data-action="edit"]');
                    const delBtn = card.querySelector('[data-action="delete"]');
                    if (editBtn) editBtn.addEventListener('click', () => startEdit(key, item));
                    if (delBtn) delBtn.addEventListener('click', () => deleteEntry(key, item.id));
                    // Comments
                    const commentsHolder = card.querySelector('[data-comments]');
                    const addCommentBtn = card.querySelector('[data-action="add-comment"]');
                    const commentForm = document.createElement('div');
                    commentForm.className = 'flex flex-col gap-2 hidden';
                    commentForm.innerHTML = `
                        <textarea class="w-full max-w-[640px] px-3 py-2 rounded-lg bg-black/50 border border-amber-500/20 text-sm text-amber-100 focus:border-amber-500/50 focus:outline-none resize-none min-h-[88px]" rows="3" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"></textarea>
                        <div class="flex justify-start gap-2">
                            <button type="button" class="px-3 py-2 rounded-lg bg-amber-500/20 border border-amber-500/40 text-amber-100 hover:bg-amber-500/30 transition text-sm" data-action="send-comment">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                            <button type="button" class="px-3 py-2 rounded-lg border border-amber-500/25 text-gray-300 hover:border-amber-500/40 transition text-sm" data-action="cancel-comment">–û—Ç–º–µ–Ω–∞</button>
                        </div>
                    `;
                    if (commentsHolder && commentsHolder.parentElement) commentsHolder.after(commentForm);
                    if (addCommentBtn && commentsHolder) {
                        addCommentBtn.addEventListener('click', () => {
                            const ta = commentForm.querySelector('textarea');
                            const isOpen = !commentForm.classList.contains('hidden');
                            if (isOpen) {
                                commentForm.classList.add('hidden');
                                if (ta) ta.value = '';
                            } else {
                                commentForm.classList.remove('hidden');
                                safeFocus(ta);
                            }
                        });
                        const sendBtn = commentForm.querySelector('[data-action="send-comment"]');
                        const cancelBtn = commentForm.querySelector('[data-action="cancel-comment"]');
                        const textarea = commentForm.querySelector('textarea');
                        if (sendBtn && textarea) {
                            const resize = () => {
                                textarea.style.height = 'auto';
                                textarea.style.height = `${textarea.scrollHeight}px`;
                            };
                            textarea.addEventListener('input', resize);
                            sendBtn.addEventListener('click', () => {
                                submitComment(entryKey, item.id, textarea.value || '');
                                textarea.value = '';
                                textarea.style.height = 'auto';
                                commentForm.classList.add('hidden');
                            });
                            resize();
                        }
                        if (cancelBtn && textarea) {
                            cancelBtn.addEventListener('click', () => {
                                textarea.value = '';
                                textarea.style.height = 'auto';
                                commentForm.classList.add('hidden');
                            });
                        }
                        renderComments(entryKey, item.id, commentsHolder);
                        attachCommentReactions(entryKey, item.id, card);
                    }
                    // Reactions
                    const summaryHolder = card.querySelector('[data-reaction-summary]');
                    if (summaryHolder) renderReactionSummary(entryKey, item.id, summaryHolder);
                    const toggleDrawingBtn = card.querySelector('[data-action="toggle-drawing"]');
                    if (toggleDrawingBtn) {
                        const panel = card.querySelector('[data-drawing-panel]');
                        if (panel) {
                            toggleDrawingBtn.addEventListener('click', () => {
                                const nowHidden = panel.classList.toggle('hidden');
                                toggleDrawingBtn.textContent = nowHidden ? '–ü–æ–∫–∞–∑–∞—Ç—å –∫–∞–ª' : '–°–∫—Ä—ã—Ç—å –∫–∞–ª';
                            });
                        }
                    }
                    // Entry comment reactions
                    if (item.comment) {
                        const entryMenu = card.querySelector('[data-entry-reaction-menu]');
                        const entrySummary = card.querySelector('[data-entry-reaction-summary]');
                        const entryBtn = card.querySelector('[data-action="open-entry-reactions"]');
                        if (entrySummary) renderCommentReactions(entryKey, item.id, '__entry', entrySummary);
                        if (entryMenu) buildCommentReactionMenu(entryKey, item.id, '__entry', entryMenu);
                        if (entryBtn && entryMenu) {
                            entryBtn.addEventListener('click', (e) => {
                                e.stopPropagation();
                                const isOpen = !entryMenu.classList.contains('hidden');
                                document.querySelectorAll('[data-entry-reaction-menu]').forEach(m => m.classList.add('hidden'));
                                if (isOpen) {
                                    entryMenu.classList.add('hidden');
                                } else {
                                    entryMenu.classList.remove('hidden');
                                }
                            });
                            entryMenu.addEventListener('click', (e) => {
                                const btn = e.target.closest('[data-emoji]');
                                if (!btn) return;
                                toggleCommentReaction(entryKey, item.id, '__entry', btn.dataset.emoji);
                                entryMenu.classList.add('hidden');
                            });
                            entrySummary.addEventListener('click', (e) => {
                                const chip = e.target.closest('span');
                                if (!chip || !chip.textContent) return;
                                const emoji = chip.textContent.trim().split(' ')[0];
                                toggleCommentReaction(entryKey, item.id, '__entry', emoji);
                            });
                        }
                    }
                    entriesList.appendChild(card);
                });
            }

            function openModal(withTime){
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                document.body.classList.add('modal-open');
                updateModalVh();
                const modalCard = modal.querySelector('.card');
                if (modalCard) modalCard.scrollTop = 0;
                modal.scrollTop = 0;
                const entryDrawing = editingEntry ? (entries?.[editingEntry.dateKey]?.[editingEntry.id]?.drawing || '') : '';
                if (entryDrawing) {
                    loadDrawing(entryDrawing);
                    drawingInput.value = entryDrawing;
                } else {
                    clearDrawingCanvas();
                    if (drawingInput) drawingInput.value = '';
                }
                const firstField = form.querySelector('input:not([type="hidden"]):not([type="radio"]):not([type="checkbox"]), textarea');
                safeFocus(firstField, { preventScroll: true });
                const timeVal = withTime || defaultTime();
                const normalizedTime = timeInputMode === 'list' ? snapTimeToQuarter(timeVal) : timeVal;
                setTime(normalizedTime);
                requestAnimationFrame(() => setTime(normalizedTime));
                const durationVal = Number(durationSecondsInput?.value || 0);
                setDurationSeconds(durationVal);
                requestAnimationFrame(() => setDurationSeconds(durationVal));
                const paperVal = Number(paperInput?.value);
                const normalizedPaper = Number.isFinite(paperVal) ? paperVal : 1;
                setPaperValue(normalizedPaper);
                requestAnimationFrame(() => setPaperValue(normalizedPaper));
            }
            function closeModal(){
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                editingEntry = null;
                form.reset();
                setTime(defaultTime());
                setDurationSeconds(0);
                setPaperValue(1);
                clearDrawingCanvas();
                if (drawingInput) drawingInput.value = '';
                if (drawingPanel) drawingPanel.classList.add('hidden');
                if (drawingToggle) drawingToggle.setAttribute('aria-expanded', 'false');
                sizeValue = null;
                sizeHover = 0;
                renderSizeScale();
                easeValue = null;
                easeHover = 0;
                satisfactionValue = null;
                satisfactionHover = 0;
                renderEmojiScale(easeScale, easeValue, easeHover);
                renderEmojiScale(satisfactionScale, satisfactionValue, satisfactionHover);
                if (easeValueLabel) easeValueLabel.textContent = '‚Äî';
                if (satisfactionValueLabel) satisfactionValueLabel.textContent = '‚Äî';
                if (sizeValueLabel) sizeValueLabel.textContent = '‚Äî';
                document.body.classList.remove('modal-open');
            }

            function stabilizeWheelSelections(){
                if (!modal || modal.classList.contains('hidden')) return;
                const timeFallback = (timeInput && timeInput.value) ? timeInput.value : timeValue;
                if (timeFallback) setTime(timeFallback);
                const durationFallback = (durationSecondsInput && durationSecondsInput.value !== '')
                    ? Number(durationSecondsInput.value || 0)
                    : durationValue;
                setDurationSeconds(durationFallback);
                const paperFallback = (paperInput && paperInput.value !== '')
                    ? Number(paperInput.value || 1)
                    : paperValue;
                setPaperValue(paperFallback);
                stabilizeScaleSelections();
            }

            function stabilizeScaleSelections(){
                if (!form) return;
                const sizeChecked = form.querySelector('input[name="size"]:checked');
                if (sizeChecked) {
                    setSizeValue(sizeChecked.value);
                } else if (sizeValue) {
                    setSizeValue(sizeValue);
                }
                const easeChecked = form.querySelector('input[name="ease"]:checked');
                if (easeChecked) {
                    setEaseValue(easeChecked.value);
                } else if (easeValue) {
                    setEaseValue(easeValue);
                }
                const satisfactionChecked = form.querySelector('input[name="satisfaction"]:checked');
                if (satisfactionChecked) {
                    setSatisfactionValue(satisfactionChecked.value);
                } else if (satisfactionValue) {
                    setSatisfactionValue(satisfactionValue);
                }
            }

            function startEdit(dateKey, entry){
                if (!currentUser || entry.author !== currentUser.username) return;
                editingEntry = { dateKey, id: entry.id };
                selectedDate = new Date(dateKey);
                setTime(entry.time);
                setDurationSeconds(getDurationSeconds(entry));
                setPaperValue(entry.paper);
                const easeRadio = form.querySelector(`input[name="ease"][value="${entry.ease}"]`);
                if (easeRadio) easeRadio.checked = true;
                setEaseValue(entry.ease);
                const satisfactionRadio = form.querySelector(`input[name="satisfaction"][value="${entry.satisfaction}"]`);
                if (satisfactionRadio) satisfactionRadio.checked = true;
                setSatisfactionValue(entry.satisfaction);
                const sizeRadio = form.querySelector(`input[name="size"][value="${entry.size}"]`);
                if (sizeRadio) sizeRadio.checked = true;
                setSizeValue(entry.size);
                const radio = form.querySelector(`input[name="bristol"][value="${entry.bristol}"]`);
                if (radio) radio.checked = true;
                if (form.elements['comment']) form.elements['comment'].value = entry.comment || '';
                openModal(entry.time);
            }

            function deleteEntry(dateKey, id){
                const entry = entries && entries[dateKey] && entries[dateKey][id];
                if (!entry || !currentUser || entry.author !== currentUser.username) return;
                if (!db) return;
                if (!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?')) return;
                db.ref(`poopSchedule/${dateKey}/${id}`).remove();
                if (editingEntry && editingEntry.id === id) editingEntry = null;
            }

            function highlightViewButtons(){
                if (viewMode === 'month') {
                    monthModeBtn.classList.add('bg-amber-500/15','border','border-amber-500/40','text-amber-200','font-semibold');
                    weekModeBtn.classList.remove('bg-amber-500/15','border','border-amber-500/40','text-amber-200','font-semibold');
                } else {
                    weekModeBtn.classList.add('bg-amber-500/15','border','border-amber-500/40','text-amber-200','font-semibold');
                    monthModeBtn.classList.remove('bg-amber-500/15','border','border-amber-500/40','text-amber-200','font-semibold');
                }
            }

            // Event bindings
            if (sizeScale) {
                const pickSizeFromX = (clientX) => {
                    const rect = sizeScale.getBoundingClientRect();
                    const ratio = (clientX - rect.left) / rect.width;
                    const val = Math.ceil(ratio * 10);
                    return Math.max(1, Math.min(10, val));
                };
                let sizePointerActive = false;
                sizeScale.addEventListener('pointerover', (e) => {
                    if (e.pointerType === 'touch') return;
                    const seg = e.target.closest('[data-size]');
                    if (!seg) return;
                    const next = Number(seg.dataset.size);
                    if (sizeHover === next) return;
                    sizeHover = next;
                    renderSizeScale();
                });
                sizeScale.addEventListener('pointerleave', () => {
                    sizeHover = 0;
                    renderSizeScale();
                });
                sizeScale.addEventListener('click', (e) => {
                    const seg = e.target.closest('[data-size]');
                    if (!seg) return;
                    const input = seg.querySelector('input[name="size"]');
                    if (input) input.checked = true;
                    setSizeValue(seg.dataset.size);
                });
                sizeScale.addEventListener('change', (e) => {
                    const input = e.target.closest('input[name="size"]');
                    if (!input) return;
                    setSizeValue(input.value);
                });
                sizeScale.addEventListener('pointerdown', (e) => {
                    if (e.pointerType === 'mouse') return;
                    sizePointerActive = true;
                    sizeScale.setPointerCapture(e.pointerId);
                    const val = pickSizeFromX(e.clientX);
                    sizeHover = val;
                    setSizeValue(val);
                    e.preventDefault();
                });
                sizeScale.addEventListener('pointermove', (e) => {
                    if (!sizePointerActive || e.pointerType === 'mouse') return;
                    const val = pickSizeFromX(e.clientX);
                    sizeHover = val;
                    setSizeValue(val);
                    e.preventDefault();
                });
                sizeScale.addEventListener('pointerup', (e) => {
                    if (e.pointerType === 'mouse') return;
                    if (sizePointerActive) {
                        sizePointerActive = false;
                        sizeHover = 0;
                        renderSizeScale();
                    }
                    if (sizeScale.hasPointerCapture(e.pointerId)) {
                        sizeScale.releasePointerCapture(e.pointerId);
                    }
                });
                sizeScale.addEventListener('pointercancel', (e) => {
                    if (sizePointerActive) {
                        sizePointerActive = false;
                        sizeHover = 0;
                        renderSizeScale();
                    }
                    if (sizeScale.hasPointerCapture(e.pointerId)) {
                        sizeScale.releasePointerCapture(e.pointerId);
                    }
                });
            }
            if (easeScale) {
                easeScale.addEventListener('pointerover', (e) => {
                    if (e.pointerType === 'touch') return;
                    const seg = e.target.closest('[data-scale-value]');
                    if (!seg) return;
                    const next = Number(seg.dataset.scaleValue);
                    if (easeHover === next) return;
                    easeHover = next;
                    renderEmojiScale(easeScale, easeValue, easeHover);
                });
                easeScale.addEventListener('pointerleave', () => {
                    easeHover = 0;
                    renderEmojiScale(easeScale, easeValue, easeHover);
                });
                easeScale.addEventListener('click', (e) => {
                    const seg = e.target.closest('[data-scale-value]');
                    if (!seg) return;
                    const input = seg.querySelector('input[name="ease"]');
                    if (input) input.checked = true;
                    setEaseValue(seg.dataset.scaleValue);
                });
                easeScale.addEventListener('change', (e) => {
                    const input = e.target.closest('input[name="ease"]');
                    if (!input) return;
                    setEaseValue(input.value);
                });
                const pickEaseFromX = (clientX) => {
                    const rect = easeScale.getBoundingClientRect();
                    const ratio = (clientX - rect.left) / rect.width;
                    const val = Math.ceil(ratio * 10);
                    return Math.max(1, Math.min(10, val));
                };
                let easePointerActive = false;
                easeScale.addEventListener('pointerdown', (e) => {
                    if (e.pointerType === 'mouse') return;
                    easePointerActive = true;
                    easeScale.setPointerCapture(e.pointerId);
                    const val = pickEaseFromX(e.clientX);
                    easeHover = val;
                    setEaseValue(val);
                    e.preventDefault();
                });
                easeScale.addEventListener('pointermove', (e) => {
                    if (!easePointerActive || e.pointerType === 'mouse') return;
                    const val = pickEaseFromX(e.clientX);
                    easeHover = val;
                    setEaseValue(val);
                    e.preventDefault();
                });
                easeScale.addEventListener('pointerup', (e) => {
                    if (e.pointerType === 'mouse') return;
                    if (easePointerActive) {
                        easePointerActive = false;
                        easeHover = 0;
                        renderEmojiScale(easeScale, easeValue, easeHover);
                    }
                    if (easeScale.hasPointerCapture(e.pointerId)) {
                        easeScale.releasePointerCapture(e.pointerId);
                    }
                });
                easeScale.addEventListener('pointercancel', (e) => {
                    if (easePointerActive) {
                        easePointerActive = false;
                        easeHover = 0;
                        renderEmojiScale(easeScale, easeValue, easeHover);
                    }
                    if (easeScale.hasPointerCapture(e.pointerId)) {
                        easeScale.releasePointerCapture(e.pointerId);
                    }
                });
            }
            if (satisfactionScale) {
                satisfactionScale.addEventListener('pointerover', (e) => {
                    if (e.pointerType === 'touch') return;
                    const seg = e.target.closest('[data-scale-value]');
                    if (!seg) return;
                    const next = Number(seg.dataset.scaleValue);
                    if (satisfactionHover === next) return;
                    satisfactionHover = next;
                    renderEmojiScale(satisfactionScale, satisfactionValue, satisfactionHover);
                });
                satisfactionScale.addEventListener('pointerleave', () => {
                    satisfactionHover = 0;
                    renderEmojiScale(satisfactionScale, satisfactionValue, satisfactionHover);
                });
                satisfactionScale.addEventListener('click', (e) => {
                    const seg = e.target.closest('[data-scale-value]');
                    if (!seg) return;
                    const input = seg.querySelector('input[name="satisfaction"]');
                    if (input) input.checked = true;
                    setSatisfactionValue(seg.dataset.scaleValue);
                });
                satisfactionScale.addEventListener('change', (e) => {
                    const input = e.target.closest('input[name="satisfaction"]');
                    if (!input) return;
                    setSatisfactionValue(input.value);
                });
                const pickSatisfactionFromX = (clientX) => {
                    const rect = satisfactionScale.getBoundingClientRect();
                    const ratio = (clientX - rect.left) / rect.width;
                    const val = Math.ceil(ratio * 10);
                    return Math.max(1, Math.min(10, val));
                };
                let satisfactionPointerActive = false;
                satisfactionScale.addEventListener('pointerdown', (e) => {
                    if (e.pointerType === 'mouse') return;
                    satisfactionPointerActive = true;
                    satisfactionScale.setPointerCapture(e.pointerId);
                    const val = pickSatisfactionFromX(e.clientX);
                    satisfactionHover = val;
                    setSatisfactionValue(val);
                    e.preventDefault();
                });
                satisfactionScale.addEventListener('pointermove', (e) => {
                    if (!satisfactionPointerActive || e.pointerType === 'mouse') return;
                    const val = pickSatisfactionFromX(e.clientX);
                    satisfactionHover = val;
                    setSatisfactionValue(val);
                    e.preventDefault();
                });
                satisfactionScale.addEventListener('pointerup', (e) => {
                    if (e.pointerType === 'mouse') return;
                    if (satisfactionPointerActive) {
                        satisfactionPointerActive = false;
                        satisfactionHover = 0;
                        renderEmojiScale(satisfactionScale, satisfactionValue, satisfactionHover);
                    }
                    if (satisfactionScale.hasPointerCapture(e.pointerId)) {
                        satisfactionScale.releasePointerCapture(e.pointerId);
                    }
                });
                satisfactionScale.addEventListener('pointercancel', (e) => {
                    if (satisfactionPointerActive) {
                        satisfactionPointerActive = false;
                        satisfactionHover = 0;
                        renderEmojiScale(satisfactionScale, satisfactionValue, satisfactionHover);
                    }
                    if (satisfactionScale.hasPointerCapture(e.pointerId)) {
                        satisfactionScale.releasePointerCapture(e.pointerId);
                    }
                });
            }
            if (timeWheel) {
                const hourCol = timeWheel.querySelector('[data-part="hour"]');
                const minuteCol = timeWheel.querySelector('[data-part="minute"]');
                const onScroll = (col) => {
                    if (!col) return;
                    if (col._scrollRaf) cancelAnimationFrame(col._scrollRaf);
                    col._scrollRaf = requestAnimationFrame(() => {
                        updateWheelSelection(col);
                        syncTimeFromWheel();
                    });
                };
                const hourList = hourCol?.querySelector('.time-wheel-list');
                const minuteList = minuteCol?.querySelector('.time-wheel-list');
                if (hourList) hourList.addEventListener('scroll', () => onScroll(hourCol));
                if (minuteList) minuteList.addEventListener('scroll', () => onScroll(minuteCol));
            }
            if (durationWheel) {
                const minuteCol = durationWheel.querySelector('[data-part="minute"]');
                const secondCol = durationWheel.querySelector('[data-part="second"]');
                const onScroll = (col) => {
                    if (!col) return;
                    if (col._scrollRaf) cancelAnimationFrame(col._scrollRaf);
                    col._scrollRaf = requestAnimationFrame(() => {
                        updateWheelSelection(col);
                        syncDurationFromWheel();
                    });
                };
                const minuteList = minuteCol?.querySelector('.time-wheel-list');
                const secondList = secondCol?.querySelector('.time-wheel-list');
                if (minuteList) minuteList.addEventListener('scroll', () => onScroll(minuteCol));
                if (secondList) secondList.addEventListener('scroll', () => onScroll(secondCol));
            }
            if (paperWheel) {
                const paperCol = paperWheel.querySelector('[data-part="paper"]');
                const onScroll = (col) => {
                    if (!col) return;
                    if (col._scrollRaf) cancelAnimationFrame(col._scrollRaf);
                    col._scrollRaf = requestAnimationFrame(() => {
                        updateWheelSelection(col);
                        syncPaperFromWheel();
                    });
                };
                const paperList = paperCol?.querySelector('.time-wheel-list');
                if (paperList) paperList.addEventListener('scroll', () => onScroll(paperCol));
            }
            if (timeModeToggle) {
                timeModeToggle.addEventListener('click', () => {
                    const next = timeInputMode === 'list' ? 'wheel' : 'list';
                    setTimeInputMode(next);
                });
            }
            if (timeSelect) {
                timeSelect.addEventListener('change', () => {
                    if (timeSelect.value) setTime(timeSelect.value);
                });
            }
            if (exportBtn) exportBtn.addEventListener('click', openExportModal);
            if (closeExportBtn) closeExportBtn.addEventListener('click', closeExportModal);
            if (cancelExportBtn) cancelExportBtn.addEventListener('click', closeExportModal);
            if (exportForm) {
                exportForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    if (!currentUser || !currentUser.username) {
                        setExportStatus('–ù—É–∂–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –¥–ª—è –≤—ã–≥—Ä—É–∑–∫–∏.', true);
                        return;
                    }
                    const selectedKeys = Array.from(exportForm.querySelectorAll('input[name="exportField"]:checked'))
                        .map((input) => input.value);
                    if (!selectedKeys.length) {
                        setExportStatus('–í—ã–±–µ—Ä–∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –ø–æ–ª–µ.', true);
                        return;
                    }
                    const fromDate = exportFrom ? exportFrom.value : '';
                    const toDate = exportTo ? exportTo.value : '';
                    if (fromDate && toDate && fromDate > toDate) {
                        setExportStatus('–î–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç –∑–∞–¥–∞–Ω –Ω–µ–≤–µ—Ä–Ω–æ.', true);
                        return;
                    }
                    const rows = collectExportRows(fromDate, toDate);
                    if (!rows.length) {
                        setExportStatus('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—ã–≥—Ä—É–∑–∫–∏ –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥.', true);
                        return;
                    }
                    const csv = buildExportCsv(selectedKeys, rows);
                    const stamp = new Date().toISOString().slice(0, 10);
                    const fileName = `pokaki_${currentUser.username || 'user'}_${fromDate || 'all'}_${toDate || 'all'}_${stamp}.csv`;
                    downloadCsvFile(csv, fileName);
                    setExportStatus(`–ì–æ—Ç–æ–≤–æ: ${rows.length} –∑–∞–ø–∏—Å–µ–π`);
                });
            }
            if (gameBtn) gameBtn.addEventListener('click', openGameModal);
            if (gameCloseBtn) gameCloseBtn.addEventListener('click', closeGameModal);
            if (gameStartBtn) gameStartBtn.addEventListener('click', toggleGame);
            if (gameResetBtn) gameResetBtn.addEventListener('click', () => resetGame(true));
            function handleGamePointerMove(e){
                if (!gameModal || gameModal.classList.contains('hidden')) return;
                if (!gameCanvas) return;
                const rect = gameCanvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                if (x < 0 || x > rect.width) return;
                gameState.paddle.x = Math.max(0, Math.min(gameState.width - gameState.paddle.width, x - gameState.paddle.width / 2));
                if (gameState.paused && !gameState.over && !gameState.win) drawGame();
            }
            if (gameCanvas) {
                gameCanvas.addEventListener('pointermove', handleGamePointerMove);
                gameCanvas.addEventListener('pointerdown', () => {
                    if (gameState.paused && !gameState.over && !gameState.win) startGame();
                });
            }
            if (gameModal) {
                gameModal.addEventListener('pointermove', handleGamePointerMove);
            }
            prevRangeBtn.addEventListener('click', () => {
                if (viewMode === 'month') {
                    monthCursor.setMonth(monthCursor.getMonth() - 1);
                    selectedDate = new Date(monthCursor);
                } else {
                    weekStart.setDate(weekStart.getDate() - 7);
                    selectedDate = new Date(weekStart);
                }
                renderCalendar();
                renderEntries();
            });
            nextRangeBtn.addEventListener('click', () => {
                if (viewMode === 'month') {
                    monthCursor.setMonth(monthCursor.getMonth() + 1);
                    selectedDate = new Date(monthCursor);
                } else {
                    weekStart.setDate(weekStart.getDate() + 7);
                    selectedDate = new Date(weekStart);
                }
                renderCalendar();
                renderEntries();
            });
            weekModeBtn.addEventListener('click', () => {
                viewMode = 'week';
                saveViewMode(viewMode);
                weekStart = getWeekStart(selectedDate);
                highlightViewButtons();
                renderCalendar();
            });
            monthModeBtn.addEventListener('click', () => {
                viewMode = 'month';
                saveViewMode(viewMode);
                monthCursor = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1);
                highlightViewButtons();
                renderCalendar();
            });
            addPoopBtn.addEventListener('click', () => openModal());
            document.getElementById('closeModalBtn').addEventListener('click', closeModal);
            document.getElementById('cancelModalBtn').addEventListener('click', closeModal);
            if (drawingToggle && drawingPanel) {
                drawingToggle.addEventListener('click', () => {
                    const isHidden = drawingPanel.classList.toggle('hidden');
                    drawingToggle.setAttribute('aria-expanded', String(!isHidden));
                });
            }
            const colorButtons = document.querySelectorAll('.drawing-color');
            colorButtons.forEach(btn => {
                btn.addEventListener('click', () => setDrawingColor(btn.dataset.color));
            });
            setDrawingColor(drawingColor);
            if (eraserSizeButtons.length) {
                eraserSizeButtons.forEach(btn => {
                    btn.addEventListener('click', () => setEraserSize(Number(btn.dataset.eraserSize)));
                });
                setEraserSize(eraserSize);
            }
            if (drawingToolButtons.length) {
                drawingToolButtons.forEach(btn => {
                    btn.addEventListener('click', () => setDrawingTool(btn.dataset.drawingTool));
                });
                setDrawingTool(drawingTool);
            }
            if (drawingClear) {
                drawingClear.addEventListener('click', () => {
                    clearDrawingCanvas();
                });
            }
            if (anonToggle) {
                anonToggle.addEventListener('click', () => {
                    anonymityOn = !anonymityOn;
                    saveAnonMode(anonymityOn);
                    selectedAuthor = 'all';
                    saveSelectedAuthor(selectedAuthor);
                    setAnonUI();
                    authorFilterLabel.textContent = '–í—Å–µ';
                    renderEntries();
                });
                setAnonUI();
            }
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.cs')) {
                    closeAllCustomSelects();
                }
                if (!authorDropdown.classList.contains('hidden') && !authorDropdown.contains(e.target) && !authorFilterBtn.contains(e.target)) {
                    closeAuthorDropdown();
                }
                if (modal && !modal.classList.contains('hidden') && !e.target.closest('.time-wheel-list')) {
                    stabilizeWheelSelections();
                }
                if (!e.target.closest('[data-reaction-menu]') && !e.target.closest('[data-action="open-reactions"]')) {
                    closeAllReactionMenus();
                }
                if (!e.target.closest('[data-comment-menu]') && !e.target.closest('[data-action="open-comment-reactions"]')) {
                    document.querySelectorAll('[data-comment-menu]').forEach(m => m.classList.add('hidden'));
                    document.querySelectorAll('[data-entry-reaction-menu]').forEach(m => m.classList.add('hidden'));
                }
                const cancelEditBtn = e.target.closest('[data-action="cancel-edit"]');
                if (cancelEditBtn) {
                    e.preventDefault();
                    const editor = cancelEditBtn.closest('[data-editor]');
                    const card = cancelEditBtn.closest('.comment-card');
                    if (editor) editor.remove();
                    if (card) {
                        const textDiv = card.querySelector('.mt-1');
                        const actions = card.querySelector('.comment-actions');
                        if (textDiv) textDiv.classList.remove('hidden');
                        if (actions) actions.classList.remove('hidden');
                        delete card.dataset.editing;
                        card.classList.remove('comment-editing');
                    }
                }
                if (!modal.classList.contains('hidden') && e.target === modal) {
                    closeModal();
                }
                if (exportModal && !exportModal.classList.contains('hidden') && e.target === exportModal) {
                    closeExportModal();
                }
                if (gameModal && !gameModal.classList.contains('hidden') && e.target === gameModal) {
                    closeGameModal();
                }
            });
            document.addEventListener('focusin', (e) => {
                if (!isSmallScreen()) return;
                const target = e.target;
                if (!(target instanceof Element)) return;
                if (target.matches('input, select, textarea')) {
                    lockViewportScale();
                }
            });
            document.addEventListener('focusout', (e) => {
                if (!isSmallScreen()) return;
                const target = e.target;
                if (!(target instanceof Element)) return;
                if (!target.matches('input, select, textarea')) return;
                setTimeout(() => {
                    const active = document.activeElement;
                    if (!(active instanceof Element) || !active.matches('input, select, textarea')) {
                        resetViewportScale();
                    }
                }, 50);
            });
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (!modal.classList.contains('hidden')) closeModal();
                    if (exportModal && !exportModal.classList.contains('hidden')) closeExportModal();
                    if (gameModal && !gameModal.classList.contains('hidden')) closeGameModal();
                }
                if (gameModal && !gameModal.classList.contains('hidden')) {
                    if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') {
                        leftPressed = true;
                        e.preventDefault();
                    }
                    if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') {
                        rightPressed = true;
                        e.preventDefault();
                    }
                    if (e.key === ' ') {
                        toggleGame();
                        e.preventDefault();
                    }
                }
            });
            document.addEventListener('keyup', (e) => {
                if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') leftPressed = false;
                if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') rightPressed = false;
            });
            modal.addEventListener('focusin', (e) => {
                if (modal.classList.contains('hidden')) return;
                const modalCard = modal.querySelector('.card');
                if (!modalCard) return;
                const el = e.target;
                if (!(el instanceof Element)) return;
                const rect = el.getBoundingClientRect();
                const cardRect = modalCard.getBoundingClientRect();
                const pad = 12;
                if (rect.bottom > cardRect.bottom - pad) {
                    modalCard.scrollTop += rect.bottom - cardRect.bottom + pad;
                } else if (rect.top < cardRect.top + pad) {
                    modalCard.scrollTop -= cardRect.top - rect.top + pad;
                }
            });
            authorFilterBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleAuthorDropdown(); });
            const confirmOk = document.getElementById('confirmOk');
            const confirmCancel = document.getElementById('confirmCancel');
            if (confirmOk) {
                confirmOk.addEventListener('click', () => {
                    if (pendingDelete && db) {
                        const { dateKey, entryId, commentId } = pendingDelete;
                        db.ref(`poopSchedule/${dateKey}/${entryId}/comments/${commentId}`).remove();
                    }
                    closeConfirmModal();
                });
            }
            if (confirmCancel) {
                confirmCancel.addEventListener('click', () => closeConfirmModal());
            }

            form.addEventListener('submit', (e) => {
                e.preventDefault();
                const formData = new FormData(form);
                const durationSeconds = Number(formData.get('durationSeconds') || 0);
                if (!durationSeconds) {
                    alert('–£–∫–∞–∂–∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ–∫–∞–∫–∞.');
                    return;
                }
                const sizeVal = Number(formData.get('size') || 0);
                if (!sizeVal) {
                    alert('–£–∫–∞–∂–∏ —Ä–∞–∑–º–µ—Ä –ø–æ–∫–∞–∫–∞.');
                    return;
                }
                const dateKey = editingEntry ? editingEntry.dateKey : formatDateKey(selectedDate);
                const existing = editingEntry && entries && entries[dateKey] && entries[dateKey][editingEntry.id] ? entries[dateKey][editingEntry.id] : {};
                const commentText = (formData.get('comment') || '').trim();
                const base = {
                    time: formData.get('time'),
                    duration: Math.floor(durationSeconds / 60),
                    durationSeconds,
                    paper: Number(formData.get('paper')),
                    ease: Number(formData.get('ease')),
                    satisfaction: Number(formData.get('satisfaction')),
                    size: sizeVal,
                    bristol: Number(formData.get('bristol')),
                    comment: commentText,
                    drawing: formData.get('drawing') || '',
                    createdAt: existing.createdAt || new Date().toISOString(),
                    author: currentUser ? currentUser.username : '',
                    authorName: anonymityOn ? '–ê–Ω–æ–Ω–∏–º' : (currentUser ? currentUser.name : '–ê–Ω–æ–Ω–∏–º')
                };
                if (!db) return alert('–°–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, –ø–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ.');

                if (editingEntry) {
                    db.ref(`poopSchedule/${editingEntry.dateKey}/${editingEntry.id}`).set(base);
                } else {
                    db.ref(`poopSchedule/${dateKey}`).push(base);
                }

                editingEntry = null;
                closeModal();
            });

            // Init
            initDrawing();
            renderBristolOptions();
            buildTimeWheel();
            buildTimeSelectOptions();
            makeCustomSelect(timeSelect);
            buildDurationWheel();
            buildPaperWheel();
            highlightViewButtons();
            const initTime = defaultTime();
            const normalizedInitTime = timeInputMode === 'list' ? snapTimeToQuarter(initTime) : initTime;
            setTime(normalizedInitTime);
            setTimeInputMode(timeInputMode);
            setDurationSeconds(0);
            setPaperValue(1);
            requestAnimationFrame(() => setTime(normalizedInitTime));
            initFirebase();
            renderCalendar();
            renderEntries();
            authorFilterLabel.textContent = selectedAuthor === 'all' ? '–í—Å–µ' : selectedAuthor;
            updateModalVh();
            window.addEventListener('resize', updateModalVh);
            if (window.visualViewport) {
                window.visualViewport.addEventListener('resize', updateModalVh);
                window.visualViewport.addEventListener('scroll', updateModalVh);
            }
            window.addEventListener('resize', () => {
                if (gameModal && !gameModal.classList.contains('hidden')) {
                    setupGameCanvas();
                }
            });
            window.addEventListener('load', () => {
                if (isSmallScreen()) {
                    lockViewportScale();
                }
                setTimeout(normalizeViewportScale, 0);
            });
            if (window.visualViewport) {
                window.visualViewport.addEventListener('resize', normalizeViewportScale);
            }
        })();
    </script>
</body>
</html>
