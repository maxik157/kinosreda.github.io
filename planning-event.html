<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ ‚Äî –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect x='20' y='30' width='45' height='55' rx='5' fill='none' stroke='%23b45309' stroke-width='4'/%3E%3Crect x='22' y='45' width='41' height='38' rx='3' fill='%23f59e0b'/%3E%3Cellipse cx='42' cy='35' rx='24' ry='8' fill='%23fff'/%3E%3Ccircle cx='30' cy='33' r='5' fill='%23fff'/%3E%3Ccircle cx='45' cy='31' r='4' fill='%23fff'/%3E%3Ccircle cx='55' cy='34' r='4' fill='%23fff'/%3E%3Cpath d='M65 38 Q85 38 85 55 Q85 72 65 72' fill='none' stroke='%23b45309' stroke-width='5' stroke-linecap='round'/%3E%3C/svg%3E" />

    <script>
        // Auth gate
        (function () {
            try {
                const cu = localStorage.getItem('currentUser');
                if (!cu) {
                    location.replace('login.html');
                    return;
                }
                document.documentElement.classList.add('authed');
            } catch (e) {
                location.replace('login.html');
            }
        })();
        // Theme gate
        (function(){
            try { document.documentElement.dataset.theme = localStorage.getItem('siteTheme') || 'beer'; } catch(_) {}
        })();
    </script>
    <style>
        html:not(.authed) body { visibility: hidden; }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        (function(){
            const html = document.documentElement;
            const KEY = 'logoFontFamily';
            const DEFAULT = 'Rubik Wet Paint';
            const LINK_ID = 'logoFontGF';

            function familyToHref(fam){
                const q = encodeURIComponent(fam).replace(/%20/g, '+');
                return `https://fonts.googleapis.com/css2?family=${q}&display=swap`;
            }

            function ensureStylesheet(fam){
                const family = (fam || DEFAULT).trim();
                if (!family) return;
                const href = familyToHref(family);
                let link = document.getElementById(LINK_ID);
                if (!link) {
                    link = document.createElement('link');
                    link.id = LINK_ID;
                    link.rel = 'stylesheet';
                    document.head.appendChild(link);
                }
                if (link.getAttribute('href') !== href) link.setAttribute('href', href);
            }

            function markReady(){
                html.classList.add('logo-font-ready');
                html.classList.remove('logo-font-loading');
            }

            function waitForFont(fam){
                const family = (fam || DEFAULT).trim();
                if (!family) return markReady();

                ensureStylesheet(family);

                html.classList.add('logo-font-loading');
                html.classList.remove('logo-font-ready');
                try {
                    if (document.fonts && document.fonts.load) {
                        document.fonts.load(`1em "${family}"`).then(markReady, markReady);
                    } else {
                        setTimeout(markReady, 1);
                    }
                } catch (_) {
                    markReady();
                }
            }

            try {
                const fam = localStorage.getItem(KEY) || DEFAULT;
                html.style.setProperty('--logo-font', `'${fam}'`);
                waitForFont(fam);
            } catch(_) {
                markReady();
            }
        })();
    </script>

    <style>
        html:not(.logo-font-ready) .logo-text { opacity: 0; }
        .logo-text { transition: opacity 0.15s ease; }

        html, body {
            background: #000;
            overflow-x: hidden;
            overscroll-behavior: none;
        }
        body {
            font-family: 'Comfortaa', cursive;
            color: #fff;
            min-height: 100vh;
        }
        @font-face {
            font-family: 'Egyptian Bold Extended';
            src: local('Egyptian Bold Extended'), local('Egyptian Bold Extended Regular');
            font-weight: 700;
            font-style: normal;
            font-display: swap;
        }
        :root {
            --logo-font: 'Rubik Wet Paint';
            --accent-200: #fde68a;
            --accent-300: #fcd34d;
            --accent-400: #f59e0b;
            --accent-500: #f59e0b;
            --logo-glow-1: rgba(245,158,11,0.50);
            --logo-glow-2: rgba(245,158,11,0.80);
            --logo-glow-3: rgba(245,158,11,0.40);
            --accent-border-10: rgba(245,158,11,0.10);
            --accent-border-20: rgba(245,158,11,0.20);
            --accent-border-25: rgba(245,158,11,0.25);
            --accent-border-30: rgba(245,158,11,0.30);
            --accent-border-50: rgba(245,158,11,0.50);
            --accent-soft: rgba(245,158,11,0.12);
        }
        html[data-theme="white"] {
            --accent-200: #ffffff;
            --accent-300: #e5e7eb;
            --accent-400: #ffffff;
            --accent-500: #ffffff;
            --logo-glow-1: rgba(255,255,255,0.45);
            --logo-glow-2: rgba(255,255,255,0.75);
            --logo-glow-3: rgba(255,255,255,0.35);
            --accent-border-10: rgba(255,255,255,0.18);
            --accent-border-20: rgba(255,255,255,0.26);
            --accent-border-25: rgba(255,255,255,0.30);
            --accent-border-30: rgba(255,255,255,0.34);
            --accent-border-50: rgba(255,255,255,0.55);
            --accent-soft: rgba(255,255,255,0.10);
        }
        .text-amber-400 { color: var(--accent-400) !important; }
        .text-amber-300 { color: var(--accent-300) !important; }
        .text-amber-200 { color: var(--accent-200) !important; }
        .text-amber-500 { color: var(--accent-500) !important; }
        .border-amber-500\/10 { border-color: var(--accent-border-10) !important; }
        .border-amber-500\/20 { border-color: var(--accent-border-20) !important; }
        .border-amber-500\/25 { border-color: var(--accent-border-25) !important; }
        .border-amber-500\/30 { border-color: var(--accent-border-30) !important; }
        .border-amber-500\/50 { border-color: var(--accent-border-50) !important; }
        .bg-amber-500\/10 { background-color: var(--accent-soft) !important; }
        .hover\\:bg-amber-500\\/10:hover { background-color: var(--accent-soft) !important; }
        #logoText { fill: var(--accent-500) !important; }

        .logo-text { font-family: var(--logo-font), 'Comfortaa', cursive; font-weight: 400; letter-spacing: 0.02em; }
        @keyframes pulse-glow {
            0%, 100% { filter: drop-shadow(0 0 5px var(--logo-glow-1)); }
            50% { filter: drop-shadow(0 0 15px var(--logo-glow-2)) drop-shadow(0 0 30px var(--logo-glow-3)); }
        }
        .pulse-glow { animation: pulse-glow 3s ease-in-out infinite; }

        .bg-dark { background: #000; position: relative; }
        .bg-dark::before {
            content: '';
            position: fixed;
            inset: 0;
            background:
                radial-gradient(ellipse at 10% 0%, rgba(245, 158, 11, 0.10) 0%, transparent 50%),
                radial-gradient(ellipse at 90% 100%, rgba(245, 158, 11, 0.08) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }
        .glow {
            box-shadow: 0 0 0 1px rgba(245,158,11,0.12), 0 18px 50px rgba(245,158,11,0.08);
        }
        .card {
            background: rgba(8, 8, 8, 0.75);
            border: 1px solid var(--accent-border-20);
            border-radius: 18px;
            backdrop-filter: blur(8px);
            overflow: visible;
            position: relative;
            z-index: 0;
            isolation: isolate;
        }

        .card.card-elevated {
            z-index: 2000;
        }

        .sheet {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            overflow: visible;
        }
        .table-scroll {
            width: 100%;
        }
        @media (max-width: 768px) {
            .table-scroll {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            .table-scroll .sheet {
                min-width: 720px;
            }
        }
        .sheet th,
        .sheet td {
            border: 1px solid var(--accent-border-20);
            padding: 8px 10px;
            text-align: left;
            vertical-align: middle;
            position: relative;
            overflow: visible;
        }
        .cell-truncate {
            display: block;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .sheet th[data-col-id="item"],
        .sheet td[data-col-id="item"] {
            min-width: 200px;
        }
        @media (max-width: 768px) {
            .sheet th[data-col-id="item"],
            .sheet td[data-col-id="item"] {
                min-width: 240px;
                white-space: normal;
                word-break: break-word;
            }
        }
        .sheet th {
            background: rgba(245,158,11,0.16);
            color: var(--accent-200);
            font-size: 0.75rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
        }
        .col-drag {
            cursor: grab;
        }
        .col-drag.dragging {
            opacity: 0.6;
            cursor: grabbing;
        }
        .col-drag-over {
            outline: 2px dashed rgba(245,158,11,0.5);
            outline-offset: -2px;
        }
        .col-dragging,
        .col-dragging * {
            cursor: grabbing !important;
            user-select: none;
        }
        .sort-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            user-select: none;
        }
        .filter-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 2px 6px;
            border-radius: 999px;
            border: 1px solid var(--accent-border-20);
            color: var(--accent-200);
            font-size: 10px;
        }
        .filter-btn.active {
            background: rgba(245,158,11,0.2);
            border-color: rgba(245,158,11,0.45);
        }
        .sort-indicator {
            font-size: 0.7rem;
            color: #fcd34d;
        }
        .sheet input,
        .sheet select {
            width: 100%;
            background: transparent;
            color: #fff;
            outline: none;
        }
        .sheet input::placeholder {
            color: rgba(156,163,175,0.8);
        }
        .section-head {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
            position: relative;
            z-index: 10;
            background: rgba(0,0,0,0.65);
            padding: 6px 0;
            backdrop-filter: blur(4px);
            transition: opacity 220ms ease;
        }
        .section-head-wrap {
            position: relative;
        }
        .sticky-portal {
            position: fixed;
            top: 0;
            left: 0;
            width: 0;
            height: 0;
            z-index: 5000;
            opacity: 0;
            pointer-events: none;
            transition: none;
            will-change: opacity;
        }
        .sticky-portal.visible {
            pointer-events: auto;
        }
        .sticky-wrap {
            position: fixed;
            box-sizing: border-box;
            background: #0b0b0b;
            border: 1px solid var(--accent-border-20);
            border-bottom: 0;
            border-radius: 0;
            overflow: hidden;
            transform: translateY(0);
            transition: none;
            will-change: transform;
        }
        .sticky-head,
        .sticky-table {
            position: relative;
            box-sizing: border-box;
        }
        .sticky-head .section-head {
            width: 100%;
            margin: 0 0 10px 0;
            background: transparent !important;
            backdrop-filter: none !important;
        }
        .sticky-table .sheet {
            width: 100%;
            margin: 0;
        }
        .sticky-table .sheet th {
            background: #241606;
        }
        .card.sticky-active {
            border-top-width: 0;
            border-top-left-radius: 0;
            border-top-right-radius: 0;
        }
        .sticky-table {
            border-left: 0;
            border-right: 0;
        }
        thead.sticky-collapsed { pointer-events: none; }
        .sticky-hidden {
            opacity: 0;
            pointer-events: none;
            visibility: hidden;
            transition: none;
        }
        .section-title {
            font-weight: 700;
            color: var(--accent-200);
            font-size: 1.05rem;
        }
        .section-drag-handle {
            cursor: grab;
            user-select: none;
        }
        .section-dragging {
            opacity: 0.6;
        }
        .section-drop-target {
            outline: 2px dashed rgba(245,158,11,0.45);
            outline-offset: -4px;
        }
        .empty-row {
            color: #9ca3af;
            font-size: 0.85rem;
            text-align: center;
        }
        .owner-wrap {
            position: relative;
            min-width: 160px;
            z-index: 20;
        }
        .owner-wrap.menu-open { z-index: 120; }
        .owner-display {
            width: 100%;
            text-align: left;
            padding: 6px 10px;
            border-radius: 8px;
            border: 1px solid var(--accent-border-20);
            background: rgba(0,0,0,0.3);
            color: #fff;
            font-size: 0.85rem;
        }
        .owner-menu {
            position: absolute;
            top: calc(100% + 6px);
            left: 0;
            z-index: 5000;
            width: 100%;
            max-height: 180px;
            overflow-y: auto;
            background: rgba(5,5,5,0.95);
            border: 1px solid var(--accent-border-30);
            border-radius: 12px;
            padding: 6px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.45);
        }
        .owner-opt {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            text-align: left;
            padding: 6px 8px;
            border-radius: 8px;
            color: #e5e7eb;
            font-size: 0.85rem;
            background: rgba(0,0,0,0.4);
        }
        .menu-portal {
            position: fixed;
            z-index: 9999;
        }
        .cell-tooltip {
            position: fixed;
            z-index: 10050;
            max-width: min(320px, 80vw);
            padding: 6px 10px;
            border-radius: 10px;
            background: rgba(15, 15, 15, 0.96);
            border: 1px solid var(--accent-border-30);
            color: #f3f4f6;
            font-size: 12px;
            line-height: 1.3;
            box-shadow: 0 12px 28px rgba(0,0,0,0.35);
            opacity: 0;
            pointer-events: none;
            transition: opacity 120ms ease;
        }
        .cell-tooltip.visible { opacity: 1; }
        .owner-opt:hover {
            background: rgba(245,158,11,0.12);
            color: var(--accent-200);
        }
        .owner-opt input {
            width: 14px;
            height: 14px;
        }
        .beer-select {
            position: relative;
            min-width: 160px;
            z-index: 20;
        }
        .beer-select.menu-open { z-index: 120; }
        .beer-btn {
            width: 100%;
            text-align: left;
            padding: 6px 10px;
            border-radius: 8px;
            border: 1px solid var(--accent-border-20);
            background: rgba(0,0,0,0.3);
            color: #fff;
            font-size: 0.85rem;
        }
        .beer-menu {
            position: absolute;
            top: calc(100% + 6px);
            left: 0;
            z-index: 5000;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            background: rgba(5,5,5,0.95);
            border: 1px solid var(--accent-border-30);
            border-radius: 12px;
            padding: 6px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.45);
        }
        .beer-opt {
            width: 100%;
            text-align: left;
            padding: 6px 8px;
            border-radius: 8px;
            color: #e5e7eb;
            font-size: 0.85rem;
            background: rgba(0,0,0,0.4);
        }
        .beer-opt:hover {
            background: rgba(245,158,11,0.12);
            color: var(--accent-200);
        }
        .icon-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 6px;
            border: 1px solid var(--accent-border-20);
            color: #fca5a5;
            background: rgba(0,0,0,0.35);
        }
        .icon-btn-edit {
            color: #fcd34d;
        }
        .icon-btn:hover {
            background: rgba(248,113,113,0.15);
            color: #fecaca;
        }
        .section-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }
        .section-menu {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            width: 220px;
            background: rgba(8,8,8,0.96);
            border: 1px solid var(--accent-border-30);
            border-radius: 12px;
            padding: 8px;
            z-index: 80;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
        }
        .section-menu button {
            width: 100%;
            text-align: left;
            padding: 8px 10px;
            border-radius: 8px;
            color: #e5e7eb;
            font-size: 0.9rem;
        }
        .section-menu button:hover {
            background: rgba(245,158,11,0.12);
            color: var(--accent-200);
        }
        .row-closed td {
            background: rgba(34,197,94,0.12);
        }
        .owner-name-self {
            color: var(--accent-200);
            background: rgba(245,158,11,0.18);
            border: 1px solid rgba(245,158,11,0.35);
            border-radius: 999px;
            padding: 0 6px;
            margin-right: 2px;
        }
        .row-toggle {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 22px;
            height: 22px;
            border-radius: 6px;
            border: 1px solid rgba(34,197,94,0.35);
            color: #86efac;
            background: rgba(34,197,94,0.12);
            margin-right: 6px;
        }
        .item-cell {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .item-cell input,
        .item-cell .beer-select {
            flex: 1;
            min-width: 0;
        }
        .row-toggle.active {
            background: rgba(34,197,94,0.35);
            color: #052e16;
            border-color: rgba(34,197,94,0.7);
        }
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 70;
        }
        .modal.active { display: flex; }
        .modal-card {
            width: min(92vw, 460px);
            background: rgba(8,8,8,0.95);
            border: 1px solid var(--accent-border-30);
            border-radius: 18px;
            padding: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
        }
        .modal-input {
            width: 100%;
            background: rgba(0,0,0,0.4);
            border: 1px solid var(--accent-border-30);
            border-radius: 12px;
            padding: 10px 12px;
            color: #fff;
            outline: none;
        }
        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 16px;
        }
        .modal-list {
            display: grid;
            gap: 8px;
            margin-top: 10px;
        }
        .modal-row {
            display: grid;
            grid-template-columns: 1fr 170px 36px;
            gap: 8px;
            align-items: center;
        }
        @media (max-width: 520px) {
            .modal-row {
                grid-template-columns: 1fr;
            }
        }
        .cs {
            position: relative;
            width: 100%;
        }
        .cs-btn {
            width: 100%;
            text-align: left;
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px solid var(--accent-border-30);
            background: rgba(0,0,0,0.4);
            color: #fff;
        }
        .cs-menu {
            position: absolute;
            top: calc(100% + 6px);
            left: 0;
            right: 0;
            z-index: 80;
            background: rgba(5,5,5,0.95);
            border: 1px solid var(--accent-border-30);
            border-radius: 12px;
            padding: 6px;
            max-height: 200px;
            overflow-y: auto;
        }
        .cs-opt {
            width: 100%;
            text-align: left;
            padding: 8px 10px;
            border-radius: 8px;
            color: #e5e7eb;
        }
        .cs-opt:hover {
            background: rgba(245,158,11,0.12);
            color: var(--accent-200);
        }
    </style>
</head>
<body class="bg-dark min-h-screen">
    <header class="py-2 md:py-4 relative z-50 sticky top-0 bg-black/95 backdrop-blur-sm border-b border-amber-500/10">
        <div class="container mx-auto px-3 md:px-4 max-w-7xl flex flex-col md:flex-row justify-between items-center gap-2 md:gap-4">
            <div class="flex items-center gap-3 pl-2">
                <svg class="w-[220px] md:w-[360px] h-12 md:h-20 float pulse-glow flex-shrink-0" viewBox="0 0 580 120" style="overflow: visible;">
                    <defs>
                        <linearGradient id="beerGradPlanEvent" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" style="stop-color:#fcd34d"/>
                            <stop offset="50%" style="stop-color:#fbbf24"/>
                            <stop offset="100%" style="stop-color:#d97706"/>
                        </linearGradient>
                        <linearGradient id="foamGradPlanEvent" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" style="stop-color:#ffffff"/>
                            <stop offset="100%" style="stop-color:#fef3c7"/>
                        </linearGradient>
                        <clipPath id="mugClipPlanEvent"><rect x="0" y="0" width="50" height="55" rx="3"/></clipPath>
                        <filter id="glowPlanEvent">
                            <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
                            <feMerge>
                                <feMergeNode in="coloredBlur"/>
                                <feMergeNode in="SourceGraphic"/>
                            </feMerge>
                        </filter>
                    </defs>

                    <a href="index.html" aria-label="–ù–∞ –≥–ª–∞–≤–Ω—É—é" style="cursor:pointer;">
                        <text id="logoText" x="28" y="78" text-anchor="start" class="logo-text" fill="var(--accent-500)" font-size="62" textLength="395" lengthAdjust="spacingAndGlyphs" filter="url(#glowPlanEvent)">–ö–ò–ù–û–°–†–ï–î–ê</text>
                    </a>

                    <g id="logoMug" transform="translate(438, 2)">
                        <rect x="0" y="25" width="50" height="60" rx="5" fill="none" stroke="rgba(180,83,9,0.95)" stroke-width="3"/>
                        <g clip-path="url(#mugClipPlanEvent)" transform="translate(0, 30)">
                            <rect x="0" y="55" height="0" width="50" fill="url(#beerGradPlanEvent)">
                                <animate attributeName="height" from="0" to="55" dur="2.5s" fill="freeze"/>
                                <animate attributeName="y" from="55" to="0" dur="2.5s" fill="freeze"/>
                            </rect>
                        </g>
                        <g opacity="0"><animate attributeName="opacity" from="0" to="1" dur="0.5s" begin="2s" fill="freeze"/>
                            <ellipse cx="25" cy="27" rx="27" ry="10" fill="url(#foamGradPlanEvent)"/>
                            <circle cx="12" cy="24" r="6" fill="white" opacity="0.95"/>
                            <circle cx="28" cy="22" r="5" fill="white" opacity="0.9"/>
                            <circle cx="40" cy="25" r="5" fill="white" opacity="0.9"/>
                        </g>
                        <path d="M50 32 Q72 32 72 55 Q72 78 50 78" fill="none" stroke="#b45309" stroke-width="5" stroke-linecap="round"/>
                    </g>
                </svg>
            </div>

            <div class="flex items-center gap-1 md:gap-3 flex-nowrap whitespace-nowrap justify-center">
                <a href="planning.html" class="text-amber-400 hover:text-amber-300 transition font-medium text-xs md:text-sm px-2 md:px-3 py-1 md:py-2 rounded-lg hover:bg-amber-500/10 flex items-center gap-1 md:gap-2">
                    <span>‚Üê</span> <span class="hidden sm:inline">–ö —Å–ø–∏—Å–∫—É</span>
                </a>
                <a href="planning.html" class="text-amber-400 transition font-medium text-xs md:text-sm px-2 md:px-3 py-1 md:py-2 rounded-lg bg-amber-500/10 flex items-center gap-1 md:gap-2" title="–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ">
                    <span>üå¥</span>
                </a>
                <a href="profile.html" class="text-amber-400 hover:text-amber-300 transition font-medium text-xs md:text-sm px-2 md:px-3 py-1 md:py-2 rounded-lg hover:bg-amber-500/10 flex items-center gap-1 md:gap-2" title="–ü—Ä–æ—Ñ–∏–ª—å">
                    <span>üë§</span> <span id="profileName" class="hidden sm:inline"></span>
                </a>
                <button onclick="logout()" class="text-red-400 hover:text-red-300 transition font-medium text-xs md:text-sm px-2 md:px-3 py-1 md:py-2 rounded-lg hover:bg-red-500/10">
                    <span class="sm:hidden">üö™</span><span class="hidden sm:inline">–í—ã–π—Ç–∏</span>
                </button>
            </div>
        </div>
    </header>

    <main class="relative z-10 container mx-auto max-w-7xl px-3 md:px-4 py-6 md:py-8">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
            <div>
                <div class="text-gray-400 text-xs">–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</div>
                <h1 id="eventTitle" class="text-2xl md:text-3xl font-bold text-amber-400">‚Äî</h1>
                <p class="text-gray-400 text-sm mt-1">–°–æ–±–∏—Ä–∞–π—Ç–µ —Å–ø–∏—Å–æ–∫ –≤–µ—â–µ–π –ø–æ —Ä–∞–∑–¥–µ–ª–∞–º.</p>
            </div>
            <div class="flex flex-wrap gap-2">
                <div class="relative">
                    <button id="addSectionBtn" class="bg-amber-500/10 hover:bg-amber-500/20 text-amber-300 border border-amber-500/30 px-4 py-2 rounded-xl text-sm font-semibold transition">
                        + –î–æ–±–∞–≤–∏—Ç—å —Ä–∞–∑–¥–µ–ª
                    </button>
                    <div id="sectionMenu" class="section-menu hidden"></div>
                </div>
            </div>
        </div>

        <div id="sectionsContainer" class="space-y-5"></div>
        <div id="emptySections" class="text-gray-400 text-sm mt-6 hidden">–†–∞–∑–¥–µ–ª–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç. –ù–∞–∂–º–∏—Ç–µ ¬´–î–æ–±–∞–≤–∏—Ç—å —Ä–∞–∑–¥–µ–ª¬ª –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω—ã–π.</div>
        <div id="missingEvent" class="text-gray-400 text-sm mt-6 hidden">–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –í–µ—Ä–Ω–∏—Ç–µ—Å—å –≤ —Å–ø–∏—Å–æ–∫ –∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤–æ–µ.</div>
    </main>

    <div id="ownerMenuPortal" class="owner-menu menu-portal hidden"></div>
    <div id="beerMenuPortal" class="beer-menu menu-portal hidden"></div>
    <div id="cellTooltip" class="cell-tooltip"></div>
    <div id="stickyPortal" class="sticky-portal">
        <div id="stickyWrap" class="sticky-wrap">
            <div id="stickyHead" class="sticky-head"></div>
            <div id="stickyTableHead" class="sticky-table"></div>
        </div>
    </div>

    <div class="modal" id="addColumnModal" role="dialog" aria-modal="true" aria-labelledby="addColumnTitle">
        <div class="modal-card">
            <h3 id="addColumnTitle" class="text-lg font-semibold text-amber-200">–ù–æ–≤—ã–π —Å—Ç–æ–ª–±–µ—Ü</h3>
            <p class="text-xs text-gray-400 mt-1">–£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —Ç–∏–ø —Å—Ç–æ–ª–±—Ü–∞.</p>
            <input id="columnNameInput" class="modal-input mt-4" type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç–æ–ª–±—Ü–∞" />
            <div class="mt-3">
                <div class="text-xs text-gray-400 mb-2">–¢–∏–ø —Å—Ç–æ–ª–±—Ü–∞</div>
                <div class="cs" id="columnTypeSelect">
                    <button type="button" class="cs-btn" id="columnTypeBtn">–°—Ç—Ä–æ–∫–∞</button>
                    <div class="cs-menu hidden" id="columnTypeMenu"></div>
                </div>
            </div>
            <div class="modal-actions">
                <button id="cancelColumnBtn" class="flex-1 px-4 py-2 rounded-xl border border-gray-600 text-gray-300 hover:text-white hover:border-amber-400 transition">–û—Ç–º–µ–Ω–∞</button>
                <button id="createColumnBtn" class="flex-1 px-4 py-2 rounded-xl bg-amber-500/20 text-amber-200 border border-amber-500/40 hover:bg-amber-500/30 transition font-semibold">–°–æ–∑–¥–∞—Ç—å</button>
            </div>
        </div>
    </div>

    <div class="modal" id="editColumnModal" role="dialog" aria-modal="true" aria-labelledby="editColumnTitle">
        <div class="modal-card">
            <h3 id="editColumnTitle" class="text-lg font-semibold text-amber-200">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–æ–ª–±–µ—Ü</h3>
            <p class="text-xs text-gray-400 mt-1">–°–º–µ–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–ª–∏ —Ç–∏–ø –ø–æ–ª—è.</p>
            <input id="editColumnNameInput" class="modal-input mt-4" type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç–æ–ª–±—Ü–∞" />
            <div class="mt-3">
                <div class="text-xs text-gray-400 mb-2">–¢–∏–ø —Å—Ç–æ–ª–±—Ü–∞</div>
                <div class="cs" id="editColumnTypeSelect">
                    <button type="button" class="cs-btn" id="editColumnTypeBtn">–°—Ç—Ä–æ–∫–∞</button>
                    <div class="cs-menu hidden" id="editColumnTypeMenu"></div>
                </div>
            </div>
            <div class="modal-actions">
                <button id="cancelEditColumnBtn" class="flex-1 px-4 py-2 rounded-xl border border-gray-600 text-gray-300 hover:text-white hover:border-amber-400 transition">–û—Ç–º–µ–Ω–∞</button>
                <button id="saveEditColumnBtn" class="flex-1 px-4 py-2 rounded-xl bg-amber-500/20 text-amber-200 border border-amber-500/40 hover:bg-amber-500/30 transition font-semibold">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <div class="modal" id="deleteSectionModal" role="dialog" aria-modal="true" aria-labelledby="deleteSectionTitle">
        <div class="modal-card">
            <h3 id="deleteSectionTitle" class="text-lg font-semibold text-red-200">–£–¥–∞–ª–∏—Ç—å —Ä–∞–∑–¥–µ–ª?</h3>
            <p class="text-sm text-gray-300 mt-2">–†–∞–∑–¥–µ–ª <span id="deleteSectionName" class="text-amber-200 font-semibold"></span> –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω –≤–º–µ—Å—Ç–µ —Å–æ –≤—Å–µ–º–∏ —Å—Ç—Ä–æ–∫–∞–º–∏.</p>
            <div class="modal-actions">
                <button id="cancelDeleteSectionBtn" class="flex-1 px-4 py-2 rounded-xl border border-gray-600 text-gray-300 hover:text-white hover:border-amber-400 transition">–û—Ç–º–µ–Ω–∞</button>
                <button id="confirmDeleteSectionBtn" class="flex-1 px-4 py-2 rounded-xl bg-red-500/20 text-red-200 border border-red-500/40 hover:bg-red-500/30 transition font-semibold">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <div class="modal" id="deleteColumnModal" role="dialog" aria-modal="true" aria-labelledby="deleteColumnTitle">
        <div class="modal-card">
            <h3 id="deleteColumnTitle" class="text-lg font-semibold text-red-200">–£–¥–∞–ª–∏—Ç—å —Å—Ç–æ–ª–±–µ—Ü?</h3>
            <p class="text-sm text-gray-300 mt-2">–°—Ç–æ–ª–±–µ—Ü <span id="deleteColumnName" class="text-amber-200 font-semibold"></span> —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã–µ. –û–Ω–∏ –±—É–¥—É—Ç —É—Ç–µ—Ä—è–Ω—ã.</p>
            <div class="modal-actions">
                <button id="cancelDeleteColumnBtn" class="flex-1 px-4 py-2 rounded-xl border border-gray-600 text-gray-300 hover:text-white hover:border-amber-400 transition">–û—Ç–º–µ–Ω–∞</button>
                <button id="confirmDeleteColumnBtn" class="flex-1 px-4 py-2 rounded-xl bg-red-500/20 text-red-200 border border-red-500/40 hover:bg-red-500/30 transition font-semibold">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <div class="modal" id="newSectionModal" role="dialog" aria-modal="true" aria-labelledby="newSectionTitle">
        <div class="modal-card">
            <h3 id="newSectionTitle" class="text-lg font-semibold text-amber-200">–ù–æ–≤—ã–π —Ä–∞–∑–¥–µ–ª</h3>
            <p class="text-xs text-gray-400 mt-1">–£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞ –∏ –Ω–∞–±–æ—Ä –∫–æ–ª–æ–Ω–æ–∫.</p>
            <input id="newSectionNameInput" class="modal-input mt-4" type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞" />

            <div class="mt-3">
                <div class="text-xs text-gray-400 mb-2">–ö–æ–ª–æ–Ω–∫–∏</div>
                <div id="newSectionColumns" class="modal-list"></div>
                <button id="addSectionColumnBtn" class="mt-2 w-full px-3 py-2 rounded-xl border border-amber-500/30 text-amber-300 hover:text-amber-200 hover:border-amber-400 transition text-sm">+ –î–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É</button>
            </div>

            <div class="modal-actions">
                <button id="cancelNewSectionBtn" class="flex-1 px-4 py-2 rounded-xl border border-gray-600 text-gray-300 hover:text-white hover:border-amber-400 transition">–û—Ç–º–µ–Ω–∞</button>
                <button id="createNewSectionBtn" class="flex-1 px-4 py-2 rounded-xl bg-amber-500/20 text-amber-200 border border-amber-500/40 hover:bg-amber-500/30 transition font-semibold">–°–æ–∑–¥–∞—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBwp4ZNbJuUM5sY0qMffvZTHr2PDvc2iLc",
            authDomain: "kinosreda-ce8ef.firebaseapp.com",
            databaseURL: "https://kinosreda-ce8ef-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "kinosreda-ce8ef",
            storageBucket: "kinosreda-ce8ef.firebasestorage.app",
            messagingSenderId: "889337905300",
            appId: "1:889337905300:web:325aea2f3fb3c6b44a7481",
            measurementId: "G-MGW6GF67H3"
        };

        const defaultColumns = [
            { id: 'item', name: '–í–µ—â—å', type: 'text' },
            { id: 'qty', name: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ', type: 'number' },
            { id: 'owner', name: '–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π', type: 'owners' },
            { id: 'cost', name: '–°—Ç–æ–∏–º–æ—Å—Ç—å', type: 'cost' }
        ];

        const sectionColumnOverrides = {
            '–ü–∏–≤–æ': {
                item: '–ü–∏–≤–æ',
                owner: '–í–ª–∞–¥–µ–ª–µ—Ü'
            },
            '–ï–¥–∞': {
                item: '–ü—Ä–æ–¥—É–∫—Ç'
            }
        };

        const presetSections = ['–û–±—â–∏–µ –≤–µ—â–∏', '–õ–∏—á–Ω—ã–µ –≤–µ—â–∏', '–ï–¥–∞', '–ü–∏–≤–æ', '–†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏'];
        const presetSectionColumns = {
            '–†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏': [
                { id: 'item', name: '–í–µ—â—å', type: 'text' },
                { id: 'qty', name: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ', type: 'number' },
                { id: 'owner', name: '–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π', type: 'owners' },
                { id: 'cost', name: '–°—Ç–æ–∏–º–æ—Å—Ç—å', type: 'cost' }
            ]
        };

        let db = null;
        let eventId = null;
        let eventData = null;
        let currentUserName = '';
        let usersList = [];
        let beerList = [];
        let saveTimer = null;
        let suppressNextSnapshot = false;
        let activeOwnerTarget = null;
        let activeBeerTarget = null;
        let pendingEditColumn = null;
        let pendingDeleteColumn = null;
        let colDragState = null;
        let lastColDragAt = 0;
        let sectionDragState = null;
        let sectionAutoScrollRaf = null;
        let sectionAutoScrollSpeed = 0;
        let activeTooltipTarget = null;
        let newSectionColumnsDraft = [];
        const SORT_LS_PREFIX = 'planningSortState:';
        const ownerFilterState = {};
        let pendingColumnSectionId = null;
        let pendingDeleteSectionId = null;
        let sortState = {};
        let renderTick = 0;
        let stickySectionId = null;
        let stickyRenderTick = -1;
        const collator = new Intl.Collator('ru', { numeric: true, sensitivity: 'base' });
        const collatorEn = new Intl.Collator('en', { numeric: true, sensitivity: 'base' });
        const columnTypes = [
            { value: 'text', label: '–°—Ç—Ä–æ–∫–∞' },
            { value: 'number', label: '–ß–∏—Å–ª–æ' },
            { value: 'cost', label: '–°—Ç–æ–∏–º–æ—Å—Ç—å' },
            { value: 'owners', label: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏' }
        ];

        function initFirebase() {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            db = firebase.database();
        }

        function loadSortStateForEvent(id) {
            try {
                const raw = localStorage.getItem(`${SORT_LS_PREFIX}${id}`);
                return raw ? JSON.parse(raw) : {};
            } catch (_) {
                return {};
            }
        }

        function saveSortStateForEvent() {
            if (!eventId) return;
            try {
                localStorage.setItem(`${SORT_LS_PREFIX}${eventId}`, JSON.stringify(sortState || {}));
            } catch (_) {}
        }

        function loadEvent() {
            if (!eventId || !db) return;

            db.ref(`planning/events/${eventId}`).on('value', (snapshot) => {
                const event = snapshot.val();
                const missing = document.getElementById('missingEvent');
                if (!event) {
                    missing.classList.remove('hidden');
                } else {
                    missing.classList.add('hidden');
                }
                const title = event && event.name ? event.name : '–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ';
                document.getElementById('eventTitle').textContent = title;
            });

            db.ref(`planning/data/${eventId}`).on('value', (snapshot) => {
                const val = snapshot.val();
                if (suppressNextSnapshot && eventData) {
                    suppressNextSnapshot = false;
                    return;
                }
                if (!val || !val.sections) {
                    eventData = { sections: [] };
                    saveEventData();
                } else {
                    eventData = normalizeEventData(val);
                }
                renderSections();
            });
        }

        function normalizeEventData(data) {
            const sections = Array.isArray(data.sections) ? data.sections : Object.values(data.sections || {});
            const fallbackColumns = Array.isArray(data.columns) && data.columns.length ? data.columns : defaultColumns;
            return {
                sections: sections.map(sec => {
                    const sourceCols = sec.columns && sec.columns.length ? sec.columns : fallbackColumns;
                    const columns = sourceCols.map(col => ({
                        id: col.id || slugify(col.name || 'col'),
                        name: col.name || '–ö–æ–ª–æ–Ω–∫–∞',
                        type: col.type || (col.id === 'owner' ? 'owners' : 'text')
                    }));
                    const rows = (Array.isArray(sec.rows) ? sec.rows : Object.values(sec.rows || {})).map(row => {
                        const cells = row.cells || {};
                        const normalizedCells = { ...cells };
                        columns.forEach(col => {
                            if (col.type === 'owners' && normalizedCells[col.id] && !Array.isArray(normalizedCells[col.id])) {
                                normalizedCells[col.id] = String(normalizedCells[col.id]).split(',').map(v => v.trim()).filter(Boolean);
                            }
                        });
                        return {
                            id: row.id || `row_${Math.random().toString(36).slice(2, 6)}`,
                            cells: normalizedCells,
                            closed: !!row.closed
                        };
                    });
                    return {
                        id: sec.id || `sec_${Math.random().toString(36).slice(2, 6)}`,
                        name: sec.name || '–†–∞–∑–¥–µ–ª',
                        columns,
                        rows
                    };
                })
            };
        }

        function saveEventData() {
            if (!eventId || !db || !eventData) return;
            clearTimeout(saveTimer);
            const payload = JSON.parse(JSON.stringify(eventData));
            saveTimer = setTimeout(() => {
                suppressNextSnapshot = true;
                db.ref(`planning/data/${eventId}`).set(payload);
            }, 200);
        }

        function createRow(columns) {
            const cells = {};
            columns.forEach(col => { cells[col.id] = col.type === 'owners' ? [] : ''; });
            return { id: `row_${Date.now()}_${Math.random().toString(36).slice(2, 6)}`, cells };
        }

        function createSection(name, columnsOverride) {
            const cols = columnsOverride && columnsOverride.length ? columnsOverride : defaultColumns.map(col => ({ ...col }));
            return {
                id: `sec_${Date.now()}_${Math.random().toString(36).slice(2, 6)}`,
                name,
                columns: cols.map(col => ({ ...col })),
                rows: []
            };
        }

        function getCellText(row, col) {
            const raw = row.cells[col.id];
            if (col.type === 'owners') {
                const list = Array.isArray(raw) ? raw : (raw ? String(raw).split(',').map(v => v.trim()).filter(Boolean) : []);
                return list.join(', ');
            }
            return raw == null ? '' : String(raw);
        }

        function getTextGroup(text) {
            if (/^[A-Za-z]/.test(text)) return 0;
            if (/^[–ê-–Ø–∞-—è–Å—ë]/.test(text)) return 1;
            return 2;
        }

        function getSortedRows(section) {
            const state = sortState[section.id];
            if (!state) return section.rows.slice();
            const col = section.columns.find(c => c.id === state.colId);
            if (!col) return section.rows.slice();
            const dir = state.dir === 'desc' ? -1 : 1;
            return section.rows.slice().sort((a, b) => {
                const aval = getCellText(a, col).trim();
                const bval = getCellText(b, col).trim();
                if (col.type === 'number' || col.type === 'cost') {
                    const an = parseFloat(aval.replace(',', '.'));
                    const bn = parseFloat(bval.replace(',', '.'));
                    const aValid = !Number.isNaN(an);
                    const bValid = !Number.isNaN(bn);
                    if (!aValid && !bValid) return 0;
                    if (!aValid) return 1;
                    if (!bValid) return -1;
                    return dir * (an - bn);
                }
                if (!aval && !bval) return 0;
                if (!aval) return 1;
                if (!bval) return -1;
                const ga = getTextGroup(aval);
                const gb = getTextGroup(bval);
                if (ga !== gb) return dir * (ga - gb);
                const cmp = ga === 0 ? collatorEn.compare(aval, bval) : collator.compare(aval, bval);
                return dir * cmp;
            });
        }

        function filterRowsByOwner(section, rows) {
            if (!ownerFilterState[section.id] || !currentUserName) return rows;
            const ownerCol = section.columns.find(c => c.type === 'owners');
            if (!ownerCol) return rows;
            return rows.filter(row => {
                const raw = row.cells[ownerCol.id];
                const list = Array.isArray(raw) ? raw : (raw ? String(raw).split(',').map(v => v.trim()).filter(Boolean) : []);
                return list.includes(currentUserName);
            });
        }

        function formatOwnerLabel(list) {
            if (!list || !list.length) return '–í—ã–±—Ä–∞—Ç—å';
            return list.map((name) => {
                if (currentUserName && name === currentUserName) {
                    return `<span class="owner-name-self">${name}</span>`;
                }
                return name;
            }).join(', ');
        }

        function getTooltipText(el) {
            if (!el) return '';
            if (el.tagName === 'INPUT') return (el.value || '').trim();
            return (el.textContent || '').trim();
        }

        function showCellTooltip(target, x, y) {
            const tooltip = document.getElementById('cellTooltip');
            if (!tooltip) return;
            const text = getTooltipText(target);
            if (!text) return;
            tooltip.textContent = text;
            tooltip.classList.add('visible');
            positionCellTooltip(tooltip, x, y);
        }

        function hideCellTooltip() {
            const tooltip = document.getElementById('cellTooltip');
            if (!tooltip) return;
            tooltip.classList.remove('visible');
        }

        function positionCellTooltip(tooltip, x, y) {
            const pad = 12;
            const offset = 12;
            const rect = tooltip.getBoundingClientRect();
            const maxX = window.innerWidth - rect.width - pad;
            const maxY = window.innerHeight - rect.height - pad;
            let left = x + offset;
            let top = y + offset;
            if (left > maxX) left = Math.max(pad, x - rect.width - offset);
            if (top > maxY) top = Math.max(pad, y - rect.height - offset);
            tooltip.style.left = `${left}px`;
            tooltip.style.top = `${top}px`;
        }

        function isDefaultColumn(col) {
            return ['item', 'qty', 'owner', 'cost'].includes(col.id);
        }

        function renderSections() {
            const active = getActiveField();
            const container = document.getElementById('sectionsContainer');
            const empty = document.getElementById('emptySections');
            if (!eventData) return;

            container.innerHTML = '';
            if (!eventData.sections.length) {
                empty.classList.remove('hidden');
            } else {
                empty.classList.add('hidden');
            }

            eventData.sections.forEach(section => {
                const card = document.createElement('section');
                card.className = 'card glow p-4 md:p-5';
                card.dataset.sectionId = section.id;

                const header = document.createElement('div');
                header.className = 'section-head';
                header.innerHTML = `
                    <div class="section-title section-drag-handle" data-section-drag="${section.id}">${section.name}</div>
                    <div class="section-actions">
                        <button class="bg-amber-500/10 hover:bg-amber-500/20 text-amber-300 border border-amber-500/30 px-3 py-1.5 rounded-lg text-xs font-semibold transition" data-add-row="${section.id}">
                            + –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É
                        </button>
                        <button class="bg-amber-500/10 hover:bg-amber-500/20 text-amber-300 border border-amber-500/30 px-3 py-1.5 rounded-lg text-xs font-semibold transition" data-add-column="${section.id}">
                            + –î–æ–±–∞–≤–∏—Ç—å —Å—Ç–æ–ª–±–µ—Ü
                        </button>
                        <button class="bg-red-500/10 hover:bg-red-500/20 text-red-300 border border-red-500/30 px-3 py-1.5 rounded-lg text-xs font-semibold transition" data-delete-section="${section.id}">
                            –£–¥–∞–ª–∏—Ç—å —Ä–∞–∑–¥–µ–ª
                        </button>
                    </div>
                `;
                const headWrap = document.createElement('div');
                headWrap.className = 'section-head-wrap';
                headWrap.appendChild(header);
                card.appendChild(headWrap);

                const tableWrap = document.createElement('div');
                tableWrap.className = 'table-scroll';
                const table = document.createElement('table');
                table.className = 'sheet';
                table.dataset.sectionId = section.id;

                const thead = document.createElement('thead');
                const headRow = document.createElement('tr');
                section.columns.forEach(col => {
                    const override = sectionColumnOverrides[section.name];
                    const colLabel = (override && override[col.id]) ? override[col.id] : col.name;
                    const state = sortState[section.id];
                    const isSorted = state && state.colId === col.id;
                    const arrow = isSorted ? (state.dir === 'desc' ? '‚Üì' : '‚Üë') : '‚Üï';
                    const filterBtn = col.type === 'owners'
                        ? `<button class="filter-btn ${ownerFilterState[section.id] ? 'active' : ''}" data-owner-filter="${section.id}" title="–ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ –º–æ–∏">–ú–æ–∏</button>`
                        : '';
                    const canDeleteCol = col.id !== 'item';
                    const th = document.createElement('th');
                    th.classList.add('col-drag');
                    th.innerHTML = `
                        <div class="flex items-center justify-between gap-2">
                            <button class="sort-btn" data-sort-col="${col.id}" data-section-id="${section.id}">
                                <span>${colLabel}</span>
                                <span class="sort-indicator">${arrow}</span>
                            </button>
                            <div class="flex items-center gap-1">
                                ${filterBtn}
                                ${isDefaultColumn(col) ? '' : `<button class="icon-btn icon-btn-edit" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–æ–ª–±–µ—Ü" data-edit-column="${section.id}" data-col-id="${col.id}">‚úé</button>`}
                                ${canDeleteCol ? `<button class="icon-btn" title="–£–¥–∞–ª–∏—Ç—å —Å—Ç–æ–ª–±–µ—Ü" data-delete-column="${section.id}" data-col-id="${col.id}">‚úï</button>` : ''}
                            </div>
                        </div>
                    `;
                    th.dataset.sectionId = section.id;
                    th.dataset.colId = col.id;
                    th.draggable = true;
                    headRow.appendChild(th);
                });
                const thAction = document.createElement('th');
                thAction.textContent = '';
                headRow.appendChild(thAction);
                thead.appendChild(headRow);
                table.appendChild(thead);

                const tbody = document.createElement('tbody');

                const rows = filterRowsByOwner(section, getSortedRows(section));
                if (!rows.length) {
                    const row = document.createElement('tr');
                    const cell = document.createElement('td');
                    cell.colSpan = section.columns.length + 1;
                    cell.className = 'empty-row';
                    cell.textContent = '–ü–æ–∫–∞ –Ω–µ—Ç —Å—Ç—Ä–æ–∫ ‚Äî –¥–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é –∑–∞–ø–∏—Å—å.';
                    row.appendChild(cell);
                    tbody.appendChild(row);
                } else {
                    rows.forEach(rowData => {
                        const tr = document.createElement('tr');
                        tr.dataset.sectionId = section.id;
                        tr.dataset.rowId = rowData.id;
                        if (rowData.closed) tr.classList.add('row-closed');
                        section.columns.forEach(col => {
                            const td = document.createElement('td');
                            const value = rowData.cells[col.id];

                            td.dataset.colId = col.id;
                            if (col.type === 'owners') {
                                const ownerWrap = document.createElement('div');
                                ownerWrap.className = 'owner-wrap';
                                ownerWrap.dataset.sectionId = section.id;
                                ownerWrap.dataset.rowId = rowData.id;
                                ownerWrap.dataset.colId = col.id;

                                const selected = Array.isArray(value) ? value : (value ? String(value).split(',').map(v => v.trim()).filter(Boolean) : []);
                                const label = formatOwnerLabel(selected);

                                ownerWrap.innerHTML = `
                                    <button type="button" class="owner-display cell-truncate">${label}</button>
                                `;

                                td.appendChild(ownerWrap);
                            } else if (section.name === '–ü–∏–≤–æ' && col.id === 'item') {
                                const wrap = document.createElement('div');
                                wrap.className = 'beer-select';
                                wrap.dataset.sectionId = section.id;
                                wrap.dataset.rowId = rowData.id;
                                wrap.dataset.colId = col.id;
                                const label = value ? String(value) : '–í—ã–±—Ä–∞—Ç—å –ø–∏–≤–æ';
                                const toggle = document.createElement('button');
                                toggle.type = 'button';
                                toggle.className = `row-toggle ${rowData.closed ? 'active' : ''}`;
                                toggle.dataset.toggleRow = section.id;
                                toggle.dataset.rowId = rowData.id;
                                toggle.title = '–û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –∑–∞–∫—Ä—ã—Ç–æ–µ';
                                toggle.textContent = rowData.closed ? '‚úì' : '+';
                                wrap.innerHTML = `
                                    <button type="button" class="beer-btn cell-truncate">${label}</button>
                                `;
                                const cellWrap = document.createElement('div');
                                cellWrap.className = 'item-cell';
                                cellWrap.appendChild(toggle);
                                cellWrap.appendChild(wrap);
                                td.appendChild(cellWrap);
                            } else {
                                const input = document.createElement('input');
                                input.className = 'cell-truncate';
                                if (col.type === 'number') input.type = 'number';
                                else input.type = 'text';
                                input.placeholder = col.type === 'cost' ? '‚Äî' : '';
                                input.value = value || '';
                                input.dataset.sectionId = section.id;
                                input.dataset.rowId = rowData.id;
                                input.dataset.colId = col.id;
                                if (col.id === 'item') {
                                    const toggle = document.createElement('button');
                                    toggle.type = 'button';
                                    toggle.className = `row-toggle ${rowData.closed ? 'active' : ''}`;
                                    toggle.dataset.toggleRow = section.id;
                                    toggle.dataset.rowId = rowData.id;
                                    toggle.title = '–û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –∑–∞–∫—Ä—ã—Ç–æ–µ';
                                    toggle.textContent = rowData.closed ? '‚úì' : '+';
                                    const cellWrap = document.createElement('div');
                                    cellWrap.className = 'item-cell';
                                    cellWrap.appendChild(toggle);
                                    cellWrap.appendChild(input);
                                    td.appendChild(cellWrap);
                                    tr.appendChild(td);
                                    return;
                                }
                                td.appendChild(input);
                            }

                            tr.appendChild(td);
                        });

                        const tdAction = document.createElement('td');
                        const delBtn = document.createElement('button');
                        delBtn.className = 'icon-btn';
                        delBtn.title = '–£–¥–∞–ª–∏—Ç—å —Å—Ç—Ä–æ–∫—É';
                        delBtn.textContent = '‚úï';
                        delBtn.dataset.deleteRow = section.id;
                        delBtn.dataset.rowId = rowData.id;
                        tdAction.appendChild(delBtn);
                        tr.appendChild(tdAction);

                        tbody.appendChild(tr);
                    });
                }

                table.appendChild(tbody);
                tableWrap.appendChild(table);
                card.appendChild(tableWrap);
                container.appendChild(card);
            });

            renderSectionMenu();
            restoreActiveField(active);
            renderTick += 1;
            updateStickyHeaders();
        }

        function getStickyTopOffset() {
            return 0;
        }

        function updateStickyHeaders() {
            const container = document.getElementById('sectionsContainer');
            const portal = document.getElementById('stickyPortal');
            const stickyWrap = document.getElementById('stickyWrap');
            const stickyHead = document.getElementById('stickyHead');
            const stickyTable = document.getElementById('stickyTableHead');
            if (!container || !portal || !stickyWrap || !stickyHead || !stickyTable) return;
            container.querySelectorAll('.table-head-fixed').forEach(el => el.remove());

            const offset = getStickyTopOffset();
            const scrollY = window.scrollY || document.documentElement.scrollTop || document.body.scrollTop || 0;
            const cards = Array.from(container.querySelectorAll('.card[data-section-id]'));
            let activeCard = null;

            for (let i = 0; i < cards.length; i += 1) {
                const card = cards[i];
                const head = card.querySelector('.section-head');
                const table = card.querySelector('table.sheet');
                const thead = table ? table.querySelector('thead') : null;
                if (!head) continue;
                const headStyles = window.getComputedStyle(head);
                const headMarginBottom = parseFloat(headStyles.marginBottom) || 0;
                const headHeight = head.offsetHeight + headMarginBottom;
                const theadHeight = thead ? thead.offsetHeight : 0;
                const cardRect = card.getBoundingClientRect();
                const cardTop = cardRect.top + scrollY;
                const cardBottom = cardTop + card.offsetHeight;
                const stick = cardTop - offset;
                const end = cardBottom - (headHeight + theadHeight) - offset;
                if (scrollY >= stick && scrollY <= end) {
                    activeCard = card;
                }
            }

            cards.forEach(card => {
                if (card === activeCard) return;
                const head = card.querySelector('.section-head');
                const thead = card.querySelector('thead');
                const table = card.querySelector('table.sheet');
                if (head) {
                    head.classList.remove('sticky-hidden');
                    head.style.opacity = '';
                    head.style.pointerEvents = '';
                    head.style.visibility = '';
                    head.style.transition = '';
                }
                if (thead) {
                    thead.classList.remove('sticky-hidden');
                    thead.classList.remove('sticky-collapsed');
                    thead.style.opacity = '';
                    thead.style.pointerEvents = '';
                    thead.style.visibility = '';
                }
                if (table) table.style.marginTop = '';
                card.classList.remove('sticky-active');
            });

            if (!activeCard) {
                stickySectionId = null;
                stickyRenderTick = -1;
                portal.classList.remove('visible');
                portal.style.opacity = '0';
                stickyWrap.style.transform = 'translateY(-6px)';
                return;
            }

            const sectionId = activeCard.dataset.sectionId;
            stickySectionId = sectionId;
            activeCard.classList.add('sticky-active');
            const wrap = activeCard.querySelector('.section-head-wrap');
            const head = activeCard.querySelector('.section-head');
            const table = activeCard.querySelector('table.sheet');
            const thead = table ? table.querySelector('thead') : null;
            if (!wrap || !head || !table || !thead) {
                portal.classList.remove('visible');
                portal.style.opacity = '0';
                stickyWrap.style.transform = 'translateY(-6px)';
                return;
            }

            const needsRebuild = stickyRenderTick !== renderTick || stickyHead.dataset.sectionId !== sectionId;
            if (needsRebuild) {
                stickyHead.innerHTML = '';
                const headClone = head.cloneNode(true);
                headClone.classList.remove('sticky-hidden');
                headClone.style.opacity = '';
                headClone.style.pointerEvents = '';
                headClone.style.visibility = '';
                stickyHead.appendChild(headClone);

                stickyTable.innerHTML = '';
                const tableClone = document.createElement('table');
                tableClone.className = 'sheet';
                const theadClone = thead.cloneNode(true);
                theadClone.classList.remove('sticky-hidden');
                theadClone.classList.remove('sticky-collapsed');
                theadClone.style.opacity = '';
                theadClone.style.pointerEvents = '';
                theadClone.style.visibility = '';
                tableClone.appendChild(theadClone);
                stickyTable.appendChild(tableClone);

                stickyHead.dataset.sectionId = sectionId;
                stickyTable.dataset.sectionId = sectionId;
                stickyRenderTick = renderTick;
            }

            const cardRect = activeCard.getBoundingClientRect();
            const cardStyle = window.getComputedStyle(activeCard);
            const padLeft = Math.round(parseFloat(cardStyle.paddingLeft) || 0);
            const padRight = Math.round(parseFloat(cardStyle.paddingRight) || 0);
            const wrapLeft = Math.round(cardRect.left);
            const wrapWidth = Math.round(cardRect.width);
            stickyWrap.style.top = `${Math.round(offset)}px`;
            stickyWrap.style.left = `${wrapLeft}px`;
            stickyWrap.style.width = `${wrapWidth}px`;
            stickyWrap.style.paddingLeft = `${padLeft}px`;
            stickyWrap.style.paddingRight = `${padRight}px`;

            const origThs = Array.from(thead.querySelectorAll('th'));
            const cloneThs = Array.from(stickyTable.querySelectorAll('th'));
            const widths = origThs.map(th => th.getBoundingClientRect().width);
            head.classList.add('sticky-hidden');
            head.style.transition = 'none';
            thead.classList.add('sticky-hidden');
            thead.classList.add('sticky-collapsed');
            table.style.marginTop = '';

            origThs.forEach((_, idx) => {
                const width = widths[idx];
                if (cloneThs[idx]) {
                    cloneThs[idx].style.width = `${width}px`;
                    cloneThs[idx].style.minWidth = `${width}px`;
                    cloneThs[idx].style.maxWidth = `${width}px`;
                }
            });
            portal.style.opacity = '1';
            stickyWrap.style.transform = 'translateY(0)';
            portal.classList.add('visible');
        }

        let stickyRaf = null;
        function scheduleStickyUpdate() {
            if (stickyRaf) return;
            stickyRaf = requestAnimationFrame(() => {
                stickyRaf = null;
                updateStickyHeaders();
            });
        }


        function getActiveField() {
            const el = document.activeElement;
            if (!el || el.tagName !== 'INPUT') return null;
            const { sectionId, rowId, colId } = el.dataset;
            if (!sectionId || !rowId || !colId) return null;
            return {
                sectionId,
                rowId,
                colId,
                selectionStart: el.selectionStart,
                selectionEnd: el.selectionEnd,
                value: el.value
            };
        }

        function restoreActiveField(active) {
            if (!active) return;
            const sel = `input[data-section-id="${active.sectionId}"][data-row-id="${active.rowId}"][data-col-id="${active.colId}"]`;
            const input = document.querySelector(sel);
            if (!input) return;
            input.focus();
            if (input.value !== active.value) input.value = active.value;
            if (typeof input.selectionStart === 'number') {
                input.setSelectionRange(active.selectionStart, active.selectionEnd);
            }
        }

        function renderSectionMenu() {
            const menu = document.getElementById('sectionMenu');
            if (!menu || !eventData) return;
            menu.innerHTML = '';

            const existing = new Set(eventData.sections.map(sec => sec.name));
            const available = presetSections.filter(name => !existing.has(name));

            const customBtn = document.createElement('button');
            customBtn.type = 'button';
            customBtn.dataset.sectionName = '__custom__';
            customBtn.textContent = '–ù–æ–≤—ã–π —Ä–∞–∑–¥–µ–ª';
            menu.appendChild(customBtn);

            const divider = document.createElement('div');
            divider.className = 'text-xs text-gray-500 px-2 py-1';
            divider.textContent = '–ü—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ';
            menu.appendChild(divider);

            if (!available.length) return;

            available.forEach(name => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.dataset.sectionName = name;
                btn.textContent = name;
                menu.appendChild(btn);
            });
        }

        function updateCellValue(sectionId, rowId, colId, value) {
            const section = eventData.sections.find(sec => sec.id === sectionId);
            if (!section) return;
            const row = section.rows.find(r => r.id === rowId);
            if (!row) return;
            row.cells[colId] = value;
            saveEventData();
        }

        function addRow(sectionId) {
            const section = eventData.sections.find(sec => sec.id === sectionId);
            if (!section) return;
            section.rows.push(createRow(section.columns));
            saveEventData();
            renderSections();
        }

        function deleteRow(sectionId, rowId) {
            const section = eventData.sections.find(sec => sec.id === sectionId);
            if (!section) return;
            section.rows = section.rows.filter(r => r.id !== rowId);
            saveEventData();
            renderSections();
        }

        function toggleRowClosed(sectionId, rowId) {
            const section = eventData.sections.find(sec => sec.id === sectionId);
            if (!section) return;
            const row = section.rows.find(r => r.id === rowId);
            if (!row) return;
            row.closed = !row.closed;
            saveEventData();
            renderSections();
        }

        function moveSection(fromId, toId, after) {
            if (!eventData) return;
            const fromIdx = eventData.sections.findIndex(s => s.id === fromId);
            const toIdx = eventData.sections.findIndex(s => s.id === toId);
            if (fromIdx === -1 || toIdx === -1 || fromIdx === toIdx) return;
            const [section] = eventData.sections.splice(fromIdx, 1);
            const insertAt = after ? toIdx + 1 : toIdx;
            eventData.sections.splice(insertAt, 0, section);
            saveEventData();
            renderSections();
        }

        function getSectionTarget(container, y) {
            const sections = Array.from(container.querySelectorAll('.card[data-section-id]'));
            for (const sec of sections) {
                const rect = sec.getBoundingClientRect();
                const mid = rect.top + rect.height / 2;
                if (y <= mid) return { id: sec.dataset.sectionId, after: false, el: sec };
                if (y <= rect.bottom) return { id: sec.dataset.sectionId, after: true, el: sec };
            }
            const last = sections[sections.length - 1];
            return last ? { id: last.dataset.sectionId, after: true, el: last } : null;
        }

        function hideOwnerMenu() {
            const menu = document.getElementById('ownerMenuPortal');
            if (!menu) return;
            menu.classList.add('hidden');
            menu.innerHTML = '';
            activeOwnerTarget = null;
        }

        function hideBeerMenu() {
            const menu = document.getElementById('beerMenuPortal');
            if (!menu) return;
            menu.classList.add('hidden');
            menu.innerHTML = '';
            activeBeerTarget = null;
        }

        function openOwnerMenu(wrap) {
            const menu = document.getElementById('ownerMenuPortal');
            if (!menu || !wrap) return;
            document.querySelectorAll('.card').forEach(card => card.classList.remove('card-elevated'));
            const card = wrap.closest('.card');
            if (card) card.classList.add('card-elevated');
            const rect = wrap.getBoundingClientRect();
            const sectionId = wrap.dataset.sectionId;
            const rowId = wrap.dataset.rowId;
            const colId = wrap.dataset.colId;
            const section = eventData.sections.find(sec => sec.id === sectionId);
            if (!section) return;
            const row = section.rows.find(r => r.id === rowId);
            if (!row) return;
            const selected = Array.isArray(row.cells[colId]) ? row.cells[colId] : [];

            menu.style.left = `${rect.left}px`;
            menu.style.width = `${rect.width}px`;
            menu.style.overflowY = 'auto';
            menu.innerHTML = '';

            if (!usersList.length) {
                const emptyOpt = document.createElement('div');
                emptyOpt.className = 'text-xs text-gray-400 px-2 py-1';
                emptyOpt.textContent = '–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π';
                menu.appendChild(emptyOpt);
            } else {
                usersList.forEach(userName => {
                    const opt = document.createElement('label');
                    opt.className = 'owner-opt';
                    opt.innerHTML = `
                        <input type="checkbox" ${selected.includes(userName) ? 'checked' : ''} data-owner="${userName}" />
                        <span>${userName}</span>
                    `;
                    menu.appendChild(opt);
                });
            }

            activeOwnerTarget = { sectionId, rowId, colId, button: wrap.querySelector('.owner-display') };
            menu.classList.remove('hidden');

            const viewportH = window.innerHeight || document.documentElement.clientHeight;
            const spaceBelow = viewportH - rect.bottom - 12;
            const spaceAbove = rect.top - 12;
            const maxHeight = Math.max(120, Math.min(260, Math.max(spaceBelow, spaceAbove)));
            menu.style.maxHeight = `${maxHeight}px`;
            if (spaceBelow < 180 && spaceAbove > spaceBelow) {
                menu.style.top = `${rect.top - maxHeight - 6}px`;
            } else {
                menu.style.top = `${rect.bottom + 6}px`;
            }
        }

        function openBeerMenu(wrap) {
            const menu = document.getElementById('beerMenuPortal');
            if (!menu || !wrap) return;
            document.querySelectorAll('.card').forEach(card => card.classList.remove('card-elevated'));
            const card = wrap.closest('.card');
            if (card) card.classList.add('card-elevated');
            const rect = wrap.getBoundingClientRect();
            const sectionId = wrap.dataset.sectionId;
            const rowId = wrap.dataset.rowId;
            const colId = wrap.dataset.colId;

            menu.style.left = `${rect.left}px`;
            menu.style.width = `${rect.width}px`;
            menu.style.overflowY = 'auto';
            menu.innerHTML = '';

            const none = document.createElement('button');
            none.type = 'button';
            none.className = 'beer-opt';
            none.dataset.beerValue = '';
            none.textContent = '‚Äî';
            menu.appendChild(none);

            beerList.forEach(beer => {
                const nm = (beer.name || '').trim();
                if (!nm) return;
                const opt = document.createElement('button');
                opt.type = 'button';
                opt.className = 'beer-opt';
                opt.dataset.beerValue = nm;
                opt.textContent = nm;
                menu.appendChild(opt);
            });

            activeBeerTarget = { sectionId, rowId, colId, button: wrap.querySelector('.beer-btn') };
            menu.classList.remove('hidden');

            const viewportH = window.innerHeight || document.documentElement.clientHeight;
            const spaceBelow = viewportH - rect.bottom - 12;
            const spaceAbove = rect.top - 12;
            const maxHeight = Math.max(120, Math.min(260, Math.max(spaceBelow, spaceAbove)));
            menu.style.maxHeight = `${maxHeight}px`;
            if (spaceBelow < 180 && spaceAbove > spaceBelow) {
                menu.style.top = `${rect.top - maxHeight - 6}px`;
            } else {
                menu.style.top = `${rect.bottom + 6}px`;
            }
        }

        function openAddColumnModal(sectionId) {
            pendingColumnSectionId = sectionId;
            const modal = document.getElementById('addColumnModal');
            const input = document.getElementById('columnNameInput');
            if (!modal || !input) return;
            input.value = '';
            setColumnType('text');
            modal.classList.add('active');
            setTimeout(() => input.focus(), 0);
        }

        function closeAddColumnModal() {
            const modal = document.getElementById('addColumnModal');
            if (modal) modal.classList.remove('active');
            pendingColumnSectionId = null;
        }

        function setColumnType(value) {
            const btn = document.getElementById('columnTypeBtn');
            const menu = document.getElementById('columnTypeMenu');
            if (!btn || !menu) return;
            const selected = columnTypes.find(t => t.value === value) || columnTypes[0];
            btn.textContent = selected.label;
            btn.dataset.value = selected.value;
            menu.classList.add('hidden');
        }

        function setEditColumnType(value) {
            const btn = document.getElementById('editColumnTypeBtn');
            const menu = document.getElementById('editColumnTypeMenu');
            if (!btn || !menu) return;
            const selected = columnTypes.find(t => t.value === value) || columnTypes[0];
            btn.textContent = selected.label;
            btn.dataset.value = selected.value;
            menu.classList.add('hidden');
        }

        function renderColumnTypeMenu() {
            const menu = document.getElementById('columnTypeMenu');
            if (!menu) return;
            menu.innerHTML = '';
            columnTypes.forEach(type => {
                const opt = document.createElement('button');
                opt.type = 'button';
                opt.className = 'cs-opt';
                opt.dataset.typeValue = type.value;
                opt.textContent = type.label;
                menu.appendChild(opt);
            });
        }

        function renderEditColumnTypeMenu() {
            const menu = document.getElementById('editColumnTypeMenu');
            if (!menu) return;
            menu.innerHTML = '';
            columnTypes.forEach(type => {
                const opt = document.createElement('button');
                opt.type = 'button';
                opt.className = 'cs-opt';
                opt.dataset.typeValue = type.value;
                opt.textContent = type.label;
                menu.appendChild(opt);
            });
        }

        function createColumnFromModal() {
            const sectionId = pendingColumnSectionId;
            const section = eventData.sections.find(sec => sec.id === sectionId);
            if (!section) return;
            const input = document.getElementById('columnNameInput');
            const btn = document.getElementById('columnTypeBtn');
            if (!input || !btn) return;
            const trimmed = input.value.trim();
            if (!trimmed) return;
            const type = btn.dataset.value || 'text';
            const baseId = slugify(trimmed) || 'col';
            let id = baseId;
            let counter = 1;
            while (section.columns.some(col => col.id === id)) {
                id = `${baseId}-${counter++}`;
            }
            section.columns.push({ id, name: trimmed, type });
            section.rows.forEach(row => {
                row.cells[id] = type === 'owners' ? [] : '';
            });
            saveEventData();
            renderSections();
            closeAddColumnModal();
        }

        function openEditColumnModal(sectionId, colId) {
            const section = eventData.sections.find(sec => sec.id === sectionId);
            if (!section) return;
            const col = section.columns.find(c => c.id === colId);
            if (!col) return;
            pendingEditColumn = { sectionId, colId };
            const modal = document.getElementById('editColumnModal');
            const input = document.getElementById('editColumnNameInput');
            if (!modal || !input) return;
            input.value = col.name || '';
            setEditColumnType(col.type || 'text');
            modal.classList.add('active');
            setTimeout(() => input.focus(), 0);
        }

        function closeEditColumnModal() {
            const modal = document.getElementById('editColumnModal');
            if (modal) modal.classList.remove('active');
            pendingEditColumn = null;
        }

        function saveEditColumn() {
            if (!pendingEditColumn) return;
            const section = eventData.sections.find(sec => sec.id === pendingEditColumn.sectionId);
            if (!section) return;
            const col = section.columns.find(c => c.id === pendingEditColumn.colId);
            if (!col) return;
            const nameInput = document.getElementById('editColumnNameInput');
            const typeBtn = document.getElementById('editColumnTypeBtn');
            if (!nameInput || !typeBtn) return;
            const trimmed = nameInput.value.trim();
            if (!trimmed) return;
            const newType = typeBtn.dataset.value || 'text';
            const oldType = col.type;
            col.name = trimmed;
            col.type = newType;
            if (oldType !== newType) {
                section.rows.forEach(row => {
                    let val = row.cells[col.id];
                    if (newType === 'owners') {
                        if (Array.isArray(val)) return;
                        row.cells[col.id] = val ? String(val).split(',').map(v => v.trim()).filter(Boolean) : [];
                    } else if (oldType === 'owners' && Array.isArray(val)) {
                        row.cells[col.id] = val.join(', ');
                    }
                });
            }
            saveEventData();
            renderSections();
            closeEditColumnModal();
        }

        function deleteColumn(sectionId, colId) {
            const section = eventData.sections.find(sec => sec.id === sectionId);
            if (!section) return;
            section.columns = section.columns.filter(col => col.id !== colId);
            section.rows.forEach(row => {
                delete row.cells[colId];
            });
            saveEventData();
            renderSections();
        }

        function columnHasData(section, colId) {
            return section.rows.some(row => {
                const val = row.cells[colId];
                if (Array.isArray(val)) return val.length > 0;
                if (val === null || val === undefined) return false;
                return String(val).trim() !== '';
            });
        }

        function openDeleteColumnModal(sectionId, colId) {
            const section = eventData.sections.find(sec => sec.id === sectionId);
            if (!section) return;
            const col = section.columns.find(c => c.id === colId);
            if (!col) return;
            pendingDeleteColumn = { sectionId, colId };
            const nameEl = document.getElementById('deleteColumnName');
            const modal = document.getElementById('deleteColumnModal');
            if (nameEl) nameEl.textContent = col.name || '';
            if (modal) modal.classList.add('active');
        }

        function closeDeleteColumnModal() {
            const modal = document.getElementById('deleteColumnModal');
            if (modal) modal.classList.remove('active');
            pendingDeleteColumn = null;
        }

        function confirmDeleteColumn() {
            if (!pendingDeleteColumn) return;
            deleteColumn(pendingDeleteColumn.sectionId, pendingDeleteColumn.colId);
            closeDeleteColumnModal();
        }

        function moveColumn(sectionId, fromColId, toColId, after) {
            const section = eventData.sections.find(sec => sec.id === sectionId);
            if (!section) return;
            const fromIdx = section.columns.findIndex(c => c.id === fromColId);
            if (fromIdx === -1) return;
            const [col] = section.columns.splice(fromIdx, 1);
            const toIdx = section.columns.findIndex(c => c.id === toColId);
            if (toIdx === -1) return;
            const insertAt = after ? toIdx + 1 : toIdx;
            section.columns.splice(insertAt, 0, col);
            saveEventData();
            renderSections();
        }

        function insertAfter(node, ref) {
            if (!ref || !ref.parentNode) return;
            ref.parentNode.insertBefore(node, ref.nextSibling);
        }

        function captureRects(table) {
            const map = new Map();
            table.querySelectorAll('thead th, tbody td').forEach(el => {
                map.set(el, el.getBoundingClientRect());
            });
            return map;
        }

        function animateReorder(table, prevRects) {
            const cells = table.querySelectorAll('thead th, tbody td');
            cells.forEach(el => {
                const prev = prevRects.get(el);
                if (!prev) return;
                const next = el.getBoundingClientRect();
                const dx = prev.left - next.left;
                const dy = prev.top - next.top;
                if (dx || dy) {
                    el.style.transition = 'transform 0s';
                    el.style.transform = `translate(${dx}px, ${dy}px)`;
                    requestAnimationFrame(() => {
                        el.style.transition = 'transform 220ms ease-out';
                        el.style.transform = 'translate(0, 0)';
                    });
                }
            });
            setTimeout(() => {
                cells.forEach(el => {
                    el.style.transition = '';
                    el.style.transform = '';
                });
            }, 240);
        }

        function getColIdFromX(table, x) {
            const headers = Array.from(table.querySelectorAll('thead th[data-col-id]'));
            let last = null;
            for (const th of headers) {
                const rect = th.getBoundingClientRect();
                const mid = rect.left + rect.width / 2;
                if (x <= mid) return { colId: th.dataset.colId, after: false };
                if (x <= rect.right) return { colId: th.dataset.colId, after: true };
                last = th;
            }
            return last ? { colId: last.dataset.colId, after: true } : null;
        }

        function previewMoveColumn(sectionId, fromColId, toColId, after) {
            const table = document.querySelector(`table.sheet[data-section-id="${sectionId}"]`);
            if (!table) return;
            const headRow = table.querySelector('thead tr');
            if (!headRow) return;
            const fromTh = headRow.querySelector(`th[data-col-id="${fromColId}"]`);
            const toTh = headRow.querySelector(`th[data-col-id="${toColId}"]`);
            if (!fromTh || !toTh || fromTh === toTh) return;

            const prev = captureRects(table);
            if (after) insertAfter(fromTh, toTh);
            else headRow.insertBefore(fromTh, toTh);

            table.querySelectorAll('tbody tr').forEach((row) => {
                const fromTd = row.querySelector(`td[data-col-id="${fromColId}"]`);
                const toTd = row.querySelector(`td[data-col-id="${toColId}"]`);
                if (!fromTd || !toTd || fromTd === toTd) return;
                if (after) insertAfter(fromTd, toTd);
                else row.insertBefore(fromTd, toTd);
            });
            animateReorder(table, prev);
        }

        function updateSectionAutoScroll(pointerY) {
            const edge = 80;
            const maxSpeed = 18;
            const viewHeight = window.innerHeight || document.documentElement.clientHeight;
            if (pointerY < edge) {
                sectionAutoScrollSpeed = -Math.round(maxSpeed * (1 - pointerY / edge));
            } else if (pointerY > viewHeight - edge) {
                sectionAutoScrollSpeed = Math.round(maxSpeed * (1 - (viewHeight - pointerY) / edge));
            } else {
                sectionAutoScrollSpeed = 0;
            }
            if (sectionAutoScrollSpeed !== 0 && !sectionAutoScrollRaf) {
                sectionAutoScrollRaf = requestAnimationFrame(runSectionAutoScroll);
            }
        }

        function runSectionAutoScroll() {
            if (!sectionDragState || !sectionDragState.dragging) {
                sectionAutoScrollRaf = null;
                sectionAutoScrollSpeed = 0;
                return;
            }
            if (sectionAutoScrollSpeed !== 0) {
                window.scrollBy(0, sectionAutoScrollSpeed);
            }
            sectionAutoScrollRaf = requestAnimationFrame(runSectionAutoScroll);
        }

        function stopSectionAutoScroll() {
            sectionAutoScrollSpeed = 0;
            if (sectionAutoScrollRaf) {
                cancelAnimationFrame(sectionAutoScrollRaf);
                sectionAutoScrollRaf = null;
            }
        }

        function addSection(name, columnsOverride) {
            if (!eventData) return;
            if (eventData.sections.some(sec => sec.name === name)) return;
            eventData.sections.push(createSection(name, columnsOverride));
            saveEventData();
            renderSections();
        }

        function openNewSectionModal() {
            const modal = document.getElementById('newSectionModal');
            const input = document.getElementById('newSectionNameInput');
            if (!modal || !input) return;
            input.value = '';
            newSectionColumnsDraft = defaultColumns.map(col => ({ id: col.id, name: col.name, type: col.type }));
            renderNewSectionColumns();
            modal.classList.add('active');
            setTimeout(() => input.focus(), 0);
        }

        function closeNewSectionModal() {
            const modal = document.getElementById('newSectionModal');
            if (modal) modal.classList.remove('active');
            newSectionColumnsDraft = [];
        }

        function renderNewSectionColumns() {
            const list = document.getElementById('newSectionColumns');
            if (!list) return;
            list.innerHTML = '';
            newSectionColumnsDraft.forEach((col, idx) => {
                const row = document.createElement('div');
                row.className = 'modal-row';
                row.innerHTML = `
                    <input class="modal-input" type="text" data-col-name="${idx}" value="${col.name || ''}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏" />
                    <div class="cs">
                        <button type="button" class="cs-btn" data-col-type-btn="${idx}">${(columnTypes.find(t => t.value === col.type) || columnTypes[0]).label}</button>
                        <div class="cs-menu hidden" data-col-type-menu="${idx}"></div>
                    </div>
                    <button class="icon-btn ${idx === 0 ? 'opacity-40 cursor-not-allowed' : ''}" title="–£–¥–∞–ª–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É" data-remove-col="${idx}" ${idx === 0 ? 'disabled' : ''}>‚úï</button>
                `;
                list.appendChild(row);

                const menu = row.querySelector(`[data-col-type-menu="${idx}"]`);
                columnTypes.forEach(type => {
                    const opt = document.createElement('button');
                    opt.type = 'button';
                    opt.className = 'cs-opt';
                    opt.dataset.colTypeValue = type.value;
                    opt.dataset.colIndex = String(idx);
                    opt.textContent = type.label;
                    menu.appendChild(opt);
                });
            });
        }

        function addDraftColumn() {
            newSectionColumnsDraft.push({ id: `col_${Date.now()}_${Math.random().toString(36).slice(2, 4)}`, name: '', type: 'text' });
            renderNewSectionColumns();
        }

        function createNewSectionFromModal() {
            const nameInput = document.getElementById('newSectionNameInput');
            if (!nameInput) return;
            const name = nameInput.value.trim();
            if (!name) return;
            const columns = newSectionColumnsDraft
                .map((c) => ({ id: slugify(c.name || c.id), name: (c.name || '').trim(), type: c.type || 'text' }))
                .filter((c) => c.name);
            if (!columns.length) return;
            addSection(name, columns);
            closeNewSectionModal();
        }

        function openDeleteSectionModal(sectionId) {
            pendingDeleteSectionId = sectionId;
            const modal = document.getElementById('deleteSectionModal');
            const nameEl = document.getElementById('deleteSectionName');
            if (!modal || !nameEl) return;
            const section = eventData.sections.find(sec => sec.id === sectionId);
            nameEl.textContent = section ? section.name : '';
            modal.classList.add('active');
        }

        function closeDeleteSectionModal() {
            const modal = document.getElementById('deleteSectionModal');
            if (modal) modal.classList.remove('active');
            pendingDeleteSectionId = null;
        }

        function confirmDeleteSection() {
            if (!pendingDeleteSectionId) return;
            eventData.sections = eventData.sections.filter(sec => sec.id !== pendingDeleteSectionId);
            saveEventData();
            renderSections();
            closeDeleteSectionModal();
        }

        function slugify(name) {
            return name.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9–∞-—è\-]/gi, '');
        }

        function initProfileName() {
            try {
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
                const nameEl = document.getElementById('profileName');
                if (currentUser && currentUser.name) {
                    currentUserName = currentUser.name;
                    if (nameEl) nameEl.textContent = currentUser.name;
                }
            } catch (_) {}
        }

        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'login.html';
        }

        function initUsers() {
            if (!db) return;
            db.ref('users').on('value', (snapshot) => {
                const val = snapshot.val() || {};
                usersList = Object.values(val).map(u => u && u.name).filter(Boolean);
                usersList.sort((a, b) => a.localeCompare(b, 'ru'));
                renderSections();
            });
        }

        function initBeerList() {
            if (!db) return;
            db.ref('beerRating').on('value', (snapshot) => {
                const val = snapshot.val() || [];
                let list = [];
                if (Array.isArray(val)) list = val;
                else list = Object.values(val);
                beerList = list.filter(Boolean).sort((a, b) => {
                    const an = (a.name || '').toString();
                    const bn = (b.name || '').toString();
                    return an.localeCompare(bn, 'ru');
                });
                renderSections();
            });
        }

        function toggleSectionMenu(forceClose = false) {
            const menu = document.getElementById('sectionMenu');
            if (!menu) return;
            if (forceClose) {
                menu.classList.add('hidden');
                return;
            }
            menu.classList.toggle('hidden');
        }

        function init() {
            const params = new URLSearchParams(window.location.search);
            eventId = params.get('id');
            if (!eventId) {
                document.getElementById('missingEvent').classList.remove('hidden');
                return;
            }

            updateStickyTop();
            window.addEventListener('resize', updateStickyTop);
            window.addEventListener('scroll', scheduleStickyUpdate, { passive: true });
            window.addEventListener('resize', updateStickyHeaders);
            document.addEventListener('scroll', scheduleStickyUpdate, true);

            sortState = loadSortStateForEvent(eventId);

            initFirebase();
            loadEvent();
            initUsers();
            initBeerList();

            document.getElementById('addSectionBtn').addEventListener('click', (e) => {
                e.stopPropagation();
                toggleSectionMenu();
            });

            document.getElementById('sectionMenu').addEventListener('click', (e) => {
                const btn = e.target.closest('[data-section-name]');
                if (!btn) return;
                if (btn.dataset.sectionName === '__custom__') {
                    openNewSectionModal();
                } else {
                    const name = btn.dataset.sectionName;
                    const presetCols = presetSectionColumns[name];
                    addSection(name, presetCols || defaultColumns);
                }
                toggleSectionMenu(true);
            });

            document.addEventListener('click', (e) => {
                if (!e.target.closest('#sectionMenu') && !e.target.closest('#addSectionBtn')) {
                    toggleSectionMenu(true);
                }

                if (!e.target.closest('#ownerMenuPortal') && !e.target.closest('.owner-wrap')) {
                    hideOwnerMenu();
                    document.querySelectorAll('.card').forEach(card => card.classList.remove('card-elevated'));
                }

                if (!e.target.closest('#beerMenuPortal') && !e.target.closest('.beer-select')) {
                    hideBeerMenu();
                    document.querySelectorAll('.card').forEach(card => card.classList.remove('card-elevated'));
                }

                if (!e.target.closest('#columnTypeSelect')) {
                    const menu = document.getElementById('columnTypeMenu');
                    if (menu) menu.classList.add('hidden');
                }
                if (!e.target.closest('#editColumnTypeSelect')) {
                    const menu = document.getElementById('editColumnTypeMenu');
                    if (menu) menu.classList.add('hidden');
                }
            });

            window.addEventListener('scroll', (e) => {
                const t = e.target;
                if (t && (t.id === 'ownerMenuPortal' || t.id === 'beerMenuPortal')) return;
                hideOwnerMenu();
                hideBeerMenu();
                hideCellTooltip();
                activeTooltipTarget = null;
                document.querySelectorAll('.card').forEach(card => card.classList.remove('card-elevated'));
            }, true);

            document.getElementById('sectionsContainer').addEventListener('input', (e) => {
                const target = e.target;
                if (target.tagName !== 'INPUT' && target.tagName !== 'SELECT') return;
                const { sectionId, rowId, colId } = target.dataset;
                if (!sectionId || !rowId || !colId) return;
                updateCellValue(sectionId, rowId, colId, target.value);
            });

            const sectionsContainer = document.getElementById('sectionsContainer');
            if (sectionsContainer) {
                sectionsContainer.addEventListener('mouseover', (e) => {
                    const target = e.target.closest('.cell-truncate');
                    if (!target || !sectionsContainer.contains(target)) {
                        hideCellTooltip();
                        activeTooltipTarget = null;
                        return;
                    }
                    if (target.scrollWidth <= target.clientWidth + 1) {
                        hideCellTooltip();
                        activeTooltipTarget = null;
                        return;
                    }
                    activeTooltipTarget = target;
                    showCellTooltip(target, e.clientX, e.clientY);
                });
                sectionsContainer.addEventListener('mousemove', (e) => {
                    if (!activeTooltipTarget) return;
                    const tooltip = document.getElementById('cellTooltip');
                    if (!tooltip) return;
                    positionCellTooltip(tooltip, e.clientX, e.clientY);
                });
                sectionsContainer.addEventListener('mouseout', (e) => {
                    if (!activeTooltipTarget) return;
                    if (e.relatedTarget && activeTooltipTarget.contains(e.relatedTarget)) return;
                    hideCellTooltip();
                    activeTooltipTarget = null;
                });
                sectionsContainer.addEventListener('scroll', () => {
                    hideCellTooltip();
                    activeTooltipTarget = null;
                }, true);
            }

            document.addEventListener('pointerdown', () => {
                hideCellTooltip();
                activeTooltipTarget = null;
            });

            document.getElementById('sectionsContainer').addEventListener('pointerdown', (e) => {
                if (e.target.closest('[data-sort-col]')) return;
                if (e.target.closest('[data-owner-filter]')) return;
                if (e.target.closest('.icon-btn')) return;
                const sectionHandle = e.target.closest('[data-section-drag]');
                if (sectionHandle) {
                    if (e.button !== 0) return;
                    e.preventDefault();
                    const card = sectionHandle.closest('.card[data-section-id]');
                    if (!card) return;
                    sectionDragState = {
                        id: card.dataset.sectionId,
                        startX: e.clientX,
                        startY: e.clientY,
                        dragging: false,
                        origin: card,
                        pointerId: e.pointerId
                    };
                    sectionHandle.setPointerCapture(e.pointerId);
                    return;
                }
                const th = e.target.closest('th');
                if (!th || !th.dataset.colId) return;
                if (e.button !== 0) return;
                e.preventDefault();
                const table = th.closest('table.sheet');
                colDragState = {
                    sectionId: th.dataset.sectionId,
                    colId: th.dataset.colId,
                    startX: e.clientX,
                    startY: e.clientY,
                    dragging: false,
                    origin: th,
                    table,
                    pointerId: e.pointerId
                };
                th.setPointerCapture(e.pointerId);
            });

            document.addEventListener('pointermove', (e) => {
                if (!colDragState || colDragState.pointerId !== e.pointerId) return;
                if (!colDragState.dragging) {
                    const dx = Math.abs(e.clientX - colDragState.startX);
                    const dy = Math.abs(e.clientY - colDragState.startY);
                    if (dx < 4 && dy < 4) return;
                    colDragState.dragging = true;
                    colDragState.origin.classList.add('dragging');
                    document.body.classList.add('col-dragging');
                }
                const table = colDragState.table;
                if (!table) return;
                const target = getColIdFromX(table, e.clientX);
                document.querySelectorAll('.col-drag-over').forEach(t => t.classList.remove('col-drag-over'));
                if (target && target.colId) {
                    const th = table.querySelector(`th[data-col-id="${target.colId}"]`);
                    if (th) th.classList.add('col-drag-over');
                    if (target.colId !== colDragState.colId) {
                        if (!colDragState.preview || colDragState.preview.colId !== target.colId || colDragState.preview.after !== target.after) {
                            previewMoveColumn(colDragState.sectionId, colDragState.colId, target.colId, target.after);
                            colDragState.preview = target;
                        }
                    }
                }
            });

            document.addEventListener('pointerup', (e) => {
                if (!colDragState || colDragState.pointerId !== e.pointerId) return;
                if (colDragState.dragging) {
                    const table = colDragState.table;
                    const target = colDragState.preview || (table ? getColIdFromX(table, e.clientX) : null);
                    if (target && target.colId && target.colId !== colDragState.colId) {
                        moveColumn(colDragState.sectionId, colDragState.colId, target.colId, target.after);
                    } else if (colDragState.preview) {
                        renderSections();
                    }
                    colDragState.origin.classList.remove('dragging');
                    document.querySelectorAll('.col-drag-over').forEach(t => t.classList.remove('col-drag-over'));
                    document.body.classList.remove('col-dragging');
                    lastColDragAt = Date.now();
                }
                colDragState = null;
            });

            document.addEventListener('pointercancel', (e) => {
                if (!colDragState || colDragState.pointerId !== e.pointerId) return;
                document.body.classList.remove('col-dragging');
                document.querySelectorAll('.col-drag-over').forEach(t => t.classList.remove('col-drag-over'));
                colDragState = null;
            });

            document.addEventListener('pointercancel', (e) => {
                if (!sectionDragState || sectionDragState.pointerId !== e.pointerId) return;
                stopSectionAutoScroll();
                if (sectionDragState.origin) sectionDragState.origin.classList.remove('section-dragging');
                document.querySelectorAll('.section-drop-target').forEach(el => el.classList.remove('section-drop-target'));
                sectionDragState = null;
            });

            document.addEventListener('pointermove', (e) => {
                if (!sectionDragState || sectionDragState.pointerId !== e.pointerId) return;
                if (!sectionDragState.dragging) {
                    const dx = Math.abs(e.clientX - sectionDragState.startX);
                    const dy = Math.abs(e.clientY - sectionDragState.startY);
                    if (dx < 4 && dy < 4) return;
                    sectionDragState.dragging = true;
                    sectionDragState.origin.classList.add('section-dragging');
                }
                updateSectionAutoScroll(e.clientY);
                const container = document.getElementById('sectionsContainer');
                const target = getSectionTarget(container, e.clientY);
                document.querySelectorAll('.section-drop-target').forEach(el => el.classList.remove('section-drop-target'));
                if (target && target.el) {
                    target.el.classList.add('section-drop-target');
                    sectionDragState.preview = target;
                }
            });

            document.addEventListener('pointerup', (e) => {
                if (!sectionDragState || sectionDragState.pointerId !== e.pointerId) return;
                if (sectionDragState.dragging && sectionDragState.preview) {
                    const target = sectionDragState.preview;
                    if (target.id !== sectionDragState.id) {
                        moveSection(sectionDragState.id, target.id, target.after);
                    }
                }
                stopSectionAutoScroll();
                if (sectionDragState.origin) sectionDragState.origin.classList.remove('section-dragging');
                document.querySelectorAll('.section-drop-target').forEach(el => el.classList.remove('section-drop-target'));
                sectionDragState = null;
            });

            document.getElementById('sectionsContainer').addEventListener('click', (e) => {
                if (Date.now() - lastColDragAt < 200) return;
                const sortBtn = e.target.closest('[data-sort-col]');
                if (sortBtn) {
                    const sectionId = sortBtn.dataset.sectionId;
                    const colId = sortBtn.dataset.sortCol;
                    const current = sortState[sectionId];
                    if (current && current.colId === colId) {
                        sortState[sectionId].dir = current.dir === 'asc' ? 'desc' : 'asc';
                    } else {
                        sortState[sectionId] = { colId, dir: 'asc' };
                    }
                    saveSortStateForEvent();
                    renderSections();
                    return;
                }

                const ownerFilterBtn = e.target.closest('[data-owner-filter]');
                if (ownerFilterBtn) {
                    const sectionId = ownerFilterBtn.dataset.ownerFilter;
                    ownerFilterState[sectionId] = !ownerFilterState[sectionId];
                    renderSections();
                    return;
                }

                const addRowBtn = e.target.closest('[data-add-row]');
                if (addRowBtn) {
                    addRow(addRowBtn.dataset.addRow);
                    return;
                }

                const addColBtn = e.target.closest('[data-add-column]');
                if (addColBtn) {
                    openAddColumnModal(addColBtn.dataset.addColumn);
                    return;
                }

                const delSectionBtn = e.target.closest('[data-delete-section]');
                if (delSectionBtn) {
                    openDeleteSectionModal(delSectionBtn.dataset.deleteSection);
                    return;
                }

                const delRowBtn = e.target.closest('[data-delete-row]');
                if (delRowBtn) {
                    deleteRow(delRowBtn.dataset.deleteRow, delRowBtn.dataset.rowId);
                    return;
                }

                const delColBtn = e.target.closest('[data-delete-column]');
                if (delColBtn) {
                    const section = eventData.sections.find(sec => sec.id === delColBtn.dataset.deleteColumn);
                    if (!section) return;
                    if (columnHasData(section, delColBtn.dataset.colId)) {
                        openDeleteColumnModal(delColBtn.dataset.deleteColumn, delColBtn.dataset.colId);
                    } else {
                        deleteColumn(delColBtn.dataset.deleteColumn, delColBtn.dataset.colId);
                    }
                    return;
                }

                const editColBtn = e.target.closest('[data-edit-column]');
                if (editColBtn) {
                    openEditColumnModal(editColBtn.dataset.editColumn, editColBtn.dataset.colId);
                    return;
                }

                const toggleRowBtn = e.target.closest('[data-toggle-row]');
                if (toggleRowBtn) {
                    toggleRowClosed(toggleRowBtn.dataset.toggleRow, toggleRowBtn.dataset.rowId);
                    return;
                }

                const beerBtn = e.target.closest('.beer-btn');
                if (beerBtn) {
                    const wrap = beerBtn.closest('.beer-select');
                    if (activeBeerTarget && activeBeerTarget.sectionId === wrap.dataset.sectionId
                        && activeBeerTarget.rowId === wrap.dataset.rowId
                        && activeBeerTarget.colId === wrap.dataset.colId
                        && !document.getElementById('beerMenuPortal').classList.contains('hidden')) {
                        hideBeerMenu();
                        return;
                    }
                    openBeerMenu(wrap);
                    return;
                }

                const beerOpt = e.target.closest('#beerMenuPortal .beer-opt');
                if (beerOpt && activeBeerTarget) {
                    updateCellValue(activeBeerTarget.sectionId, activeBeerTarget.rowId, activeBeerTarget.colId, beerOpt.dataset.beerValue || '');
                    if (activeBeerTarget.button) {
                        activeBeerTarget.button.textContent = beerOpt.dataset.beerValue || '–í—ã–±—Ä–∞—Ç—å –ø–∏–≤–æ';
                    }
                    hideBeerMenu();
                    return;
                }

                const ownerDisplay = e.target.closest('.owner-display');
                if (ownerDisplay) {
                    const wrap = ownerDisplay.closest('.owner-wrap');
                    if (activeOwnerTarget && activeOwnerTarget.sectionId === wrap.dataset.sectionId
                        && activeOwnerTarget.rowId === wrap.dataset.rowId
                        && activeOwnerTarget.colId === wrap.dataset.colId
                        && !document.getElementById('ownerMenuPortal').classList.contains('hidden')) {
                        hideOwnerMenu();
                        return;
                    }
                    openOwnerMenu(wrap);
                    return;
                }
            });

            const stickyPortal = document.getElementById('stickyPortal');
            if (stickyPortal) {
                stickyPortal.addEventListener('click', (e) => {
                    if (Date.now() - lastColDragAt < 200) return;
                    const sortBtn = e.target.closest('[data-sort-col]');
                    if (sortBtn) {
                        const sectionId = sortBtn.dataset.sectionId;
                        const colId = sortBtn.dataset.sortCol;
                        const current = sortState[sectionId];
                        if (current && current.colId === colId) {
                            sortState[sectionId].dir = current.dir === 'asc' ? 'desc' : 'asc';
                        } else {
                            sortState[sectionId] = { colId, dir: 'asc' };
                        }
                        saveSortStateForEvent();
                        renderSections();
                        return;
                    }

                    const ownerFilterBtn = e.target.closest('[data-owner-filter]');
                    if (ownerFilterBtn) {
                        const sectionId = ownerFilterBtn.dataset.ownerFilter;
                        ownerFilterState[sectionId] = !ownerFilterState[sectionId];
                        renderSections();
                        return;
                    }

                    const addRowBtn = e.target.closest('[data-add-row]');
                    if (addRowBtn) {
                        addRow(addRowBtn.dataset.addRow);
                        return;
                    }

                    const addColBtn = e.target.closest('[data-add-column]');
                    if (addColBtn) {
                        openAddColumnModal(addColBtn.dataset.addColumn);
                        return;
                    }

                    const delSectionBtn = e.target.closest('[data-delete-section]');
                    if (delSectionBtn) {
                        openDeleteSectionModal(delSectionBtn.dataset.deleteSection);
                        return;
                    }

                    const delColBtn = e.target.closest('[data-delete-column]');
                    if (delColBtn) {
                        const section = eventData.sections.find(sec => sec.id === delColBtn.dataset.deleteColumn);
                        if (!section) return;
                        if (columnHasData(section, delColBtn.dataset.colId)) {
                            openDeleteColumnModal(delColBtn.dataset.deleteColumn, delColBtn.dataset.colId);
                        } else {
                            deleteColumn(delColBtn.dataset.deleteColumn, delColBtn.dataset.colId);
                        }
                        return;
                    }

                    const editColBtn = e.target.closest('[data-edit-column]');
                    if (editColBtn) {
                        openEditColumnModal(editColBtn.dataset.editColumn, editColBtn.dataset.colId);
                        return;
                    }
                });
            }

            document.getElementById('ownerMenuPortal').addEventListener('change', (e) => {
                const ownerOption = e.target.closest('.owner-opt input');
                if (!ownerOption || !activeOwnerTarget) return;
                const { sectionId, rowId, colId } = activeOwnerTarget;
                const section = eventData.sections.find(sec => sec.id === sectionId);
                if (!section) return;
                const row = section.rows.find(r => r.id === rowId);
                if (!row) return;
                const current = Array.isArray(row.cells[colId]) ? row.cells[colId] : [];
                const userName = ownerOption.dataset.owner;
                let next = current.slice();
                if (ownerOption.checked) {
                    if (!next.includes(userName)) next.push(userName);
                } else {
                    next = next.filter(n => n !== userName);
                }
                row.cells[colId] = next;
                saveEventData();
                renderSections();
                const newWrap = document.querySelector(`.owner-wrap[data-section-id="${sectionId}"][data-row-id="${rowId}"][data-col-id="${colId}"]`);
                if (newWrap) openOwnerMenu(newWrap);
            });

            document.getElementById('beerMenuPortal').addEventListener('click', (e) => {
                const beerOpt = e.target.closest('.beer-opt');
                if (!beerOpt || !activeBeerTarget) return;
                updateCellValue(activeBeerTarget.sectionId, activeBeerTarget.rowId, activeBeerTarget.colId, beerOpt.dataset.beerValue || '');
                if (activeBeerTarget.button) {
                    activeBeerTarget.button.textContent = beerOpt.dataset.beerValue || '–í—ã–±—Ä–∞—Ç—å –ø–∏–≤–æ';
                }
                hideBeerMenu();
            });

            renderColumnTypeMenu();
            setColumnType('text');
            renderEditColumnTypeMenu();
            setEditColumnType('text');

            document.getElementById('columnTypeBtn').addEventListener('click', (e) => {
                e.stopPropagation();
                const menu = document.getElementById('columnTypeMenu');
                if (menu) menu.classList.toggle('hidden');
            });

            document.getElementById('columnTypeMenu').addEventListener('click', (e) => {
                const opt = e.target.closest('[data-type-value]');
                if (!opt) return;
                setColumnType(opt.dataset.typeValue);
            });

            document.getElementById('editColumnTypeBtn').addEventListener('click', (e) => {
                e.stopPropagation();
                const menu = document.getElementById('editColumnTypeMenu');
                if (menu) menu.classList.toggle('hidden');
            });

            document.getElementById('editColumnTypeMenu').addEventListener('click', (e) => {
                const opt = e.target.closest('[data-type-value]');
                if (!opt) return;
                setEditColumnType(opt.dataset.typeValue);
            });

            document.getElementById('cancelColumnBtn').addEventListener('click', closeAddColumnModal);
            document.getElementById('createColumnBtn').addEventListener('click', createColumnFromModal);
            document.getElementById('columnNameInput').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') createColumnFromModal();
                if (e.key === 'Escape') closeAddColumnModal();
            });
            document.getElementById('addColumnModal').addEventListener('click', (e) => {
                if (e.target.id === 'addColumnModal') closeAddColumnModal();
            });

            document.getElementById('cancelEditColumnBtn').addEventListener('click', closeEditColumnModal);
            document.getElementById('saveEditColumnBtn').addEventListener('click', saveEditColumn);
            document.getElementById('editColumnNameInput').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') saveEditColumn();
                if (e.key === 'Escape') closeEditColumnModal();
            });
            document.getElementById('editColumnModal').addEventListener('click', (e) => {
                if (e.target.id === 'editColumnModal') closeEditColumnModal();
            });

            document.getElementById('cancelDeleteSectionBtn').addEventListener('click', closeDeleteSectionModal);
            document.getElementById('confirmDeleteSectionBtn').addEventListener('click', confirmDeleteSection);
            document.getElementById('deleteSectionModal').addEventListener('click', (e) => {
                if (e.target.id === 'deleteSectionModal') closeDeleteSectionModal();
            });

            document.getElementById('cancelDeleteColumnBtn').addEventListener('click', closeDeleteColumnModal);
            document.getElementById('confirmDeleteColumnBtn').addEventListener('click', confirmDeleteColumn);
            document.getElementById('deleteColumnModal').addEventListener('click', (e) => {
                if (e.target.id === 'deleteColumnModal') closeDeleteColumnModal();
            });

            document.getElementById('addSectionColumnBtn').addEventListener('click', addDraftColumn);
            document.getElementById('cancelNewSectionBtn').addEventListener('click', closeNewSectionModal);
            document.getElementById('createNewSectionBtn').addEventListener('click', createNewSectionFromModal);
            document.getElementById('newSectionModal').addEventListener('click', (e) => {
                if (e.target.id === 'newSectionModal') closeNewSectionModal();
            });
            document.getElementById('newSectionNameInput').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') createNewSectionFromModal();
                if (e.key === 'Escape') closeNewSectionModal();
            });
            document.getElementById('newSectionColumns').addEventListener('click', (e) => {
                const removeBtn = e.target.closest('[data-remove-col]');
                if (removeBtn) {
                    const idx = Number(removeBtn.dataset.removeCol);
                    if (!Number.isNaN(idx) && idx > 0) {
                        newSectionColumnsDraft.splice(idx, 1);
                        renderNewSectionColumns();
                    }
                    return;
                }
                const typeBtn = e.target.closest('[data-col-type-btn]');
                if (typeBtn) {
                    const idx = Number(typeBtn.dataset.colTypeBtn);
                    if (Number.isNaN(idx)) return;
                    const menu = document.querySelector(`[data-col-type-menu="${idx}"]`);
                    if (menu) menu.classList.toggle('hidden');
                }
                const typeOpt = e.target.closest('[data-col-type-value]');
                if (typeOpt) {
                    const idx = Number(typeOpt.dataset.colIndex);
                    if (Number.isNaN(idx)) return;
                    newSectionColumnsDraft[idx].type = typeOpt.dataset.colTypeValue;
                    renderNewSectionColumns();
                }
            });
            document.getElementById('newSectionColumns').addEventListener('input', (e) => {
                const input = e.target.closest('[data-col-name]');
                if (!input) return;
                const idx = Number(input.dataset.colName);
                if (Number.isNaN(idx)) return;
                newSectionColumnsDraft[idx].name = input.value;
            });
        }

        function updateStickyTop() {
            document.documentElement.style.setProperty('--sticky-top', '0px');
            updateStickyHeaders();
        }

        initProfileName();
        init();
    </script>
</body>
</html>
