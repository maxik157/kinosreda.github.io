<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ø–µ—Ä–µ–∫—É—Å–æ–≤ ‚Äî –ö–∏–Ω–æ—Å—Ä–µ–¥–∞</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect x='20' y='30' width='45' height='55' rx='5' fill='none' stroke='%23b45309' stroke-width='4'/%3E%3Crect x='22' y='45' width='41' height='38' rx='3' fill='%23f59e0b'/%3E%3Cellipse cx='42' cy='35' rx='24' ry='8' fill='%23fff'/%3E%3Ccircle cx='30' cy='33' r='5' fill='%23fff'/%3E%3Ccircle cx='45' cy='31' r='4' fill='%23fff'/%3E%3Ccircle cx='55' cy='34' r='4' fill='%23fff'/%3E%3Cpath d='M65 38 Q85 38 85 55 Q85 72 65 72' fill='none' stroke='%23b45309' stroke-width='5' stroke-linecap='round'/%3E%3C/svg%3E" />

    <script>
        // Auth gate
        (function () {
            try {
                const cu = localStorage.getItem('currentUser');
                if (!cu) {
                    location.replace('login.html');
                    return;
                }
                document.documentElement.classList.add('authed');
            } catch (e) {
                location.replace('login.html');
            }
        })();
        // Theme gate
        (function(){
            try { document.documentElement.dataset.theme = localStorage.getItem('siteTheme') || 'beer'; } catch(_) {}
        })();
    </script>
    <style>
        html:not(.authed) body { visibility: hidden; }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        (function(){
            const html = document.documentElement;
            const KEY = 'logoFontFamily';
            const DEFAULT = 'Rubik Wet Paint';
            const LINK_ID = 'logoFontGF';

            function familyToHref(fam){
                const q = encodeURIComponent(fam).replace(/%20/g, '+');
                return `https://fonts.googleapis.com/css2?family=${q}&display=swap`;
            }

            function ensureStylesheet(fam){
                const family = (fam || DEFAULT).trim();
                if (!family) return;
                const href = familyToHref(family);
                let link = document.getElementById(LINK_ID);
                if (!link) {
                    link = document.createElement('link');
                    link.id = LINK_ID;
                    link.rel = 'stylesheet';
                    document.head.appendChild(link);
                }
                if (link.getAttribute('href') !== href) link.setAttribute('href', href);
            }

            function markReady(){
                html.classList.add('logo-font-ready');
                html.classList.remove('logo-font-loading');
            }

            function waitForFont(fam){
                const family = (fam || DEFAULT).trim();
                if (!family) return markReady();

                ensureStylesheet(family);

                html.classList.add('logo-font-loading');
                html.classList.remove('logo-font-ready');
                try {
                    if (document.fonts && document.fonts.load) {
                        document.fonts.load(`1em "${family}"`).then(markReady, markReady);
                    } else {
                        setTimeout(markReady, 1);
                    }
                } catch (_) {
                    markReady();
                }
            }

            try {
                const fam = localStorage.getItem(KEY) || DEFAULT;
                html.style.setProperty('--logo-font', `'${fam}'`);
                waitForFont(fam);
            } catch(_) {
                markReady();
            }
        })();
    </script>

    <style>
        html:not(.logo-font-ready) .logo-text { opacity: 0; }
        .logo-text { transition: opacity 0.15s ease; }

        html, body {
            background: #000;
            overflow-x: hidden;
            overscroll-behavior: none;
        }
        body {
            font-family: 'Comfortaa', cursive;
            color: #fff;
            min-height: 100vh;
        }
        @font-face {
            font-family: 'Egyptian Bold Extended';
            src: local('Egyptian Bold Extended'), local('Egyptian Bold Extended Regular');
            font-weight: 700;
            font-style: normal;
            font-display: swap;
        }
        :root {
            --logo-font: 'Rubik Wet Paint';
            --accent-200: #fde68a;
            --accent-300: #fcd34d;
            --accent-400: #f59e0b;
            --accent-500: #f59e0b;
            --logo-glow-1: rgba(245,158,11,0.50);
            --logo-glow-2: rgba(245,158,11,0.80);
            --logo-glow-3: rgba(245,158,11,0.40);
            --accent-border-10: rgba(245,158,11,0.10);
            --accent-border-20: rgba(245,158,11,0.20);
            --accent-border-25: rgba(245,158,11,0.25);
            --accent-border-30: rgba(245,158,11,0.30);
            --accent-border-50: rgba(245,158,11,0.50);
            --accent-soft: rgba(245,158,11,0.12);
        }
        html[data-theme="white"] {
            --accent-200: #ffffff;
            --accent-300: #e5e7eb;
            --accent-400: #ffffff;
            --accent-500: #ffffff;
            --logo-glow-1: rgba(255,255,255,0.45);
            --logo-glow-2: rgba(255,255,255,0.75);
            --logo-glow-3: rgba(255,255,255,0.35);
            --accent-border-10: rgba(255,255,255,0.18);
            --accent-border-20: rgba(255,255,255,0.26);
            --accent-border-25: rgba(255,255,255,0.30);
            --accent-border-30: rgba(255,255,255,0.34);
            --accent-border-50: rgba(255,255,255,0.55);
            --accent-soft: rgba(255,255,255,0.10);
        }
        .text-amber-400 { color: var(--accent-400) !important; }
        .text-amber-300 { color: var(--accent-300) !important; }
        .text-amber-200 { color: var(--accent-200) !important; }
        .text-amber-500 { color: var(--accent-500) !important; }
        .border-amber-500\/10 { border-color: var(--accent-border-10) !important; }
        .border-amber-500\/20 { border-color: var(--accent-border-20) !important; }
        .border-amber-500\/25 { border-color: var(--accent-border-25) !important; }
        .border-amber-500\/30 { border-color: var(--accent-border-30) !important; }
        .border-amber-500\/50 { border-color: var(--accent-border-50) !important; }
        .bg-amber-500\/10 { background-color: var(--accent-soft) !important; }
        .hover\:bg-amber-500\/10:hover { background-color: var(--accent-soft) !important; }
        #logoText { fill: var(--accent-500) !important; }

        .logo-text { font-family: var(--logo-font), 'Comfortaa', cursive; font-weight: 400; letter-spacing: 0.02em; }
        @keyframes pulse-glow {
            0%, 100% { filter: drop-shadow(0 0 5px var(--logo-glow-1)); }
            50% { filter: drop-shadow(0 0 15px var(--logo-glow-2)) drop-shadow(0 0 30px var(--logo-glow-3)); }
        }
        .pulse-glow { animation: pulse-glow 3s ease-in-out infinite; }

        .bg-dark { background: #000; position: relative; }
        .bg-dark::before {
            content: '';
            position: fixed;
            inset: 0;
            background:
                radial-gradient(ellipse at 12% 0%, rgba(245, 158, 11, 0.12) 0%, transparent 50%),
                radial-gradient(ellipse at 88% 100%, rgba(245, 158, 11, 0.08) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }
        .glow {
            box-shadow: 0 0 0 1px rgba(245,158,11,0.12), 0 18px 50px rgba(245,158,11,0.08);
        }
        .card {
            background: rgba(8, 8, 8, 0.75);
            border: 1px solid var(--accent-border-20);
            border-radius: 18px;
            backdrop-filter: blur(8px);
            position: relative;
            z-index: 1;
            overflow: visible;
        }
        .card.elevated { z-index: 30; }
        .card.calendar-open { z-index: 80; }
        .section-title {
            font-size: 1.1rem;
            font-weight: 700;
            letter-spacing: 0.01em;
        }
        .input-field,
        .select-field {
            background: #0c0c0c;
            border: 1px solid var(--accent-border-30);
            color: #fff;
            padding: 10px 12px;
            border-radius: 12px;
            font-size: 0.9rem;
            width: 100%;
        }
        .input-field::placeholder { color: #6b7280; }
        .input-field:focus,
        .select-field:focus {
            outline: none;
            border-color: var(--accent-400);
            box-shadow: 0 0 0 1px var(--accent-400);
        }
        .btn-amber {
            background: linear-gradient(90deg, rgba(245,158,11,0.25), rgba(245,158,11,0.45));
            border: 1px solid var(--accent-border-30);
            color: var(--accent-200);
            padding: 10px 14px;
            border-radius: 12px;
            font-weight: 600;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .btn-amber:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 16px rgba(245,158,11,0.15);
        }
        .btn-muted {
            border: 1px solid rgba(255,255,255,0.12);
            color: #cbd5f5;
            padding: 8px 12px;
            border-radius: 10px;
            font-size: 0.85rem;
        }
        .row-remove {
            width: 30px;
            height: 30px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.12);
            background: rgba(0,0,0,0.35);
            color: #fca5a5;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.15s ease, box-shadow 0.2s ease, background 0.2s ease;
            justify-self: start;
            box-sizing: border-box;
            margin: 0;
        }
        @media (min-width: 640px) {
            .row-remove {
                justify-self: start;
                transform: translateX(-30px);
            }
        }
        .row-remove:hover {
            background: rgba(248,113,113,0.15);
            color: #fecaca;
            transform: scale(1.05);
        }
        @media (min-width: 640px) {
            .row-remove:hover { transform: translateX(-30px) scale(1.05); }
        }
        .beer-select {
            position: relative;
            min-width: 180px;
            z-index: 20;
        }
        .beer-select.menu-open { z-index: 200; }
        .beer-btn {
            width: 100%;
            text-align: left;
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px solid var(--accent-border-30);
            background: #0c0c0c;
            color: #fff;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }
        .beer-btn .beer-label {
            flex: 1;
            min-width: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .beer-btn::after {
            content: '‚ñæ';
            color: #9ca3af;
            font-size: 0.75rem;
        }
        .beer-menu {
            position: absolute;
            top: calc(100% + 6px);
            left: 0;
            right: 0;
            z-index: 210;
            max-height: 240px;
            overflow-y: auto;
            overscroll-behavior: contain;
            background: rgba(8,8,8,0.96);
            border: 1px solid var(--accent-border-30);
            border-radius: 12px;
            padding: 6px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.45);
        }
        .calendar-panel {
            position: absolute;
            top: calc(100% + 10px);
            right: 0;
            width: min(320px, 90vw);
            background: rgba(10,10,10,0.98);
            border: 1px solid var(--accent-border-30);
            border-radius: 16px;
            padding: 14px;
            z-index: 200;
            box-shadow: 0 12px 32px rgba(0,0,0,0.45);
        }
        .calendar-panel.hidden { display: none; }
        .calendar-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 12px;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, minmax(0, 1fr));
            gap: 6px;
        }
        .calendar-day {
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.08);
            padding: 8px 6px;
            background: rgba(0,0,0,0.35);
            color: #d1d5db;
            font-size: 0.85rem;
            text-align: center;
            position: relative;
        }
        .calendar-day.is-today { border-color: var(--accent-border-50); color: var(--accent-200); }
        .calendar-day.is-active { background: rgba(245,158,11,0.22); color: #fff; }
        .calendar-day button {
            width: 100%;
            height: 100%;
        }
        .calendar-day .day-count {
            position: absolute;
            top: 4px;
            right: 5px;
            font-size: 0.65rem;
            color: #fcd34d;
        }
        .calendar-weekday {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #6b7280;
            text-align: center;
        }
        .beer-menu.hidden { display: none; }
        .beer-opt {
            width: 100%;
            text-align: left;
            padding: 8px 10px;
            border-radius: 8px;
            color: #e5e7eb;
            font-size: 0.85rem;
            background: rgba(0,0,0,0.35);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block;
        }
        .beer-opt:hover {
            background: rgba(245,158,11,0.12);
            color: var(--accent-200);
        }
        .beer-opt[disabled] {
            opacity: 0.55;
            cursor: default;
        }
        .table-head {
            color: #9ca3af;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }
        .cell-label {
            color: #6b7280;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .summary-card {
            border: 1px solid var(--accent-border-20);
            background: rgba(10, 10, 10, 0.85);
            border-radius: 18px;
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 999px;
            background: #22c55e;
            box-shadow: 0 0 10px rgba(34,197,94,0.5);
        }
        #saveStatus[data-mode="pending"] .status-dot {
            background: #f59e0b;
            box-shadow: 0 0 10px rgba(245,158,11,0.6);
        }
        #saveStatus[data-mode="error"] .status-dot {
            background: #ef4444;
            box-shadow: 0 0 10px rgba(239,68,68,0.6);
        }
    </style>
</head>
<body class="bg-dark">
    <header class="py-2 md:py-4 relative z-50 sticky top-0 bg-black/95 backdrop-blur-sm border-b border-amber-500/10">
        <div class="container mx-auto px-3 md:px-4 max-w-7xl flex flex-col md:flex-row justify-between items-center gap-2 md:gap-4">
            <div class="flex items-center gap-3 pl-2">
                <svg class="w-[220px] md:w-[360px] h-12 md:h-20 float pulse-glow flex-shrink-0" viewBox="0 0 580 120" style="overflow: visible;">
                    <defs>
                        <linearGradient id="beerGradSnack" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" style="stop-color:#fcd34d"/>
                            <stop offset="50%" style="stop-color:#fbbf24"/>
                            <stop offset="100%" style="stop-color:#d97706"/>
                        </linearGradient>
                        <linearGradient id="foamGradSnack" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" style="stop-color:#ffffff"/>
                            <stop offset="100%" style="stop-color:#fef3c7"/>
                        </linearGradient>
                        <clipPath id="mugClipSnack"><rect x="0" y="0" width="50" height="55" rx="3"/></clipPath>
                        <filter id="glowSnack">
                            <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
                            <feMerge>
                                <feMergeNode in="coloredBlur"/>
                                <feMergeNode in="SourceGraphic"/>
                            </feMerge>
                        </filter>
                    </defs>

                    <a href="index.html" aria-label="–ù–∞ –≥–ª–∞–≤–Ω—É—é" style="cursor:pointer;">
                        <text id="logoText" x="28" y="78" text-anchor="start" class="logo-text" fill="var(--accent-500)" font-size="62" textLength="395" lengthAdjust="spacingAndGlyphs" filter="url(#glowSnack)">–ö–ò–ù–û–°–†–ï–î–ê</text>
                    </a>

                    <g id="logoMug" transform="translate(438, 2)">
                        <rect x="0" y="25" width="50" height="60" rx="5" fill="none" stroke="rgba(180,83,9,0.95)" stroke-width="3"/>
                        <g clip-path="url(#mugClipSnack)" transform="translate(0, 30)">
                            <rect x="0" y="55" height="0" width="50" fill="url(#beerGradSnack)">
                                <animate attributeName="height" from="0" to="55" dur="2.5s" fill="freeze"/>
                                <animate attributeName="y" from="55" to="0" dur="2.5s" fill="freeze"/>
                            </rect>
                        </g>
                        <g opacity="0"><animate attributeName="opacity" from="0" to="1" dur="0.5s" begin="2s" fill="freeze"/>
                            <ellipse cx="25" cy="27" rx="27" ry="10" fill="url(#foamGradSnack)"/>
                            <circle cx="12" cy="24" r="6" fill="white" opacity="0.95"/>
                            <circle cx="28" cy="22" r="5" fill="white" opacity="0.9"/>
                            <circle cx="40" cy="25" r="5" fill="white" opacity="0.9"/>
                        </g>
                        <path d="M50 32 Q72 32 72 55 Q72 78 50 78" fill="none" stroke="#b45309" stroke-width="5" stroke-linecap="round"/>
                    </g>
                </svg>
            </div>

            <div class="flex items-center gap-1 md:gap-3 flex-nowrap whitespace-nowrap justify-center">
                <a href="index.html" class="text-amber-400 hover:text-amber-300 transition font-medium text-xs md:text-sm px-2 md:px-3 py-1 md:py-2 rounded-lg hover:bg-amber-500/10 flex items-center gap-1 md:gap-2">
                    <span>‚Üê</span> <span class="hidden sm:inline">–ù–∞ –≥–ª–∞–≤–Ω—É—é</span>
                </a>
                <a href="planning.html" class="text-amber-400 hover:text-amber-300 transition font-medium text-xs md:text-sm px-2 md:px-3 py-1 md:py-2 rounded-lg hover:bg-amber-500/10 flex items-center gap-1 md:gap-2" title="–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ">
                    <span>üå¥</span>
                </a>
                <span class="text-amber-400 transition font-medium text-xs md:text-sm px-2 md:px-3 py-1 md:py-2 rounded-lg bg-amber-500/10 flex items-center gap-1 md:gap-2" title="–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ø–µ—Ä–µ–∫—É—Å–æ–≤">
                    <span>ü•®</span>
                </span>
                <a href="profile.html" class="text-amber-400 hover:text-amber-300 transition font-medium text-xs md:text-sm px-2 md:px-3 py-1 md:py-2 rounded-lg hover:bg-amber-500/10 flex items-center gap-1 md:gap-2" title="–ü—Ä–æ—Ñ–∏–ª—å">
                    <span>üë§</span> <span id="profileName" class="hidden sm:inline"></span>
                </a>
                <button onclick="logout()" class="text-red-400 hover:text-red-300 transition font-medium text-xs md:text-sm px-2 md:px-3 py-1 md:py-2 rounded-lg hover:bg-red-500/10">
                    <span class="sm:hidden">üö™</span><span class="hidden sm:inline">–í—ã–π—Ç–∏</span>
                </button>
            </div>
        </div>
    </header>

    <main class="relative z-10">
        <section class="container mx-auto px-3 md:px-4 max-w-7xl pt-6 pb-12">
            <div class="flex flex-col lg:flex-row gap-6 lg:items-start lg:justify-between">
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold text-amber-200 m-0">–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ø–µ—Ä–µ–∫—É—Å–æ–≤</h1>
                </div>
                <div class="card glow p-3 w-full lg:w-auto">
                    <div class="flex flex-col sm:flex-row sm:items-center gap-3 relative">
                        <div class="flex items-center gap-2">
                            <button id="prevDateBtn" type="button" class="btn-muted" aria-label="–ü—Ä–µ–¥—ã–¥—É—â–∏–π –¥–µ–Ω—å">‚Üê</button>
                            <input id="snackDate" type="date" class="input-field" />
                            <button id="nextDateBtn" type="button" class="btn-muted" aria-label="–°–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å">‚Üí</button>
                            <button id="calendarToggle" type="button" class="btn-muted" aria-label="–û—Ç–∫—Ä—ã—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å">üìÖ</button>
                        </div>
                    </div>
                    <div id="calendarPanel" class="calendar-panel hidden">
                        <div class="calendar-head">
                            <button id="calendarPrevMonth" type="button" class="btn-muted" aria-label="–ü—Ä–µ–¥—ã–¥—É—â–∏–π –º–µ—Å—è—Ü">‚Üê</button>
                            <div id="calendarMonthLabel" class="text-sm text-amber-200 font-semibold"></div>
                            <button id="calendarNextMonth" type="button" class="btn-muted" aria-label="–°–ª–µ–¥—É—é—â–∏–π –º–µ—Å—è—Ü">‚Üí</button>
                        </div>
                        <div class="calendar-grid mb-2">
                            <div class="calendar-weekday">–ü–Ω</div>
                            <div class="calendar-weekday">–í—Ç</div>
                            <div class="calendar-weekday">–°—Ä</div>
                            <div class="calendar-weekday">–ß—Ç</div>
                            <div class="calendar-weekday">–ü—Ç</div>
                            <div class="calendar-weekday">–°–±</div>
                            <div class="calendar-weekday">–í—Å</div>
                        </div>
                        <div id="calendarDays" class="calendar-grid"></div>
                    </div>
                </div>
            </div>

            <div class="grid gap-6 lg:grid-cols-2 mt-8 items-start">
                <div class="card glow p-5">
                    <div class="flex items-center justify-between">
                        <h2 class="section-title text-amber-200">–ü–∏–≤–æ</h2>
                        <button id="addBeerRow" class="btn-amber">+ –î–æ–±–∞–≤–∏—Ç—å –ø–∏–≤–æ</button>
                    </div>
                    <div class="mt-5 space-y-3">
                        <div class="hidden sm:grid grid-cols-[minmax(180px,1fr)_100px_120px_110px_32px] gap-3 table-head">
                            <div>–ü–∏–≤–æ</div>
                            <div>–û–±—ä–µ–º</div>
                            <div>–ö–∫–∞–ª / 100 –º–ª</div>
                            <div>–ò—Ç–æ–≥–æ</div>
                            <div></div>
                        </div>
                        <div id="beerRows" class="space-y-3"></div>
                    </div>
                    <div class="mt-5 flex items-center justify-between text-sm">
                        <span class="text-gray-400">–ò—Ç–æ–≥–æ –ø–æ –ø–∏–≤—É</span>
                        <span id="beerTotal" class="text-amber-200 font-semibold">0 –∫–∫–∞–ª</span>
                    </div>
                </div>

                <div class="card glow p-5">
                    <div class="flex items-center justify-between">
                        <h2 class="section-title text-amber-200">–ï–¥–∞</h2>
                        <button id="addFoodRow" class="btn-amber">+ –î–æ–±–∞–≤–∏—Ç—å –±–ª—é–¥–æ</button>
                    </div>
                    <div class="mt-5 space-y-3">
                        <div class="hidden sm:grid grid-cols-[minmax(180px,1fr)_110px_120px_110px_32px] gap-3 table-head">
                            <div>–ë–ª—é–¥–æ / –ø—Ä–æ–¥—É–∫—Ç</div>
                            <div>–í–µ—Å, –≥</div>
                            <div>–ö–∫–∞–ª / 100 –≥</div>
                            <div>–ò—Ç–æ–≥–æ</div>
                            <div></div>
                        </div>
                        <div id="foodRows" class="space-y-3"></div>
                    </div>
                    <div class="mt-5 flex items-center justify-between text-sm">
                        <span class="text-gray-400">–ò—Ç–æ–≥–æ –ø–æ –µ–¥–µ</span>
                        <span id="foodTotal" class="text-amber-200 font-semibold">0 –∫–∫–∞–ª</span>
                    </div>
                </div>
            </div>

            <div class="card glow p-5 mt-6">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                    <div>
                        <div class="text-xs uppercase tracking-[0.3em] text-amber-300/70">–û–±—â–∏–π –∏—Ç–æ–≥</div>
                        <div class="text-lg md:text-xl font-bold text-amber-200">–°—É–º–º–∞—Ä–Ω–∞—è –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å –∑–∞ –¥–µ–Ω—å</div>
                    </div>
                    <div id="grandTotal" class="text-2xl md:text-3xl font-bold text-amber-300">0 –∫–∫–∞–ª</div>
                </div>
            </div>

            <section class="mt-10">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                    <div>
                        <div class="text-xs uppercase tracking-[0.3em] text-amber-300/70">–°–≤–æ–¥–∫–∞</div>
                        <h2 class="text-xl md:text-2xl font-bold text-amber-200">–ü–µ—Ä–µ–∫—É—Å—ã —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</h2>
                    </div>
                    <div id="summaryDateLabel" class="text-sm text-gray-400"></div>
                </div>
                <div id="summaryEmpty" class="card glow p-6 text-center text-gray-400 mt-5">–ü–æ–∫–∞ –Ω–∏–∫—Ç–æ –Ω–µ –¥–æ–±–∞–≤–∏–ª –ø–µ—Ä–µ–∫—É—Å—ã –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –¥–µ–Ω—å.</div>
                <div id="summaryCards" class="grid gap-5 sm:grid-cols-2 lg:grid-cols-3 mt-5"></div>
            </section>
        </section>
    </main>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBwp4ZNbJuUM5sY0qMffvZTHr2PDvc2iLc",
            authDomain: "kinosreda-ce8ef.firebaseapp.com",
            databaseURL: "https://kinosreda-ce8ef-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "kinosreda-ce8ef",
            storageBucket: "kinosreda-ce8ef.firebasestorage.app",
            messagingSenderId: "889337905300",
            appId: "1:889337905300:web:325aea2f3fb3c6b44a7481",
            measurementId: "G-MGW6GF67H3"
        };

        const state = {
            db: null,
            beerRating: [],
            usersMap: {},
            currentUser: { login: '', name: '' },
            currentDate: '',
            availableDates: [],
            dateCounts: {},
            calendarMonth: null,
            snacksRef: null,
            snacksData: {},
            lastSavedAt: null,
            suppressFormUpdate: false,
            saveTimer: null
        };

        function initCurrentUser() {
            try {
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
                if (currentUser && currentUser.username) state.currentUser.login = currentUser.username;
                if (currentUser && currentUser.name) state.currentUser.name = currentUser.name;
                const nameEl = document.getElementById('profileName');
                if (nameEl && currentUser && currentUser.name) nameEl.textContent = currentUser.name;
            } catch (_) {}
        }

        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'login.html';
        }

        function formatLocalDate(d = new Date()) {
            const tzOffset = d.getTimezoneOffset() * 60000;
            return new Date(d.getTime() - tzOffset).toISOString().slice(0, 10);
        }

        function formatLocalDateFromDate(date) {
            if (!date) return formatLocalDate();
            const tzOffset = date.getTimezoneOffset() * 60000;
            return new Date(date.getTime() - tzOffset).toISOString().slice(0, 10);
        }

        function formatDateRu(dateKey) {
            if (!dateKey) return '';
            const [year, month, day] = dateKey.split('-').map(Number);
            if (!year || !month || !day) return dateKey;
            const dt = new Date(Date.UTC(year, month - 1, day));
            return dt.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long', year: 'numeric' });
        }

        function formatKcal(value) {
            const num = Math.round(value || 0);
            return `${num.toLocaleString('ru-RU')} –∫–∫–∞–ª`;
        }

        function calcBeerCalories(volume, caloriesPer100) {
            const vol = parseFloat(volume);
            const cal = parseFloat(caloriesPer100);
            if (!vol || !cal) return 0;
            return cal * vol * 10;
        }

        function calcFoodCalories(weight, caloriesPer100) {
            const wt = parseFloat(weight);
            const cal = parseFloat(caloriesPer100);
            if (!wt || !cal) return 0;
            return (cal * wt) / 100;
        }

        function escapeHtml(str) {
            return String(str || '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function normalizeBeerList(val) {
            if (!val) return [];
            if (Array.isArray(val)) return val.filter(Boolean);
            return Object.values(val);
        }

        function getBeerById(id) {
            if (!id) return null;
            return state.beerRating.find(b => String(b.id) === String(id)) || null;
        }

        function buildBeerMenuItems(selectedId, selectedName) {
            const list = [...state.beerRating].sort((a, b) => {
                const an = (a.name || '').toString();
                const bn = (b.name || '').toString();
                return an.localeCompare(bn, 'ru');
            });
            const selected = selectedId || (selectedName ? selectedName : '');
            const hasSelected = selected && list.some(b => String(b.id) === String(selected));
            const items = [
                '<button type="button" class="beer-opt" data-beer-id="">–í—ã–±—Ä–∞—Ç—å –ø–∏–≤–æ</button>'
            ];
            if (selected && !hasSelected) {
                const label = selectedName ? `${selectedName} (—É–¥–∞–ª–µ–Ω–æ)` : `–ü–∏–≤–æ ${selected}`;
                items.push(`<button type="button" class="beer-opt" data-beer-id="${escapeHtml(selected)}" title="${escapeHtml(label)}">${escapeHtml(label)}</button>`);
            }
            if (!list.length) {
                items.push('<div class="text-xs text-gray-500 px-2 py-1">–ü–æ–∫–∞ –Ω–µ—Ç –ø–∏–≤–∞ –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ</div>');
            } else {
                list.forEach(beer => {
                    const id = beer.id != null ? String(beer.id) : '';
                    const label = beer.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
                    items.push(`<button type="button" class="beer-opt" data-beer-id="${escapeHtml(id)}" title="${escapeHtml(label)}">${escapeHtml(label)}</button>`);
                });
            }
            return items.join('');
        }

        function closeBeerMenus() {
            document.querySelectorAll('.beer-select.menu-open').forEach(wrap => {
                wrap.classList.remove('menu-open');
                const menu = wrap.querySelector('.beer-menu');
                if (menu) menu.classList.add('hidden');
                const btn = wrap.querySelector('.beer-btn');
                if (btn) btn.setAttribute('aria-expanded', 'false');
                const card = wrap.closest('.card');
                if (card) card.classList.remove('elevated');
            });
        }

        function toggleBeerMenu(wrap) {
            if (!wrap) return;
            const isOpen = wrap.classList.contains('menu-open');
            closeBeerMenus();
            if (!isOpen) {
                const menu = wrap.querySelector('.beer-menu');
                if (menu) menu.classList.remove('hidden');
                wrap.classList.add('menu-open');
                const btn = wrap.querySelector('.beer-btn');
                if (btn) btn.setAttribute('aria-expanded', 'true');
                const card = wrap.closest('.card');
                if (card) card.classList.add('elevated');
            }
        }

        function createBeerRow(data = {}) {
            const row = document.createElement('div');
            row.className = 'grid grid-cols-1 sm:grid-cols-[minmax(180px,1fr)_100px_120px_110px_32px] gap-3 items-center';
            row.dataset.beerRow = '1';

            const selectWrap = document.createElement('div');
            selectWrap.className = 'beer-select';
            selectWrap.dataset.beerSelect = '1';
            const beerBtn = document.createElement('button');
            beerBtn.type = 'button';
            beerBtn.className = 'beer-btn';
            beerBtn.setAttribute('aria-expanded', 'false');
            const beerLabel = document.createElement('span');
            beerLabel.className = 'beer-label';
            beerLabel.textContent = data.name || '–í—ã–±—Ä–∞—Ç—å –ø–∏–≤–æ';
            beerBtn.appendChild(beerLabel);
            const beerMenu = document.createElement('div');
            beerMenu.className = 'beer-menu hidden';
            const selectedId = data.beerId || '';
            beerMenu.innerHTML = buildBeerMenuItems(selectedId, data.name || '');
            selectWrap.appendChild(beerBtn);
            selectWrap.appendChild(beerMenu);

            const volEl = document.createElement('div');
            volEl.className = 'text-sm text-gray-200 flex items-center gap-2';
            volEl.innerHTML = '<span class="cell-label sm:hidden">–û–±—ä–µ–º</span><span data-beer-volume>‚Äî</span>';

            const calEl = document.createElement('div');
            calEl.className = 'text-sm text-gray-200 flex items-center gap-2';
            calEl.innerHTML = '<span class="cell-label sm:hidden">–ö–∫–∞–ª / 100 –º–ª</span><span data-beer-calories>‚Äî</span>';

            const totalEl = document.createElement('div');
            totalEl.className = 'text-sm font-semibold text-amber-200 flex items-center gap-2';
            totalEl.innerHTML = '<span class="cell-label sm:hidden">–ò—Ç–æ–≥–æ</span><span data-beer-total>0</span>';

            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'row-remove';
            removeBtn.textContent = '‚úï';

            row.appendChild(selectWrap);
            row.appendChild(volEl);
            row.appendChild(calEl);
            row.appendChild(totalEl);
            row.appendChild(removeBtn);

            function applyBeerInfo(beerInfo, useInitial = false) {
                const source = beerInfo || (useInitial ? data : null);
                const volume = source && source.volume != null ? source.volume : '';
                const calories = source && source.calories != null ? source.calories : '';
                const name = source && source.name ? source.name : '';
                const id = source && source.id != null ? source.id : (useInitial ? (data.beerId || '') : '');

                row.dataset.beerId = id != null ? String(id) : '';
                row.dataset.beerName = name || '';
                row.dataset.beerVolume = volume != null ? String(volume) : '';
                row.dataset.beerCalories = calories != null ? String(calories) : '';

                row.querySelector('[data-beer-volume]').textContent = volume ? `${volume} –ª` : '‚Äî';
                row.querySelector('[data-beer-calories]').textContent = calories ? `${calories}` : '‚Äî';
                const total = calcBeerCalories(volume, calories);
                row.dataset.beerTotal = String(total || 0);
                row.querySelector('[data-beer-total]').textContent = total ? Math.round(total).toString() : '0';
                const label = name || '–í—ã–±—Ä–∞—Ç—å –ø–∏–≤–æ';
                beerLabel.textContent = label;
                beerBtn.title = label;
            }

            const selectedBeer = getBeerById(selectedId);
            if (selectedBeer) {
                applyBeerInfo(selectedBeer, true);
            } else {
                applyBeerInfo(null, true);
            }

            beerBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleBeerMenu(selectWrap);
            });

            beerMenu.addEventListener('click', (e) => {
                e.stopPropagation();
                const opt = e.target.closest('.beer-opt');
                if (!opt) return;
                const id = opt.dataset.beerId || '';
                const beer = id ? getBeerById(id) : null;
                if (beer) {
                    applyBeerInfo(beer, false);
                } else {
                    const label = opt.textContent ? opt.textContent.trim() : '';
                    if (id) {
                        applyBeerInfo({ id, name: label, volume: data.volume, calories: data.calories }, false);
                    } else {
                        applyBeerInfo(null, false);
                    }
                }
                closeBeerMenus();
                updateTotals();
                scheduleSave();
            });

            removeBtn.addEventListener('click', () => {
                row.remove();
                ensureAtLeastOneRow('beer');
                updateTotals();
                scheduleSave();
            });

            return row;
        }

        function createFoodRow(data = {}) {
            const row = document.createElement('div');
            row.className = 'grid grid-cols-1 sm:grid-cols-[minmax(180px,1fr)_110px_120px_110px_32px] gap-3 items-center';
            row.dataset.foodRow = '1';

            const nameWrap = document.createElement('div');
            const nameInput = document.createElement('input');
            nameInput.type = 'text';
            nameInput.placeholder = '–ë–ª—é–¥–æ –∏–ª–∏ –ø—Ä–æ–¥—É–∫—Ç';
            nameInput.className = 'input-field';
            nameInput.value = data.name || '';
            nameInput.dataset.foodName = '1';
            nameWrap.appendChild(nameInput);

            const weightWrap = document.createElement('div');
            weightWrap.className = 'flex items-center gap-2';
            const weightInput = document.createElement('input');
            weightInput.type = 'number';
            weightInput.min = '0';
            weightInput.step = '1';
            weightInput.placeholder = '–≥';
            weightInput.className = 'input-field';
            weightInput.value = data.weight != null ? data.weight : '';
            weightInput.dataset.foodWeight = '1';
            weightWrap.appendChild(weightInput);

            const calWrap = document.createElement('div');
            calWrap.className = 'flex items-center gap-2';
            const calInput = document.createElement('input');
            calInput.type = 'number';
            calInput.min = '0';
            calInput.step = '1';
            calInput.placeholder = '–∫–∫–∞–ª/100 –≥';
            calInput.className = 'input-field';
            calInput.value = data.calories != null ? data.calories : '';
            calInput.dataset.foodCalories = '1';
            calWrap.appendChild(calInput);

            const totalEl = document.createElement('div');
            totalEl.className = 'text-sm font-semibold text-amber-200 flex items-center gap-2';
            totalEl.innerHTML = '<span class="cell-label sm:hidden">–ò—Ç–æ–≥–æ</span><span data-food-total>0</span>';

            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'row-remove';
            removeBtn.textContent = '‚úï';

            row.appendChild(nameWrap);
            row.appendChild(weightWrap);
            row.appendChild(calWrap);
            row.appendChild(totalEl);
            row.appendChild(removeBtn);

            function updateFoodRowTotal() {
                const weight = parseFloat(weightInput.value);
                const calories = parseFloat(calInput.value);
                const total = calcFoodCalories(weight, calories);
                row.dataset.foodTotal = String(total || 0);
                row.querySelector('[data-food-total]').textContent = total ? Math.round(total).toString() : '0';
            }

            updateFoodRowTotal();

            [nameInput, weightInput, calInput].forEach(input => {
                input.addEventListener('input', () => {
                    updateFoodRowTotal();
                    updateTotals();
                    scheduleSave();
                });
            });

            removeBtn.addEventListener('click', () => {
                row.remove();
                ensureAtLeastOneRow('food');
                updateTotals();
                scheduleSave();
            });

            return row;
        }

        function ensureAtLeastOneRow(type) {
            if (type === 'beer') {
                const wrap = document.getElementById('beerRows');
                if (wrap && !wrap.querySelector('[data-beer-row]')) {
                    wrap.appendChild(createBeerRow());
                }
            }
            if (type === 'food') {
                const wrap = document.getElementById('foodRows');
                if (wrap && !wrap.querySelector('[data-food-row]')) {
                    wrap.appendChild(createFoodRow());
                }
            }
        }

        function updateTotals() {
            let beerTotal = 0;
            document.querySelectorAll('[data-beer-row]').forEach(row => {
                beerTotal += parseFloat(row.dataset.beerTotal || '0') || 0;
            });
            let foodTotal = 0;
            document.querySelectorAll('[data-food-row]').forEach(row => {
                foodTotal += parseFloat(row.dataset.foodTotal || '0') || 0;
            });
            document.getElementById('beerTotal').textContent = formatKcal(beerTotal);
            document.getElementById('foodTotal').textContent = formatKcal(foodTotal);
            document.getElementById('grandTotal').textContent = formatKcal(beerTotal + foodTotal);
        }

        function setSaveStatus(text, mode) {
            const status = document.getElementById('saveStatus');
            const statusText = document.getElementById('saveStatusText');
            if (!status || !statusText) return;
            status.dataset.mode = mode || 'saved';
            statusText.textContent = text;
        }

        function scheduleSave() {
            setSaveStatus('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...', 'pending');
            if (state.saveTimer) clearTimeout(state.saveTimer);
            state.saveTimer = setTimeout(saveCurrentUser, 700);
        }

        function buildPayloadFromDom() {
            const beers = [];
            document.querySelectorAll('[data-beer-row]').forEach(row => {
                const id = row.dataset.beerId || '';
                const name = row.dataset.beerName || '';
                const volume = row.dataset.beerVolume || '';
                const calories = row.dataset.beerCalories || '';
                if (!name && !id) return;
                beers.push({
                    beerId: id,
                    name,
                    volume: volume ? parseFloat(volume) : '',
                    calories: calories ? parseFloat(calories) : ''
                });
            });

            const foods = [];
            document.querySelectorAll('[data-food-row]').forEach(row => {
                const name = row.querySelector('[data-food-name]').value.trim();
                const weight = row.querySelector('[data-food-weight]').value;
                const calories = row.querySelector('[data-food-calories]').value;
                if (!name && !weight && !calories) return;
                foods.push({
                    name,
                    weight: weight ? parseFloat(weight) : '',
                    calories: calories ? parseFloat(calories) : ''
                });
            });

            return { beers, foods };
        }

        function saveCurrentUser() {
            if (!state.db || !state.currentUser.login || !state.snacksRef) return;
            const payloadData = buildPayloadFromDom();
            const hasData = payloadData.beers.length || payloadData.foods.length;

            if (!hasData) {
                state.suppressFormUpdate = true;
                state.lastSavedAt = null;
                state.snacksRef.child(state.currentUser.login).remove()
                    .then(() => setSaveStatus('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö', 'saved'))
                    .catch(() => setSaveStatus('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error'));
                return;
            }

            const payload = {
                userName: state.currentUser.name || '',
                updatedAt: Date.now(),
                beers: payloadData.beers,
                foods: payloadData.foods
            };

            state.lastSavedAt = payload.updatedAt;
            state.suppressFormUpdate = true;
            state.snacksRef.child(state.currentUser.login).set(payload)
                .then(() => {
                    const now = new Date();
                    const time = now.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
                    setSaveStatus(`–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ ${time}`, 'saved');
                })
                .catch(() => setSaveStatus('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error'));
        }

        function renderCurrentUserForm(data) {
            const beerWrap = document.getElementById('beerRows');
            const foodWrap = document.getElementById('foodRows');
            if (!beerWrap || !foodWrap) return;

            beerWrap.innerHTML = '';
            foodWrap.innerHTML = '';

            if (data && Array.isArray(data.beers) && data.beers.length) {
                data.beers.forEach(beer => {
                    beerWrap.appendChild(createBeerRow(beer));
                });
            } else {
                beerWrap.appendChild(createBeerRow());
            }

            if (data && Array.isArray(data.foods) && data.foods.length) {
                data.foods.forEach(food => {
                    foodWrap.appendChild(createFoodRow(food));
                });
            } else {
                foodWrap.appendChild(createFoodRow());
            }

            updateTotals();
        }

        function renderSummary() {
            const wrap = document.getElementById('summaryCards');
            const empty = document.getElementById('summaryEmpty');
            if (!wrap || !empty) return;

            const entries = Object.entries(state.snacksData || {}).filter(([, data]) => {
                const beers = data && Array.isArray(data.beers) ? data.beers : [];
                const foods = data && Array.isArray(data.foods) ? data.foods : [];
                return beers.length || foods.length;
            });

            entries.sort((a, b) => {
                const nameA = (a[1].userName || state.usersMap[a[0]] || a[0]).toString();
                const nameB = (b[1].userName || state.usersMap[b[0]] || b[0]).toString();
                return nameA.localeCompare(nameB, 'ru');
            });

            if (!entries.length) {
                empty.classList.remove('hidden');
                wrap.innerHTML = '';
                return;
            }

            empty.classList.add('hidden');

            wrap.innerHTML = entries.map(([login, data]) => {
                const userName = data.userName || state.usersMap[login] || login;
                const beers = Array.isArray(data.beers) ? data.beers : [];
                const foods = Array.isArray(data.foods) ? data.foods : [];
                const beerTotal = beers.reduce((sum, item) => sum + calcBeerCalories(item.volume, item.calories), 0);
                const foodTotal = foods.reduce((sum, item) => sum + calcFoodCalories(item.weight, item.calories), 0);
                const total = beerTotal + foodTotal;

                const beerList = beers.map(item => {
                    const name = item.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
                    const kcal = formatKcal(calcBeerCalories(item.volume, item.calories));
                    return `${name} (${kcal})`;
                });
                const foodList = foods.map(item => {
                    const name = item.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
                    const kcal = formatKcal(calcFoodCalories(item.weight, item.calories));
                    return `${name} (${kcal})`;
                });

                function sliceList(list) {
                    if (!list.length) return '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
                    const shown = list.slice(0, 3).join(', ');
                    const extra = list.length > 3 ? ` +${list.length - 3}` : '';
                    return `${shown}${extra}`;
                }

                return `
                    <div class="summary-card p-5">
                        <div class="flex items-center justify-between gap-2">
                            <div class="text-lg font-bold text-white">${escapeHtml(userName)}</div>
                            <div class="text-amber-300 font-bold">${formatKcal(total)}</div>
                        </div>
                        <div class="text-xs text-gray-400 mt-1">üç∫ ${beers.length} ‚Ä¢ ü•™ ${foods.length}</div>
                        <div class="mt-4 space-y-2 text-sm text-gray-300">
                            <div><span class="text-gray-400">–ü–∏–≤–æ:</span> ${escapeHtml(sliceList(beerList))}</div>
                            <div><span class="text-gray-400">–ï–¥–∞:</span> ${escapeHtml(sliceList(foodList))}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function applyDateSelection(dateKey) {
            if (!dateKey) return;
            state.currentDate = dateKey;
            const dateInput = document.getElementById('snackDate');
            if (dateInput) dateInput.value = dateKey;
            const dateLabel = document.getElementById('summaryDateLabel');
            if (dateLabel) dateLabel.textContent = formatDateRu(dateKey);
            if (state.calendarMonth) renderCalendar();
            listenSnackDate(dateKey);
        }

        function shiftDateBy(days) {
            const base = state.currentDate ? new Date(`${state.currentDate}T00:00:00`) : new Date();
            base.setDate(base.getDate() + days);
            applyDateSelection(formatLocalDateFromDate(base));
        }

        function renderCalendar() {
            const panel = document.getElementById('calendarPanel');
            const daysEl = document.getElementById('calendarDays');
            const label = document.getElementById('calendarMonthLabel');
            if (!panel || !daysEl || !label) return;
            const monthDate = state.calendarMonth || new Date();
            const year = monthDate.getFullYear();
            const month = monthDate.getMonth();
            label.textContent = monthDate.toLocaleDateString('ru-RU', { month: 'long', year: 'numeric' });

            const firstDay = new Date(year, month, 1);
            const startWeekday = (firstDay.getDay() + 6) % 7;
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const todayKey = formatLocalDate();

            const cells = [];
            for (let i = 0; i < startWeekday; i += 1) {
                cells.push('<div class="calendar-day" aria-hidden="true"></div>');
            }
            for (let day = 1; day <= daysInMonth; day += 1) {
                const dateKey = formatLocalDateFromDate(new Date(year, month, day));
                const count = state.dateCounts[dateKey] || 0;
                const isToday = dateKey === todayKey;
                const isActive = dateKey === state.currentDate;
                const countBadge = count ? `<span class="day-count">${count}</span>` : '';
                const classes = ['calendar-day'];
                if (isToday) classes.push('is-today');
                if (isActive) classes.push('is-active');
                cells.push(`
                    <div class="${classes.join(' ')}">
                        ${countBadge}
                        <button type="button" data-cal-date="${dateKey}">${day}</button>
                    </div>
                `);
            }
            daysEl.innerHTML = cells.join('');
        }

        function toggleCalendar(open) {
            const panel = document.getElementById('calendarPanel');
            if (!panel) return;
            const shouldOpen = typeof open === 'boolean' ? open : panel.classList.contains('hidden');
            if (shouldOpen) {
                panel.classList.remove('hidden');
                renderCalendar();
                const card = panel.closest('.card');
                if (card) card.classList.add('calendar-open');
            } else {
                panel.classList.add('hidden');
                const card = panel.closest('.card');
                if (card) card.classList.remove('calendar-open');
            }
        }

        function refreshBeerMenus() {
            document.querySelectorAll('[data-beer-select]').forEach(wrap => {
                const row = wrap.closest('[data-beer-row]');
                const selectedId = row ? row.dataset.beerId : '';
                const selectedName = row ? row.dataset.beerName : '';
                const menu = wrap.querySelector('.beer-menu');
                if (menu) menu.innerHTML = buildBeerMenuItems(selectedId, selectedName);
                const btn = wrap.querySelector('.beer-btn');
                if (btn) {
                    let label = selectedName;
                    if (!label && selectedId) {
                        const beer = getBeerById(selectedId);
                        if (beer && beer.name) label = beer.name;
                    }
                    const finalLabel = label || '–í—ã–±—Ä–∞—Ç—å –ø–∏–≤–æ';
                    const labelEl = btn.querySelector('.beer-label');
                    if (labelEl) labelEl.textContent = finalLabel;
                    else btn.textContent = finalLabel;
                    btn.title = finalLabel;
                }
            });
        }

        function listenSnackDate(dateKey) {
            if (!state.db) return;
            if (state.snacksRef) state.snacksRef.off();
            state.snacksRef = state.db.ref(`snackCalculator/${dateKey}`);
            state.snacksRef.on('value', snapshot => {
                const val = snapshot.val() || {};
                state.snacksData = val;
                renderSummary();

                const myData = val[state.currentUser.login];
                const shouldSkip = state.suppressFormUpdate
                    && ((myData && state.lastSavedAt != null && myData.updatedAt === state.lastSavedAt)
                        || (!myData && state.lastSavedAt == null));
                if (shouldSkip) {
                    state.suppressFormUpdate = false;
                    return;
                }
                state.suppressFormUpdate = false;
                renderCurrentUserForm(myData);
            });
        }

        function initHistoryDates() {
            if (!state.db) return;
            state.db.ref('snackCalculator').orderByKey().limitToLast(60).on('value', snapshot => {
                const val = snapshot.val() || {};
                const dates = Object.keys(val).sort();
                state.availableDates = [...dates].reverse();
                state.dateCounts = {};
                dates.forEach(dateKey => {
                    const dayData = val[dateKey] || {};
                    const count = Object.values(dayData).filter(item => {
                        const beers = item && Array.isArray(item.beers) ? item.beers : [];
                        const foods = item && Array.isArray(item.foods) ? item.foods : [];
                        return beers.length || foods.length;
                    }).length;
                    if (count) state.dateCounts[dateKey] = count;
                });
                if (!state.calendarMonth) {
                    const base = state.currentDate ? new Date(`${state.currentDate}T00:00:00`) : new Date();
                    state.calendarMonth = new Date(base.getFullYear(), base.getMonth(), 1);
                }
                renderCalendar();
            });
        }

        function initFirebase() {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            state.db = firebase.database();

            state.db.ref('beerRating').on('value', snapshot => {
                state.beerRating = normalizeBeerList(snapshot.val());
                refreshBeerMenus();
            });

            state.db.ref('users').on('value', snapshot => {
                const val = snapshot.val() || {};
                state.usersMap = {};
                Object.entries(val).forEach(([login, user]) => {
                    if (user && user.name) state.usersMap[login] = user.name;
                });
                renderSummary();
            });

            initHistoryDates();
        }

        function initPage() {
            initCurrentUser();

            const dateInput = document.getElementById('snackDate');
            const prevBtn = document.getElementById('prevDateBtn');
            const nextBtn = document.getElementById('nextDateBtn');
            const calendarToggle = document.getElementById('calendarToggle');
            const calendarPrev = document.getElementById('calendarPrevMonth');
            const calendarNext = document.getElementById('calendarNextMonth');
            state.currentDate = formatLocalDate();
            if (dateInput) dateInput.value = state.currentDate;
            const dateLabel = document.getElementById('summaryDateLabel');
            if (dateLabel) dateLabel.textContent = formatDateRu(state.currentDate);
            state.calendarMonth = new Date();

            const addBeerBtn = document.getElementById('addBeerRow');
            const addFoodBtn = document.getElementById('addFoodRow');

            if (addBeerBtn) {
                addBeerBtn.addEventListener('click', () => {
                    const wrap = document.getElementById('beerRows');
                    if (!wrap) return;
                    closeBeerMenus();
                    const row = createBeerRow();
                    wrap.appendChild(row);
                    updateTotals();
                    const btn = row.querySelector('.beer-btn');
                    if (btn) btn.focus();
                });
            }

            if (addFoodBtn) {
                addFoodBtn.addEventListener('click', () => {
                    const wrap = document.getElementById('foodRows');
                    if (!wrap) return;
                    const row = createFoodRow();
                    wrap.appendChild(row);
                    updateTotals();
                    const input = row.querySelector('[data-food-name]');
                    if (input) input.focus();
                });
            }

            if (dateInput) {
                dateInput.addEventListener('change', () => {
                    applyDateSelection(dateInput.value || formatLocalDate());
                });
            }
            if (prevBtn) prevBtn.addEventListener('click', () => shiftDateBy(-1));
            if (nextBtn) nextBtn.addEventListener('click', () => shiftDateBy(1));
            if (calendarToggle) {
                calendarToggle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (!state.calendarMonth) {
                        const base = state.currentDate ? new Date(`${state.currentDate}T00:00:00`) : new Date();
                        state.calendarMonth = new Date(base.getFullYear(), base.getMonth(), 1);
                    }
                    toggleCalendar();
                });
            }
            if (calendarPrev) {
                calendarPrev.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const base = state.calendarMonth || new Date();
                    state.calendarMonth = new Date(base.getFullYear(), base.getMonth() - 1, 1);
                    renderCalendar();
                });
            }
            if (calendarNext) {
                calendarNext.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const base = state.calendarMonth || new Date();
                    state.calendarMonth = new Date(base.getFullYear(), base.getMonth() + 1, 1);
                    renderCalendar();
                });
            }

            document.addEventListener('click', (e) => {
                if (!e.target.closest('.beer-select')) closeBeerMenus();
                if (!e.target.closest('#calendarPanel') && !e.target.closest('#calendarToggle')) {
                    toggleCalendar(false);
                }
            });
            window.addEventListener('scroll', (e) => {
                if (e.target && e.target.closest && e.target.closest('.beer-menu')) return;
                closeBeerMenus();
            }, true);
            const calendarDays = document.getElementById('calendarDays');
            if (calendarDays) {
                calendarDays.addEventListener('click', (e) => {
                    const btn = e.target.closest('[data-cal-date]');
                    if (!btn) return;
                    applyDateSelection(btn.dataset.calDate);
                    toggleCalendar(false);
                });
            }

            renderCurrentUserForm(null);
            initFirebase();
            listenSnackDate(state.currentDate);
        }

        document.addEventListener('DOMContentLoaded', initPage);
    </script>
</body>
</html>
