<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∏–Ω–æ—Å—Ä–µ–¥–∞</title>
    <script>
        // Auth gate: prevent UI flash before redirecting to login
        (function () {
            try {
                const cu = localStorage.getItem('currentUser');
                if (!cu) {
                    // Replace to avoid back button returning to protected page
                    location.replace('login.html');
                    return;
                }
                document.documentElement.classList.add('authed');
            } catch (e) {
                // If localStorage is blocked, fallback to login
                location.replace('login.html');
            }
        })();
        // Theme gate: apply theme before first paint
        (function(){
            try {
                document.documentElement.dataset.theme = localStorage.getItem('siteTheme') || 'beer';
            } catch(_) {}
        })();
    </script>
    <style>
        /* Hide body until we know the user is authenticated (prevents flicker) */
        html:not(.authed) body { visibility: hidden; }
    </style>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect x='20' y='30' width='45' height='55' rx='5' fill='none' stroke='%23b45309' stroke-width='4'/%3E%3Crect x='22' y='45' width='41' height='38' rx='3' fill='%23f59e0b'/%3E%3Cellipse cx='42' cy='35' rx='24' ry='8' fill='%23fff'/%3E%3Ccircle cx='30' cy='33' r='5' fill='%23fff'/%3E%3Ccircle cx='45' cy='31' r='4' fill='%23fff'/%3E%3Ccircle cx='55' cy='34' r='4' fill='%23fff'/%3E%3Cpath d='M65 38 Q85 38 85 55 Q85 72 65 72' fill='none' stroke='%23b45309' stroke-width='5' stroke-linecap='round'/%3E%3C/svg%3E">
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <!-- Logo font: load selected font from Google Fonts (per-user) -->
    <script>
        // Logo font gate: avoid logo flash + load selected Google Font
        (function(){
            const html = document.documentElement;
            const KEY = 'logoFontFamily';
            const DEFAULT = 'Rubik Wet Paint';
            const LINK_ID = 'logoFontGF';

            function familyToHref(fam){
                const q = encodeURIComponent(fam).replace(/%20/g, '+');
                return `https://fonts.googleapis.com/css2?family=${q}&display=swap`;
            }

            function ensureStylesheet(fam){
                const family = (fam || DEFAULT).trim();
                if (!family) return;
                const href = familyToHref(family);
                let link = document.getElementById(LINK_ID);
                if (!link) {
                    link = document.createElement('link');
                    link.id = LINK_ID;
                    link.rel = 'stylesheet';
                    document.head.appendChild(link);
                }
                if (link.getAttribute('href') !== href) link.setAttribute('href', href);
            }

            function markReady(){
                html.classList.add('logo-font-ready');
                html.classList.remove('logo-font-loading');
            }

            function waitForFont(fam){
                const family = (fam || DEFAULT).trim();
                if (!family) return markReady();

                // Start font download as early as possible
                ensureStylesheet(family);

                html.classList.add('logo-font-loading');
                html.classList.remove('logo-font-ready');

                try {
                    if (document.fonts && document.fonts.load) {
                        // No flash: show logo text ONLY after the chosen font is actually loaded
                        document.fonts.load(`1em "${family}"`).then(markReady, markReady);
                    } else {
                        setTimeout(markReady, 1);
                    }
                } catch (_) {
                    markReady();
                }
            }

            try {
                const fam = localStorage.getItem(KEY) || DEFAULT;
                html.style.setProperty('--logo-font', `'${fam}'`);
                window.__loadLogoFont = waitForFont;
                waitForFont(fam);
            } catch(_) {
                window.__loadLogoFont = waitForFont;
                markReady();
            }
        })();
    </script>
    <style>
        /* Hide only the logo text until the chosen logo font is loaded */
        html:not(.logo-font-ready) .logo-text { opacity: 0; }
        .logo-text { transition: opacity 0.15s ease; }

        html, body {
            background: #000000;
        }
        /* Keep layout width stable when content height changes (prevents slight shrink/jump when scrollbar appears) */
        html {
            scrollbar-gutter: stable;
        }
        body { 
            font-family: 'Comfortaa', cursive; 
            background: #000000;
            overflow-x: hidden;
            /* Always reserve vertical scrollbar space on desktop to avoid width jumps */
            overflow-y: scroll;
            overscroll-behavior: none;
        }
        @font-face {
            font-family: 'Egyptian Bold Extended';
            src: local('Egyptian Bold Extended'), local('Egyptian Bold Extended Regular');
            font-weight: 700;
            font-style: normal;
            font-display: swap;
        }
        :root {
            --logo-font: 'Rubik Wet Paint';
            /* Theme variables (Beer by default) */
            --accent-200: #fde68a;
            --accent-300: #fcd34d;
            --accent-400: #f59e0b;
            --accent-500: #f59e0b;
            --accent-border-10: rgba(245,158,11,0.10);
            --accent-border-20: rgba(245,158,11,0.20);
            --accent-border-25: rgba(245,158,11,0.25);
            --accent-border-30: rgba(245,158,11,0.30);
            --accent-border-50: rgba(245,158,11,0.50);
            --accent-soft: rgba(245,158,11,0.10);

            /* Theme-dependent visuals */
            --glow-box-1: rgba(245,158,11,0.20);
            --glow-box-2: rgba(245,158,11,0.10);
            --glow-text-1: rgba(245,158,11,0.80);
            --glow-text-2: rgba(245,158,11,0.50);
            --glow-text-3: rgba(245,158,11,0.30);
            --logo-glow-1: rgba(245,158,11,0.50);
            --logo-glow-2: rgba(245,158,11,0.80);
            --logo-glow-3: rgba(245,158,11,0.40);
            --particle-color: rgba(245,158,11,0.40);
            --scrollbar-thumb: #f59e0b;
            --scrollbar-thumb-hover: #d97706;
        }
        html[data-theme="white"] {
            /* White scheme */
            --accent-200: #ffffff;
            --accent-300: #e5e7eb;
            --accent-400: #ffffff;
            --accent-500: #ffffff;
            --accent-border-10: rgba(255,255,255,0.18);
            --accent-border-20: rgba(255,255,255,0.26);
            --accent-border-25: rgba(255,255,255,0.30);
            --accent-border-30: rgba(255,255,255,0.34);
            --accent-border-50: rgba(255,255,255,0.55);
            --accent-soft: rgba(255,255,255,0.10);

            --glow-box-1: rgba(255,255,255,0.18);
            --glow-box-2: rgba(255,255,255,0.08);
            --glow-text-1: rgba(255,255,255,0.78);
            --glow-text-2: rgba(255,255,255,0.42);
            --glow-text-3: rgba(255,255,255,0.22);
            --logo-glow-1: rgba(255,255,255,0.45);
            --logo-glow-2: rgba(255,255,255,0.75);
            --logo-glow-3: rgba(255,255,255,0.35);
            --particle-color: rgba(255,255,255,0.18);
            --scrollbar-thumb: #ffffff;
            --scrollbar-thumb-hover: #e5e7eb;
        }

        /* Minimal overrides so "–ë–µ–ª—ã–π" theme changes the site accent without breaking layout */
        .text-amber-400 { color: var(--accent-400) !important; }
        .text-amber-300 { color: var(--accent-300) !important; }
        .text-amber-200 { color: var(--accent-200) !important; }
        .text-amber-500 { color: var(--accent-500) !important; }
        .border-amber-500\/10 { border-color: var(--accent-border-10) !important; }
        .border-amber-500\/20 { border-color: var(--accent-border-20) !important; }
        .border-amber-500\/25 { border-color: var(--accent-border-25) !important; }
        .border-amber-500\/30 { border-color: var(--accent-border-30) !important; }
        .border-amber-500\/50 { border-color: var(--accent-border-50) !important; }
        .bg-amber-500\/10 { background-color: var(--accent-soft) !important; }
        .hover\\:bg-amber-500\\/10:hover { background-color: var(--accent-soft) !important; }
        .ring-amber-300 { --tw-ring-color: var(--accent-300) !important; }
        #logoText { fill: var(--accent-500) !important; }

        /* White theme: override amber gradient elements (Tailwind gradients don't follow CSS vars) */
        html[data-theme="white"] .wednesday.bg-gradient-to-br {
            background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(229,231,235,0.95)) !important;
            color: #0b0b0f !important;
            box-shadow: 0 10px 22px rgba(255,255,255,0.08) !important;
        }
        html[data-theme="white"] .wednesday.bg-gradient-to-br:hover {
            background: linear-gradient(135deg, rgba(255,255,255,1), rgba(243,244,246,1)) !important;
        }
        /* Movie vote buttons (when voted) */
        html[data-theme="white"] #moviesList button.bg-gradient-to-br {
            background: linear-gradient(135deg, #2563eb, #1d4ed8) !important;
            box-shadow: 0 10px 18px rgba(37,99,235,0.20) !important;
        }
        /* Beer section primary amber-gradient buttons (Add beer + Apply) */
        html[data-theme="white"] #beerSection .bg-gradient-to-r.from-amber-600.to-amber-500,
        html[data-theme="white"] #beerSection .bg-gradient-to-r.from-amber-600.to-amber-500:hover,
        html[data-theme="white"] #beerSection .bg-gradient-to-r.from-amber-600.to-amber-500:active {
            background: linear-gradient(90deg, #ffffff, #e5e7eb) !important;
            color: #0b0b0f !important;
            box-shadow: 0 10px 26px rgba(255,255,255,0.10) !important;
        }
        html[data-theme="white"] #scrollTopBtn {
            background: linear-gradient(90deg, #ffffff, #e5e7eb) !important;
            color: #0b0b0f !important;
            box-shadow: 0 10px 24px rgba(255,255,255,0.10), 0 0 0 1px var(--accent-border-20) !important;
        }
        html[data-theme="white"] #chatBtn {
            background: linear-gradient(90deg, #ffffff, #e5e7eb) !important;
            color: #0b0b0f !important;
            box-shadow: 0 10px 24px rgba(255,255,255,0.10), 0 0 0 1px var(--accent-border-20) !important;
        }
        html[data-theme="white"] #chatPanel .text-white { color: #ffffff; }
        html[data-theme="white"] #chatPanel .border-amber-500\/20 { border-color: var(--accent-border-30) !important; }

        /* White theme: past Wednesdays should not be amber */
        html[data-theme="white"] .wednesday.text-amber-700\/50 { color: rgba(255,255,255,0.65) !important; }
        html[data-theme="white"] .wednesday.border-amber-900\/20 { border-color: var(--accent-border-30) !important; }
        html[data-theme="white"] .wednesday.border-amber-900\/20:hover { border-color: var(--accent-border-50) !important; }

        /* White theme: movie vote buttons (both states) */
        html[data-theme="white"] .movie-vote-btn {
            background: rgba(37, 99, 235, 0.22) !important;
            box-shadow: 0 10px 18px rgba(37,99,235,0.10) !important;
        }
        html[data-theme="white"] .movie-vote-btn:hover {
            background: rgba(37, 99, 235, 0.30) !important;
        }
        html[data-theme="white"] .movie-vote-btn.voted {
            background: linear-gradient(135deg, #2563eb, #1d4ed8) !important;
            box-shadow: 0 10px 18px rgba(37,99,235,0.22) !important;
        }

        /* White theme: Add Beer modal primary button */
        html[data-theme="white"] #addBeerModal .bg-gradient-to-r.from-amber-600.to-amber-500,
        html[data-theme="white"] #addBeerModal .bg-gradient-to-r.from-amber-600.to-amber-500:hover,
        html[data-theme="white"] #addBeerModal .bg-gradient-to-r.from-amber-600.to-amber-500:active {
            background: linear-gradient(90deg, #ffffff, #e5e7eb) !important;
            color: #0b0b0f !important;
            box-shadow: 0 10px 26px rgba(255,255,255,0.10) !important;
        }

        /* White theme: beer filter inputs focus borders should be white */
        html[data-theme="white"] #beerFiltersPanel input:focus {
            border-color: rgba(255,255,255,0.85) !important;
            box-shadow: 0 0 0 3px rgba(255,255,255,0.14) !important;
        }

        /* White theme: logo mug stroke should match white accent */
        html[data-theme="white"] #logoMug rect,
        html[data-theme="white"] #logoMug path {
            stroke: rgba(255,255,255,0.85) !important;
        }

        /* White theme: backlog borders */
        html[data-theme="white"] .backlog-column { border-color: var(--accent-border-30) !important; }
        html[data-theme="white"] .column-header { border-bottom-color: var(--accent-border-10) !important; }

        /* White theme: custom selects (beer) - keep dark surfaces like inputs, but white accents */
        html[data-theme="white"] .cs-btn {
            background: rgb(17 24 39 / 1) !important; /* like bg-gray-900 */
            color: #ffffff !important;
            border-color: var(--accent-border-30) !important;
        }
        html[data-theme="white"] .cs-btn:focus {
            border-color: rgba(255,255,255,0.85) !important;
            box-shadow: 0 0 0 3px rgba(255,255,255,0.16) !important;
        }
        html[data-theme="white"] .cs-chevron { color: rgba(229,231,235,0.95) !important; }

        .logo-text { font-family: var(--logo-font), 'Comfortaa', cursive; font-weight: 400; letter-spacing: 0.02em; }
        
        .bg-dark {
            background: #000000;
            position: relative;
        }
        .bg-dark::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(ellipse at 20% 0%, rgba(245, 158, 11, 0.06) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 100%, rgba(245, 158, 11, 0.04) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }
        
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            overflow: hidden;
        }
        .particle {
            position: absolute;
            width: 3px;
            height: 3px;
            background: var(--particle-color);
            border-radius: 50%;
            animation: floatParticle 20s infinite;
        }
        @keyframes floatParticle {
            0% { transform: translateY(0) rotate(0deg); opacity: 0; }
            5% { opacity: 0.6; }
            95% { opacity: 0.6; }
            100% { transform: translateY(-100vh) rotate(720deg); opacity: 0; }
        }
        
        .glow-amber {
            box-shadow: 0 0 20px var(--glow-box-1), 0 0 40px var(--glow-box-2);
        }
        .text-glow {
            text-shadow: 0 0 10px var(--glow-text-1), 0 0 20px var(--glow-text-2), 0 0 40px var(--glow-text-3);
        }
        
        .wednesday { 
            cursor: pointer; 
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
        }
        .wednesday::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 70%);
            transform: translate(-50%, -50%);
            transition: all 0.5s;
            border-radius: 50%;
        }
        .wednesday:hover::before {
            width: 200%;
            height: 200%;
        }
        .wednesday:hover { 
            transform: scale(1.1);
            z-index: 10;
        }
        
        .modal { backdrop-filter: blur(10px); }
        
        @keyframes float { 
            0%, 100% { transform: translateY(0); } 
            50% { transform: translateY(-8px); } 
        }
        .float { animation: float 4s ease-in-out infinite; }
        
        @keyframes pulse-glow {
            0%, 100% { filter: drop-shadow(0 0 5px var(--logo-glow-1)); }
            50% { filter: drop-shadow(0 0 15px var(--logo-glow-2)) drop-shadow(0 0 30px var(--logo-glow-3)); }
        }
        .pulse-glow { animation: pulse-glow 3s ease-in-out infinite; }

        /* Logo mug as a link to Beer Roulette */
        a:hover #logoMug { filter: drop-shadow(0 0 10px rgba(245,158,11,0.55)); }
        html[data-theme="white"] a:hover #logoMug { filter: drop-shadow(0 0 10px rgba(255,255,255,0.45)); }
        
        @keyframes bubble { 
            0% { transform: translateY(0) scale(0); opacity: 0; }
            20% { opacity: 0.8; }
            100% { transform: translateY(-40px) scale(1); opacity: 0; } 
        }
        .bubble { animation: bubble 2s ease-in infinite; }
        .bubble-1 { animation-delay: 0s; }
        .bubble-2 { animation-delay: 0.3s; }
        .bubble-3 { animation-delay: 0.6s; }
        .bubble-4 { animation-delay: 0.9s; }
        .bubble-5 { animation-delay: 1.2s; }
        .bubble-6 { animation-delay: 1.5s; }
        
        @keyframes foamGrow {
            0%, 100% { transform: scaleY(0.8); }
            50% { transform: scaleY(1); }
        }
        .foam-animate { animation: foamGrow 2s ease-in-out infinite; }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.5), 0 0 20px rgba(245, 158, 11, 0.1);
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .slide-in {
            animation: slideIn 0.5s ease-out forwards;
        }
        .slide-in-delay-1 { animation-delay: 0.1s; opacity: 0; }
        .slide-in-delay-2 { animation-delay: 0.2s; opacity: 0; }
        .slide-in-delay-3 { animation-delay: 0.3s; opacity: 0; }
        
        .btn-glow {
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
        }
        .btn-glow::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: rotate(45deg) translateX(-100%);
            transition: 0.5s;
        }
        .btn-glow:hover::after {
            transform: rotate(45deg) translateX(100%);
        }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--scrollbar-thumb-hover); }
        
        .backlog-board {
            display: flex;
            gap: 1rem;
            overflow-x: auto;
            padding-bottom: 1rem;
            min-height: 400px;
        }
        
        .backlog-column {
            min-width: 280px;
            max-width: 280px;
            background: rgba(30, 30, 40, 0.8);
            border-radius: 12px;
            border: 1px solid var(--accent-border-20);
            display: flex;
            flex-direction: column;
            max-height: 500px;
            transition: all 0.3s;
        }
        
        .backlog-column.drag-over {
            border-color: var(--accent-500);
            box-shadow: 0 0 20px var(--glow-box-1);
        }
        
        .backlog-column.column-dragging {
            opacity: 0.5;
        }
        
        .rating-badge {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: bold;
        }
        
        .rating-high {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
        }
        
        .rating-medium {
            background: linear-gradient(135deg, #eab308, #ca8a04);
            color: black;
        }
        
        .rating-low {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }
        
        .column-header {
            padding: 12px;
            border-bottom: 1px solid rgba(245, 158, 11, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: grab;
        }
        
        .column-header:active {
            cursor: grabbing;
        }
        
        .column-cards {
            padding: 8px;
            flex: 1;
            overflow-y: auto;
            min-height: 100px;
        }
        
        .backlog-card {
            background: rgba(50, 50, 60, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 8px;
            padding: 10px 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .backlog-card:hover {
            border-color: var(--accent-border-50);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        /* White scheme: make backlog card borders white */
        html[data-theme="white"] .backlog-card { border-color: var(--accent-border-25); }
        html[data-theme="white"] .backlog-card:hover { border-color: var(--accent-border-50); }
        
        .backlog-card.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }
        
        .add-column-btn {
            min-width: 280px;
            height: fit-content;
            background: rgba(255, 255, 255, 0.05);
            border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: rgba(255, 255, 255, 0.5);
        }
        
        .add-column-btn:hover {
            border-color: #f59e0b;
            color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
        }
        
        .watch-count {
            background: linear-gradient(135deg, #8b5cf6, #6d28d9);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: bold;
        }
        
        .review-count {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: bold;
        }
        
        .beer-row {
            transition: all 0.2s;
        }
        .beer-row:hover {
            background: var(--accent-soft);
        }
        .beer-type-light {
            background: linear-gradient(135deg, #fcd34d, #fbbf24);
            color: #000;
        }
        .beer-type-dark {
            background: linear-gradient(135deg, #78350f, #451a03);
            color: #fff;
        }
        .star-btn {
            transition: all 0.2s;
            cursor: pointer;
        }
        .star-btn:hover {
            transform: scale(1.2);
        }
        .star-btn.active {
            color: #fbbf24;
        }
        .star-btn.inactive {
            color: #4b5563;
        }

        /* Half-star picker for beer rating (0.5 step) */
        .star-picker {
            display: flex;
            flex-wrap: nowrap;
            justify-content: center;
            gap: 10px;
            user-select: none;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            padding: 6px 6px;
            min-height: 34px;
            touch-action: pan-x;
        }
        #beerStarPicker { min-height: 34px; }
        .star-unit {
            position: relative;
            width: 24px;
            height: 24px;
            flex: 0 0 24px;
            transition: transform 0.12s ease;
        }
        .star-unit svg {
            width: 24px;
            height: 24px;
            display: block;
        }
        .star-base {
            position: absolute;
            inset: 0;
            color: #4b5563; /* gray */
        }
        .star-fill {
            position: absolute;
            inset: 0;
            overflow: hidden;
            width: 0%;
            color: #fbbf24; /* amber */
            filter: drop-shadow(0 0 8px rgba(251,191,36,0.25));
        }
        .star-dim {
            position: absolute;
            inset: 0;
            overflow: hidden;
            width: 0%;
            left: 0%;
            color: rgba(0,0,0,0.85);
            opacity: 0.45;
            pointer-events: none;
        }
        .star-hit {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 50%;
            cursor: pointer;
        }
        .star-hit.left { left: 0; }
        .star-hit.right { right: 0; }
        .star-picker:hover .star-unit { transform: translateY(-1px); }
        .sortable-header {
            cursor: pointer;
            user-select: none;
            transition: all 0.2s;
        }
        .sortable-header:hover {
            color: #fbbf24 !important;
        }
        .sortable-header.active {
            color: #f59e0b !important;
        }
        /* White theme: keep sort headers white on hover/active (no amber accent) */
        html[data-theme="white"] .sortable-header:hover { color: #ffffff !important; }
        html[data-theme="white"] .sortable-header.active { color: #ffffff !important; }
        
        /* Dropdown arrows in beer filters */
        #beerFiltersPanel select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='none'%3E%3Cpath d='M5 7l5 6 5-6' stroke='%239ca3af' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-size: 16px 16px;
            background-position: calc(100% - 1.15rem) 50%;
            padding-right: 2.75rem;
        }

        /* Dropdown arrows in beer add/edit modals */
        #addBeerModal select,
        #editBeerModal select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='none'%3E%3Cpath d='M5 7l5 6 5-6' stroke='%239ca3af' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-size: 16px 16px;
            background-position: calc(100% - 1.35rem) 50%;
            padding-right: 3.1rem;
        }

        /* Custom select UI for beer filters & beer add/edit modals
           - opens dropdown BELOW the field (doesn't cover it)
           - dynamic chevron rotation */
        .cs { position: relative; }
        .cs select,
        .cs .cs-native {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: 0;
            border: 0;
            opacity: 0;
            pointer-events: none;
        }
        .cs-btn {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            border-radius: 0.75rem;
            background: rgb(17 24 39 / 1); /* gray-900 */
            color: #fff;
            border: 1px solid var(--accent-border-30);
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            line-height: 1.25rem;
        }
        html[data-theme="white"] .cs-btn { border-color: var(--accent-border-30); }
        .cs-btn:focus {
            outline: none;
            border-color: rgba(245, 158, 11, 0.85);
            box-shadow: 0 0 0 3px rgba(245,158,11,0.15);
        }
        .cs-label { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .cs-chevron { flex: 0 0 auto; width: 18px; height: 18px; color: #9ca3af; transition: transform 0.18s ease; }
        .cs.open .cs-chevron { transform: rotate(180deg); }
        .cs-menu {
            position: absolute;
            left: 0;
            right: 0;
            top: 100%;
            margin-top: 8px;
            z-index: 100;
            background: rgba(3, 7, 18, 0.98);
            border: 1px solid var(--accent-border-25);
            border-radius: 0.75rem;
            box-shadow: 0 20px 50px rgba(0,0,0,0.55);
            max-height: 240px;
            overflow: auto;
            display: none;
        }
        html[data-theme="white"] .cs-menu {
            background: rgba(17, 24, 39, 0.98); /* keep same dark surface as inputs */
            color: #fff;
            border-color: var(--accent-border-30) !important;
        }
        html[data-theme="white"] .cs-opt { color: rgba(229,231,235,0.95); }
        html[data-theme="white"] .cs-opt:hover { background: rgba(255,255,255,0.08); color: #fff; }
        html[data-theme="white"] .cs-opt[aria-selected="true"] { background: rgba(255,255,255,0.12); color: #fff; }
        .cs.open .cs-menu { display: block; }
        .cs-opt {
            width: 100%;
            text-align: left;
            padding: 0.55rem 0.75rem;
            font-size: 0.875rem;
            color: rgba(229,231,235,0.95);
        }
        .cs-opt:hover { background: rgba(245, 158, 11, 0.12); color: #fff; }
        .cs-opt[aria-selected="true"] { background: rgba(245, 158, 11, 0.18); color: #fff; }

        /* Restore vertical spacing between fields in Beer add/edit modals (custom selects) */
        #addBeerModal .cs,
        #editBeerModal .cs { margin-bottom: 0.75rem; }

        .scroll-mt-24 {
            scroll-margin-top: 8rem;
        }
        
        .nav-btn {
            transition: all 0.2s;
        }
        .nav-btn:hover {
            transform: translateY(-2px);
        }

        /* Snow mode */
        .snow {
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            /* IMPORTANT: don't cover the page scrollbar on desktop (it can look "frozen") */
            right: var(--sbw, 0px);
            pointer-events: none;
            /* Above all content, but below the sticky header (header has z-50) */
            z-index: 40;
            overflow: hidden;
            /* iOS Safari can flash white on transparent fixed layers; keep a near-transparent black */
            background: rgba(0, 0, 0, 0.01);
            transform: translateZ(0);
        }
        .snowflake {
            position: absolute;
            top: -32px;
            font-size: 16px;
            line-height: 1;
            color: rgba(255,255,255,0.9);
            text-shadow: 0 0 10px rgba(255,255,255,0.15);
            filter: drop-shadow(0 0 6px rgba(59,130,246,0.12));
            opacity: 0.8;
            animation-name: snowFall;
            animation-timing-function: linear;
            animation-iteration-count: infinite;
            will-change: transform;
        }
        @keyframes snowFall {
            from { transform: translate3d(0, -10px, 0) rotate(0deg); }
            to { transform: translate3d(var(--drift, 0px), 110vh, 0) rotate(360deg); }
        }

        /* Mobile performance: smaller flakes, less expensive effects */
        @media (pointer: coarse) {
            .snowflake {
                text-shadow: 0 0 6px rgba(255,255,255,0.12);
                filter: none;
                opacity: 0.7;
            }
        }

        /* Keep header/SVG stable above animated layers (prevents occasional text flicker on mobile) */
        header { isolation: isolate; }
        header svg { transform: translateZ(0); }

        .snow-toggle {
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        .snow-switch {
            position: relative;
            width: 52px;
            height: 30px;
            border-radius: 999px;
            background: rgba(31, 41, 55, 0.85);
            border: 1px solid rgba(245, 158, 11, 0.22);
            box-shadow: inset 0 0 0 1px rgba(255,255,255,0.03), 0 10px 30px rgba(0,0,0,0.35);
            transition: background 0.2s ease, border-color 0.2s ease;
            cursor: pointer;
            user-select: none;
        }
        .snow-switch input {
            position: absolute;
            opacity: 0;
            pointer-events: none;
        }
        .snow-thumb {
            position: absolute;
            left: 3px;
            top: 50%;
            width: 24px;
            height: 24px;
            border-radius: 999px;
            background: linear-gradient(180deg, rgba(255,255,255,0.96), rgba(229,231,235,0.96));
            box-shadow: 0 10px 20px rgba(0,0,0,0.35);
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            color: rgba(37, 99, 235, 0.9);
            transform: translate3d(0, -50%, 0);
            transition: transform 0.22s cubic-bezier(0.2, 0.9, 0.2, 1), color 0.2s ease;
        }
        .snow-switch.on {
            /* Amber/orange like the site theme */
            background: linear-gradient(135deg, rgba(245,158,11,0.98), rgba(217,119,6,0.95));
            border-color: rgba(245, 158, 11, 0.55);
        }
        html[data-theme="white"] .snow-switch.on {
            background: linear-gradient(135deg, rgba(255,255,255,0.96), rgba(229,231,235,0.96));
            border-color: rgba(255,255,255,0.55);
        }
        .snow-switch.on .snow-thumb {
            transform: translate3d(22px, -50%, 0);
            color: rgba(120, 53, 15, 0.95);
        }
        html[data-theme="white"] .snow-switch.on .snow-thumb {
            color: rgba(37, 99, 235, 0.9);
        }
        .snow-icon {
            font-size: 18px;
            line-height: 1;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transform: translateY(0);
            filter: drop-shadow(0 0 6px rgba(255,255,255,0.35));
        }

        /* Chat panel animation + textarea scrollbar behavior */
        .chat-panel {
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px) scale(0.98);
            transform-origin: bottom right;
            transition: opacity 0.18s ease, transform 0.18s ease, visibility 0.18s ease;
            pointer-events: none;
        }
        .chat-panel.open {
            opacity: 1;
            visibility: visible;
            transform: translateY(0) scale(1);
            pointer-events: auto;
        }
        .chat-input {
            overflow-y: hidden; /* no scrollbar when empty/short */
        }
        .chat-input.scroll {
            overflow-y: auto; /* show only when needed */
        }

        /* When chat is open, move the "scroll to top" button to the left of the chat button (same baseline)
           to avoid overlapping the chat panel. Use measured chat button width for perfect alignment. */
        html.chat-open #scrollTopBtn {
            right: calc(1.5rem + var(--chatw, 0px) + 0.75rem) !important;
            bottom: 1.5rem !important;
        }

        /* Keep Chat + Top buttons aligned and same height */
        #chatBtn { height: 56px; }
        #scrollTopBtn { width: 56px; height: 56px; padding: 0; display: flex; align-items: center; justify-content: center; }
        #chatSendBtn { height: 44px; min-width: 110px; }
    </style>
</head>
<body class="bg-dark min-h-screen text-white">
    <div class="particles" id="particles"></div>
    <div class="snow hidden" id="snow"></div>

    <!-- Header with Logo and Navigation -->
    <header class="py-2 md:py-4 relative z-50 sticky top-0 bg-black/95 backdrop-blur-sm border-b border-amber-500/10">
        <div class="container mx-auto px-3 md:px-4 max-w-7xl flex flex-col md:flex-row justify-between items-center gap-2 md:gap-4">
            <!-- Logo -->
            <div class="flex items-center gap-3 pl-2">
                <svg class="w-[220px] md:w-[360px] h-12 md:h-20 float pulse-glow flex-shrink-0" viewBox="0 0 580 120" style="overflow: visible;">
                <defs>
                    <linearGradient id="beerGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#fcd34d"/>
                        <stop offset="50%" style="stop-color:#fbbf24"/>
                        <stop offset="100%" style="stop-color:#d97706"/>
                    </linearGradient>
                    <linearGradient id="foamGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#ffffff"/>
                        <stop offset="100%" style="stop-color:#fef3c7"/>
                    </linearGradient>
                    <clipPath id="mugClip">
                        <rect x="0" y="0" width="50" height="55" rx="3"/>
                    </clipPath>
                    <filter id="glow">
                        <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
                        <feMerge>
                            <feMergeNode in="coloredBlur"/>
                            <feMergeNode in="SourceGraphic"/>
                        </feMerge>
                    </filter>
                </defs>
                
                <text id="logoText" x="28" y="78" text-anchor="start" class="logo-text" fill="#f59e0b" font-size="62" textLength="395" lengthAdjust="spacingAndGlyphs" filter="url(#glow)">–ö–ò–ù–û–°–†–ï–î–ê</text>
                
                <a href="roulette.html" target="_self" aria-label="–ü–∏–≤–Ω–∞—è —Ä—É–ª–µ—Ç–∫–∞">
                <g id="logoMug" transform="translate(438, 2)" style="cursor: pointer;" onclick="event.preventDefault(); event.stopPropagation(); location.assign('roulette.html');">
                    <rect x="0" y="25" width="50" height="60" rx="5" fill="none" stroke="#b45309" stroke-width="3"/>
                    <g clip-path="url(#mugClip)" transform="translate(0, 30)">
                        <rect x="0" y="55" height="0" width="50" fill="url(#beerGrad)">
                            <animate attributeName="height" from="0" to="55" dur="2.5s" fill="freeze" calcMode="spline" keySplines="0.25 0.1 0.25 1"/>
                            <animate attributeName="y" from="55" to="0" dur="2.5s" fill="freeze" calcMode="spline" keySplines="0.25 0.1 0.25 1"/>
                        </rect>
                    </g>
                    <rect x="6" y="30" width="6" height="50" rx="3" fill="rgba(255,255,255,0.3)" opacity="0.5"/>
                    <g class="foam-animate" transform-origin="25 25" opacity="0">
                        <animate attributeName="opacity" from="0" to="1" dur="0.5s" begin="2s" fill="freeze"/>
                        <ellipse cx="25" cy="27" rx="27" ry="10" fill="url(#foamGrad)"/>
                        <circle cx="12" cy="24" r="6" fill="white" opacity="0.95"/>
                        <circle cx="28" cy="22" r="5" fill="white" opacity="0.9"/>
                        <circle cx="40" cy="25" r="5" fill="white" opacity="0.9"/>
                    </g>
                    <path d="M50 32 Q72 32 72 55 Q72 78 50 78" fill="none" stroke="#b45309" stroke-width="5" stroke-linecap="round"/>
                    <g opacity="0">
                        <animate attributeName="opacity" from="0" to="1" dur="0.3s" begin="1s" fill="freeze"/>
                        <circle cx="15" cy="55" r="2.5" fill="#fef3c7" opacity="0.6" class="bubble bubble-1"/>
                        <circle cx="28" cy="65" r="2" fill="#fef3c7" opacity="0.5" class="bubble bubble-2"/>
                        <circle cx="38" cy="58" r="1.5" fill="#fef3c7" opacity="0.6" class="bubble bubble-3"/>
                    </g>
                </g>
                </a>
            </svg>
                
                <!-- Snow toggle -->
                <div class="snow-toggle ml-1">
                    <div class="snow-switch" id="snowSwitch" role="switch" aria-checked="false" tabindex="0" onclick="toggleSnow()">
                        <input type="checkbox" id="snowToggle" aria-label="–°–Ω–µ–∂–∏–Ω–∫–∏">
                        <div class="snow-thumb"><span class="snow-icon">‚ùÑ</span></div>
                    </div>
                </div>

            </div>
            
            <!-- Navigation Menu -->
            <nav class="flex items-center gap-1 md:gap-4 flex-wrap justify-center">
                <button onclick="scrollToSection('calendarSection')" class="text-amber-400 hover:text-amber-300 transition font-medium text-xs md:text-sm px-2 md:px-3 py-1 md:py-2 rounded-lg hover:bg-amber-500/10 flex items-center gap-1 md:gap-2">
                    <span>üìÖ</span> <span class="hidden sm:inline">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</span>
                </button>
                <button onclick="scrollToSection('backlogSection')" class="text-amber-400 hover:text-amber-300 transition font-medium text-xs md:text-sm px-2 md:px-3 py-1 md:py-2 rounded-lg hover:bg-amber-500/10 flex items-center gap-1 md:gap-2">
                    <span>üé•</span> <span class="hidden sm:inline">–ë—ç–∫–ª–æ–≥ —Ñ–∏–ª—å–º–æ–≤</span>
                </button>
                <button onclick="scrollToSection('beerSection')" class="text-amber-400 hover:text-amber-300 transition font-medium text-xs md:text-sm px-2 md:px-3 py-1 md:py-2 rounded-lg hover:bg-amber-500/10 flex items-center gap-1 md:gap-2">
                    <span>üç∫</span> <span class="hidden sm:inline">–†–µ–π—Ç–∏–Ω–≥ –ø–∏–≤–∞</span>
                </button>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6 relative z-10">
        <div id="calendarSection" class="flex flex-col lg:flex-row lg:flex-nowrap lg:items-start gap-6 max-w-7xl mx-auto scroll-mt-24">
            
            <!-- Left Column - Calendar -->
            <div class="lg:w-3/5 lg:flex-[0_0_60%] lg:max-w-[60%] min-w-0">
                <div class="bg-black/60 backdrop-blur-sm rounded-2xl p-5 border border-amber-500/20 glow-amber slide-in slide-in-delay-1">
                    <div class="flex justify-between items-center mb-5">
                        <button onclick="prevMonth()" class="text-amber-400 hover:text-amber-300 transition p-2 hover:bg-amber-500/10 rounded-full group">
                            <svg class="w-7 h-7 transform group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                            </svg>
                        </button>
                        <h2 id="monthYear" class="text-2xl font-bold text-amber-400 text-glow"></h2>
                        <button onclick="nextMonth()" class="text-amber-400 hover:text-amber-300 transition p-2 hover:bg-amber-500/10 rounded-full group">
                            <svg class="w-7 h-7 transform group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-7 gap-2 mb-3">
                        <div class="text-center text-gray-600 font-semibold py-2 text-sm">–ü–Ω</div>
                        <div class="text-center text-gray-600 font-semibold py-2 text-sm">–í—Ç</div>
                        <div class="text-center text-amber-400 font-bold py-2 text-sm text-glow">–°—Ä</div>
                        <div class="text-center text-gray-600 font-semibold py-2 text-sm">–ß—Ç</div>
                        <div class="text-center text-gray-600 font-semibold py-2 text-sm">–ü—Ç</div>
                        <div class="text-center text-gray-600 font-semibold py-2 text-sm">–°–±</div>
                        <div class="text-center text-gray-600 font-semibold py-2 text-sm">–í—Å</div>
                    </div>
                    
                    <div id="calendarDays" class="grid grid-cols-7 gap-2"></div>
                </div>

                <!-- Upcoming Events -->
                <div class="mt-6 bg-black/60 backdrop-blur-sm rounded-2xl p-5 border border-amber-500/20 slide-in slide-in-delay-3">
                    <h3 class="text-lg font-bold text-amber-400 mb-4 flex items-center gap-2">
                        <span class="text-xl">üé¨</span> –ë–ª–∏–∂–∞–π—à–∏–µ –≤—Å—Ç—Ä–µ—á–∏
                    </h3>
                    <div id="upcomingEvents" class="space-y-3"></div>
                </div>
            </div>

            <!-- Right Column - User Info & Event Form -->
            <div class="lg:w-2/5 lg:flex-[0_0_40%] lg:max-w-[40%] min-w-0">
                <!-- Event Details Panel -->
                <div id="eventPanel" class="hidden slide-in">
                    <div class="bg-black/60 backdrop-blur-sm rounded-2xl p-5 border border-amber-500/30 glow-amber">
                        <div class="flex justify-between items-center mb-5">
                            <h3 id="panelDate" class="text-xl font-bold text-amber-400 text-glow"></h3>
                            <button onclick="closePanel()" class="text-gray-500 hover:text-white transition hover:rotate-90 transform duration-300">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>

                        <!-- RSVP Section -->
                        <div class="bg-gray-900/50 rounded-xl p-4 mb-4 border border-green-500/20">
                            <h4 id="rsvpTitle" class="text-base font-bold text-green-400 mb-3 flex items-center gap-2">
                                <span>‚úã</span> –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —É—á–∞—Å—Ç–∏–µ
                            </h4>
                            <div class="space-y-3">
                                <div>
                                    <label class="text-gray-400 text-xs mb-1 block">–°–∫–æ–ª—å–∫–æ –ø–∏–≤–∞ –ø—Ä–∏–Ω–µ—Å—ë—Ç–µ? üç∫</label>
                                    <input type="number" id="beerCount" min="0" max="99" value="2"
                                        class="w-full px-3 py-2 rounded-lg bg-gray-800/50 text-white border border-amber-500/30 focus:outline-none focus:border-amber-400 transition text-sm">
                                </div>
                                <button onclick="confirmAttendance()" 
                                    class="w-full btn-glow bg-gradient-to-r from-green-600 to-green-500 hover:from-green-500 hover:to-green-400 text-white font-bold py-2 px-4 rounded-xl transition transform hover:scale-[1.02] shadow-lg shadow-green-500/20">
                                    –Ø –ø—Ä–∏–¥—É! üéâ
                                </button>
                            </div>
                            
                            <div class="mt-4">
                                <h5 class="text-gray-400 text-xs mb-2">–ö—Ç–æ –ø—Ä–∏–¥—ë—Ç:</h5>
                                <div id="attendeesList" class="flex flex-wrap gap-2"></div>
                            </div>
                        </div>

                        <!-- Movie Suggestions -->
                        <div class="bg-gray-900/50 rounded-xl p-4 mb-4 border border-purple-500/20">
                            <h4 class="text-base font-bold text-purple-400 mb-3 flex items-center gap-2">
                                <span>üé¨</span> –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Ñ–∏–ª—å–º
                            </h4>
                            <div class="flex gap-2 mb-3">
                                <input type="text" id="movieInput" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–∏–ª—å–º–∞..."
                                    class="flex-1 px-3 py-2 rounded-lg bg-gray-800/50 text-white placeholder-gray-500 border border-purple-500/30 focus:outline-none focus:border-purple-400 transition text-sm">
                                <button onclick="addMovie()" 
                                    class="btn-glow bg-gradient-to-r from-purple-600 to-purple-500 hover:from-purple-500 hover:to-purple-400 text-white font-bold py-2 px-3 rounded-lg transition transform hover:scale-105 text-sm">
                                    +
                                </button>
                            </div>
                            
                            <div id="moviesList" class="space-y-2 max-h-48 overflow-y-auto"></div>
                        </div>

                        <!-- Total Beer -->
                        <div class="bg-gradient-to-r from-amber-600 to-yellow-500 rounded-xl p-4 text-center relative overflow-hidden">
                            <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/10 to-transparent animate-pulse"></div>
                            <div class="text-4xl mb-1 relative">üç∫</div>
                            <div class="text-gray-900 font-bold relative text-sm">–í—Å–µ–≥–æ –ø–∏–≤–∞: <span id="totalBeer" class="text-2xl">0</span> —à—Ç.</div>
                        </div>
                    </div>
                </div>

                <!-- Placeholder -->
                <div id="eventPlaceholder" class="slide-in slide-in-delay-2">
                    <div class="bg-black/40 backdrop-blur-sm rounded-2xl p-8 border border-gray-800 text-center">
                        <div class="text-5xl mb-4 opacity-50">üìÖ</div>
                        <p class="text-gray-500 text-sm">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ä–µ–¥—É –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ,<br>—á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –¥–µ—Ç–∞–ª–∏ –≤—Å—Ç—Ä–µ—á–∏</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Backlog Section -->
        <div id="backlogSection" class="mt-12 max-w-7xl mx-auto scroll-mt-24">
            <div class="bg-black/60 backdrop-blur-sm rounded-2xl p-6 border border-amber-500/20 slide-in">
                <h2 class="text-2xl font-bold text-amber-400 mb-6 flex items-center gap-3">
                    <span class="text-3xl">üé•</span> –ë—ç–∫–ª–æ–≥ —Ñ–∏–ª—å–º–æ–≤
                </h2>
                <div class="backlog-board" id="backlogBoard"></div>
            </div>
        </div>

        <!-- Beer Rating Section -->
        <div id="beerSection" class="mt-12 max-w-7xl mx-auto scroll-mt-24">
            <div class="bg-black/60 backdrop-blur-sm rounded-2xl p-6 border border-amber-500/20 slide-in">
                <div class="flex justify-between items-center mb-6 gap-3 flex-wrap">
                    <div class="flex items-center gap-3 flex-wrap">
                        <h2 class="text-2xl font-bold text-amber-400 flex items-center gap-3">
                            <span class="text-3xl">üç∫</span> –†–µ–π—Ç–∏–Ω–≥ –ø–∏–≤–∞
                        </h2>
                        <span id="beerCountBadge" class="text-xs px-3 py-1 rounded-full border border-amber-500/30 bg-amber-500/10 text-amber-200">–ü–∏–≤–∞: 0</span>

                        <!-- Search (by beer name) -->
                        <input id="beerSearchInput" type="search" placeholder="–ü–æ–∏—Å–∫ –ø–∏–≤–∞‚Ä¶"
                            oninput="setBeerSearch(this.value)"
                            class="w-full sm:w-64 md:w-72 px-3 py-2 rounded-xl bg-gray-900/70 text-white placeholder-gray-500 border border-amber-500/25 focus:outline-none focus:border-amber-400 focus:ring-2 focus:ring-amber-500/15 transition text-sm" />

                        <button onclick="toggleBeerFilters()" class="flex items-center gap-2 text-sm px-3 py-2 rounded-xl border border-amber-500/30 text-amber-300 hover:text-amber-200 hover:border-amber-400 transition">
                            –§–∏–ª—å—Ç—Ä—ã
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4h18M6 12h12M10 20h4" />
                            </svg>
                        </button>

                        <button onclick="openBeerColumnsModal()" class="flex items-center gap-2 text-sm px-3 py-2 rounded-xl border border-amber-500/30 text-amber-300 hover:text-amber-200 hover:border-amber-400 transition" title="–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∫–æ–ª–æ–Ω–∫–∏">
                            –ö–æ–ª–æ–Ω–∫–∏
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                            </svg>
                        </button>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="openAddBeerModal()" class="btn-glow bg-gradient-to-r from-amber-600 to-amber-500 hover:from-amber-500 hover:to-amber-400 text-white font-bold py-2 px-4 rounded-xl transition transform hover:scale-105">
                            ‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–∏–≤–æ
                        </button>
                    </div>
                </div>

                <!-- –ü–∞–Ω–µ–ª—å —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
                <div id="beerFiltersPanel" class="hidden mb-4 bg-black/50 border border-amber-500/20 rounded-2xl p-4 text-sm">
                    <div class="grid md:grid-cols-3 gap-3">
                        <div>
                            <label class="text-gray-400 text-xs mb-1 block">–í–∏–¥</label>
                            <select id="beerFilterType" class="w-full px-3 py-2 rounded-lg bg-gray-900 text-white border border-amber-500/30 focus:outline-none focus:border-amber-400">
                                <option value="">–í—Å–µ</option>
                                <option value="–°–≤–µ—Ç–ª–æ–µ">–°–≤–µ—Ç–ª–æ–µ</option>
                                <option value="–¢—ë–º–Ω–æ–µ">–¢—ë–º–Ω–æ–µ</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-gray-400 text-xs mb-1 block">–°–æ—Ä—Ç</label>
                            <select id="beerFilterStyle" class="w-full px-3 py-2 rounded-lg bg-gray-900 text-white border border-amber-500/30 focus:outline-none focus:border-amber-400">
                                <option value="">–í—Å–µ</option>
                                <option value="Lager">Lager</option>
                                <option value="Wheat">Wheat</option>
                                <option value="Pilsner">Pilsner</option>
                                <option value="Cider">Cider</option>
                                <option value="Bock">Bock</option>
                                <option value="Marzen">Marzen</option>
                                <option value="Ale">Ale</option>
                                <option value="Porter">Porter</option>
                                <option value="Stout">Stout</option>
                                <option value="Dunkel">Dunkel</option>
                                <option value="Weizen">Weizen</option>
                                <option value="Hell">Hell</option>
                                <option value="IPA">IPA</option>
                                <option value="APA">APA</option>
                                <option value="Kellerbier">Kellerbier</option>
                                <option value="Dubbel">Dubbel</option>
                                <option value="Tripel">Tripel</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-gray-400 text-xs mb-1 block">–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è</label>
                            <select id="beerFilterFiltered" class="w-full px-3 py-2 rounded-lg bg-gray-900 text-white border border-amber-500/30 focus:outline-none focus:border-amber-400">
                                <option value="">–í—Å–µ</option>
                                <option value="–§–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω–æ–µ">–§–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω–æ–µ</option>
                                <option value="–ù–µ—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω–æ–µ">–ù–µ—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω–æ–µ</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-gray-400 text-xs mb-1 block">–°—Ç—Ä–∞–Ω–∞</label>
                            <select id="beerFilterCountry" class="w-full px-3 py-2 rounded-lg bg-gray-900 text-white border border-amber-500/30 focus:outline-none focus:border-amber-400">
                                <option value="">–í—Å–µ</option>
                                <option value="–ë–µ–ª—å–≥–∏—è">–ë–µ–ª—å–≥–∏—è</option>
                                <option value="–í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è">–í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è</option>
                                <option value="–ì–µ—Ä–º–∞–Ω–∏—è">–ì–µ—Ä–º–∞–Ω–∏—è</option>
                                <option value="–ö–∏—Ç–∞–π">–ö–∏—Ç–∞–π</option>
                                <option value="–ù–∏–¥–µ—Ä–ª–∞–Ω–¥—ã">–ù–∏–¥–µ—Ä–ª–∞–Ω–¥—ã</option>
                                <option value="–†–æ—Å—Å–∏—è">–†–æ—Å—Å–∏—è</option>
                                <option value="–ß–µ—Ö–∏—è">–ß–µ—Ö–∏—è</option>
                                <option value="–ê–≤—Å—Ç—Ä–∏—è">–ê–≤—Å—Ç—Ä–∏—è</option>
                                <option value="–°–µ—Ä–±–∏—è">–°–µ—Ä–±–∏—è</option>
                                <option value="–§—Ä–∞–Ω—Ü–∏—è">–§—Ä–∞–Ω—Ü–∏—è</option>
                                <option value="–ò—Å–ø–∞–Ω–∏—è">–ò—Å–ø–∞–Ω–∏—è</option>
                                <option value="–õ–∏—Ç–≤–∞">–õ–∏—Ç–≤–∞</option>
                                <option value="–Æ–∂–Ω–∞—è –ö–æ—Ä–µ—è">–Æ–∂–Ω–∞—è –ö–æ—Ä–µ—è</option>
                                <option value="–í—å–µ—Ç–Ω–∞–º">–í—å–µ—Ç–Ω–∞–º</option>
                                <option value="–°–®–ê">–°–®–ê</option>
                                <option value="–ú–µ–∫—Å–∏–∫–∞">–ú–µ–∫—Å–∏–∫–∞</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-gray-400 text-xs mb-1 block">–û–±—ä—ë–º, –ª</label>
                            <select id="beerFilterVolume" class="w-full px-3 py-2 rounded-lg bg-gray-900 text-white border border-amber-500/30 focus:outline-none focus:border-amber-400">
                                <option value="">–í—Å–µ</option>
                                <option value="0.33">0.33</option>
                                <option value="0.45">0.45</option>
                                <option value="0.5">0.5</option>
                                <option value="0.75">0.75</option>
                                <option value="1">1</option>
                                <option value="5">5</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="text-gray-400 text-xs mb-1 block">–ö—Ä–µ–ø–æ—Å—Ç—å –æ—Ç, %</label>
                                <input type="number" step="0.1" id="beerFilterAlcoholMin" class="w-full px-3 py-2 rounded-lg bg-gray-900 text-white border border-amber-500/30 focus:outline-none focus:border-amber-400" placeholder="0">
                            </div>
                            <div>
                                <label class="text-gray-400 text-xs mb-1 block">–ö—Ä–µ–ø–æ—Å—Ç—å –¥–æ, %</label>
                                <input type="number" step="0.1" id="beerFilterAlcoholMax" class="w-full px-3 py-2 rounded-lg bg-gray-900 text-white border border-amber-500/30 focus:outline-none focus:border-amber-400" placeholder="100">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="text-gray-400 text-xs mb-1 block">–†–µ–π—Ç–∏–Ω–≥ –æ—Ç</label>
                                <input type="number" step="0.1" min="0" max="10" id="beerFilterRatingMin" class="w-full px-3 py-2 rounded-lg bg-gray-900 text-white border border-amber-500/30 focus:outline-none focus:border-amber-400" placeholder="0">
                            </div>
                            <div>
                                <label class="text-gray-400 text-xs mb-1 block">–†–µ–π—Ç–∏–Ω–≥ –¥–æ</label>
                                <input type="number" step="0.1" min="0" max="10" id="beerFilterRatingMax" class="w-full px-3 py-2 rounded-lg bg-gray-900 text-white border border-amber-500/30 focus:outline-none focus:border-amber-400" placeholder="10">
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 flex gap-2 justify-end">
                        <button onclick="resetBeerFilters()" class="px-4 py-2 rounded-xl border border-gray-600 text-gray-300 hover:text-white hover:border-amber-400 transition">–°–±—Ä–æ—Å–∏—Ç—å</button>
                        <button onclick="applyBeerFiltersFromUI()" class="px-4 py-2 rounded-xl bg-gradient-to-r from-amber-600 to-amber-500 text-white font-semibold hover:from-amber-500 hover:to-amber-400 transition">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full text-sm" id="beerTable">
                        <thead>
                            <tr class="border-b border-gray-700">
                                <th class="py-3 px-4 text-left text-amber-400 sortable-header" onclick="sortBeerBy('name')">
                                    –ù–∞–∑–≤–∞–Ω–∏–µ <span id="sort-name">‚Üï</span>
                                </th>
                                <th class="py-3 px-4 text-left text-amber-400 sortable-header" onclick="sortBeerBy('type')">
                                    –í–∏–¥ <span id="sort-type">‚Üï</span>
                                </th>
                                <th class="py-3 px-4 text-left text-amber-400 sortable-header" onclick="sortBeerBy('style')">
                                    –°–æ—Ä—Ç <span id="sort-style">‚Üï</span>
                                </th>
                                <th class="py-3 px-4 text-left text-amber-400 sortable-header" onclick="sortBeerBy('filtered')">
                                    –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è <span id="sort-filtered">‚Üï</span>
                                </th>
                                <th class="py-3 px-4 text-left text-amber-400 sortable-header" onclick="sortBeerBy('country')">
                                    –°—Ç—Ä–∞–Ω–∞ <span id="sort-country">‚Üï</span>
                                </th>
                                <th class="py-3 px-4 text-left text-amber-400 sortable-header" onclick="sortBeerBy('volume')">
                                    –û–±—ä—ë–º, –ª <span id="sort-volume">‚Üï</span>
                                </th>
                                <th class="py-3 px-4 text-left text-amber-400 sortable-header" onclick="sortBeerBy('alcohol')">
                                    –ö—Ä–µ–ø–æ—Å—Ç—å, % <span id="sort-alcohol">‚Üï</span>
                                </th>
                                <th class="py-3 px-4 text-left text-amber-400 sortable-header" onclick="sortBeerBy('rating')">
                                    –†–µ–π—Ç–∏–Ω–≥ <span id="sort-rating">‚Üï</span>
                                </th>
                                <th class="py-3 px-4 text-center text-amber-400" style="min-width: 120px;">–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody id="beerTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <!-- Add Column Modal -->
    <div id="addColumnModal" class="modal fixed inset-0 bg-black/90 hidden items-center justify-center z-50">
        <div class="bg-gray-950 rounded-2xl max-w-md w-full p-6 border border-amber-500/30 mx-4">
            <h3 class="text-xl font-bold text-amber-400 mb-4">–î–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É</h3>
            <input type="text" id="columnNameInput" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏..."
                class="w-full px-4 py-3 rounded-xl bg-gray-900 text-white placeholder-gray-500 border border-amber-500/30 focus:outline-none focus:border-amber-400 mb-4">
            <div class="flex gap-2">
                <button onclick="createColumn()" class="flex-1 btn-glow bg-gradient-to-r from-green-600 to-green-500 text-white font-bold py-2 px-4 rounded-xl">
                    –°–æ–∑–¥–∞—Ç—å
                </button>
                <button onclick="closeAddColumnModal()" class="flex-1 btn-glow bg-gray-700 text-white font-bold py-2 px-4 rounded-xl">
                    –û—Ç–º–µ–Ω–∞
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Column Modal -->
    <div id="editColumnModal" class="modal fixed inset-0 bg-black/90 hidden items-center justify-center z-50">
        <div class="bg-gray-950 rounded-2xl max-w-md w-full p-6 border border-amber-500/30 mx-4">
            <h3 class="text-xl font-bold text-amber-400 mb-4">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–ª–æ–Ω–∫—É</h3>
            <input type="text" id="editColumnNameInput" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏..."
                class="w-full px-4 py-3 rounded-xl bg-gray-900 text-white placeholder-gray-500 border border-amber-500/30 focus:outline-none focus:border-amber-400 mb-4">
            <div class="flex gap-2 mb-3">
                <button onclick="saveColumnEdit()" class="flex-1 btn-glow bg-gradient-to-r from-green-600 to-green-500 text-white font-bold py-2 px-4 rounded-xl">
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
                <button onclick="closeEditColumnModal()" class="flex-1 btn-glow bg-gray-700 text-white font-bold py-2 px-4 rounded-xl">
                    –û—Ç–º–µ–Ω–∞
                </button>
            </div>
            <button onclick="deleteColumn()" class="w-full btn-glow bg-gradient-to-r from-red-600 to-red-500 text-white font-bold py-2 px-4 rounded-xl">
                üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É
            </button>
        </div>
    </div>

    <!-- Add Card Modal -->
    <div id="addCardModal" class="modal fixed inset-0 bg-black/90 hidden items-center justify-center z-50">
        <div class="bg-gray-950 rounded-2xl max-w-md w-full p-6 border border-amber-500/30 mx-4">
            <h3 class="text-xl font-bold text-amber-400 mb-4">–î–æ–±–∞–≤–∏—Ç—å —Ñ–∏–ª—å–º</h3>
            <input type="text" id="cardTitleInput" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–∏–ª—å–º–∞..."
                class="w-full px-4 py-3 rounded-xl bg-gray-900 text-white placeholder-gray-500 border border-amber-500/30 focus:outline-none focus:border-amber-400 mb-3">
            <textarea id="cardDescInput" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)..."
                class="w-full px-4 py-3 rounded-xl bg-gray-900 text-white placeholder-gray-500 border border-amber-500/30 focus:outline-none focus:border-amber-400 mb-3 h-24"></textarea>
            <input type="number" id="cardRatingInput" placeholder="–ú–æ—è –æ—Ü–µ–Ω–∫–∞ (0-10)" min="0" max="10" step="0.1"
                class="w-full px-4 py-3 rounded-xl bg-gray-900 text-white placeholder-gray-500 border border-amber-500/30 focus:outline-none focus:border-amber-400 mb-4">
            <div class="flex gap-2">
                <button onclick="createCard()" class="flex-1 btn-glow bg-gradient-to-r from-purple-600 to-purple-500 text-white font-bold py-2 px-4 rounded-xl">
                    –î–æ–±–∞–≤–∏—Ç—å
                </button>
                <button onclick="closeAddCardModal()" class="flex-1 btn-glow bg-gray-700 text-white font-bold py-2 px-4 rounded-xl">
                    –û—Ç–º–µ–Ω–∞
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Card Modal -->
    <div id="editCardModal" class="modal fixed inset-0 bg-black/90 hidden items-center justify-center z-50">
        <div class="bg-gray-950 rounded-2xl max-w-lg w-full p-6 border border-amber-500/30 mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold text-amber-400 mb-4">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ–∏–ª—å–º</h3>
            <input type="text" id="editCardTitleInput" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–∏–ª—å–º–∞..."
                class="w-full px-4 py-3 rounded-xl bg-gray-900 text-white placeholder-gray-500 border border-amber-500/30 focus:outline-none focus:border-amber-400 mb-3">
            <textarea id="editCardDescInput" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ..."
                class="w-full px-4 py-3 rounded-xl bg-gray-900 text-white placeholder-gray-500 border border-amber-500/30 focus:outline-none focus:border-amber-400 mb-3 h-24"></textarea>
            <input type="number" id="editCardRatingInput" placeholder="–ú–æ—è –æ—Ü–µ–Ω–∫–∞ (0-10)" min="0" max="10" step="0.1"
                class="w-full px-4 py-3 rounded-xl bg-gray-900 text-white placeholder-gray-500 border border-amber-500/30 focus:outline-none focus:border-amber-400 mb-3">

            <!-- Ratings summary (all users) -->
            <div id="cardRatingsSection" class="bg-gray-900/50 rounded-xl p-4 mb-4 border border-amber-500/20">
                <h4 class="text-base font-bold text-amber-300 mb-2 flex items-center gap-2">
                    <span>‚≠ê</span> –û—Ü–µ–Ω–∫–∏
                </h4>
                <div class="text-xs text-gray-400 mb-2">–°—Ä–µ–¥–Ω—è—è: <span id="cardAvgRating" class="text-amber-300 font-bold">‚Äî</span> ‚Ä¢ –û—Ü–µ–Ω–æ–∫: <span id="cardRatingsCount" class="text-gray-200 font-semibold">0</span></div>
                <div id="cardRatingsList" class="text-xs text-gray-300 space-y-1 max-h-24 overflow-y-auto"></div>
                <div class="text-[11px] text-gray-500 mt-2">–£–∫–∞–∂–∏—Ç–µ <span class="text-gray-200">—Å–≤–æ—é</span> –æ—Ü–µ–Ω–∫—É –≤—ã—à–µ ‚Äî –æ–Ω–∞ –¥–æ–±–∞–≤–∏—Ç—Å—è/–æ–±–Ω–æ–≤–∏—Ç—Å—è –≤ —Å–ø–∏—Å–∫–µ.</div>
            </div>
            
            <!-- Watch History Section -->
            <div id="watchHistorySection" class="hidden bg-gray-900/50 rounded-xl p-4 mb-4 border border-green-500/20">
                <h4 class="text-base font-bold text-green-400 mb-3 flex items-center gap-2">
                    <span>üëÅ</span> –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤
                </h4>
                <div id="watchHistoryList" class="space-y-1 max-h-24 overflow-y-auto"></div>
            </div>
            
            <!-- Reviews Section -->
            <div class="bg-gray-900/50 rounded-xl p-4 mb-4 border border-blue-500/20">
                <h4 class="text-base font-bold text-blue-400 mb-3 flex items-center gap-2">
                    <span>üí¨</span> –û—Ç–∑—ã–≤—ã
                </h4>
                <div id="cardReviewsList" class="space-y-2 mb-3 max-h-32 overflow-y-auto"></div>
                <div id="reviewInputSection">
                    <textarea id="cardReviewInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –æ—Ç–∑—ã–≤..."
                        class="w-full px-3 py-2 rounded-lg bg-gray-800/50 text-white placeholder-gray-500 border border-blue-500/30 focus:outline-none focus:border-blue-400 text-sm h-16 mb-2"></textarea>
                    <div class="flex gap-2">
                        <button onclick="saveCardReview()" class="flex-1 btn-glow bg-gradient-to-r from-blue-600 to-blue-500 text-white font-bold py-2 px-3 rounded-lg text-sm">
                            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç–∑—ã–≤
                        </button>
                        <button id="deleteReviewBtn" onclick="deleteCardReview()" class="hidden btn-glow bg-gradient-to-r from-red-600 to-red-500 text-white font-bold py-2 px-3 rounded-lg text-sm">
                            –£–¥–∞–ª–∏—Ç—å
                        </button>
                    </div>
                </div>
                <button id="deleteReviewBtnOutside" onclick="deleteCardReview()" class="hidden w-full btn-glow bg-gradient-to-r from-red-600 to-red-500 text-white font-bold py-2 px-3 rounded-lg text-sm mt-2">
                    –£–¥–∞–ª–∏—Ç—å –º–æ–π –æ—Ç–∑—ã–≤
                </button>
            </div>
            
            <div class="flex gap-2 mb-3">
                <button onclick="saveCardEdit()" class="flex-1 btn-glow bg-gradient-to-r from-green-600 to-green-500 text-white font-bold py-2 px-4 rounded-xl">
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
                <button onclick="closeEditCardModal()" class="flex-1 btn-glow bg-gray-700 text-white font-bold py-2 px-4 rounded-xl">
                    –û—Ç–º–µ–Ω–∞
                </button>
            </div>
            <button onclick="deleteCard()" class="w-full btn-glow bg-gradient-to-r from-red-600 to-red-500 text-white font-bold py-2 px-4 rounded-xl">
                üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —Ñ–∏–ª—å–º
            </button>
        </div>
    </div>

    <!-- Add Beer Modal -->
    <div id="addBeerModal" class="modal fixed inset-0 bg-black/90 hidden items-center justify-center z-50">
        <div class="bg-gray-950 rounded-2xl max-w-md w-full p-6 border border-amber-500/30 mx-4">
            <h3 class="text-xl font-bold text-amber-400 mb-4">–î–æ–±–∞–≤–∏—Ç—å –ø–∏–≤–æ</h3>
            <input type="text" id="beerNameInput" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ..."
                class="w-full px-4 py-2 rounded-xl bg-gray-900 text-white placeholder-gray-500 border border-amber-500/30 focus:outline-none focus:border-amber-400 mb-3 text-sm">
            <select id="beerTypeInput"
                class="w-full px-4 py-2 rounded-xl bg-gray-900 text-white border border-amber-500/30 focus:outline-none focus:border-amber-400 mb-3 text-sm">
                <option value="–°–≤–µ—Ç–ª–æ–µ">–°–≤–µ—Ç–ª–æ–µ</option>
                <option value="–¢—ë–º–Ω–æ–µ">–¢—ë–º–Ω–æ–µ</option>
            </select>
            <select id="beerStyleInput"
                class="w-full px-4 py-2 rounded-xl bg-gray-900 text-white border border-amber-500/30 focus:outline-none focus:border-amber-400 mb-3 text-sm">
                <option value="Lager">Lager</option>
                <option value="Wheat">Wheat</option>
                <option value="Pilsner">Pilsner</option>
                <option value="Cider">Cider</option>
                <option value="Bock">Bock</option>
                <option value="Marzen">Marzen</option>
                <option value="Ale">Ale</option>
                <option value="Porter">Porter</option>
                <option value="Stout">Stout</option>
                <option value="Dunkel">Dunkel</option>
                <option value="Weizen">Weizen</option>
                <option value="Hell">Hell</option>
                <option value="IPA">IPA</option>
                <option value="APA">APA</option>
                <option value="Kellerbier">Kellerbier</option>
                <option value="Dubbel">Dubbel</option>
                <option value="Tripel">Tripel</option>
            </select>
            <select id="beerFilteredInput"
                class="w-full px-4 py-2 rounded-xl bg-gray-900 text-white border border-amber-500/30 focus:outline-none focus:border-amber-400 mb-3 text-sm">
                <option value="–§–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω–æ–µ">–§–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω–æ–µ</option>
                <option value="–ù–µ—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω–æ–µ">–ù–µ—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω–æ–µ</option>
            </select>
            <select id="beerCountryInput"
                class="w-full px-4 py-2 rounded-xl bg-gray-900 text-white border border-amber-500/30 focus:outline-none focus:border-amber-400 mb-3 text-sm">
                <option value="–ë–µ–ª—å–≥–∏—è">üáßüá™ –ë–µ–ª—å–≥–∏—è</option>
                <option value="–í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è">üá¨üáß –í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è</option>
                <option value="–ì–µ—Ä–º–∞–Ω–∏—è">üá©üá™ –ì–µ—Ä–º–∞–Ω–∏—è</option>
                <option value="–ö–∏—Ç–∞–π">üá®üá≥ –ö–∏—Ç–∞–π</option>
                <option value="–ù–∏–¥–µ—Ä–ª–∞–Ω–¥—ã">üá≥üá± –ù–∏–¥–µ—Ä–ª–∞–Ω–¥—ã</option>
                <option value="–†–æ—Å—Å–∏—è">üá∑üá∫ –†–æ—Å—Å–∏—è</option>
                <option value="–ß–µ—Ö–∏—è">üá®üáø –ß–µ—Ö–∏—è</option>
                <option value="–ê–≤—Å—Ç—Ä–∏—è">üá¶üáπ –ê–≤—Å—Ç—Ä–∏—è</option>
                <option value="–°–µ—Ä–±–∏—è">üá∑üá∏ –°–µ—Ä–±–∏—è</option>
                <option value="–§—Ä–∞–Ω—Ü–∏—è">üá´üá∑ –§—Ä–∞–Ω—Ü–∏—è</option>
                <option value="–ò—Å–ø–∞–Ω–∏—è">üá™üá∏ –ò—Å–ø–∞–Ω–∏—è</option>
                <option value="–õ–∏—Ç–≤–∞">üá±üáπ –õ–∏—Ç–≤–∞</option>
                <option value="–Æ–∂–Ω–∞—è –ö–æ—Ä–µ—è">üá∞üá∑ –Æ–∂–Ω–∞—è –ö–æ—Ä–µ—è</option>
                <option value="–í—å–µ—Ç–Ω–∞–º">üáªüá≥ –í—å–µ—Ç–Ω–∞–º</option>
                <option value="–°–®–ê">üá∫üá∏ –°–®–ê</option>
                <option value="–ú–µ–∫—Å–∏–∫–∞">üá≤üáΩ –ú–µ–∫—Å–∏–∫–∞</option>
            </select>
            <select id="beerVolumeInput"
                class="w-full px-4 py-2 rounded-xl bg-gray-900 text-white border border-amber-500/30 focus:outline-none focus:border-amber-400 mb-3 text-sm">
                <option value="0.33">0.33 –ª</option>
                <option value="0.45">0.45 –ª</option>
                <option value="0.5">0.5 –ª</option>
                <option value="0.75">0.75 –ª</option>
                <option value="1">1 –ª</option>
                <option value="5">5 –ª</option>
            </select>
            <input type="number" id="beerAlcoholInput" placeholder="–ö—Ä–µ–ø–æ—Å—Ç—å (%)" min="0" max="100" step="0.1"
                class="w-full px-4 py-2 rounded-xl bg-gray-900 text-white placeholder-gray-500 border border-amber-500/30 focus:outline-none focus:border-amber-400 mb-4 text-sm">
            <div class="flex gap-2">
                <button onclick="addBeer()" class="flex-1 btn-glow bg-gradient-to-r from-amber-600 to-amber-500 text-white font-bold py-2 px-4 rounded-xl">
                    –î–æ–±–∞–≤–∏—Ç—å
                </button>
                <button onclick="closeAddBeerModal()" class="flex-1 btn-glow bg-gray-700 text-white font-bold py-2 px-4 rounded-xl">
                    –û—Ç–º–µ–Ω–∞
                </button>
            </div>
        </div>
    </div>

    <!-- Rate Beer Modal -->
    <div id="rateBeerModal" class="modal fixed inset-0 bg-black/90 hidden items-center justify-center z-50">
        <div class="bg-gray-950 rounded-2xl max-w-lg w-full p-6 border border-amber-500/30 mx-4">
            <h3 class="text-xl font-bold text-amber-400 mb-2">–û—Ü–µ–Ω–∏—Ç—å –ø–∏–≤–æ</h3>
            <p class="text-white mb-3 text-center font-semibold" id="rateBeerName"></p>

            <div class="text-center text-gray-400 text-xs mb-3">–û—Ü–µ–Ω–∫–∞: <span id="rateBeerValue" class="text-amber-300 font-bold">‚Äî</span></div>

            <div class="star-picker mb-6 overflow-x-auto py-2" id="beerStarPicker" aria-label="–í—ã–±–æ—Ä —Ä–µ–π—Ç–∏–Ω–≥–∞"></div>

            <button onclick="closeRateBeerModal()" class="w-full btn-glow bg-gray-700 text-white font-bold py-2 px-4 rounded-xl">
                –û—Ç–º–µ–Ω–∞
            </button>
        </div>
    </div>

    <!-- Edit Beer Modal -->
    <div id="editBeerModal" class="modal fixed inset-0 bg-black/90 hidden items-center justify-center z-50">
        <div class="bg-gray-950 rounded-2xl max-w-md w-full p-6 border border-amber-500/30 mx-4">
            <h3 class="text-xl font-bold text-amber-400 mb-4">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–∏–≤–æ</h3>
            <input type="text" id="editBeerNameInput" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ..."
                class="w-full px-4 py-2 rounded-xl bg-gray-900 text-white placeholder-gray-500 border border-amber-500/30 focus:outline-none focus:border-amber-400 mb-3 text-sm">
            <select id="editBeerTypeInput"
                class="w-full px-4 py-2 rounded-xl bg-gray-900 text-white border border-amber-500/30 focus:outline-none focus:border-amber-400 mb-3 text-sm">
                <option value="–°–≤–µ—Ç–ª–æ–µ">–°–≤–µ—Ç–ª–æ–µ</option>
                <option value="–¢—ë–º–Ω–æ–µ">–¢—ë–º–Ω–æ–µ</option>
            </select>
            <select id="editBeerStyleInput"
                class="w-full px-4 py-2 rounded-xl bg-gray-900 text-white border border-amber-500/30 focus:outline-none focus:border-amber-400 mb-3 text-sm">
                <option value="Lager">Lager</option>
                <option value="Wheat">Wheat</option>
                <option value="Pilsner">Pilsner</option>
                <option value="Cider">Cider</option>
                <option value="Bock">Bock</option>
                <option value="Marzen">Marzen</option>
                <option value="Ale">Ale</option>
                <option value="Porter">Porter</option>
                <option value="Stout">Stout</option>
                <option value="Dunkel">Dunkel</option>
                <option value="Weizen">Weizen</option>
                <option value="Hell">Hell</option>
                <option value="IPA">IPA</option>
                <option value="APA">APA</option>
                <option value="Kellerbier">Kellerbier</option>
                <option value="Dubbel">Dubbel</option>
                <option value="Tripel">Tripel</option>
            </select>
            <select id="editBeerFilteredInput"
                class="w-full px-4 py-2 rounded-xl bg-gray-900 text-white border border-amber-500/30 focus:outline-none focus:border-amber-400 mb-3 text-sm">
                <option value="–§–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω–æ–µ">–§–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω–æ–µ</option>
                <option value="–ù–µ—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω–æ–µ">–ù–µ—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω–æ–µ</option>
            </select>
            <select id="editBeerCountryInput"
                class="w-full px-4 py-2 rounded-xl bg-gray-900 text-white border border-amber-500/30 focus:outline-none focus:border-amber-400 mb-3 text-sm">
                <option value="–ë–µ–ª—å–≥–∏—è">üáßüá™ –ë–µ–ª—å–≥–∏—è</option>
                <option value="–í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è">üá¨üáß –í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è</option>
                <option value="–ì–µ—Ä–º–∞–Ω–∏—è">üá©üá™ –ì–µ—Ä–º–∞–Ω–∏—è</option>
                <option value="–ö–∏—Ç–∞–π">üá®üá≥ –ö–∏—Ç–∞–π</option>
                <option value="–ù–∏–¥–µ—Ä–ª–∞–Ω–¥—ã">üá≥üá± –ù–∏–¥–µ—Ä–ª–∞–Ω–¥—ã</option>
                <option value="–†–æ—Å—Å–∏—è">üá∑üá∫ –†–æ—Å—Å–∏—è</option>
                <option value="–ß–µ—Ö–∏—è">üá®üáø –ß–µ—Ö–∏—è</option>
                <option value="–ê–≤—Å—Ç—Ä–∏—è">üá¶üáπ –ê–≤—Å—Ç—Ä–∏—è</option>
                <option value="–°–µ—Ä–±–∏—è">üá∑üá∏ –°–µ—Ä–±–∏—è</option>
                <option value="–§—Ä–∞–Ω—Ü–∏—è">üá´üá∑ –§—Ä–∞–Ω—Ü–∏—è</option>
                <option value="–ò—Å–ø–∞–Ω–∏—è">üá™üá∏ –ò—Å–ø–∞–Ω–∏—è</option>
                <option value="–õ–∏—Ç–≤–∞">üá±üáπ –õ–∏—Ç–≤–∞</option>
                <option value="–Æ–∂–Ω–∞—è –ö–æ—Ä–µ—è">üá∞üá∑ –Æ–∂–Ω–∞—è –ö–æ—Ä–µ—è</option>
                <option value="–í—å–µ—Ç–Ω–∞–º">üáªüá≥ –í—å–µ—Ç–Ω–∞–º</option>
                <option value="–°–®–ê">üá∫üá∏ –°–®–ê</option>
                <option value="–ú–µ–∫—Å–∏–∫–∞">üá≤üáΩ –ú–µ–∫—Å–∏–∫–∞</option>
            </select>
            <select id="editBeerVolumeInput"
                class="w-full px-4 py-2 rounded-xl bg-gray-900 text-white border border-amber-500/30 focus:outline-none focus:border-amber-400 mb-3 text-sm">
                <option value="0.33">0.33 –ª</option>
                <option value="0.45">0.45 –ª</option>
                <option value="0.5">0.5 –ª</option>
                <option value="0.75">0.75 –ª</option>
                <option value="1">1 –ª</option>
                <option value="5">5 –ª</option>
            </select>
            <input type="number" id="editBeerAlcoholInput" placeholder="–ö—Ä–µ–ø–æ—Å—Ç—å (%)" min="0" max="100" step="0.1"
                class="w-full px-4 py-2 rounded-xl bg-gray-900 text-white placeholder-gray-500 border border-amber-500/30 focus:outline-none focus:border-amber-400 mb-4 text-sm">
            <div class="flex gap-2">
                <button onclick="saveBeerEdit()" class="flex-1 btn-glow bg-gradient-to-r from-green-600 to-green-500 text-white font-bold py-2 px-4 rounded-xl">
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
                <button onclick="closeEditBeerModal()" class="flex-1 btn-glow bg-gray-700 text-white font-bold py-2 px-4 rounded-xl">
                    –û—Ç–º–µ–Ω–∞
                </button>
            </div>
        </div>
    </div>

    <!-- Delete Beer Modal -->
    <div id="deleteBeerModal" class="modal fixed inset-0 bg-black/90 hidden items-center justify-center z-50">
        <div class="bg-gray-950 rounded-2xl max-w-md w-full p-6 border border-amber-500/30 mx-4">
            <h3 class="text-xl font-bold text-amber-400 mb-2">–£–¥–∞–ª–∏—Ç—å –ø–∏–≤–æ?</h3>
            <p class="text-gray-400 text-sm mb-5">–ó–∞–ø–∏—Å—å –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–∞ –∏–∑ –æ–±—â–µ–≥–æ —Ä–µ–π—Ç–∏–Ω–≥–∞ –¥–ª—è –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.</p>
            <div class="bg-black/40 border border-red-500/20 rounded-xl p-3 mb-5">
                <div class="text-xs text-gray-500 mb-1">–ü–∏–≤–æ:</div>
                <div id="deleteBeerName" class="text-white font-semibold"></div>
            </div>
            <div class="flex gap-2">
                <button onclick="closeDeleteBeerModal()" class="flex-1 btn-glow bg-gray-700 text-white font-bold py-2 px-4 rounded-xl">
                    –û—Ç–º–µ–Ω–∞
                </button>
                <button onclick="confirmDeleteBeer()" class="flex-1 btn-glow bg-gradient-to-r from-red-600 to-red-500 hover:from-red-500 hover:to-red-400 text-white font-bold py-2 px-4 rounded-xl">
                    –£–¥–∞–ª–∏—Ç—å
                </button>
            </div>
        </div>
    </div>

    <!-- Beer Columns Modal -->
    <div id="beerColumnsModal" class="modal fixed inset-0 bg-black/90 hidden items-center justify-center z-50">
        <div class="bg-gray-950 rounded-2xl max-w-md w-full p-6 border border-amber-500/30 mx-4">
            <div class="flex items-start justify-between gap-3 mb-4">
                <div>
                    <h3 class="text-xl font-bold text-amber-400">–ö–æ–ª–æ–Ω–∫–∏ —Ç–∞–±–ª–∏—Ü—ã</h3>
                    <div class="text-xs text-gray-500 mt-1">–í—ã–±–µ—Ä–∏—Ç–µ, –∫–∞–∫–∏–µ –∫–æ–ª–æ–Ω–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤ ¬´–†–µ–π—Ç–∏–Ω–≥ –ø–∏–≤–∞¬ª</div>
                </div>
                <button onclick="closeBeerColumnsModal()" class="text-gray-500 hover:text-white transition hover:rotate-90 transform duration-300" title="–ó–∞–∫—Ä—ã—Ç—å">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <div id="beerColumnsList" class="space-y-2 bg-black/30 rounded-xl p-3 border border-amber-500/20">
                <!-- checkboxes injected by JS -->
            </div>

            <div class="mt-4 flex gap-2">
                <button onclick="resetBeerColumns()" class="flex-1 px-4 py-2 rounded-xl border border-gray-600 text-gray-300 hover:text-white hover:border-amber-400 transition">–°–±—Ä–æ—Å–∏—Ç—å</button>
                <button onclick="saveBeerColumns()" class="flex-1 btn-glow bg-gradient-to-r from-green-600 to-green-500 hover:from-green-500 hover:to-green-400 text-white font-bold py-2 px-4 rounded-xl">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- Chat Button + Panel -->
    <button id="chatBtn" onclick="toggleChat()" class="fixed bottom-6 right-6 left-auto z-50 btn-glow bg-gradient-to-r from-amber-600 to-amber-500 hover:from-amber-500 hover:to-amber-400 text-white font-bold px-4 py-3 rounded-full shadow-lg shadow-amber-500/30 transition-all transform hover:scale-[1.04] flex items-center gap-2" style="position:fixed; right:1.5rem; left:auto; bottom:1.5rem; height:56px;">
        <span class="text-lg">üí¨</span>
        <span class="hidden sm:inline">–ß–∞—Ç</span>
    </button>

    <div id="chatPanel" class="chat-panel fixed bottom-24 right-6 left-auto z-50 w-[92vw] sm:w-[380px] max-w-[92vw]" aria-hidden="true">
        <div class="bg-black/70 backdrop-blur-xl border border-amber-500/20 rounded-2xl shadow-2xl overflow-hidden">
            <div class="flex items-center justify-between px-4 py-3 border-b border-amber-500/10 bg-black/60">
                <div class="flex items-center gap-2">
                    <span class="text-amber-300">üí¨</span>
                    <div class="font-bold text-amber-400">–ß–∞—Ç</div>
                </div>
                <button onclick="toggleChat(false)" class="text-gray-400 hover:text-white transition" aria-label="–ó–∞–∫—Ä—ã—Ç—å —á–∞—Ç">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <div id="chatMessages" class="px-3 py-3 space-y-2 max-h-[55vh] sm:max-h-[420px] overflow-y-auto"></div>
            <div id="typingIndicator" class="hidden px-3 pb-2 text-xs text-gray-400"></div>

            <div class="px-3 py-3 border-t border-amber-500/10 bg-black/60">
                <div class="flex gap-2 items-end">
                    <textarea id="chatInput" rows="1" class="chat-input flex-1 min-h-[44px] max-h-28 px-3 py-2 rounded-xl bg-gray-900/80 text-white placeholder-gray-500 border border-amber-500/25 focus:outline-none focus:border-amber-400 focus:ring-2 focus:ring-amber-500/15 transition text-sm resize-none"></textarea>
                    <button id="chatSendBtn" onclick="sendChatMessage()" class="btn-glow bg-gradient-to-r from-amber-600 to-amber-500 hover:from-amber-500 hover:to-amber-400 text-white font-bold px-4 rounded-xl transition" style="height:44px;">
                        –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                    </button>
                </div>
                <div class="text-[11px] text-gray-500 mt-2">Enter ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å ‚Ä¢ Shift+Enter ‚Äî –Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞</div>
            </div>
        </div>
    </div>

    <!-- Delete Chat Message Modal -->
    <div id="deleteChatModal" class="modal fixed inset-0 bg-black/90 hidden items-center justify-center z-50">
        <div class="bg-gray-950 rounded-2xl max-w-md w-full p-6 border border-amber-500/30 mx-4">
            <h3 class="text-xl font-bold text-amber-400 mb-2">–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?</h3>
            <p class="text-gray-400 text-sm mb-5">–°–æ–æ–±—â–µ–Ω–∏–µ –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–æ –¥–ª—è –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —á–∞—Ç–∞.</p>
            <div class="bg-black/40 border border-red-500/20 rounded-xl p-3 mb-5">
                <div class="text-xs text-gray-500 mb-1">–°–æ–æ–±—â–µ–Ω–∏–µ:</div>
                <div id="deleteChatPreview" class="text-white text-sm"></div>
            </div>
            <div class="flex gap-2">
                <button onclick="closeDeleteChatModal()" class="flex-1 btn-glow bg-gray-700 text-white font-bold py-2 px-4 rounded-xl">–û—Ç–º–µ–Ω–∞</button>
                <button onclick="confirmDeleteChatMessage()" class="flex-1 btn-glow bg-gradient-to-r from-red-600 to-red-500 hover:from-red-500 hover:to-red-400 text-white font-bold py-2 px-4 rounded-xl">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- Scroll to Top Button -->
    <button id="scrollTopBtn" onclick="scrollToTop()" class="fixed bottom-24 right-6 z-50 bg-gradient-to-r from-amber-600 to-amber-500 hover:from-amber-500 hover:to-amber-400 text-white font-bold rounded-full shadow-lg shadow-amber-500/30 transition-all transform hover:scale-110 opacity-0 invisible" style="transition: opacity 0.3s, visibility 0.3s, transform 0.2s; box-shadow: 0 10px 24px var(--glow-box-2), 0 0 0 1px var(--accent-border-20);">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"/>
        </svg>
    </button>

    <footer class="text-center py-6 text-gray-700 text-xs relative z-10">
        <p>üç∫ –ö–ò–ù–û–°–†–ï–î–ê ¬© 2025 ‚Ä¢ –°–¥–µ–ª–∞–Ω–æ —Å –ª—é–±–æ–≤—å—é –∫ –ø–∏–≤—É –∏ –∫–∏–Ω–æ üé¨</p>
    </footer>

    <script>
        // Create particles
        function createParticles() {
            const container = document.getElementById('particles');
            for (let i = 0; i < 15; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.bottom = '-10px';
                particle.style.animationDelay = Math.random() * 15 + 's';
                particle.style.animationDuration = (20 + Math.random() * 15) + 's';
                container.appendChild(particle);
            }
        }
        createParticles();

        // -----------------
        // Snow mode
        // -----------------
        // Prevent the snow overlay from covering the OS scrollbar area on desktop.
        (function setScrollbarWidthVar(){
            try {
                const sbw = Math.max(0, window.innerWidth - document.documentElement.clientWidth);
                document.documentElement.style.setProperty('--sbw', sbw + 'px');
                window.addEventListener('resize', () => {
                    const sbw2 = Math.max(0, window.innerWidth - document.documentElement.clientWidth);
                    document.documentElement.style.setProperty('--sbw', sbw2 + 'px');
                });
            } catch(_) {}
        })();

        const SNOW_LS_KEY = 'snowModeEnabled';
        let snowTimer = null;

        function setSnowUI(enabled) {
            const snow = document.getElementById('snow');
            const sw = document.getElementById('snowSwitch');
            const cb = document.getElementById('snowToggle');
            if (!snow || !sw || !cb) return;

            cb.checked = !!enabled;
            sw.classList.toggle('on', !!enabled);
            sw.setAttribute('aria-checked', enabled ? 'true' : 'false');

            if (enabled) {
                snow.classList.remove('hidden');
                startSnow();
            } else {
                stopSnow();
                snow.classList.add('hidden');
            }
        }

        // If the tab becomes hidden (mobile: app switch), stop snow to avoid heavy CPU/GPU + freezes.
        document.addEventListener('visibilitychange', () => {
            const enabled = localStorage.getItem(SNOW_LS_KEY) === '1';
            if (document.hidden) {
                stopSnow();
            } else if (enabled) {
                startSnow();
            }
        });

        function toggleSnow(force = null) {
            const current = localStorage.getItem(SNOW_LS_KEY) === '1';
            const next = (force === null) ? !current : !!force;
            localStorage.setItem(SNOW_LS_KEY, next ? '1' : '0');
            setSnowUI(next);
        }

        function startSnow() {
            const snow = document.getElementById('snow');
            if (!snow) return;
            // already running
            if (snowTimer) return;

            const isCoarse = window.matchMedia && window.matchMedia('(pointer: coarse)').matches;

            // Performance: fewer flakes on mobile AND a bit fewer on desktop (prevents scroll jank)
            const initialCount = isCoarse ? 8 : 14;
            for (let i = 0; i < initialCount; i++) spawnSnowflake(true);

            const interval = isCoarse ? 780 : 420;
            snowTimer = setInterval(() => spawnSnowflake(false), interval);
        }

        function stopSnow() {
            const snow = document.getElementById('snow');
            if (snowTimer) {
                clearInterval(snowTimer);
                snowTimer = null;
            }
            if (snow) {
                // Remove flakes immediately to free memory/CPU
                snow.replaceChildren();
            }
        }

        function spawnSnowflake(isInitial) {
            const snow = document.getElementById('snow');
            if (!snow) return;

            const isCoarse = window.matchMedia && window.matchMedia('(pointer: coarse)').matches;

            // Cap amount of flakes in DOM (performance)
            const maxFlakes = isCoarse ? 22 : 45;
            if (snow.childElementCount >= maxFlakes) return;

            const flake = document.createElement('div');
            flake.className = 'snowflake';
            flake.textContent = '‚ùÑ';

            const left = Math.random() * 100;
            const size = isCoarse ? (8 + Math.random() * 6) : (10 + Math.random() * 12);
            const duration = isCoarse ? (12 + Math.random() * 12) : (9 + Math.random() * 11);
            const drift = isCoarse ? (Math.random() * 50 - 25).toFixed(0) + 'px' : (Math.random() * 100 - 50).toFixed(0) + 'px';
            const opacity = isCoarse ? (0.28 + Math.random() * 0.35) : (0.35 + Math.random() * 0.5);
            const delay = isInitial ? (Math.random() * (isCoarse ? 6 : 4)) : 0;

            flake.style.left = left + 'vw';
            flake.style.fontSize = size + 'px';
            flake.style.opacity = String(opacity);
            flake.style.animationDuration = duration + 's';
            flake.style.animationDelay = delay + 's';
            flake.style.setProperty('--drift', drift);

            // remove after animation
            const removeAfter = (duration + delay + 0.3) * 1000;
            setTimeout(() => flake.remove(), removeAfter);

            snow.appendChild(flake);
        }

        // State
        let currentDate = new Date();
        let selectedDate = null;
        let db = null;
        let useFirebase = false;
        let data = { events: {}, backlog: { columns: [], cards: [] }, beerRating: [] };
        let editingColumnId = null;
        let currentColumnId = null;
        let editingCardId = null;
        let currentBeerIdForRating = null;
        let editingBeerId = null;
        let pendingDeleteBeerId = null;
        let beerSortBy = 'name';
        let beerSortDirection = 'asc';
        let beerSearchQuery = '';

        // -----------------
        // Chat (Realtime)
        // -----------------
        const CHAT_PATH = 'chatMessages';
        const CHAT_TYPING_PATH = 'chatTyping';
        let chatOpen = false;
        let chatInitialized = false;
        let chatUnsubscribe = null;
        let chatTypingUnsub = null;
        let chatTypingTimer = null;
        let chatEditId = null; // message id being edited
        let pendingDeleteChatId = null;
        let beerFilters = {
            type: '',
            style: '',
            filtered: '',
            country: '',
            volume: '',
            alcoholMin: '',
            alcoholMax: '',
            ratingMin: '',
            ratingMax: ''
        };

        // Beer table column visibility
        const BEER_COLS_LS_KEY = 'beerTableColumns';
        const BEER_COLUMNS = [
            { key: 'name', label: '–ù–∞–∑–≤–∞–Ω–∏–µ', required: true },
            { key: 'type', label: '–í–∏–¥' },
            { key: 'style', label: '–°–æ—Ä—Ç' },
            { key: 'filtered', label: '–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è' },
            { key: 'country', label: '–°—Ç—Ä–∞–Ω–∞' },
            { key: 'volume', label: '–û–±—ä—ë–º' },
            { key: 'alcohol', label: '–ö—Ä–µ–ø–æ—Å—Ç—å' },
            { key: 'rating', label: '–†–µ–π—Ç–∏–Ω–≥' },
            { key: 'actions', label: '–î–µ–π—Å—Ç–≤–∏—è', required: true }
        ];
        let beerColumnsVisible = null; // set in init

        let columnSortState = {}; // { columnId: 'asc' | 'desc' | null }

        const monthNames = ['–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å', 
                           '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'];
        
        const WATCHED_COLUMN_NAME = '–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω—ã';
        const BACKLOG_COLUMN_NAME = '–ë—ç–∫–ª–æ–≥';
        const NEW_COLUMN_NAME = '–ù–æ–≤—ã–µ';

        const countryInfo = {
            'be': { flag: 'üáßüá™', name: '–ë–µ–ª—å–≥–∏—è' },
            'gb': { flag: 'üá¨üáß', name: '–í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è' },
            'uk': { flag: 'üá¨üáß', name: '–í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è' },
            'de': { flag: 'üá©üá™', name: '–ì–µ—Ä–º–∞–Ω–∏—è' },
            'cn': { flag: 'üá®üá≥', name: '–ö–∏—Ç–∞–π' },
            'nl': { flag: 'üá≥üá±', name: '–ù–∏–¥–µ—Ä–ª–∞–Ω–¥—ã' },
            'ru': { flag: 'üá∑üá∫', name: '–†–æ—Å—Å–∏—è' },
            'cz': { flag: 'üá®üáø', name: '–ß–µ—Ö–∏—è' },
            'at': { flag: 'üá¶üáπ', name: '–ê–≤—Å—Ç—Ä–∏—è' },
            'rs': { flag: 'üá∑üá∏', name: '–°–µ—Ä–±–∏—è' },
            'fr': { flag: 'üá´üá∑', name: '–§—Ä–∞–Ω—Ü–∏—è' },
            'es': { flag: 'üá™üá∏', name: '–ò—Å–ø–∞–Ω–∏—è' },
            'lt': { flag: 'üá±üáπ', name: '–õ–∏—Ç–≤–∞' },
            'kr': { flag: 'üá∞üá∑', name: '–Æ–∂–Ω–∞—è –ö–æ—Ä–µ—è' },
            'vn': { flag: 'üáªüá≥', name: '–í—å–µ—Ç–Ω–∞–º' },
            'us': { flag: 'üá∫üá∏', name: '–°–®–ê' },
            'mx': { flag: 'üá≤üáΩ', name: '–ú–µ–∫—Å–∏–∫–∞' },
            '–±–µ–ª—å–≥–∏—è': { flag: 'üáßüá™', name: '–ë–µ–ª—å–≥–∏—è' },
            '–≤–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è': { flag: 'üá¨üáß', name: '–í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è' },
            '–≥–µ—Ä–º–∞–Ω–∏—è': { flag: 'üá©üá™', name: '–ì–µ—Ä–º–∞–Ω–∏—è' },
            '–∫–∏—Ç–∞–π': { flag: 'üá®üá≥', name: '–ö–∏—Ç–∞–π' },
            '–Ω–∏–¥–µ—Ä–ª–∞–Ω–¥—ã': { flag: 'üá≥üá±', name: '–ù–∏–¥–µ—Ä–ª–∞–Ω–¥—ã' },
            '—Ä–æ—Å—Å–∏—è': { flag: 'üá∑üá∫', name: '–†–æ—Å—Å–∏—è' },
            '—á–µ—Ö–∏—è': { flag: 'üá®üáø', name: '–ß–µ—Ö–∏—è' },
            '–∞–≤—Å—Ç—Ä–∏—è': { flag: 'üá¶üáπ', name: '–ê–≤—Å—Ç—Ä–∏—è' },
            '—Å–µ—Ä–±–∏—è': { flag: 'üá∑üá∏', name: '–°–µ—Ä–±–∏—è' },
            '—Ñ—Ä–∞–Ω—Ü–∏—è': { flag: 'üá´üá∑', name: '–§—Ä–∞–Ω—Ü–∏—è' },
            '–∏—Å–ø–∞–Ω–∏—è': { flag: 'üá™üá∏', name: '–ò—Å–ø–∞–Ω–∏—è' },
            '–ª–∏—Ç–≤–∞': { flag: 'üá±üáπ', name: '–õ–∏—Ç–≤–∞' },
            '—é–∂–Ω–∞—è –∫–æ—Ä–µ—è': { flag: 'üá∞üá∑', name: '–Æ–∂–Ω–∞—è –ö–æ—Ä–µ—è' },
            '–≤—å–µ—Ç–Ω–∞–º': { flag: 'üáªüá≥', name: '–í—å–µ—Ç–Ω–∞–º' },
            '—Å—à–∞': { flag: 'üá∫üá∏', name: '–°–®–ê' },
            '–º–µ–∫—Å–∏–∫–∞': { flag: 'üá≤üáΩ', name: '–ú–µ–∫—Å–∏–∫–∞' }
        };

        const collator = new Intl.Collator(['ru', 'en'], { sensitivity: 'base', numeric: false, ignorePunctuation: true });

        function formatCountry(country) {
            const key = (country || '').toString().trim().toLowerCase();
            if (countryInfo[key]) return `${countryInfo[key].flag} ${countryInfo[key].name}`;
            // –µ—Å–ª–∏ –ø—Ä–∏–ª–µ—Ç–µ–ª–æ –∑–Ω–∞—á–µ–Ω–∏–µ —É–∂–µ —Å —Ñ–ª–∞–≥–æ–º
            const stripped = (country || '').replace(/[\u{1F1E6}-\u{1F1FF}]/gu, '').trim();
            if (countryInfo[stripped.toLowerCase()]) return `${countryInfo[stripped.toLowerCase()].flag} ${countryInfo[stripped.toLowerCase()].name}`;
            return country || '';
        }

        function normalizeCountryCode(country) {
            const raw = (country || '').toString().trim();
            const key = raw.toLowerCase();
            if (countryInfo[key]) {
                const entry = Object.entries(countryInfo).find(([code, info]) => info.name.toLowerCase() === countryInfo[key].name.toLowerCase() && code.length <= 2);
                return entry ? entry[0] : key;
            }
            // –µ—Å–ª–∏ –±—ã–ª–æ —Å —Ñ–ª–∞–≥–æ–º ‚Äî —É–±–∏—Ä–∞–µ–º —Ñ–ª–∞–≥ –∏ –ø—Ä–æ–±—É–µ–º —Å–Ω–æ–≤–∞
            const noFlag = raw.replace(/[\u{1F1E6}-\u{1F1FF}]/gu, '').trim().toLowerCase();
            if (countryInfo[noFlag]) return normalizeCountryCode(noFlag);
            return key;
        }

        function getCountryNameForSelect(country) {
            const code = normalizeCountryCode(country);
            if (countryInfo[code]) return countryInfo[code].name;
            const noFlag = (country || '').replace(/[\u{1F1E6}-\u{1F1FF}]/gu, '').trim();
            const fallback = noFlag.toLowerCase();
            if (countryInfo[fallback]) return countryInfo[fallback].name;
            return '–†–æ—Å—Å–∏—è';
        }

        function isLatin(text) {
            return /^[A-Za-z]/.test((text || '').trim());
        }

        // -----------------
        // Backlog: per-user ratings for movies
        // -----------------
        function getCardRatingsObject(card) {
            if (card && card.ratings && typeof card.ratings === 'object') return card.ratings;
            // legacy fallback: single numeric rating stored as card.rating
            const legacy = card ? (parseFloat(card.rating) || 0) : 0;
            if (legacy > 0) {
                const k = (card && card.author) ? card.author : '–ê–≤—Ç–æ—Ä';
                return { [k]: legacy };
            }
            return {};
        }

        function getCardAvgRating(card) {
            const entries = Object.entries(getCardRatingsObject(card));
            if (!entries.length) return 0;
            const sum = entries.reduce((s, [, r]) => s + (parseFloat(r) || 0), 0);
            return sum / entries.length;
        }

        function getCardRatingsCount(card) {
            return Object.keys(getCardRatingsObject(card)).length;
        }

        function buildCardRatingsLine(card, maxItems = 3) {
            const entries = Object.entries(getCardRatingsObject(card));
            if (!entries.length) return { short: '', full: '' };
            // stable order
            entries.sort((a, b) => collator.compare(a[0], b[0]));
            const full = entries.map(([n, r]) => `${n}: ${String(r)}`).join(', ');
            const shown = entries.slice(0, maxItems).map(([n, r]) => `${n}: ${String(r)}`);
            const more = entries.length > maxItems ? ` +${entries.length - maxItems}` : '';
            return { short: shown.join(' ‚Ä¢ ') + more, full };
        }

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyBwp4ZNbJuUM5sY0qMffvZTHr2PDvc2iLc",
            authDomain: "kinosreda-ce8ef.firebaseapp.com",
            databaseURL: "https://kinosreda-ce8ef-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "kinosreda-ce8ef",
            storageBucket: "kinosreda-ce8ef.firebasestorage.app",
            messagingSenderId: "889337905300",
            appId: "1:889337905300:web:325aea2f3fb3c6b44a7481",
            measurementId: "G-MGW6GF67H3"
        };

        // Current user
        let currentUser = null;

        // -----------------
        // Logo font picker (profile-controlled)
        // -----------------
        const LOGO_FONT_LS_KEY = 'logoFontFamily';

        // -----------------
        // Theme picker (profile-controlled)
        // -----------------
        const THEME_LS_KEY = 'siteTheme';
        function applyTheme() {
            document.documentElement.dataset.theme = localStorage.getItem(THEME_LS_KEY) || 'beer';
        }
        const LOGO_FONTS = [
            'Train One',
            'Rubik Wet Paint',
            'Rubik Moonrocks',
            'Rubik Microbe',
            'Rubik Puddles',
            'Stick',
            'Press Start 2P',
            'Reggae One',
            'Dela Gothic One',
            'Amatic SC',
            'Underdog',
            'Stalinist One',
            'Lobster',
            'Kablammo',
            'Comforter',
            'Pacifico',
            'Ruslan Display',
            'Caveat',
            'Rampart One',
            'Rubik Scribble'
        ];
        // Carefully tuned per-font sizes so text fits and mug doesn't overlap.
        const LOGO_PRESETS = {
            'Train One': { family: 'Train One', size: 62, textLength: 395, y: 78, mugX: 438, mugY: 2 },
            'Rubik Wet Paint': { family: 'Rubik Wet Paint', size: 62, textLength: 395, y: 78, mugX: 438, mugY: 2 },
            'Rubik Moonrocks': { family: 'Rubik Moonrocks', size: 58, textLength: 395, y: 78, mugX: 438, mugY: 2 },
            'Rubik Microbe': { family: 'Rubik Microbe', size: 64, textLength: 395, y: 78, mugX: 438, mugY: 2 },
            'Rubik Puddles': { family: 'Rubik Puddles', size: 54, textLength: 395, y: 80, mugX: 438, mugY: 2 },
            'Stick': { family: 'Stick', size: 64, textLength: 395, y: 78, mugX: 438, mugY: 2 },
            'Press Start 2P': { family: 'Press Start 2P', size: 40, textLength: 395, y: 74, mugX: 438, mugY: 2 },
            'Reggae One': { family: 'Reggae One', size: 60, textLength: 395, y: 78, mugX: 438, mugY: 2 },
            'Dela Gothic One': { family: 'Dela Gothic One', size: 56, textLength: 395, y: 78, mugX: 438, mugY: 2 },
            'Amatic SC': { family: 'Amatic SC', size: 78, textLength: 395, y: 82, mugX: 438, mugY: 2 },
            'Underdog': { family: 'Underdog', size: 60, textLength: 395, y: 78, mugX: 438, mugY: 2 },
            'Stalinist One': { family: 'Stalinist One', size: 40, textLength: 395, y: 74, mugX: 438, mugY: 2 },
            'Lobster': { family: 'Lobster', size: 64, textLength: 395, y: 80, mugX: 438, mugY: 2 },
            'Kablammo': { family: 'Kablammo', size: 54, textLength: 395, y: 80, mugX: 438, mugY: 2 },
            'Comforter': { family: 'Comforter', size: 76, textLength: 395, y: 84, mugX: 438, mugY: 2 },
            'Pacifico': { family: 'Pacifico', size: 66, textLength: 395, y: 82, mugX: 438, mugY: 2 },
            'Ruslan Display': { family: 'Ruslan Display', size: 56, textLength: 395, y: 78, mugX: 438, mugY: 2 },
            'Caveat': { family: 'Caveat', size: 82, textLength: 395, y: 86, mugX: 438, mugY: 2 },
            'Rampart One': { family: 'Rampart One', size: 62, textLength: 395, y: 80, mugX: 438, mugY: 2 },
            'Rubik Scribble': { family: 'Rubik Scribble', size: 52, textLength: 395, y: 80, mugX: 438, mugY: 2 }
        };

        function getLogoFontChoice() {
            const saved = localStorage.getItem(LOGO_FONT_LS_KEY);
            return (saved && LOGO_PRESETS[saved]) ? saved : 'Rubik Wet Paint';
        }

        function applyLogoSettings() {
            const choice = getLogoFontChoice();
            const preset = LOGO_PRESETS[choice] || LOGO_PRESETS['Train One'];
            document.documentElement.style.setProperty('--logo-font', `'${preset.family}'`);
            try { window.__loadLogoFont && window.__loadLogoFont(preset.family); } catch(_) {}

            const t = document.getElementById('logoText');
            if (t) {
                // Force SVG text to swap font immediately (prevents "only size changes" issue)
                // SVG is sometimes picky: set BOTH style and SVG attribute.
                t.style.fontFamily = `"${preset.family}", Comfortaa, cursive`;
                t.setAttribute('font-family', preset.family);
                t.setAttribute('font-size', String(preset.size));
                t.setAttribute('textLength', String(preset.textLength));
                t.setAttribute('y', String(preset.y));
            }
            const mug = document.getElementById('logoMug');
            if (mug) mug.setAttribute('transform', `translate(${preset.mugX}, ${preset.mugY})`);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Check authorization
            const userDataStr = localStorage.getItem('currentUser');
            if (!userDataStr) {
                window.location.href = 'login.html';
                return;
            }
            
            currentUser = JSON.parse(userDataStr);

            // Ensure chat button is on the right even if some CSS overrides exist
            const chatBtn = document.getElementById('chatBtn');
            if (chatBtn) {
                chatBtn.style.right = '1.5rem';
                chatBtn.style.left = 'auto';
                chatBtn.style.position = 'fixed';
                chatBtn.style.bottom = '1.5rem';
                chatBtn.style.height = '56px';
                // store width for aligning "scroll to top" button when chat is open
                try {
                    const w = chatBtn.getBoundingClientRect().width;
                    document.documentElement.style.setProperty('--chatw', w + 'px');
                    window.addEventListener('resize', () => {
                        const w2 = chatBtn.getBoundingClientRect().width;
                        document.documentElement.style.setProperty('--chatw', w2 + 'px');
                    });
                } catch(_) {}
            }

            // Apply theme selection
            applyTheme();

            // Apply logo font selection
            applyLogoSettings();

            // Beer columns visibility init
            beerColumnsVisible = loadBeerColumnsVisible();

            window.addEventListener('storage', (e) => {
                if (e.key === LOGO_FONT_LS_KEY) {
                    // Seamless: load font first, then apply preset
                    const fam = localStorage.getItem(LOGO_FONT_LS_KEY) || 'Rubik Wet Paint';
                    try {
                        if (window.__loadLogoFont) {
                            // __loadLogoFont will mark logo-font-ready when loaded
                            window.__loadLogoFont(fam);
                        }
                    } catch(_) {}
                    // Apply sizing/position after a microtask to let font loader kick in
                    Promise.resolve().then(applyLogoSettings);
                }
                if (e.key === THEME_LS_KEY) applyTheme();
                if (e.key === BEER_COLS_LS_KEY) {
                    beerColumnsVisible = loadBeerColumnsVisible();
                    renderBeerRating();
                }
            });
            
            // Update user profile in header
            updateUserProfile();

            // Snow switch init
            const snowEnabled = localStorage.getItem(SNOW_LS_KEY) === '1';
            setSnowUI(snowEnabled);
            const sw = document.getElementById('snowSwitch');
            if (sw) {
                sw.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        toggleSnow();
                    }
                });
            }

            initFirebase(firebaseConfig);

            // Enhance beer selects UI (filters + add/edit modals)
            enhanceBeerSelects();
            syncBeerSelects();
        });
        
        function updateUserProfile() {
            const nav = document.querySelector('header nav');
            const profileHTML = `
                <div class="flex items-center gap-1 md:gap-3 ml-1 md:ml-4 pl-1 md:pl-4 border-l border-amber-500/30">
                    <a href="profile.html" class="text-amber-400 hover:text-amber-300 transition font-medium text-xs md:text-sm px-2 md:px-3 py-1 md:py-2 rounded-lg hover:bg-amber-500/10" title="–ü—Ä–æ—Ñ–∏–ª—å">
                        üë§ <span class="hidden sm:inline">${currentUser.name}</span>
                    </a>
                    <button onclick="logout()" class="text-red-400 hover:text-red-300 transition font-medium text-xs md:text-sm px-2 md:px-3 py-1 md:py-2 rounded-lg hover:bg-red-500/10">
                        <span class="sm:hidden">üö™</span><span class="hidden sm:inline">–í—ã–π—Ç–∏</span>
                    </button>
                </div>
            `;
            nav.insertAdjacentHTML('beforeend', profileHTML);
        }
        
        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'login.html';
        }
        
        function getUserName() {
            return currentUser ? currentUser.name : '';
        }

        // Firebase Methods
        function initFirebase(config) {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(config);
                }
                db = firebase.database();
                useFirebase = true;
                
                db.ref('events').on('value', (snapshot) => {
                    data.events = snapshot.val() || {};
                    renderCalendar();
                    renderUpcomingEvents();
                    if (selectedDate) renderPanelContent();
                });
                
                db.ref('backlog').on('value', (snapshot) => {
                    const backlogData = snapshot.val() || { columns: [], cards: [] };
                    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –æ–±—ä–µ–∫—Ç—ã –≤ –º–∞—Å—Å–∏–≤—ã –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                    if (backlogData.columns && !Array.isArray(backlogData.columns)) {
                        backlogData.columns = Object.values(backlogData.columns);
                    }
                    if (backlogData.cards && !Array.isArray(backlogData.cards)) {
                        backlogData.cards = Object.values(backlogData.cards);
                    }
                    data.backlog = {
                        columns: backlogData.columns || [],
                        cards: backlogData.cards || []
                    };
                    renderBacklog();
                });
                
                db.ref('beerRating').on('value', (snapshot) => {
                    const beerData = snapshot.val() || [];
                    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –æ–±—ä–µ–∫—Ç –≤ –º–∞—Å—Å–∏–≤ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                    if (beerData && !Array.isArray(beerData)) {
                        data.beerRating = Object.values(beerData);
                    } else {
                        data.beerRating = beerData || [];
                    }
                    renderBeerRating();
                });
                
                console.log('Firebase connected!');
            } catch (e) {
                console.error('Firebase error:', e);
                const savedData = localStorage.getItem('eventData');
                if (savedData) data = JSON.parse(savedData);
                renderCalendar();
                renderUpcomingEvents();
                renderBacklog();
                renderBeerRating();
            }
        }

        // Data Methods
        function saveData() {
            if (useFirebase && db) {
                db.ref('events').set(data.events);
                db.ref('backlog').set(data.backlog);
                db.ref('beerRating').set(data.beerRating);
            } else {
                localStorage.setItem('eventData', JSON.stringify(data));
                renderCalendar();
                renderUpcomingEvents();
                renderBacklog();
                renderBeerRating();
            }
        }

        function getEvent(dateKey) {
            return data.events[dateKey] || { attendees: {}, movies: {} };
        }

        function setEvent(dateKey, event) {
            data.events[dateKey] = event;
            saveData();
        }

        // Calendar Methods
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            document.getElementById('monthYear').textContent = `${monthNames[month]} ${year}`;
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDay = (firstDay.getDay() + 6) % 7;
            
            const container = document.getElementById('calendarDays');
            container.innerHTML = '';
            
            const nearestMeetingDate = getNearestMeetingDateKey();
            
            for (let i = 0; i < startDay; i++) {
                container.innerHTML += '<div></div>';
            }
            
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const date = new Date(year, month, day);
                const isWednesday = date.getDay() === 3;
                const dateKey = formatDateKey(date);
                const event = getEvent(dateKey);
                const hasAttendees = Object.keys(event.attendees || {}).length > 0;
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const dateNoTime = new Date(year, month, day);
                const isToday = dateNoTime.getTime() === today.getTime();
                const isPast = dateNoTime < today;
                const isSelected = selectedDate === dateKey;
                const isNearestMeeting = dateKey === nearestMeetingDate;
                
                let classes = 'h-12 rounded-lg flex flex-col items-center justify-center text-center relative ';
                
                if (isWednesday && !isPast) {
                    classes += 'wednesday bg-gradient-to-br from-amber-500 to-amber-600 hover:from-amber-400 hover:to-amber-500 text-gray-900 font-bold shadow-lg shadow-amber-500/20 ';
                    if (isNearestMeeting) classes += 'ring-2 ring-green-400 ring-offset-1 ring-offset-black ';
                    if (isToday) classes += 'ring-2 ring-white ring-offset-1 ring-offset-black ';
                    if (isSelected) classes += 'ring-2 ring-amber-300 ring-offset-2 ring-offset-black scale-110 ';
                } else if (isWednesday && isPast) {
                    classes += 'wednesday bg-gray-900/50 text-amber-700/50 border border-amber-900/20 cursor-pointer hover:bg-gray-800/50 hover:border-amber-700/30 ';
                    if (isSelected) classes += 'ring-2 ring-amber-300 ring-offset-2 ring-offset-black ';
                } else {
                    classes += 'text-gray-700 ';
                }
                
                const attendeeCount = Object.keys(event.attendees || {}).length;
                const totalBeer = Object.values(event.attendees || {}).reduce((sum, a) => sum + (parseInt(a.beer) || 0), 0);
                
                container.innerHTML += `
                    <div class="${classes}" ${isWednesday ? `onclick="openPanel('${dateKey}')"` : ''}>
                        <span class="text-sm font-bold">${day}</span>
                        ${hasAttendees ? `<span class="text-[10px] leading-none font-semibold">üë•${attendeeCount} üç∫${totalBeer}</span>` : ''}
                    </div>
                `;
            }
        }

        function getNearestMeetingDateKey() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const futureMeetings = Object.entries(data.events)
                .filter(([dateKey, event]) => {
                    const [year, month, day] = dateKey.split('-').map(Number);
                    const date = new Date(year, month - 1, day);
                    return date >= today && Object.keys(event.attendees || {}).length > 0;
                })
                .sort((a, b) => {
                    const [aY, aM, aD] = a[0].split('-').map(Number);
                    const [bY, bM, bD] = b[0].split('-').map(Number);
                    return new Date(aY, aM - 1, aD) - new Date(bY, bM - 1, bD);
                });
            
            return futureMeetings.length > 0 ? futureMeetings[0][0] : null;
        }

        function prevMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        }

        function formatDateKey(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatDateDisplay(dateKey) {
            const [year, month, day] = dateKey.split('-').map(Number);
            const date = new Date(year, month - 1, day);
            return date.toLocaleDateString('ru-RU', { 
                weekday: 'long', 
                day: 'numeric', 
                month: 'long'
            });
        }

        // Panel Methods
        function openPanel(dateKey) {
            const userName = getUserName();
            
            selectedDate = dateKey;
            document.getElementById('panelDate').textContent = formatDateDisplay(dateKey);
            
            document.getElementById('eventPlaceholder').classList.add('hidden');
            document.getElementById('eventPanel').classList.remove('hidden');
            
            renderPanelContent();
            renderCalendar();
        }

        function closePanel() {
            selectedDate = null;
            document.getElementById('eventPanel').classList.add('hidden');
            document.getElementById('eventPlaceholder').classList.remove('hidden');
            renderCalendar();
        }

        function renderPanelContent() {
            const event = getEvent(selectedDate);
            const userName = getUserName();
            
            // Update RSVP title based on user attendance
            const rsvpTitle = document.getElementById('rsvpTitle');
            const attendees = event.attendees || {};
            const isUserAttending = attendees[userName] !== undefined;
            
            if (isUserAttending) {
                rsvpTitle.innerHTML = '<span>‚úÖ</span> –£—á–∞—Å—Ç–∏–µ –∑–∞—è–≤–ª–µ–Ω–æ';
            } else {
                rsvpTitle.innerHTML = '<span>‚úã</span> –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —É—á–∞—Å—Ç–∏–µ';
            }
            
            const attendeesContainer = document.getElementById('attendeesList');
            
            if (Object.keys(attendees).length === 0) {
                attendeesContainer.innerHTML = '<span class="text-gray-600 text-xs italic">–ü–æ–∫–∞ –Ω–∏–∫—Ç–æ –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª...</span>';
            } else {
                attendeesContainer.innerHTML = Object.entries(attendees).map(([name, info]) => `
                    <div class="bg-green-600/20 px-3 py-1.5 rounded-full flex items-center gap-1.5 border border-green-500/30 text-sm">
                        <span class="text-white font-medium">${name}</span>
                        <span class="text-amber-300 font-bold text-xs">üç∫${info.beer}</span>
                        ${name === userName ? `<button onclick="removeAttendance('${name}')" class="text-red-400 hover:text-red-300 ml-1 text-xs">‚úï</button>` : ''}
                    </div>
                `).join('');
            }
            
            if (attendees[userName]) {
                document.getElementById('beerCount').value = attendees[userName].beer;
            }
            
            const totalBeer = Object.values(attendees).reduce((sum, a) => sum + (parseInt(a.beer) || 0), 0);
            document.getElementById('totalBeer').textContent = totalBeer;
            
            const moviesContainer = document.getElementById('moviesList');
            const movies = event.movies || {};
            
            if (Object.keys(movies).length === 0) {
                moviesContainer.innerHTML = '<p class="text-gray-600 text-xs text-center italic py-3">–ü–æ–∫–∞ –Ω–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π...</p>';
            } else {
                const sortedMovies = Object.entries(movies).sort((a, b) => 
                    (Object.keys(b[1].votes || {}).length) - (Object.keys(a[1].votes || {}).length)
                );
                
                moviesContainer.innerHTML = sortedMovies.map(([id, movie], index) => {
                    const votes = Object.keys(movie.votes || {});
                    const hasVoted = votes.includes(userName);
                    const isAuthor = movie.author === userName;
                    const isLeader = index === 0 && votes.length > 0;
                    
                    return `
                        <div class="bg-gray-800/30 rounded-lg p-2.5 flex items-center gap-2 border ${isLeader ? 'border-amber-500/50 glow-amber' : 'border-gray-700/30'} transition-all hover:bg-gray-800/50">
                            <button onclick="voteMovie('${id}')" 
                                class="movie-vote-btn w-10 h-10 rounded-lg ${hasVoted ? 'voted bg-gradient-to-br from-amber-500 to-amber-600 shadow shadow-amber-500/30' : 'bg-gray-700/50 hover:bg-gray-600/50'} flex flex-col items-center justify-center transition-all transform hover:scale-105">
                                <span class="text-sm">${hasVoted ? 'üëç' : 'üëÜ'}</span>
                                <span class="text-xs text-white font-bold">${votes.length}</span>
                            </button>
                            <div class="flex-1 min-w-0">
                                <div class="text-white font-medium text-sm truncate" title="${movie.title}">
                                    ${isLeader ? 'üëë ' : ''}${movie.title}
                                </div>
                                <div class="text-gray-500 text-xs truncate">${movie.author}</div>
                            </div>
                            ${isAuthor ? `<button onclick="removeMovie('${id}')" class="text-red-400/60 hover:text-red-400 p-1 text-sm">üóëÔ∏è</button>` : ''}
                        </div>
                    `;
                }).join('');
            }
        }

        // Event Actions
        function confirmAttendance() {
            const userName = getUserName();
            const beerCount = parseInt(document.getElementById('beerCount').value) || 0;
            
            const event = getEvent(selectedDate);
            if (!event.attendees) event.attendees = {};
            event.attendees[userName] = { beer: beerCount, timestamp: Date.now() };
            setEvent(selectedDate, event);
            
            if (!useFirebase) renderPanelContent();
        }

        function removeAttendance(name) {
            const event = getEvent(selectedDate);
            if (event.attendees && event.attendees[name]) {
                delete event.attendees[name];
                setEvent(selectedDate, event);
                if (!useFirebase) renderPanelContent();
            }
        }

        function addMovie() {
            const userName = getUserName();
            const movieInput = document.getElementById('movieInput');
            const title = movieInput.value.trim();
            
            if (!title) return;
            
            // Check if movie already suggested for this event (case-insensitive)
            const event = getEvent(selectedDate);
            if (!event.movies) event.movies = {};
            const existingMovieEntry = Object.entries(event.movies).find(([, m]) => (m.title || '').toLowerCase() === title.toLowerCase());
            if (existingMovieEntry) {
                // –§–∏–ª—å–º —É–∂–µ –µ—Å—Ç—å –≤ —Å–ø–∏—Å–∫–µ - –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç
                movieInput.value = '';
                return;
            }
            
            // Check if movie exists in backlog
            const existingCard = data.backlog.cards.find(card => 
                card.title.toLowerCase() === title.toLowerCase()
            );
            
            if (existingCard) {
                const watchedColumn = data.backlog.columns.find(col => col.name === WATCHED_COLUMN_NAME);
                const newColumn = data.backlog.columns.find(col => col.name === NEW_COLUMN_NAME);
                
                if (watchedColumn && existingCard.columnId === watchedColumn.id && newColumn) {
                    // Move from Watched to New
                    existingCard.columnId = newColumn.id;
                    saveData();
                }
            } else {
                // Add movie to backlog in "New" column
                const newColumn = data.backlog.columns.find(col => col.name === NEW_COLUMN_NAME);
                if (newColumn) {
                    const card = {
                        id: Date.now().toString(),
                        columnId: newColumn.id,
                        title: title,
                        description: '',
                        rating: 0,
                        author: userName,
                        watchCount: 0,
                        timestamp: Date.now()
                    };
                    data.backlog.cards.push(card);
                }
            }
            
            // Add to event movies for voting
            const movieId = Date.now().toString();
            event.movies[movieId] = {
                title: title,
                author: userName,
                votes: { [userName]: true },
                timestamp: Date.now()
            };
            
            setEvent(selectedDate, event);
            movieInput.value = '';
            
            if (!useFirebase) renderPanelContent();
        }

        function voteMovie(movieId) {
            const userName = getUserName();
            const event = getEvent(selectedDate);
            
            if (!event.movies || !event.movies[movieId]) return;
            
            if (!event.movies[movieId].votes) event.movies[movieId].votes = {};
            
            if (event.movies[movieId].votes[userName]) {
                delete event.movies[movieId].votes[userName];
            } else {
                event.movies[movieId].votes[userName] = true;
            }
            
            setEvent(selectedDate, event);
            if (!useFirebase) renderPanelContent();
        }

        function removeMovie(movieId) {
            const event = getEvent(selectedDate);
            if (event.movies && event.movies[movieId]) {
                delete event.movies[movieId];
                setEvent(selectedDate, event);
                if (!useFirebase) renderPanelContent();
            }
        }

        // Upcoming Events
        function renderUpcomingEvents() {
            const container = document.getElementById('upcomingEvents');
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const upcoming = Object.entries(data.events)
                .filter(([dateKey, event]) => {
                    const [year, month, day] = dateKey.split('-').map(Number);
                    const date = new Date(year, month - 1, day);
                    return date >= today && Object.keys(event.attendees || {}).length > 0;
                })
                .sort((a, b) => {
                    const [aY, aM, aD] = a[0].split('-').map(Number);
                    const [bY, bM, bD] = b[0].split('-').map(Number);
                    return new Date(aY, aM - 1, aD) - new Date(bY, bM - 1, bD);
                })
                .slice(0, 3);
            
            if (upcoming.length === 0) {
                container.innerHTML = '<p class="text-gray-600 text-center italic py-4 text-sm">–ù–µ—Ç –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –≤—Å—Ç—Ä–µ—á</p>';
                return;
            }
            
            container.innerHTML = upcoming.map(([dateKey, event]) => {
                const attendees = Object.entries(event.attendees || {});
                const totalBeer = attendees.reduce((sum, [, a]) => sum + (parseInt(a.beer) || 0), 0);
                
                const moviesWithVotes = Object.entries(event.movies || {})
                    .filter(([, movie]) => Object.keys(movie.votes || {}).length > 0)
                    .sort((a, b) => Object.keys(b[1].votes || {}).length - Object.keys(a[1].votes || {}).length);
                const topMovie = moviesWithVotes.length > 0 ? moviesWithVotes[0] : null;
                
                return `
                    <div onclick="openPanel('${dateKey}')" 
                        class="bg-gray-900/50 hover:bg-gray-800/50 rounded-xl p-3 cursor-pointer transition-all border border-amber-500/10 hover:border-amber-500/30 card-hover group">
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="text-amber-400 font-semibold text-sm group-hover:text-glow transition-all">${formatDateDisplay(dateKey)}</div>
                                <div class="text-gray-500 text-xs mt-1">
                                    üë• ${attendees.length} ‚Ä¢ üç∫ ${totalBeer}
                                </div>
                                ${topMovie ? `<div class="text-purple-400/70 text-xs mt-1 truncate max-w-[200px]">üé¨ ${topMovie[1].title}</div>` : ''}
                            </div>
                            <div class="text-2xl opacity-30 group-hover:opacity-70 transition-all">üé¨</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Backlog Methods
        function renderBacklog() {
            const board = document.getElementById('backlogBoard');
            const columns = data.backlog.columns || [];
            const cards = data.backlog.cards || [];
            
            if (columns.length === 0) {
                columns.push(
                    { id: Date.now().toString(), name: NEW_COLUMN_NAME },
                    { id: (Date.now() + 1).toString(), name: BACKLOG_COLUMN_NAME },
                    { id: (Date.now() + 2).toString(), name: WATCHED_COLUMN_NAME }
                );
                data.backlog.columns = columns;
                saveData();
            }
            
            board.innerHTML = columns.map(column => {
                let columnCards = cards.filter(card => card.columnId === column.id);
                
                // Get column sort state
                const sortState = columnSortState[column.id];
                
                // Sort all cards
                columnCards.sort((a, b) => {
                    // If manual rating sort is active, use only that (by avg rating)
                    if (sortState === 'asc' || sortState === 'desc') {
                        const aRating = getCardAvgRating(a);
                        const bRating = getCardAvgRating(b);
                        return sortState === 'asc' ? aRating - bRating : bRating - aRating;
                    }
                    
                    // Default sorting: first by watch history (no history first, then by earliest date), then by rating (descending)
                    const aLastWatch = a.watchHistory && a.watchHistory.length > 0 ? a.watchHistory[a.watchHistory.length - 1] : 0;
                    const bLastWatch = b.watchHistory && b.watchHistory.length > 0 ? b.watchHistory[b.watchHistory.length - 1] : 0;
                    
                    // Cards without watch history go first
                    if (aLastWatch === 0 && bLastWatch !== 0) return -1;
                    if (aLastWatch !== 0 && bLastWatch === 0) return 1;
                    
                    // If both have watch history, sort by earliest watch date first (ascending)
                    if (aLastWatch !== 0 && bLastWatch !== 0) {
                        if (aLastWatch !== bLastWatch) {
                            return aLastWatch - bLastWatch; // Earlier date first
                        }
                    }
                    
                    // Within same watch status/date group, sort by avg rating (descending - higher first)
                    const aRating = getCardAvgRating(a);
                    const bRating = getCardAvgRating(b);
                    return bRating - aRating;
                });
                
                return `
                    <div class="backlog-column" data-column-id="${column.id}" draggable="true">
                        <div class="column-header">
                            <div class="flex items-center gap-2">
                                <span class="text-gray-400 cursor-grab">‚†ø</span>
                                <span class="text-white font-semibold text-sm">${column.name}</span>
                                <span class="text-gray-500 text-xs">${columnCards.length}</span>
                            </div>
                            <div class="flex gap-2 items-center">
                                <button onclick="event.stopPropagation(); toggleColumnSort('${column.id}')" class="text-gray-400 hover:text-amber-400 text-sm px-1 flex items-center gap-1" title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —Ä–µ–π—Ç–∏–Ω–≥—É">
                                    ‚≠ê${columnSortState[column.id] === 'asc' ? '‚Üë' : columnSortState[column.id] === 'desc' ? '‚Üì' : '‚Üï'}
                                </button>
                                ${columnSortState[column.id] ? `<button onclick="event.stopPropagation(); resetColumnSort('${column.id}')" class="text-gray-500 hover:text-red-400 text-xs px-1" title="–°–±—Ä–æ—Å–∏—Ç—å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É">‚úï</button>` : ''}
                                <button onclick="event.stopPropagation(); openAddCardModal('${column.id}')" class="text-amber-400 hover:text-amber-300 text-lg px-1">‚ûï</button>
                                <button onclick="event.stopPropagation(); openEditColumnModal('${column.id}')" class="text-gray-400 hover:text-white text-lg px-1">‚ãÆ</button>
                            </div>
                        </div>
                        <div class="column-cards" data-column-id="${column.id}">
                            ${columnCards.map(card => {
                                const avg = getCardAvgRating(card);
                                const ratingsCount = getCardRatingsCount(card);
                                const ratingClass = avg >= 7 ? 'rating-high' : avg >= 5 ? 'rating-medium' : 'rating-low';
                                const ratingsLine = buildCardRatingsLine(card, 2);
                                const avgText = avg ? String(Math.round(avg * 10) / 10).replace(/\.0$/, '') : '';
                                return `
                                    <div class="backlog-card relative" data-card-id="${card.id}" draggable="true" onclick="openEditCardModal('${card.id}')">
                                        <button onclick="event.stopPropagation(); addMovieFromBacklog('${card.id}')" 
                                            class="absolute top-1 right-1 w-6 h-6 bg-purple-600 hover:bg-purple-500 rounded text-white text-xs flex items-center justify-center transition-all hover:scale-110" 
                                            title="–î–æ–±–∞–≤–∏—Ç—å –≤ –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Ñ–∏–ª—å–º">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <rect x="3" y="4" width="18" height="18" rx="2" stroke-width="2"/>
                                                <path d="M3 10h18M8 2v4M16 2v4" stroke-width="2" stroke-linecap="round"/>
                                            </svg>
                                        </button>
                                        <div class="text-white font-medium text-sm mb-1 pr-7">${card.title}</div>
                                        ${card.description ? `<div class="text-gray-400 text-xs mb-2">${card.description}</div>` : ''}

                                        ${ratingsCount > 0 ? `
                                            <div class="text-xs text-gray-400 mb-2 truncate" title="${ratingsLine.full}">
                                                ${ratingsLine.short}
                                            </div>
                                        ` : ''}

                                        <div class="flex items-center gap-2 flex-wrap">
                                            <div class="text-gray-500 text-xs">${card.author}</div>
                                            ${ratingsCount > 0 ? `<span class="rating-badge ${ratingClass}">‚≠ê ${avgText}${ratingsCount > 1 ? ` (${ratingsCount})` : ''}</span>` : ''}
                                            ${card.watchCount > 0 ? `<span class="watch-count">üëÅ ${card.watchCount}</span>` : ''}
                                            ${Object.keys(card.reviews || {}).length > 0 ? `<span class="review-count">üí¨ ${Object.keys(card.reviews || {}).length}</span>` : ''}
                                        </div>
                                    </div>
                                `;
                            }).join('') || '<div class="text-gray-600 text-xs text-center py-4">–ü—É—Å—Ç–æ</div>'}
                        </div>
                    </div>
                `;
            }).join('') + `
                <div class="add-column-btn" onclick="openAddColumnModal()">
                    <span class="text-xl">+</span>
                    <span>–î–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É</span>
                </div>
            `;
            
            setupBacklogDragDrop();
        }

        function setupBacklogDragDrop() {
            let draggedCard = null;
            let draggedColumn = null;
            
            // Card drag
            document.querySelectorAll('.backlog-card').forEach(card => {
                card.addEventListener('dragstart', (e) => {
                    draggedCard = card;
                    card.classList.add('dragging');
                    e.stopPropagation();
                });
                
                card.addEventListener('dragend', () => {
                    card.classList.remove('dragging');
                    draggedCard = null;
                });
            });
            
            // Column drag
            document.querySelectorAll('.backlog-column').forEach(column => {
                column.addEventListener('dragstart', (e) => {
                    if (e.target.classList.contains('backlog-card')) return;
                    draggedColumn = column;
                    column.classList.add('column-dragging');
                });
                
                column.addEventListener('dragend', () => {
                    column.classList.remove('column-dragging');
                    draggedColumn = null;
                });
                
                column.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    if (draggedColumn && draggedColumn !== column) {
                        column.classList.add('drag-over');
                    }
                });
                
                column.addEventListener('dragleave', () => {
                    column.classList.remove('drag-over');
                });
                
                column.addEventListener('drop', (e) => {
                    e.preventDefault();
                    column.classList.remove('drag-over');
                    
                    if (draggedColumn && draggedColumn !== column) {
                        const board = document.getElementById('backlogBoard');
                        const columns = Array.from(board.querySelectorAll('.backlog-column'));
                        const draggedIndex = columns.indexOf(draggedColumn);
                        const targetIndex = columns.indexOf(column);
                        
                        if (draggedIndex < targetIndex) {
                            column.after(draggedColumn);
                        } else {
                            column.before(draggedColumn);
                        }
                        
                        const newOrder = Array.from(board.querySelectorAll('.backlog-column')).map(col => col.dataset.columnId);
                        data.backlog.columns = newOrder.map(id => data.backlog.columns.find(c => c.id === id));
                        saveData();
                    }
                });
            });
            
            // Card drop zones
            document.querySelectorAll('.column-cards').forEach(zone => {
                zone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    if (draggedCard) {
                        zone.parentElement.classList.add('drag-over');
                    }
                });
                
                zone.addEventListener('dragleave', () => {
                    zone.parentElement.classList.remove('drag-over');
                });
                
                zone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    zone.parentElement.classList.remove('drag-over');
                    
                    if (!draggedCard) return;
                    
                    const cardId = draggedCard.dataset.cardId;
                    const newColumnId = zone.dataset.columnId;
                    const card = data.backlog.cards.find(c => c.id === cardId);
                    const oldColumnId = card.columnId;
                    
                    if (card) {
                        card.columnId = newColumnId;
                        
                        const watchedColumn = data.backlog.columns.find(col => col.name === WATCHED_COLUMN_NAME);
                        if (watchedColumn && newColumnId === watchedColumn.id && oldColumnId !== watchedColumn.id) {
                            card.watchCount = (card.watchCount || 0) + 1;
                            // Add watch date to history
                            if (!card.watchHistory) card.watchHistory = [];
                            card.watchHistory.push(Date.now());
                        }
                        
                        saveData();
                    }
                });
            });
        }

        // Column Sort Functions
        function toggleColumnSort(columnId) {
            const currentState = columnSortState[columnId];
            if (!currentState) {
                columnSortState[columnId] = 'desc'; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –æ—Ç –≤—ã—Å–æ–∫–æ–≥–æ –∫ –Ω–∏–∑–∫–æ–º—É
            } else if (currentState === 'desc') {
                columnSortState[columnId] = 'asc';
            } else {
                columnSortState[columnId] = 'desc';
            }
            renderBacklog();
        }
        
        function resetColumnSort(columnId) {
            delete columnSortState[columnId];
            renderBacklog();
        }

        // Column Modals
        function openAddColumnModal() {
            document.getElementById('addColumnModal').classList.remove('hidden');
            document.getElementById('addColumnModal').classList.add('flex');
            document.getElementById('columnNameInput').value = '';
            document.getElementById('columnNameInput').focus();
        }

        function closeAddColumnModal() {
            document.getElementById('addColumnModal').classList.add('hidden');
            document.getElementById('addColumnModal').classList.remove('flex');
        }

        function createColumn() {
            const name = document.getElementById('columnNameInput').value.trim();
            if (!name) return;
            
            const column = {
                id: Date.now().toString(),
                name: name
            };
            
            data.backlog.columns.push(column);
            saveData();
            closeAddColumnModal();
        }

        function openEditColumnModal(columnId) {
            editingColumnId = columnId;
            const column = data.backlog.columns.find(c => c.id === columnId);
            if (column) {
                document.getElementById('editColumnNameInput').value = column.name;
                document.getElementById('editColumnModal').classList.remove('hidden');
                document.getElementById('editColumnModal').classList.add('flex');
                document.getElementById('editColumnNameInput').focus();
            }
        }

        function closeEditColumnModal() {
            document.getElementById('editColumnModal').classList.add('hidden');
            document.getElementById('editColumnModal').classList.remove('flex');
            editingColumnId = null;
        }

        function saveColumnEdit() {
            const name = document.getElementById('editColumnNameInput').value.trim();
            if (!name || !editingColumnId) return;
            
            const column = data.backlog.columns.find(c => c.id === editingColumnId);
            if (column) {
                column.name = name;
                saveData();
                closeEditColumnModal();
            }
        }

        function deleteColumn() {
            if (!editingColumnId) return;
            
            const cardsInColumn = data.backlog.cards.filter(c => c.columnId === editingColumnId);
            if (cardsInColumn.length > 0) {
                if (!confirm(`–í –∫–æ–ª–æ–Ω–∫–µ ${cardsInColumn.length} –∫–∞—Ä—Ç–æ—á–µ–∫. –£–¥–∞–ª–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É –≤–º–µ—Å—Ç–µ —Å –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏?`)) {
                    return;
                }
            }
            
            data.backlog.columns = data.backlog.columns.filter(c => c.id !== editingColumnId);
            data.backlog.cards = data.backlog.cards.filter(c => c.columnId !== editingColumnId);
            saveData();
            closeEditColumnModal();
        }

        // Card Modals
        function openAddCardModal(columnId) {
            currentColumnId = columnId;
            document.getElementById('cardTitleInput').value = '';
            document.getElementById('cardDescInput').value = '';
            document.getElementById('cardRatingInput').value = '';
            document.getElementById('addCardModal').classList.remove('hidden');
            document.getElementById('addCardModal').classList.add('flex');
            document.getElementById('cardTitleInput').focus();
        }

        function closeAddCardModal() {
            document.getElementById('addCardModal').classList.add('hidden');
            document.getElementById('addCardModal').classList.remove('flex');
            currentColumnId = null;
        }

        function createCard() {
            const title = document.getElementById('cardTitleInput').value.trim();
            const description = document.getElementById('cardDescInput').value.trim();
            const rating = parseFloat(document.getElementById('cardRatingInput').value) || 0;
            const userName = getUserName();
            
            if (!title) {
                alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ñ–∏–ª—å–º–∞!');
                return;
            }
            
            // Check if movie exists in Watched
            const existingCard = data.backlog.cards.find(card => 
                card.title.toLowerCase() === title.toLowerCase()
            );
            
            if (existingCard) {
                const watchedColumn = data.backlog.columns.find(col => col.name === WATCHED_COLUMN_NAME);
                const newColumn = data.backlog.columns.find(col => col.name === NEW_COLUMN_NAME);
                
                if (watchedColumn && existingCard.columnId === watchedColumn.id && newColumn) {
                    existingCard.columnId = newColumn.id;
                    saveData();
                    closeAddCardModal();
                    return;
                }
            }
            
            const card = {
                id: Date.now().toString(),
                columnId: currentColumnId,
                title: title,
                description: description,
                // Per-user ratings (each user can rate). Keep legacy `rating` as avg for sorting/badges.
                ratings: rating > 0 ? { [userName]: rating } : {},
                rating: rating > 0 ? rating : 0,
                author: userName,
                watchCount: 0,
                timestamp: Date.now()
            };
            
            data.backlog.cards.push(card);
            saveData();
            closeAddCardModal();
        }

        function openEditCardModal(cardId) {
            editingCardId = cardId;
            const card = data.backlog.cards.find(c => c.id === cardId);
            if (card) {
                const userName = getUserName();
                const myRating = (card.ratings && card.ratings[userName] != null)
                    ? card.ratings[userName]
                    : ((card.author === userName) ? (parseFloat(card.rating) || '') : '');

                document.getElementById('editCardTitleInput').value = card.title;
                document.getElementById('editCardDescInput').value = card.description || '';
                // This field now represents *my* rating for this movie.
                document.getElementById('editCardRatingInput').value = (myRating === 0 ? '' : (myRating ?? ''));
                
                // Load watch history
                renderWatchHistory(card);

                // Load ratings summary
                renderCardRatings(card);
                
                // Load reviews
                renderCardReviews(card);
                
                document.getElementById('editCardModal').classList.remove('hidden');
                document.getElementById('editCardModal').classList.add('flex');
            }
        }
        
        function renderWatchHistory(card) {
            const watchHistory = card.watchHistory || [];
            const watchHistorySection = document.getElementById('watchHistorySection');
            const watchHistoryList = document.getElementById('watchHistoryList');
            
            if (watchHistory.length === 0) {
                watchHistorySection.classList.add('hidden');
                return;
            }
            
            watchHistorySection.classList.remove('hidden');
            watchHistoryList.innerHTML = watchHistory.map((timestamp, index) => {
                const date = new Date(timestamp);
                return `
                    <div class="flex items-center gap-2 text-xs">
                        <span class="text-green-400 font-bold">${index + 1}.</span>
                        <span class="text-gray-300">${date.toLocaleDateString('ru-RU', { 
                            day: 'numeric', 
                            month: 'long', 
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        })}</span>
                    </div>
                `;
            }).join('');
        }

        function renderCardRatings(card) {
            const avgEl = document.getElementById('cardAvgRating');
            const cntEl = document.getElementById('cardRatingsCount');
            const listEl = document.getElementById('cardRatingsList');
            if (!avgEl || !cntEl || !listEl) return;

            // Ensure ratings object exists and seed legacy rating if needed
            if (!card.ratings || typeof card.ratings !== 'object') card.ratings = {};
            const legacy = parseFloat(card.rating) || 0;
            if (legacy > 0 && card.author && card.ratings[card.author] == null) {
                card.ratings[card.author] = legacy;
            }

            const entries = Object.entries(card.ratings || {})
                .map(([n, r]) => [n, parseFloat(r) || 0])
                .filter(([, r]) => r > 0);
            entries.sort((a, b) => collator.compare(a[0], b[0]));

            const avg = entries.length ? (entries.reduce((s, [, r]) => s + r, 0) / entries.length) : 0;
            avgEl.textContent = avg ? String(Math.round(avg * 10) / 10).replace(/\.0$/, '') : '‚Äî';
            cntEl.textContent = String(entries.length);

            if (!entries.length) {
                listEl.innerHTML = '<div class="text-gray-500 italic">–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ü–µ–Ω–æ–∫‚Ä¶</div>';
                return;
            }

            listEl.innerHTML = entries.map(([name, rating]) => {
                const rr = String(Math.round(rating * 10) / 10).replace(/\.0$/, '');
                return `<div class="flex items-center justify-between gap-2"><span class="text-gray-300 truncate">${name}</span><span class="text-amber-300 font-bold">${rr}</span></div>`;
            }).join('');
        }
        
        function renderCardReviews(card) {
            const userName = getUserName();
            const reviews = card.reviews || {};
            const reviewsList = document.getElementById('cardReviewsList');
            const reviewInputSection = document.getElementById('reviewInputSection');
            const reviewInput = document.getElementById('cardReviewInput');
            const deleteReviewBtn = document.getElementById('deleteReviewBtn');
            const userHasReview = reviews[userName] !== undefined;
            
            // Show existing reviews
            if (Object.keys(reviews).length === 0) {
                reviewsList.innerHTML = '<p class="text-gray-500 text-xs italic">–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤...</p>';
            } else {
                reviewsList.innerHTML = Object.entries(reviews).map(([author, review]) => `
                    <div class="bg-gray-800/50 rounded-lg p-2 border border-gray-700/50 relative">
                        <div class="flex justify-between items-start mb-1">
                            <span class="text-blue-400 text-xs font-semibold">${author}</span>
                            <div class="flex items-center gap-2">
                                <span class="text-gray-600 text-xs">${new Date(review.timestamp).toLocaleDateString('ru-RU')}</span>
                                ${author === userName ? `<button onclick="editReview()" class="text-gray-400 hover:text-blue-400 transition" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>` : ''}
                            </div>
                        </div>
                        <p class="text-gray-300 text-xs">${review.text}</p>
                    </div>
                `).join('');
            }
            
            // Get outside delete button
            const deleteReviewBtnOutside = document.getElementById('deleteReviewBtnOutside');
            
            // Hide input section if user already has a review
            if (userHasReview) {
                reviewInputSection.classList.add('hidden');
                deleteReviewBtn.classList.add('hidden');
                deleteReviewBtnOutside.classList.remove('hidden');
            } else {
                reviewInputSection.classList.remove('hidden');
                deleteReviewBtn.classList.add('hidden');
                deleteReviewBtnOutside.classList.add('hidden');
            }
            // Always clear input after render
            reviewInput.value = '';
        }
        
        function editReview() {
            const userName = getUserName();
            const card = data.backlog.cards.find(c => c.id === editingCardId);
            if (!card || !card.reviews || !card.reviews[userName]) return;
            
            const reviewInputSection = document.getElementById('reviewInputSection');
            const reviewInput = document.getElementById('cardReviewInput');
            const deleteReviewBtn = document.getElementById('deleteReviewBtn');
            const deleteReviewBtnOutside = document.getElementById('deleteReviewBtnOutside');
            
            // Show input section and fill with current review text
            reviewInputSection.classList.remove('hidden');
            reviewInput.value = card.reviews[userName].text;
            deleteReviewBtn.classList.remove('hidden');
            deleteReviewBtnOutside.classList.add('hidden');
            reviewInput.focus();
        }
        
        function saveCardReview() {
            if (!editingCardId) return;
            const userName = getUserName();
            const reviewInput = document.getElementById('cardReviewInput');
            const reviewText = reviewInput.value.trim();
            
            if (!reviewText) {
                alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –æ—Ç–∑—ã–≤–∞!');
                return;
            }
            
            const card = data.backlog.cards.find(c => c.id === editingCardId);
            if (card) {
                if (!card.reviews) card.reviews = {};
                card.reviews[userName] = {
                    text: reviewText,
                    timestamp: Date.now()
                };
                saveData();
                renderCardReviews(card);
                reviewInput.value = '';
            }
        }
        
        function deleteCardReview() {
            if (!editingCardId) return;
            const userName = getUserName();
            
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –≤–∞—à –æ—Ç–∑—ã–≤?')) return;
            
            const card = data.backlog.cards.find(c => c.id === editingCardId);
            if (card && card.reviews && card.reviews[userName]) {
                delete card.reviews[userName];
                saveData();
                renderCardReviews(card);
            }
        }

        function closeEditCardModal() {
            document.getElementById('editCardModal').classList.add('hidden');
            document.getElementById('editCardModal').classList.remove('flex');
            editingCardId = null;
        }

        function saveCardEdit() {
            const title = document.getElementById('editCardTitleInput').value.trim();
            const description = document.getElementById('editCardDescInput').value.trim();
            const myRating = parseFloat(document.getElementById('editCardRatingInput').value) || 0;
            const userName = getUserName();
            
            if (!title || !editingCardId) return;
            
            const card = data.backlog.cards.find(c => c.id === editingCardId);
            if (card) {
                card.title = title;
                card.description = description;

                // Ensure per-user ratings object exists
                if (!card.ratings || typeof card.ratings !== 'object') card.ratings = {};

                // Seed legacy rating into per-user ratings once (keeps old data)
                const legacy = parseFloat(card.rating) || 0;
                if (legacy > 0 && card.author && card.ratings[card.author] == null) {
                    card.ratings[card.author] = legacy;
                }

                // Set/remove my rating
                if (myRating > 0) {
                    card.ratings[userName] = myRating;
                } else {
                    delete card.ratings[userName];
                }

                // Recalculate avg rating (kept in legacy `card.rating` for sorting/badges)
                const vals = Object.values(card.ratings || {}).map(v => parseFloat(v) || 0).filter(v => v > 0);
                const avg = vals.length ? (vals.reduce((s, v) => s + v, 0) / vals.length) : 0;
                card.rating = avg ? Math.round(avg * 10) / 10 : 0;

                saveData();
                closeEditCardModal();
            }
        }

        function deleteCard() {
            if (!editingCardId) return;
            
            if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ñ–∏–ª—å–º?')) {
                data.backlog.cards = data.backlog.cards.filter(c => c.id !== editingCardId);
                saveData();
                closeEditCardModal();
            }
        }

        // Add movie from backlog to selected date's movie suggestions
        function addMovieFromBacklog(cardId) {
            const card = data.backlog.cards.find(c => c.id === cardId);
            if (!card) return;
            
            // Check if date is selected
            if (!selectedDate) {
                alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ!');
                return;
            }
            
            const userName = getUserName();
            const title = card.title;
            
            // Check if movie already exists in the event's movie list
            const event = getEvent(selectedDate);
            if (!event.movies) event.movies = {};
            
            const existingMovieEntry = Object.entries(event.movies).find(([, m]) => (m.title || '').toLowerCase() === title.toLowerCase());
            if (existingMovieEntry) {
                alert('–≠—Ç–æ—Ç —Ñ–∏–ª—å–º —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Å–ø–∏—Å–æ–∫ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π!');
                return;
            }
            
            // Add movie to event
            const movieId = Date.now().toString();
            event.movies[movieId] = {
                title: title,
                author: userName,
                votes: { [userName]: true },
                timestamp: Date.now()
            };
            
            setEvent(selectedDate, event);
            
            // Show confirmation
            alert(`–§–∏–ª—å–º "${title}" –¥–æ–±–∞–≤–ª–µ–Ω –≤ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –¥–ª—è ${formatDateDisplay(selectedDate)}`);
        }

        // -----------------------------
        // Custom selects (Beer section)
        // -----------------------------
        let _beerSelectsEnhanced = false;

        function getChevronSVG() {
            return `
                <svg class="cs-chevron" viewBox="0 0 20 20" fill="none" aria-hidden="true">
                    <path d="M5 7l5 6 5-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            `.trim();
        }

        function closeAllCustomSelects(exceptEl = null) {
            document.querySelectorAll('.cs.open').forEach(cs => {
                if (exceptEl && cs === exceptEl) return;
                cs.classList.remove('open');
            });
        }

        function syncCustomSelect(selectEl) {
            const cs = selectEl?.closest('.cs');
            if (!cs) return;
            const label = cs.querySelector('.cs-label');
            const menu = cs.querySelector('.cs-menu');
            const selected = selectEl.options[selectEl.selectedIndex];
            if (label) label.textContent = (selected ? selected.textContent : '').trim();
            if (menu) {
                const val = String(selectEl.value);
                menu.querySelectorAll('.cs-opt').forEach(btn => {
                    btn.setAttribute('aria-selected', String(btn.dataset.value) === val ? 'true' : 'false');
                });
            }
        }

        function makeCustomSelect(selectEl) {
            if (!selectEl) return;
            if (selectEl.closest('.cs')) {
                syncCustomSelect(selectEl);
                return;
            }

            const cs = document.createElement('div');
            cs.className = 'cs';

            // Move select into wrapper
            selectEl.parentNode.insertBefore(cs, selectEl);
            cs.appendChild(selectEl);

            // Button
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'cs-btn';
            btn.setAttribute('aria-haspopup', 'listbox');
            btn.innerHTML = `
                <span class="cs-label"></span>
                ${getChevronSVG()}
            `;
            cs.appendChild(btn);

            // Menu
            const menu = document.createElement('div');
            menu.className = 'cs-menu';
            menu.setAttribute('role', 'listbox');

            // Options
            Array.from(selectEl.options).forEach(opt => {
                const item = document.createElement('button');
                item.type = 'button';
                item.className = 'cs-opt';
                item.dataset.value = opt.value;
                item.setAttribute('role', 'option');
                item.textContent = opt.textContent;
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    selectEl.value = opt.value;
                    selectEl.dispatchEvent(new Event('change', { bubbles: true }));
                    syncCustomSelect(selectEl);
                    cs.classList.remove('open');
                });
                menu.appendChild(item);
            });
            cs.appendChild(menu);

            btn.addEventListener('click', (e) => {
                e.preventDefault();
                const willOpen = !cs.classList.contains('open');
                closeAllCustomSelects(cs);
                cs.classList.toggle('open', willOpen);
                syncCustomSelect(selectEl);
            });

            // Keep in sync on value changes
            selectEl.addEventListener('change', () => syncCustomSelect(selectEl));
            syncCustomSelect(selectEl);
        }

        function enhanceBeerSelects() {
            const targets = document.querySelectorAll('#beerFiltersPanel select, #addBeerModal select, #editBeerModal select');
            targets.forEach(makeCustomSelect);

            if (_beerSelectsEnhanced) return;
            _beerSelectsEnhanced = true;

            // Close on outside click
            document.addEventListener('click', (e) => {
                const cs = e.target.closest('.cs');
                if (!cs) closeAllCustomSelects();
            });

            // Close on ESC
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeAllCustomSelects();
            });
        }

        function syncBeerSelects() {
            document.querySelectorAll('#beerFiltersPanel select, #addBeerModal select, #editBeerModal select').forEach(syncCustomSelect);
        }

        // Beer Rating Methods
        function toggleBeerFilters() {
            const panel = document.getElementById('beerFiltersPanel');
            panel.classList.toggle('hidden');
            // ensure custom selects are applied and in sync
            enhanceBeerSelects();
            syncBeerSelects();
        }

        // -----------------
        // Beer table columns (customize)
        // -----------------
        function getDefaultBeerColumnsVisible() {
            const vis = {};
            BEER_COLUMNS.forEach(c => {
                vis[c.key] = c.required ? true : true;
            });
            return vis;
        }

        function loadBeerColumnsVisible() {
            try {
                const raw = localStorage.getItem(BEER_COLS_LS_KEY);
                if (!raw) return getDefaultBeerColumnsVisible();
                const parsed = JSON.parse(raw);
                const vis = getDefaultBeerColumnsVisible();
                Object.keys(vis).forEach(k => {
                    if (typeof parsed[k] === 'boolean') vis[k] = parsed[k];
                });
                // enforce required
                BEER_COLUMNS.forEach(c => { if (c.required) vis[c.key] = true; });
                return vis;
            } catch (_) {
                return getDefaultBeerColumnsVisible();
            }
        }

        function applyBeerColumnsVisibility() {
            const vis = beerColumnsVisible || getDefaultBeerColumnsVisible();

            // headers
            const thMap = {
                name: document.querySelector('th[onclick="sortBeerBy(\'name\')"]'),
                type: document.querySelector('th[onclick="sortBeerBy(\'type\')"]'),
                style: document.querySelector('th[onclick="sortBeerBy(\'style\')"]'),
                filtered: document.querySelector('th[onclick="sortBeerBy(\'filtered\')"]'),
                country: document.querySelector('th[onclick="sortBeerBy(\'country\')"]'),
                volume: document.querySelector('th[onclick="sortBeerBy(\'volume\')"]'),
                alcohol: document.querySelector('th[onclick="sortBeerBy(\'alcohol\')"]'),
                rating: document.querySelector('th[onclick="sortBeerBy(\'rating\')"]'),
                actions: document.querySelector('#beerTable thead th:last-child')
            };
            Object.entries(thMap).forEach(([k, el]) => {
                if (!el) return;
                el.style.display = vis[k] ? '' : 'none';
            });

            // body cells (by nth-child) ‚Äî depends on fixed column order
            // order: name(1), type(2), style(3), filtered(4), country(5), volume(6), alcohol(7), rating(8), actions(9)
            const idx = { name: 1, type: 2, style: 3, filtered: 4, country: 5, volume: 6, alcohol: 7, rating: 8, actions: 9 };
            document.querySelectorAll('#beerTableBody tr').forEach(tr => {
                Object.keys(idx).forEach(k => {
                    const td = tr.children[idx[k] - 1];
                    if (td) td.style.display = vis[k] ? '' : 'none';
                });
            });
        }

        function openBeerColumnsModal() {
            if (!beerColumnsVisible) beerColumnsVisible = loadBeerColumnsVisible();
            const list = document.getElementById('beerColumnsList');
            if (!list) return;

            list.innerHTML = BEER_COLUMNS.filter(c => !c.required).map(c => {
                const checked = beerColumnsVisible[c.key] !== false;
                return `
                    <label class="flex items-center gap-3 text-sm text-gray-200">
                        <input type="checkbox" class="accent-amber-500" data-col="${c.key}" ${checked ? 'checked' : ''}>
                        <span>${c.label}</span>
                    </label>
                `;
            }).join('');

            const modal = document.getElementById('beerColumnsModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeBeerColumnsModal() {
            const modal = document.getElementById('beerColumnsModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function saveBeerColumns() {
            const list = document.getElementById('beerColumnsList');
            if (!list) return;

            const vis = loadBeerColumnsVisible();
            list.querySelectorAll('input[type="checkbox"][data-col]').forEach(cb => {
                const k = cb.getAttribute('data-col');
                vis[k] = !!cb.checked;
            });
            // enforce required
            BEER_COLUMNS.forEach(c => { if (c.required) vis[c.key] = true; });

            beerColumnsVisible = vis;
            try { localStorage.setItem(BEER_COLS_LS_KEY, JSON.stringify(vis)); } catch (_) {}

            closeBeerColumnsModal();
            // re-render so empty state colspan correct too
            renderBeerRating();
        }

        function resetBeerColumns() {
            beerColumnsVisible = getDefaultBeerColumnsVisible();
            try { localStorage.removeItem(BEER_COLS_LS_KEY); } catch (_) {}
            // refresh modal UI
            openBeerColumnsModal();
            renderBeerRating();
        }

        function resetBeerFilters() {
            beerFilters = {
                type: '',
                style: '',
                filtered: '',
                country: '',
                volume: '',
                alcoholMin: '',
                alcoholMax: '',
                ratingMin: '',
                ratingMax: ''
            };
            beerSearchQuery = '';
            const searchEl = document.getElementById('beerSearchInput');
            if (searchEl) searchEl.value = '';

            document.getElementById('beerFilterType').value = '';
            document.getElementById('beerFilterStyle').value = '';
            document.getElementById('beerFilterFiltered').value = '';
            document.getElementById('beerFilterCountry').value = '';
            document.getElementById('beerFilterVolume').value = '';
            document.getElementById('beerFilterAlcoholMin').value = '';
            document.getElementById('beerFilterAlcoholMax').value = '';
            document.getElementById('beerFilterRatingMin').value = '';
            document.getElementById('beerFilterRatingMax').value = '';
            renderBeerRating();
        }

        function setBeerSearch(q) {
            beerSearchQuery = (q || '').toString().trim().toLowerCase();
            renderBeerRating();
        }

        function applyBeerFiltersFromUI() {
            beerFilters.type = document.getElementById('beerFilterType').value;
            beerFilters.style = document.getElementById('beerFilterStyle').value;
            beerFilters.filtered = document.getElementById('beerFilterFiltered').value;
            beerFilters.country = document.getElementById('beerFilterCountry').value;
            beerFilters.volume = document.getElementById('beerFilterVolume').value;
            beerFilters.alcoholMin = document.getElementById('beerFilterAlcoholMin').value;
            beerFilters.alcoholMax = document.getElementById('beerFilterAlcoholMax').value;
            beerFilters.ratingMin = document.getElementById('beerFilterRatingMin').value;
            beerFilters.ratingMax = document.getElementById('beerFilterRatingMax').value;
            // –µ—Å–ª–∏ –µ—Å—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã/–ø–æ–∏—Å–∫ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–±—Ä–æ—Å —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ –ø–∞–Ω–µ–ª–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
            renderBeerRating();
        }

        function sortBeerBy(sortType) {
            if (beerSortBy === sortType) {
                beerSortDirection = beerSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                beerSortBy = sortType;
                beerSortDirection = 'asc';
            }
            renderBeerRating();
        }

        function renderBeerRating() {
            const tbody = document.getElementById('beerTableBody');
            if (!beerColumnsVisible) beerColumnsVisible = loadBeerColumnsVisible();
            const allBeers = data.beerRating || [];
            let beers = allBeers;
            
            // Normalize countries to a uniform flag+name representation
            beers.forEach(b => { b.country = formatCountry(b.country); });
            
            // Apply filters
            beers = beers.filter(beer => {
                // search by name
                if (beerSearchQuery) {
                    const nm = (beer.name || '').toString().toLowerCase();
                    if (!nm.includes(beerSearchQuery)) return false;
                }
                // type
                if (beerFilters.type && beer.type !== beerFilters.type) return false;
                // style
                if (beerFilters.style && beer.style !== beerFilters.style) return false;
                // filtered
                if (beerFilters.filtered && beer.filtered !== beerFilters.filtered) return false;
                // country (normalize for comparison)
                if (beerFilters.country && getCountryNameForSelect(beer.country) !== beerFilters.country) return false;
                // volume
                if (beerFilters.volume && String(beer.volume) !== String(beerFilters.volume)) return false;
                // alcohol
                const alcoholVal = parseFloat(beer.alcohol) || 0;
                if (beerFilters.alcoholMin && alcoholVal < parseFloat(beerFilters.alcoholMin)) return false;
                if (beerFilters.alcoholMax && alcoholVal > parseFloat(beerFilters.alcoholMax)) return false;
                // rating
                const ratings = Object.values(beer.ratings || {});
                const avgRating = ratings.length ? ratings.reduce((s, r) => s + r, 0) / ratings.length : 0;
                if (beerFilters.ratingMin && avgRating < parseFloat(beerFilters.ratingMin)) return false;
                if (beerFilters.ratingMax && avgRating > parseFloat(beerFilters.ratingMax)) return false;
                return true;
            });

            // Update beer count badge
            const badge = document.getElementById('beerCountBadge');
            if (badge) {
                const shown = beers.length;
                const total = allBeers.length;
                badge.textContent = shown === total ? `–ü–∏–≤–∞: ${shown}` : `–ü–∏–≤–∞: ${shown} –∏–∑ ${total}`;
            }
            
            // Update headers
            ['name', 'type', 'style', 'filtered', 'country', 'volume', 'alcohol', 'rating'].forEach(field => {
                const span = document.getElementById(`sort-${field}`);
                const th = span.parentElement;
                if (beerSortBy === field) {
                    span.textContent = beerSortDirection === 'asc' ? '‚Üë' : '‚Üì';
                    th.classList.add('active');
                } else {
                    span.textContent = '‚Üï';
                    th.classList.remove('active');
                }
            });
            
            // Sort beers
            const sortedBeers = [...beers].sort((a, b) => {
                let aVal, bVal;

                switch(beerSortBy) {
                    case 'name': {
                        const aName = (a.name || '').trim();
                        const bName = (b.name || '').trim();
                        const aLatin = isLatin(aName);
                        const bLatin = isLatin(bName);
                        if (aLatin !== bLatin) return beerSortDirection === 'asc' ? (aLatin ? -1 : 1) : (aLatin ? 1 : -1);
                        const cmp = collator.compare(aName, bName);
                        return beerSortDirection === 'asc' ? cmp : -cmp;
                    }
                    case 'type':
                        aVal = a.type || '';
                        bVal = b.type || '';
                        break;
                    case 'style':
                        aVal = a.style || '';
                        bVal = b.style || '';
                        break;
                    case 'filtered':
                        aVal = a.filtered || '';
                        bVal = b.filtered || '';
                        break;
                    case 'country':
                        aVal = normalizeCountryCode(a.country);
                        bVal = normalizeCountryCode(b.country);
                        break;
                    case 'volume':
                        aVal = parseFloat(a.volume) || 0;
                        bVal = parseFloat(b.volume) || 0;
                        break;
                    case 'alcohol':
                        aVal = parseFloat(a.alcohol) || 0;
                        bVal = parseFloat(b.alcohol) || 0;
                        break;
                    case 'rating':
                        const aRatings = Object.values(a.ratings || {});
                        const bRatings = Object.values(b.ratings || {});
                        aVal = aRatings.length ? aRatings.reduce((sum, r) => sum + r, 0) / aRatings.length : 0;
                        bVal = bRatings.length ? bRatings.reduce((sum, r) => sum + r, 0) / bRatings.length : 0;
                        break;
                    default:
                        return 0;
                }

                if (typeof aVal === 'string') {
                    const cmp = collator.compare(aVal, bVal);
                    return beerSortDirection === 'asc' ? cmp : -cmp;
                }
                return beerSortDirection === 'asc' ? aVal - bVal : bVal - aVal;
            });
            
            const visibleCount = (() => {
                const vis = beerColumnsVisible || loadBeerColumnsVisible();
                // count visible columns in fixed order
                const keys = ['name','type','style','filtered','country','volume','alcohol','rating','actions'];
                return keys.reduce((c, k) => c + (vis[k] ? 1 : 0), 0);
            })();

            if (sortedBeers.length === 0) {
                const msg = beerSearchQuery ? '–¢–∞–∫–æ–µ –ø–∏–≤–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ' : '–ü–æ–∫–∞ –Ω–µ—Ç –ø–∏–≤–∞ –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ';
                tbody.innerHTML = `<tr><td colspan="${visibleCount}" class="text-center text-gray-600 py-8">${msg}</td></tr>`;
                // also keep header in sync
                applyBeerColumnsVisibility();
                return;
            }
            
            const userName = getUserName();
            
            tbody.innerHTML = sortedBeers.map(beer => {
                const ratings = Object.entries(beer.ratings || {});
                const avgRating = ratings.length > 0 
                    ? (ratings.reduce((sum, [, r]) => sum + r, 0) / ratings.length).toFixed(1)
                    : '‚Äî';
                const userRating = beer.ratings && beer.ratings[userName];
                const isAuthor = beer.author === userName;
                
                return `
                    <tr class="border-b border-gray-800 beer-row">
                        <td class="py-3 px-4">
                            <div class="font-medium text-white">${beer.name}</div>
                            ${ratings.length > 0 ? `<div class="text-xs text-gray-500 mt-1">${ratings.map(([name, rating]) => `${name}: ${rating}`).join(', ')}</div>` : ''}
                        </td>
                        <td class="py-3 px-4">
                            <span class="beer-type-${beer.type === '–°–≤–µ—Ç–ª–æ–µ' ? 'light' : 'dark'} px-2 py-1 rounded text-xs font-bold">
                                ${beer.type}
                            </span>
                        </td>
                        <td class="py-3 px-4 text-gray-400">${beer.style || '‚Äî'}</td>
                        <td class="py-3 px-4 text-gray-400">${beer.filtered}</td>
                        <td class="py-3 px-4 text-gray-400">${formatCountry(beer.country)}</td>
                        <td class="py-3 px-4 text-gray-400">${beer.volume}</td>
                        <td class="py-3 px-4 text-gray-400">${beer.alcohol}%</td>
                        <td class="py-3 px-4">
                            <div class="text-amber-400 font-bold">${avgRating}</div>
                            <div class="text-xs text-gray-500">${ratings.length} ${ratings.length === 1 ? '–æ—Ü–µ–Ω–∫–∞' : '–æ—Ü–µ–Ω–æ–∫'}</div>
                        </td>
                        <td class="py-3 px-4">
                            <div class="flex gap-2 justify-center">
                                <button onclick="event.stopPropagation(); openRateBeerModal('${beer.id}')" class="text-amber-400 hover:text-amber-300 text-xl" title="–û—Ü–µ–Ω–∏—Ç—å">
                                    ${userRating ? '‚≠ê' : '‚òÜ'}
                                </button>
                                ${isAuthor ? `<button onclick="event.stopPropagation(); openEditBeerModal('${beer.id}')" class="text-blue-400 hover:text-blue-300" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>` : ''}
                                ${isAuthor ? `<button onclick="event.stopPropagation(); openDeleteBeerModal('${beer.id}')" class="text-red-400 hover:text-red-300" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            // Apply column visibility after rendering
            applyBeerColumnsVisibility();
        }

        function openAddBeerModal() {
            document.getElementById('addBeerModal').classList.remove('hidden');
            document.getElementById('addBeerModal').classList.add('flex');
            document.getElementById('beerNameInput').value = '';
            document.getElementById('beerAlcoholInput').value = '';
            // default style
            const styleSel = document.getElementById('beerStyleInput');
            if (styleSel) styleSel.value = 'Lager';

            // ensure custom selects are applied and in sync
            enhanceBeerSelects();
            syncBeerSelects();
        }

        function closeAddBeerModal() {
            document.getElementById('addBeerModal').classList.add('hidden');
            document.getElementById('addBeerModal').classList.remove('flex');
        }

        function addBeer() {
            const name = document.getElementById('beerNameInput').value.trim();
            const type = document.getElementById('beerTypeInput').value;
            const style = document.getElementById('beerStyleInput').value;
            const filtered = document.getElementById('beerFilteredInput').value;
            const country = document.getElementById('beerCountryInput').value;
            const volume = document.getElementById('beerVolumeInput').value;
            const alcohol = document.getElementById('beerAlcoholInput').value.trim();
            const userName = getUserName();
            
            if (!name || !alcohol || !userName) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!');
                return;
            }
            
            const beer = {
                id: Date.now().toString(),
                name, type, style, filtered, country, volume, alcohol,
                author: userName,
                ratings: {},
                timestamp: Date.now()
            };
            
            data.beerRating.push(beer);
            saveData();
            closeAddBeerModal();
        }

        function openRateBeerModal(beerId) {
            currentBeerIdForRating = beerId;
            const beer = data.beerRating.find(b => String(b.id) === String(beerId));
            if (!beer) return;

            document.getElementById('rateBeerName').textContent = beer.name;
            document.getElementById('rateBeerModal').classList.remove('hidden');
            document.getElementById('rateBeerModal').classList.add('flex');

            const userName = getUserName();
            const userRating = beer.ratings && beer.ratings[userName];

            // Ensure picker renders every time modal opens
            requestAnimationFrame(() => initBeerStarPicker(userRating));
        }

        function closeRateBeerModal() {
            document.getElementById('rateBeerModal').classList.add('hidden');
            document.getElementById('rateBeerModal').classList.remove('flex');
            currentBeerIdForRating = null;
        }

        function rateBeer(rating) {
            // Guard against duplicate calls (e.g. swipe "end" firing after a click already saved and closed the modal)
            if (!currentBeerIdForRating) return;

            const userName = getUserName();
            if (!userName) {
                alert('–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã');
                return;
            }
            
            const beer = data.beerRating.find(b => String(b.id) === String(currentBeerIdForRating));
            if (beer) {
                if (!beer.ratings) beer.ratings = {};
                beer.ratings[userName] = rating;
                saveData();
                closeRateBeerModal();
            }
        }

        function openEditBeerModal(beerId) {
            editingBeerId = beerId;
            const beer = data.beerRating.find(b => String(b.id) === String(beerId));
            if (!beer) {
                console.warn('Beer not found for edit', beerId);
                return;
            }
            document.getElementById('editBeerNameInput').value = beer.name || '';
            document.getElementById('editBeerTypeInput').value = beer.type || '–°–≤–µ—Ç–ª–æ–µ';
            document.getElementById('editBeerStyleInput').value = beer.style || 'Lager';
            document.getElementById('editBeerFilteredInput').value = beer.filtered || '–§–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω–æ–µ';
            document.getElementById('editBeerCountryInput').value = getCountryNameForSelect(beer.country);
            document.getElementById('editBeerVolumeInput').value = beer.volume || '0.5';
            document.getElementById('editBeerAlcoholInput').value = beer.alcohol || '';
            document.getElementById('editBeerModal').classList.remove('hidden');
            document.getElementById('editBeerModal').classList.add('flex');

            // ensure custom selects are applied and in sync
            enhanceBeerSelects();
            syncBeerSelects();
        }

        function closeEditBeerModal() {
            document.getElementById('editBeerModal').classList.add('hidden');
            document.getElementById('editBeerModal').classList.remove('flex');
            editingBeerId = null;
        }

        function saveBeerEdit() {
            const name = document.getElementById('editBeerNameInput').value.trim();
            const type = document.getElementById('editBeerTypeInput').value;
            const style = document.getElementById('editBeerStyleInput').value;
            const filtered = document.getElementById('editBeerFilteredInput').value;
            const country = document.getElementById('editBeerCountryInput').value;
            const volume = document.getElementById('editBeerVolumeInput').value;
            const alcohol = document.getElementById('editBeerAlcoholInput').value.trim();
            
            if (!name || !alcohol || !editingBeerId) return;
            
            const beer = data.beerRating.find(b => String(b.id) === String(editingBeerId));
            if (beer) {
                beer.name = name;
                beer.type = type;
                beer.style = style;
                beer.filtered = filtered;
                beer.country = country;
                beer.volume = volume;
                beer.alcohol = alcohol;
                saveData();
                closeEditBeerModal();
            }
        }

        function openDeleteBeerModal(beerId) {
            pendingDeleteBeerId = String(beerId);
            const beer = data.beerRating.find(b => String(b.id) === String(beerId));
            const nameEl = document.getElementById('deleteBeerName');
            if (nameEl) nameEl.textContent = beer ? beer.name : '';

            const modal = document.getElementById('deleteBeerModal');
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }
        }

        function closeDeleteBeerModal() {
            const modal = document.getElementById('deleteBeerModal');
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
            pendingDeleteBeerId = null;
        }

        function confirmDeleteBeer() {
            if (!pendingDeleteBeerId) return;
            const id = pendingDeleteBeerId;
            data.beerRating = (data.beerRating || []).filter(b => String(b.id) !== String(id));
            saveData();
            closeDeleteBeerModal();
        }

        // Half-star picker (0.5 step) for beer rating
        const STAR_MAX = 10;
        let beerStarHoverValue = null;

        function getStarSVG() {
            return `
                <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                    <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
                </svg>
            `.trim();
        }

        function initBeerStarPicker(currentValue) {
            const picker = document.getElementById('beerStarPicker');
            const valueEl = document.getElementById('rateBeerValue');
            if (!picker || !valueEl) return;

            const val = (typeof currentValue === 'number') ? currentValue : (parseFloat(currentValue) || 0);
            valueEl.textContent = val ? val.toFixed(1).replace(/\.0$/, '') : '‚Äî';

            picker.innerHTML = '';
            beerStarHoverValue = null;

            for (let i = 1; i <= STAR_MAX; i++) {
                const unit = document.createElement('div');
                unit.className = 'star-unit';
                unit.dataset.star = String(i);

                unit.innerHTML = `
                    <div class="star-base">${getStarSVG()}</div>
                    <div class="star-fill">${getStarSVG()}</div>
                    <div class="star-dim">${getStarSVG()}</div>
                    <div class="star-hit left" data-val="${(i - 0.5).toFixed(1)}"></div>
                    <div class="star-hit right" data-val="${i.toFixed(1)}"></div>
                `;

                // Hover preview
                unit.querySelectorAll('.star-hit').forEach(hit => {
                    hit.addEventListener('mouseenter', () => {
                        const v = parseFloat(hit.dataset.val);
                        beerStarHoverValue = v;
                        applyBeerStarVisual(v, true);
                        valueEl.textContent = v.toFixed(1).replace(/\.0$/, '');
                    });
                    hit.addEventListener('click', () => {
                        const v = parseFloat(hit.dataset.val);
                        rateBeer(v);
                    });
                });

                picker.appendChild(unit);
            }

            // Use property handler to avoid stacking listeners across modal openings
            picker.onmouseleave = () => {
                beerStarHoverValue = null;
                const fixed = val;
                applyBeerStarVisual(fixed, false);
                valueEl.textContent = fixed ? fixed.toFixed(1).replace(/\.0$/, '') : '‚Äî';
            };

            applyBeerStarVisual(val, false);
            bindBeerStarPickerSwipe(val);
        }

        function applyBeerStarVisual(value, isHover) {
            const v = parseFloat(value) || 0;
            document.querySelectorAll('#beerStarPicker .star-unit').forEach(unit => {
                const i = parseInt(unit.dataset.star, 10);
                const fillEl = unit.querySelector('.star-fill');
                const dimEl = unit.querySelector('.star-dim');

                // Determine fill for each star: 0, 50, 100
                let fill = 0;
                if (v >= i) fill = 100;
                else if (v >= i - 0.5) fill = 50;

                fillEl.style.width = fill + '%';

                // Extra dimming only for hover-preview:
                // - if rating ends with .5 => dim the remaining half of that star
                // - dim fully the remaining stars after the hovered value
                if (isHover) {
                    if (fill === 50) {
                        dimEl.style.width = '50%';
                        dimEl.style.left = '50%';
                    } else if (fill === 0) {
                        dimEl.style.width = '100%';
                        dimEl.style.left = '0%';
                    } else {
                        dimEl.style.width = '0%';
                        dimEl.style.left = '0%';
                    }
                } else {
                    dimEl.style.width = '0%';
                    dimEl.style.left = '0%';
                }
            });
        }

        // Swipe/drag rating (mobile friendly)
        function getBeerRatingFromPointerEvent(evt) {
            const picker = document.getElementById('beerStarPicker');
            if (!picker) return 0;
            const rect = picker.getBoundingClientRect();

            const clientX = (evt.touches && evt.touches[0]) ? evt.touches[0].clientX : evt.clientX;
            const x = Math.max(0, Math.min(rect.width, clientX - rect.left));

            const units = Array.from(picker.querySelectorAll('.star-unit'));
            if (!units.length) return 0;

            // find closest unit by x center
            let closest = units[0];
            let closestDist = Infinity;
            for (const u of units) {
                const r = u.getBoundingClientRect();
                const center = (r.left + r.right) / 2;
                const dist = Math.abs(clientX - center);
                if (dist < closestDist) {
                    closestDist = dist;
                    closest = u;
                }
            }

            const cr = closest.getBoundingClientRect();
            const isRightHalf = clientX >= (cr.left + cr.width / 2);
            const star = parseInt(closest.dataset.star, 10);
            const v = isRightHalf ? star : (star - 0.5);
            return Math.max(0.5, Math.min(STAR_MAX, v));
        }

        function bindBeerStarPickerSwipe(baseValue) {
            const picker = document.getElementById('beerStarPicker');
            const valueEl = document.getElementById('rateBeerValue');
            if (!picker || !valueEl) return;

            // Enable swipe/drag only on touch/coarse-pointer devices to avoid double-trigger on desktop.
            const isCoarse = (window.matchMedia && window.matchMedia('(pointer: coarse)').matches) || ('ontouchstart' in window);

            let isDragging = false;
            let lastV = null;

            const preview = (evt) => {
                const v = getBeerRatingFromPointerEvent(evt);
                if (!v) return;
                lastV = v;
                applyBeerStarVisual(v, true);
                valueEl.textContent = v.toFixed(1).replace(/\.0$/, '');
            };

            const start = (evt) => {
                isDragging = true;
                picker.classList.add('select-none');
                preview(evt);
                evt.preventDefault?.();
            };

            const move = (evt) => {
                if (!isDragging) return;
                preview(evt);
                evt.preventDefault?.();
            };

            const end = () => {
                if (!isDragging) return;
                isDragging = false;
                picker.classList.remove('select-none');
                if (lastV != null) rateBeer(lastV);
            };

            // remove previous handlers to avoid stacking
            picker.onpointerdown = null;
            picker.onpointermove = null;
            picker.onpointerup = null;
            picker.onpointercancel = null;
            picker.ontouchstart = null;
            picker.ontouchmove = null;
            picker.ontouchend = null;
            picker.ontouchcancel = null;

            if (isCoarse) {
                picker.onpointerdown = start;
                picker.onpointermove = move;
                picker.onpointerup = end;
                picker.onpointercancel = end;

                // iOS Safari sometimes prefers touch events
                picker.ontouchstart = (e) => start(e);
                picker.ontouchmove = (e) => move(e);
                picker.ontouchend = () => end();
                picker.ontouchcancel = () => end();
            }

            // keep existing mouseleave behavior (restore fixed value)
            picker.onmouseleave = () => {
                if (isDragging) return;
                const fixed = baseValue;
                applyBeerStarVisual(fixed, false);
                valueEl.textContent = fixed ? fixed.toFixed(1).replace(/\.0$/, '') : '‚Äî';
            };
        }

        // -----------------
        // Chat UI + Firebase
        // -----------------
        function toggleChat(force = null) {
            const panel = document.getElementById('chatPanel');
            if (!panel) return;
            chatOpen = (force === null) ? !chatOpen : !!force;

            panel.classList.toggle('open', chatOpen);
            panel.setAttribute('aria-hidden', chatOpen ? 'false' : 'true');

            // mark html for layout tweaks (scroll-to-top button position)
            document.documentElement.classList.toggle('chat-open', chatOpen);

            if (chatOpen) {
                initChatOnce();
                requestAnimationFrame(() => {
                    const inp = document.getElementById('chatInput');
                    inp && inp.focus();
                    scrollChatToBottom(true);
                });
            } else {
                // stop typing when closing
                try { setTyping(false); } catch(_) {}
                cancelChatEdit();
            }
        }

        function initChatOnce() {
            if (chatInitialized) return;
            chatInitialized = true;

            const inp = document.getElementById('chatInput');
            const sendBtn = document.getElementById('chatSendBtn');
            if (inp) {
                inp.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendChatMessage();
                    }
                });

                const updateOverflow = () => {
                    // show scrollbar only if content exceeds max height
                    const needs = inp.scrollHeight > 112;
                    inp.classList.toggle('scroll', needs);
                };

                // autosize + typing indicator
                const resize = () => {
                    inp.style.height = 'auto';
                    inp.style.height = Math.min(inp.scrollHeight, 112) + 'px';
                    updateOverflow();
                };

                inp.addEventListener('input', () => {
                    resize();
                    markTyping();
                });
                inp.addEventListener('focus', () => markTyping());
                inp.addEventListener('blur', () => setTyping(false));

                resize();
            }

            // Subscribe to Firebase chat
            if (useFirebase && db) {
                const ref = db.ref(CHAT_PATH).limitToLast(250);
                const cb = (snap) => {
                    const raw = snap.val() || {};
                    const messages = Array.isArray(raw) ? raw : Object.values(raw);
                    renderChatMessages(messages);
                };
                ref.on('value', cb);
                chatUnsubscribe = () => ref.off('value', cb);

                // typing
                const tRef = db.ref(CHAT_TYPING_PATH);
                const tCb = (snap) => {
                    const raw = snap.val() || {};
                    renderTypingIndicator(raw);
                };
                tRef.on('value', tCb);
                chatTypingUnsub = () => tRef.off('value', tCb);
            } else {
                // fallback local
                const raw = localStorage.getItem('chatMessagesLocal');
                const messages = raw ? JSON.parse(raw) : [];
                renderChatMessages(messages);
            }
        }

        function formatDayHeader(ts) {
            const d = new Date(ts);
            return d.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long', year: 'numeric' });
        }

        function sameDay(aTs, bTs) {
            const a = new Date(aTs);
            const b = new Date(bTs);
            return a.getFullYear() === b.getFullYear() && a.getMonth() === b.getMonth() && a.getDate() === b.getDate();
        }

        function renderChatMessages(messages) {
            const box = document.getElementById('chatMessages');
            if (!box) return;

            // detect if user is near bottom
            const nearBottom = (box.scrollTop + box.clientHeight) >= (box.scrollHeight - 80);

            const safe = (s) => String(s || '')
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#39;');

            const me = getUserName();
            const sorted = (messages || [])
                .filter(m => m && (m.text || '').trim())
                .sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));

            let html = '';
            let prevTs = null;
            for (const m of sorted) {
                const mine = m.author === me;
                const t = new Date(m.timestamp || Date.now());
                const time = t.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });

                if (!prevTs || !sameDay(prevTs, m.timestamp || 0)) {
                    html += `<div class="text-center text-[11px] text-gray-500 py-2">${safe(formatDayHeader(m.timestamp || Date.now()))}</div>`;
                }
                prevTs = m.timestamp || 0;

                const canEdit = mine;
                html += `
                    <div class="flex ${mine ? 'justify-end' : 'justify-start'}" data-msg="${safe(m.id)}">
                        <div class="max-w-[88%] rounded-2xl px-3 py-2 border ${mine ? 'bg-amber-500/15 border-amber-500/25' : 'bg-white/5 border-white/10'}">
                            <div class="flex items-start justify-between gap-2">
                                <div class="min-w-0">
                                    <div class="text-xs ${mine ? 'text-amber-200' : 'text-gray-300'} font-semibold truncate">${safe(m.author || '‚Äî')}</div>
                                    <div class="text-sm text-white whitespace-pre-wrap break-words mt-1">${safe(m.text)}</div>
                                </div>
                                <div class="flex flex-col items-end gap-1 flex-shrink-0">
                                    <div class="text-[10px] text-gray-500">${time}</div>
                                    ${canEdit ? `
                                        <div class="flex items-center gap-1">
                                            <button class="text-gray-400 hover:text-amber-300 transition text-[12px]" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" onclick="event.preventDefault(); event.stopPropagation(); startChatEdit('${safe(m.id)}')">‚úèÔ∏è</button>
                                            <button class="text-gray-400 hover:text-red-300 transition text-[12px]" title="–£–¥–∞–ª–∏—Ç—å" onclick="event.preventDefault(); event.stopPropagation(); openDeleteChatModal('${safe(m.id)}')">üóëÔ∏è</button>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            box.innerHTML = html || `<div class="text-center text-gray-500 text-sm py-6">–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π‚Ä¶</div>`;

            if (chatOpen && (nearBottom || sorted.length < 10)) {
                scrollChatToBottom(true);
            }
        }

        function scrollChatToBottom(smooth) {
            const box = document.getElementById('chatMessages');
            if (!box) return;
            try {
                box.scrollTo({ top: box.scrollHeight, behavior: smooth ? 'smooth' : 'auto' });
            } catch (_) {
                box.scrollTop = box.scrollHeight;
            }
        }

        function getMyChatKey() {
            // stable key for typing indicator (avoid spaces)
            const u = (currentUser && currentUser.username) ? currentUser.username : (getUserName() || 'me');
            return String(u).toLowerCase().replace(/[^a-z0-9_-]+/g, '_').slice(0, 40);
        }

        function markTyping() {
            if (!chatOpen) return;
            setTyping(true);
            if (chatTypingTimer) clearTimeout(chatTypingTimer);
            chatTypingTimer = setTimeout(() => setTyping(false), 1800);
        }

        function setTyping(isTyping) {
            if (!(useFirebase && db)) return;
            try {
                const key = getMyChatKey();
                if (!key) return;
                const ref = db.ref(`${CHAT_TYPING_PATH}/${key}`);
                if (isTyping) {
                    ref.set({ name: getUserName(), ts: Date.now() });
                } else {
                    ref.remove();
                }
            } catch (_) {}
        }

        function renderTypingIndicator(raw) {
            const el = document.getElementById('typingIndicator');
            if (!el) return;
            const meKey = getMyChatKey();
            const now = Date.now();
            const arr = Object.entries(raw || {})
                .filter(([k, v]) => k !== meKey && v && v.name && (now - (v.ts || 0) < 3500))
                .map(([, v]) => v.name);
            if (!arr.length) {
                el.classList.add('hidden');
                el.textContent = '';
                return;
            }
            const names = arr.slice(0, 3).join(', ');
            const more = arr.length > 3 ? ` –∏ –µ—â—ë ${arr.length - 3}` : '';
            el.textContent = `${names}${more} –ø–µ—á–∞—Ç–∞–µ—Ç‚Ä¶`;
            el.classList.remove('hidden');
        }

        function startChatEdit(id) {
            if (!id) return;
            chatEditId = id;
            const box = document.getElementById('chatMessages');
            const node = box?.querySelector(`[data-msg="${CSS.escape(id)}"] .text-sm`);
            const currentText = node ? node.textContent : '';
            const inp = document.getElementById('chatInput');
            const sendBtn = document.getElementById('chatSendBtn');
            if (inp) {
                inp.value = currentText;
                inp.focus();
                inp.dispatchEvent(new Event('input'));
            }
            if (sendBtn) sendBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
        }

        function cancelChatEdit() {
            chatEditId = null;
            const inp = document.getElementById('chatInput');
            const sendBtn = document.getElementById('chatSendBtn');
            if (inp) {
                inp.value = '';
                inp.dispatchEvent(new Event('input'));
            }
            if (sendBtn) sendBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å';
        }

        function openDeleteChatModal(id) {
            pendingDeleteChatId = id;
            const preview = document.getElementById('deleteChatPreview');
            const box = document.getElementById('chatMessages');
            const node = box?.querySelector(`[data-msg="${CSS.escape(id)}"] .text-sm`);
            if (preview) preview.textContent = node ? node.textContent : '';
            const modal = document.getElementById('deleteChatModal');
            modal?.classList.remove('hidden');
            modal?.classList.add('flex');
        }

        function closeDeleteChatModal() {
            const modal = document.getElementById('deleteChatModal');
            modal?.classList.add('hidden');
            modal?.classList.remove('flex');
            pendingDeleteChatId = null;
        }

        function confirmDeleteChatMessage() {
            const id = pendingDeleteChatId;
            if (!id) return;
            if (useFirebase && db) {
                db.ref(`${CHAT_PATH}/${id}`).remove();
            }
            closeDeleteChatModal();
        }

        function sendChatMessage() {
            const inp = document.getElementById('chatInput');
            if (!inp) return;
            const text = (inp.value || '').trim();
            if (!text) return;

            const author = getUserName();
            if (!author) return;

            const now = Date.now();

            // edit existing
            if (chatEditId) {
                const id = chatEditId;
                if (useFirebase && db) {
                    db.ref(`${CHAT_PATH}/${id}`).transaction((m) => {
                        if (!m) return m;
                        if (m.author !== author) return m;
                        m.text = text;
                        m.editedAt = now;
                        return m;
                    });
                }
                cancelChatEdit();
                setTyping(false);
                return;
            }

            const msg = {
                id: now.toString(),
                author,
                text,
                timestamp: now
            };

            // Optimistic clear
            inp.value = '';
            inp.dispatchEvent(new Event('input'));
            setTyping(false);

            if (useFirebase && db) {
                db.ref(`${CHAT_PATH}/${msg.id}`).set(msg);
            } else {
                const raw = localStorage.getItem('chatMessagesLocal');
                const arr = raw ? JSON.parse(raw) : [];
                arr.push(msg);
                localStorage.setItem('chatMessagesLocal', JSON.stringify(arr));
                renderChatMessages(arr);
            }

            requestAnimationFrame(() => scrollChatToBottom(true));
        }

        // Keyboard handlers
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeAddColumnModal();
                closeEditColumnModal();
                closeAddCardModal();
                closeEditCardModal();
                closeAddBeerModal();
                closeRateBeerModal();
                closeEditBeerModal();
                closeDeleteBeerModal();
                closeBeerColumnsModal();
                closeDeleteChatModal();
                // chat
                if (chatOpen) toggleChat(false);
            }
            if (e.key === 'Enter') {
                if (document.getElementById('addColumnModal').classList.contains('flex')) createColumn();
                if (document.getElementById('editColumnModal').classList.contains('flex')) saveColumnEdit();
                if (document.getElementById('addCardModal').classList.contains('flex')) createCard();
                if (document.getElementById('editCardModal').classList.contains('flex')) saveCardEdit();
                if (document.getElementById('addBeerModal').classList.contains('flex')) addBeer();
                if (document.getElementById('editBeerModal').classList.contains('flex')) saveBeerEdit();
            }
        });

        document.getElementById('movieInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addMovie();
        });
        document.getElementById('movieInput').addEventListener('blur', () => {
            // auto-trim on blur
            const inp = document.getElementById('movieInput');
            inp.value = inp.value.trim();
        });

        // Scroll functions
        function scrollToSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (section) {
                section.scrollIntoView({ behavior: 'smooth' });
            }
        }

        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Show/hide scroll to top button
        window.addEventListener('scroll', () => {
            const scrollTopBtn = document.getElementById('scrollTopBtn');
            const calendarSection = document.getElementById('calendarSection');
            
            if (calendarSection) {
                const calendarRect = calendarSection.getBoundingClientRect();
                const calendarBottom = calendarRect.bottom;
                
                if (calendarBottom < 0) {
                    scrollTopBtn.style.opacity = '1';
                    scrollTopBtn.style.visibility = 'visible';
                } else {
                    scrollTopBtn.style.opacity = '0';
                    scrollTopBtn.style.visibility = 'hidden';
                }
            }
        });
    </script>
</body>
</html>