<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Среда: кино и пиво</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
</head>
<body class="min-h-screen bg-slate-950 text-slate-100 flex items-center justify-center">
  <div class="w-full max-w-6xl px-4 py-8 md:py-12">
    <header class="mb-8 flex flex-col md:flex-row md:items-end md:justify-between gap-4">
      <div>
        <h1 class="text-3xl md:text-4xl font-bold tracking-tight">
          Среда. Кино &amp; Пиво
        </h1>
        <p class="text-slate-300 mt-2 max-w-xl text-sm md:text-base">
          Сайт вашей компании друзей: выбирайте среду, предлагайте фильм, голосуйте и отмечайтесь, кто приходит.
        </p>
      </div>
      <div class="text-sm md:text-right text-slate-300">
        <p>
          Встречаемся каждую
          <span class="font-semibold text-amber-300">среду вечером</span>.
        </p>
        <p id="todayLabel" class="mt-1 opacity-80"></p>
      </div>
    </header>
    <main class="grid gap-6 lg:grid-cols-[minmax(0,1.1fr)_minmax(0,1fr)] items-start">
      <!-- Календарь -->
      <section class="bg-slate-900/70 rounded-2xl border border-slate-800 shadow-lg shadow-slate-900/40 p-4 md:p-6">
        <div class="flex items-center justify-between mb-4 gap-3">
          <div>
            <h2 class="text-lg font-semibold flex items-center gap-2">
              Календарь сред
              <span class="inline-flex items-center text-[11px] px-2 py-0.5 rounded-full bg-indigo-500/15 text-indigo-200 border border-indigo-500/40">
                выбираются только среды
              </span>
            </h2>
            <p class="text-xs text-slate-400 mt-1">
              Кликни по доступной среде, чтобы выбрать фильм и подтвердить участие.
            </p>
          </div>
          <div class="inline-flex items-stretch rounded-full border border-slate-700 bg-slate-800/80 overflow-hidden text-xs">
            <button id="prevMonthBtn" type="button" class="px-3 py-1.5 border-r border-slate-700 hover:bg-slate-700/70 transition-colors">
              ←
            </button>
            <div id="currentMonthLabel" class="px-3 py-1.5 font-medium text-slate-100"></div>
            <button id="nextMonthBtn" type="button" class="px-3 py-1.5 border-l border-slate-700 hover:bg-slate-700/70 transition-colors">
              →
            </button>
          </div>
        </div>
        <div class="grid grid-cols-7 text-center text-[11px] md:text-xs uppercase tracking-wide text-slate-400 mb-2">
          <div>Пн</div>
          <div>Вт</div>
          <div>Ср</div>
          <div>Чт</div>
          <div>Пт</div>
          <div>Сб</div>
          <div>Вс</div>
        </div>
        <div id="calendarGrid" class="grid grid-cols-7 gap-1.5 md:gap-2 auto-rows-[70px] md:auto-rows-[90px]"></div>
        <div class="mt-3 flex items-center justify-between text-[11px] text-slate-400">
          <div class="flex items-center gap-2">
            <span class="inline-flex items-center gap-1">
              <span class="inline-block w-3 h-3 rounded-full bg-indigo-500/80"></span>
              <span>активные среды</span>
            </span>
            <span class="inline-flex items-center gap-1">
              <span class="inline-block w-3 h-3 rounded-full bg-emerald-400"></span>
              <span>есть предложения / участники</span>
            </span>
          </div>
          <span class="hidden md:inline">Все данные хранятся локально в твоём браузере.</span>
        </div>
      </section>
      <!-- Панель деталей выбранной среды -->
      <section id="detailsPanel" class="bg-slate-900/70 rounded-2xl border border-slate-800 shadow-lg shadow-slate-900/40 p-4 md:p-6">
        <div class="flex items-center justify-between gap-3 mb-4">
          <div class="min-w-0">
            <h2 class="text-lg font-semibold truncate">Вечер среды</h2>
            <p id="selectedDateLabel" class="text-sm text-slate-300 mt-1">
              Сначала выбери среду в календаре слева.
            </p>
          </div>
        </div>
        <div id="noDatePlaceholder" class="mt-6 text-sm text-slate-400 border border-dashed border-slate-700 rounded-xl px-4 py-8 text-center flex flex-col items-center justify-center gap-2">
          <p class="font-medium text-slate-200">Дата ещё не выбрана</p>
          <p>Нажми на доступную среду в календаре — после этого появятся формы выбора фильма и подтверждения участия.</p>
        </div>
        <div id="detailsContent" class="mt-2 space-y-6 hidden">
          <!-- Выбор фильма и голосование -->
          <section class="space-y-3">
            <div class="flex items-center justify-between gap-2">
              <h3 class="text-sm font-semibold uppercase tracking-wide text-slate-300">Фильм недели</h3>
              <span id="winningMovieBadge" class="text-[11px] text-emerald-300 font-medium hidden">
                Лидер голосования
              </span>
            </div>
            <form id="movieForm" class="flex flex-col sm:flex-row gap-2 text-sm">
              <div class="flex-1">
                <input
                  id="movieTitle"
                  type="text"
                  class="w-full rounded-xl border border-slate-700 bg-slate-900/80 px-3 py-2 text-sm placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/70 focus:border-indigo-500/70"
                  placeholder="Предложи фильм (название / режиссёр / год)"
                  autocomplete="off"
                />
              </div>
              <button
                type="submit"
                class="shrink-0 inline-flex items-center justify-center rounded-xl bg-indigo-500 hover:bg-indigo-400 px-3 py-2 text-xs font-semibold text-white transition-colors"
              >
                Добавить в список
              </button>
            </form>
            <div id="movieList" class="space-y-2 max-h-56 overflow-y-auto pr-1 text-sm"></div>
          </section>
          <!-- Участники -->
          <section class="border-t border-slate-800 pt-4 mt-2 space-y-3">
            <div class="flex items-center justify-between gap-2">
              <h3 class="text-sm font-semibold uppercase tracking-wide text-slate-300">Кто идёт</h3>
              <p id="attendanceStats" class="text-[11px] text-slate-400"></p>
            </div>
            <form id="attendanceForm" class="space-y-3 text-sm">
              <div>
                <label for="participantName" class="block text-xs font-medium text-slate-300 mb-1">Имя или ник</label>
                <input
                  id="participantName"
                  type="text"
                  class="w-full rounded-xl border border-slate-700 bg-slate-900/80 px-3 py-2 text-sm placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-emerald-500/70 focus:border-emerald-500/70"
                  placeholder="Например: Ваня, Лиса, Hobbit88"
                  autocomplete="off"
                />
                <p id="nameError" class="text-[11px] text-rose-400 mt-1 hidden">Укажи хотя бы имя или ник.</p>
              </div>
              <div class="flex flex-wrap gap-3 items-center">
                <span class="text-xs text-slate-400">Статус:</span>
                <label class="inline-flex items-center gap-2 text-xs">
                  <input type="radio" name="status" value="yes" class="accent-emerald-500" checked />
                  <span>Приду</span>
                </label>
                <label class="inline-flex items-center gap-2 text-xs">
                  <input type="radio" name="status" value="no" class="accent-rose-500" />
                  <span>Не смогу</span>
                </label>
              </div>
              <div>
                <label for="comment" class="block text-xs font-medium text-slate-300 mb-1">Комментарий (опционально)</label>
                <input
                  id="comment"
                  type="text"
                  class="w-full rounded-xl border border-slate-700 bg-slate-900/80 px-3 py-2 text-sm placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-slate-500/70 focus:border-slate-500/70"
                  placeholder="Во сколько будешь? Что возьмёшь? Любимый сорт пива?"
                  autocomplete="off"
                />
              </div>
              <button
                type="submit"
                class="inline-flex items-center justify-center rounded-xl bg-emerald-500 hover:bg-emerald-400 px-3 py-2 text-xs font-semibold text-emerald-950 transition-colors"
              >
                Подтвердить участие
              </button>
            </form>
            <div id="attendanceList" class="space-y-2 max-h-40 overflow-y-auto pr-1 text-sm"></div>
          </section>
        </div>
      </section>
    </main>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      'use strict';
      const STORAGE_KEY_DATA = 'movieNightData';
      const STORAGE_KEY_VOTES = 'movieNightVotes';
      const STORAGE_KEY_LAST_DATE = 'movieNightLastDate';
      const MONTHS_NOMINATIVE = [
        'Январь',
        'Февраль',
        'Март',
        'Апрель',
        'Май',
        'Июнь',
        'Июль',
        'Август',
        'Сентябрь',
        'Октябрь',
        'Ноябрь',
        'Декабрь'
      ];
      const MONTHS_GENITIVE = [
        'января',
        'февраля',
        'марта',
        'апреля',
        'мая',
        'июня',
        'июля',
        'августа',
        'сентября',
        'октября',
        'ноября',
        'декабря'
      ];
      const WEEKDAYS_NOMINATIVE = [
        'Воскресенье',
        'Понедельник',
        'Вторник',
        'Среда',
        'Четверг',
        'Пятница',
        'Суббота'
      ];
      const appState = {
        data: {},
        selectedDate: null,
        currentYear: null,
        currentMonth: null
      };
      const calendarGrid = document.getElementById('calendarGrid');
      const currentMonthLabel = document.getElementById('currentMonthLabel');
      const prevMonthBtn = document.getElementById('prevMonthBtn');
      const nextMonthBtn = document.getElementById('nextMonthBtn');
      const todayLabel = document.getElementById('todayLabel');
      const detailsContent = document.getElementById('detailsContent');
      const noDatePlaceholder = document.getElementById('noDatePlaceholder');
      const selectedDateLabel = document.getElementById('selectedDateLabel');
      const movieForm = document.getElementById('movieForm');
      const movieTitleInput = document.getElementById('movieTitle');
      const movieListEl = document.getElementById('movieList');
      const winningMovieBadge = document.getElementById('winningMovieBadge');
      const attendanceForm = document.getElementById('attendanceForm');
      const participantNameInput = document.getElementById('participantName');
      const nameError = document.getElementById('nameError');
      const commentInput = document.getElementById('comment');
      const attendanceListEl = document.getElementById('attendanceList');
      const attendanceStats = document.getElementById('attendanceStats');
      function safeParse(json, fallback) {
        try {
          return json ? JSON.parse(json) : fallback;
        } catch (e) {
          return fallback;
        }
      }
      function loadState() {
        const rawData = localStorage.getItem(STORAGE_KEY_DATA);
        appState.data = safeParse(rawData, {}) || {};
        const lastDate = localStorage.getItem(STORAGE_KEY_LAST_DATE);
        if (lastDate) {
          appState.selectedDate = lastDate;
        }
      }
      function saveState() {
        try {
          localStorage.setItem(STORAGE_KEY_DATA, JSON.stringify(appState.data));
          if (appState.selectedDate) {
            localStorage.setItem(STORAGE_KEY_LAST_DATE, appState.selectedDate);
          }
        } catch (e) {
          // Если localStorage недоступен, просто игнорируем ошибку.
        }
      }
      function loadVotes() {
        const rawVotes = localStorage.getItem(STORAGE_KEY_VOTES);
        return safeParse(rawVotes, {}) || {};
      }
      function saveVotes(votes) {
        try {
          localStorage.setItem(STORAGE_KEY_VOTES, JSON.stringify(votes));
        } catch (e) {
          // игнорируем
        }
      }
      function generateId() {
        return (
          Date.now().toString(36) + Math.random().toString(36).slice(2, 8)
        );
      }
      function escapeHtml(str) {
        return String(str).replace(/[&<>"']/g, function (ch) {
          const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
          };
          return map[ch] || ch;
        });
      }
      function isSameDate(a, b) {
        return (
          a.getFullYear() === b.getFullYear() &&
          a.getMonth() === b.getMonth() &&
          a.getDate() === b.getDate()
        );
      }
      function createDefaultMovies() {
        return [
          { id: generateId(), title: 'Большой Лебовски (1998)', votes: 0 },
          { id: generateId(), title: 'Криминальное чтиво (1994)', votes: 0 },
          { id: generateId(), title: 'Бойцовский клуб (1999)', votes: 0 }
        ];
      }
      function ensureDateData(dateKey) {
        if (!appState.data[dateKey]) {
          appState.data[dateKey] = {
            movies: createDefaultMovies(),
            attendees: []
          };
          saveState();
        } else {
          if (!Array.isArray(appState.data[dateKey].movies)) {
            appState.data[dateKey].movies = [];
          }
          if (!Array.isArray(appState.data[dateKey].attendees)) {
            appState.data[dateKey].attendees = [];
          }
        }
        return appState.data[dateKey];
      }
      function formatFriendlyDate(dateStr) {
        const date = new Date(dateStr + 'T12:00:00');
        if (Number.isNaN(date.getTime())) return dateStr;
        const day = date.getDate();
        const monthIndex = date.getMonth();
        const year = date.getFullYear();
        const weekdayIndex = date.getDay();
        const weekday = WEEKDAYS_NOMINATIVE[weekdayIndex] || '';
        const monthName = MONTHS_GENITIVE[monthIndex] || '';
        return weekday + ', ' + day + ' ' + monthName + ' ' + year;
      }
      function updateTodayLabel() {
        const now = new Date();
        const day = now.getDate();
        const monthIndex = now.getMonth();
        const year = now.getFullYear();
        const weekdayIndex = now.getDay();
        const weekday = WEEKDAYS_NOMINATIVE[weekdayIndex] || '';
        const monthName = MONTHS_GENITIVE[monthIndex] || '';
        let text = 'Сегодня: ' + weekday + ', ' + day + ' ' + monthName + ' ' + year;
        if (weekdayIndex === 3) {
          text += ' — как раз среда, самое время выбрать фильм!';
        } else {
          const diffToWed = (3 - weekdayIndex + 7) % 7 || 7;
          const nextWed = new Date(now);
          nextWed.setDate(now.getDate() + diffToWed);
          const d = nextWed.getDate();
          const mName = MONTHS_GENITIVE[nextWed.getMonth()] || '';
          text += ' · Ближайшая среда: ' + d + ' ' + mName + '.';
        }
        todayLabel.textContent = text;
      }
      function renderCalendar() {
        currentMonthLabel.textContent =
          (MONTHS_NOMINATIVE[appState.currentMonth] || '') +
          ' ' +
          appState.currentYear;
        calendarGrid.innerHTML = '';
        const firstDay = new Date(appState.currentYear, appState.currentMonth, 1);
        const lastDay = new Date(appState.currentYear, appState.currentMonth + 1, 0);
        let startWeekDay = firstDay.getDay();
        if (startWeekDay === 0) startWeekDay = 7; // воскресенье -> 7
        const leadingBlanks = startWeekDay - 1; // понедельник как первый столбец
        for (let i = 0; i < leadingBlanks; i++) {
          const emptyCell = document.createElement('div');
          calendarGrid.appendChild(emptyCell);
        }
        const today = new Date();
        for (let day = 1; day <= lastDay.getDate(); day++) {
          const dateObj = new Date(appState.currentYear, appState.currentMonth, day);
          const dateKey = dateObj.toISOString().split('T')[0];
          const weekDay = dateObj.getDay(); // 0-6, 3 = среда
          const cell = document.createElement('button');
          cell.type = 'button';
          cell.className =
            'relative flex flex-col items-center justify-center rounded-xl border border-slate-800/80 bg-slate-900/60 text-xs md:text-sm px-1 py-1.5 text-slate-300 transition-colors';
          const isTodayFlag = isSameDate(dateObj, today);
          const dayNumberEl = document.createElement('div');
          dayNumberEl.textContent = day;
          dayNumberEl.className = 'font-medium';
          const subLabel = document.createElement('div');
          subLabel.className =
            'mt-0.5 text-[10px] uppercase tracking-wide text-slate-500';
          if (weekDay === 3) {
            cell.classList.add(
              'hover:border-indigo-400/80',
              'hover:bg-indigo-500/10',
              'cursor-pointer',
              'text-indigo-100',
              'bg-indigo-900/40'
            );
            cell.dataset.date = dateKey;
            const dateData = appState.data[dateKey];
            if (
              dateData &&
              ((Array.isArray(dateData.movies) && dateData.movies.length > 0) ||
                (Array.isArray(dateData.attendees) &&
                  dateData.attendees.length > 0))
            ) {
              const dot = document.createElement('span');
              dot.className =
                'absolute top-1 right-1 w-1.5 h-1.5 rounded-full bg-emerald-400';
              cell.appendChild(dot);
            }
            subLabel.textContent = 'среда';
            cell.addEventListener('click', function () {
              selectDate(dateKey);
            });
          } else {
            cell.classList.add(
              'opacity-40',
              'cursor-not-allowed',
              'bg-slate-900/20'
            );
            if (isTodayFlag) {
              subLabel.textContent = 'сегодня';
            }
          }
          if (isTodayFlag) {
            dayNumberEl.classList.add('text-amber-300');
          }
          if (appState.selectedDate === dateKey) {
            cell.classList.add(
              'ring-2',
              'ring-indigo-400',
              'ring-offset-2',
              'ring-offset-slate-900'
            );
          }
          cell.appendChild(dayNumberEl);
          cell.appendChild(subLabel);
          calendarGrid.appendChild(cell);
        }
      }
      function renderMovieList(dateKey) {
        const dateData = ensureDateData(dateKey);
        const movies = Array.isArray(dateData.movies)
          ? dateData.movies.slice()
          : [];
        movieListEl.innerHTML = '';
        if (!movies.length) {
          const empty = document.createElement('p');
          empty.className = 'text-xs text-slate-400';
          empty.textContent = 'Пока нет фильмов на эту среду. Добавь первый вариант!';
          movieListEl.appendChild(empty);
          winningMovieBadge.classList.add('hidden');
          return;
        }
        movies.sort(function (a, b) {
          const diff = (b.votes || 0) - (a.votes || 0);
          if (diff !== 0) return diff;
          return String(a.title || '').localeCompare(String(b.title || ''));
        });
        const topVotes = movies[0].votes || 0;
        if (topVotes > 0) {
          winningMovieBadge.classList.remove('hidden');
        } else {
          winningMovieBadge.classList.add('hidden');
        }
        movies.forEach(function (movie) {
          const row = document.createElement('div');
          row.className =
            'flex items-center justify-between gap-2 rounded-xl border border-slate-800 bg-slate-800/60 px-3 py-2 hover:border-indigo-500/70 transition-colors';
          const left = document.createElement('div');
          left.className = 'min-w-0';
          const titleEl = document.createElement('div');
          titleEl.className = 'font-medium text-sm truncate';
          titleEl.innerHTML = escapeHtml(movie.title || 'Без названия');
          left.appendChild(titleEl);
          const subtitle = document.createElement('div');
          subtitle.className = 'text-[11px] text-slate-400 mt-0.5';
          subtitle.textContent = 'Голоса: ' + (movie.votes || 0);
          left.appendChild(subtitle);
          const right = document.createElement('div');
          right.className = 'flex items-center gap-2 shrink-0';
          const counter = document.createElement('div');
          counter.className =
            'px-2 py-1 rounded-full bg-slate-900/70 text-xs font-semibold flex items-center gap-1';
          const dot = document.createElement('span');
          dot.className =
            'w-1.5 h-1.5 rounded-full ' +
            (movie.votes === topVotes && topVotes > 0
              ? 'bg-emerald-400'
              : 'bg-slate-500');
          const votesText = document.createElement('span');
          votesText.textContent = movie.votes || 0;
          counter.appendChild(dot);
          counter.appendChild(votesText);
          const voteBtn = document.createElement('button');
          voteBtn.type = 'button';
          voteBtn.className =
            'text-xs px-2.5 py-1 rounded-full bg-indigo-500 hover:bg-indigo-400 text-white font-medium transition-colors';
          voteBtn.textContent = 'Голосовать';
          voteBtn.addEventListener('click', function () {
            handleVote(dateKey, movie.id);
          });
          right.appendChild(counter);
          right.appendChild(voteBtn);
          row.appendChild(left);
          row.appendChild(right);
          movieListEl.appendChild(row);
        });
      }
      function renderAttendanceList(dateKey) {
        const dateData = ensureDateData(dateKey);
        const attendees = Array.isArray(dateData.attendees)
          ? dateData.attendees.slice()
          : [];
        attendanceListEl.innerHTML = '';
        if (!attendees.length) {
          const empty = document.createElement('p');
          empty.className = 'text-xs text-slate-400';
          empty.textContent =
            'Пока никто не отметился. Будь первым, кто подтвердит участие!';
          attendanceListEl.appendChild(empty);
          attendanceStats.textContent = '';
          return;
        }
        let yesCount = 0;
        let noCount = 0;
        attendees.forEach(function (p) {
          if (p.status === 'yes') yesCount++;
          else if (p.status === 'no') noCount++;
        });
        attendanceStats.textContent =
          'Придут: ' + yesCount + ' · Не смогут: ' + noCount;
        attendees
          .slice()
          .reverse()
          .forEach(function (p) {
            const row = document.createElement('div');
            row.className =
              'flex items-start justify-between gap-2 rounded-xl border border-slate-800 bg-slate-800/60 px-3 py-2';
            const left = document.createElement('div');
            left.className = 'min-w-0';
            const nameEl = document.createElement('div');
            nameEl.className = 'font-medium text-sm truncate';
            nameEl.textContent = p.name || 'Аноним';
            left.appendChild(nameEl);
            const subtitle = document.createElement('div');
            subtitle.className = 'text-[11px] text-slate-400 mt-0.5';
            subtitle.textContent =
              p.status === 'yes'
                ? 'Идёт на встречу'
                : 'В этот раз не сможет придти';
            left.appendChild(subtitle);
            if (p.comment) {
              const commentEl = document.createElement('div');
              commentEl.className = 'mt-1 text-[11px] text-slate-300 italic';
              commentEl.textContent = '«' + p.comment + '»';
              left.appendChild(commentEl);
            }
            const badge = document.createElement('div');
            badge.className =
              'mt-1 inline-flex items-center gap-1 rounded-full px-2 py-0.5 text-[11px] font-semibold border ' +
              (p.status === 'yes'
                ? 'bg-emerald-500/15 text-emerald-300 border-emerald-500/40'
                : 'bg-rose-500/15 text-rose-300 border-rose-500/40');
            badge.innerHTML =
              (p.status === 'yes' ? '<span>✓</span><span>Иду</span>' : '<span>✗</span><span>Не иду</span>');
            row.appendChild(left);
            row.appendChild(badge);
            attendanceListEl.appendChild(row);
          });
      }
      function selectDate(dateKey) {
        if (!dateKey) return;
        appState.selectedDate = dateKey;
        saveState();
        document
          .querySelectorAll('#calendarGrid [data-date]')
          .forEach(function (cell) {
            cell.classList.remove(
              'ring-2',
              'ring-indigo-400',
              'ring-offset-2',
              'ring-offset-slate-900'
            );
          });
        const activeCell = document.querySelector(
          '#calendarGrid [data-date="' + dateKey + '"]'
        );
        if (activeCell) {
          activeCell.classList.add(
            'ring-2',
            'ring-indigo-400',
            'ring-offset-2',
            'ring-offset-slate-900'
          );
        }
        ensureDateData(dateKey);
        noDatePlaceholder.classList.add('hidden');
        detailsContent.classList.remove('hidden');
        selectedDateLabel.textContent = formatFriendlyDate(dateKey);
        nameError.classList.add('hidden');
        renderMovieList(dateKey);
        renderAttendanceList(dateKey);
      }
      function handleVote(dateKey, movieId) {
        if (!dateKey || !movieId) return;
        const dateData = ensureDateData(dateKey);
        const movie = (dateData.movies || []).find(function (m) {
          return m.id === movieId;
        });
        if (!movie) return;
        const votes = loadVotes();
        const votedForDate = Array.isArray(votes[dateKey]) ? votes[dateKey] : [];
        if (votedForDate.indexOf(movieId) !== -1) {
          alert(
            'Ты уже голосовал за этот фильм в эту среду с этого устройства.'
          );
          return;
        }
        movie.votes = (movie.votes || 0) + 1;
        votedForDate.push(movieId);
        votes[dateKey] = votedForDate;
        saveState();
        saveVotes(votes);
        renderMovieList(dateKey);
      }
      function init() {
        loadState();
        updateTodayLabel();
        const now = new Date();
        appState.currentYear = now.getFullYear();
        appState.currentMonth = now.getMonth();
        if (appState.selectedDate) {
          const d = new Date(appState.selectedDate + 'T12:00:00');
          if (!Number.isNaN(d.getTime())) {
            appState.currentYear = d.getFullYear();
            appState.currentMonth = d.getMonth();
          }
        }
        renderCalendar();
        if (appState.selectedDate) {
          selectDate(appState.selectedDate);
        }
        prevMonthBtn.addEventListener('click', function () {
          appState.currentMonth -= 1;
          if (appState.currentMonth < 0) {
            appState.currentMonth = 11;
            appState.currentYear -= 1;
          }
          renderCalendar();
        });
        nextMonthBtn.addEventListener('click', function () {
          appState.currentMonth += 1;
          if (appState.currentMonth > 11) {
            appState.currentMonth = 0;
            appState.currentYear += 1;
          }
          renderCalendar();
        });
        movieForm.addEventListener('submit', function (event) {
          event.preventDefault();
          if (!appState.selectedDate) {
            alert('Сначала выбери дату-среду в календаре.');
            return;
          }
          const title = movieTitleInput.value.trim();
          if (!title) return;
          const dateData = ensureDateData(appState.selectedDate);
          const existing = (dateData.movies || []).find(function (m) {
            return (
              typeof m.title === 'string' &&
              m.title.toLowerCase() === title.toLowerCase()
            );
          });
          if (existing) {
            alert('Такой фильм уже есть в списке для этой среды.');
            return;
          }
          dateData.movies = dateData.movies || [];
          dateData.movies.push({
            id: generateId(),
            title: title,
            votes: 0
          });
          saveState();
          movieTitleInput.value = '';
          renderMovieList(appState.selectedDate);
        });
        attendanceForm.addEventListener('submit', function (event) {
          event.preventDefault();
          if (!appState.selectedDate) {
            alert('Сначала выбери дату-среду в календаре.');
            return;
          }
          const name = participantNameInput.value.trim();
          if (!name) {
            nameError.classList.remove('hidden');
            participantNameInput.focus();
            return;
          }
          nameError.classList.add('hidden');
          const status = attendanceForm.elements['status'].value || 'yes';
          const comment = commentInput.value.trim();
          const dateData = ensureDateData(appState.selectedDate);
          dateData.attendees = dateData.attendees || [];
          dateData.attendees.push({
            id: generateId(),
            name: name,
            status: status,
            comment: comment
          });
          saveState();
          attendanceForm.reset();
          attendanceForm.elements['status'].value = 'yes';
          renderAttendanceList(appState.selectedDate);
        });
      }
      init();
    });
  </script>
</body>
</html>