<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ü–∏–≤–Ω–∞—è —Ä—É–ª–µ—Ç–∫–∞ ‚Äî –ö–∏–Ω–æ—Å—Ä–µ–¥–∞</title>

  <script>
    // Auth gate
    (function () {
      try {
        const cu = localStorage.getItem('currentUser');
        if (!cu) {
          location.replace('login.html');
          return;
        }
        document.documentElement.classList.add('authed');
      } catch (e) {
        location.replace('login.html');
      }
    })();

    // Theme gate
    (function(){
      try { document.documentElement.dataset.theme = localStorage.getItem('siteTheme') || 'beer'; } catch(_) {}
    })();

    // Ensure canonical URL includes /roulette.html (prevents host rewriting issues on reload)
    (function(){
      try {
        const p = location.pathname;
        if (!/roulette\.html$/i.test(p)) {
          location.replace('roulette.html');
        }
      } catch(_) {}
    })();
  </script>
  <style>
    html:not(.authed) body { visibility: hidden; }
  </style>

  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect x='20' y='30' width='45' height='55' rx='5' fill='none' stroke='%23b45309' stroke-width='4'/%3E%3Crect x='22' y='45' width='41' height='38' rx='3' fill='%23f59e0b'/%3E%3Cellipse cx='42' cy='35' rx='24' ry='8' fill='%23fff'/%3E%3Ccircle cx='30' cy='33' r='5' fill='%23fff'/%3E%3Ccircle cx='45' cy='31' r='4' fill='%23fff'/%3E%3Ccircle cx='55' cy='34' r='4' fill='%23fff'/%3E%3Cpath d='M65 38 Q85 38 85 55 Q85 72 65 72' fill='none' stroke='%23b45309' stroke-width='5' stroke-linecap='round'/%3E%3C/svg%3E" />

  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <!-- Logo font: load selected font from Google Fonts (per-user) -->
  <script>
    // Logo font gate: avoid logo flash + load selected Google Font
    (function(){
      const html = document.documentElement;
      const KEY = 'logoFontFamily';
      const DEFAULT = 'Rubik Wet Paint';
      const LINK_ID = 'logoFontGF';

      function familyToHref(fam){
        const q = encodeURIComponent(fam).replace(/%20/g, '+');
        return `https://fonts.googleapis.com/css2?family=${q}&display=swap`;
      }

      function ensureStylesheet(fam){
        const family = (fam || DEFAULT).trim();
        if (!family) return;
        const href = familyToHref(family);
        let link = document.getElementById(LINK_ID);
        if (!link) {
          link = document.createElement('link');
          link.id = LINK_ID;
          link.rel = 'stylesheet';
          document.head.appendChild(link);
        }
        if (link.getAttribute('href') !== href) link.setAttribute('href', href);
      }

      function markReady(){
        html.classList.add('logo-font-ready');
        html.classList.remove('logo-font-loading');
      }

      function waitForFont(fam){
        const family = (fam || DEFAULT).trim();
        if (!family) return markReady();

        ensureStylesheet(family);

        html.classList.add('logo-font-loading');
        html.classList.remove('logo-font-ready');
        try {
          if (document.fonts && document.fonts.load) {
            // No flash: show logo text ONLY after the chosen font is actually loaded
            document.fonts.load(`1em "${family}"`).then(markReady, markReady);
          } else {
            setTimeout(markReady, 1);
          }
        } catch (_) {
          markReady();
        }
      }

      try {
        const fam = localStorage.getItem(KEY) || DEFAULT;
        html.style.setProperty('--logo-font', `'${fam}'`);
        window.__loadLogoFont = waitForFont;
        waitForFont(fam);
      } catch(_) {
        window.__loadLogoFont = waitForFont;
        markReady();
      }
    })();
  </script>

  <style>
    /* Hide only the logo text until the chosen logo font is loaded */
    html:not(.logo-font-ready) .logo-text { opacity: 0; }
    .logo-text { transition: opacity 0.15s ease; }

    html { scrollbar-gutter: stable; }
    html, body { background: #000; }
    body {
      font-family: 'Comfortaa', cursive;
      overflow-x: hidden;
      overflow-y: scroll;
      overscroll-behavior: none;
      color: #fff;
    }

    :root {
      --logo-font: 'Rubik Wet Paint';
      --accent-200: #fde68a;
      --accent-300: #fcd34d;
      --accent-400: #f59e0b;
      --accent-500: #f59e0b;
      --accent-border-20: rgba(245,158,11,0.20);
      --accent-border-30: rgba(245,158,11,0.30);
      --accent-border-50: rgba(245,158,11,0.50);
      --accent-soft: rgba(245,158,11,0.10);
      --glow-box-1: rgba(245,158,11,0.18);
      --glow-box-2: rgba(245,158,11,0.08);
      --particle-color: rgba(245,158,11,0.35);
      --scrollbar-thumb: #f59e0b;
      --scrollbar-thumb-hover: #d97706;
    }
    html[data-theme="white"] {
      --accent-200: #ffffff;
      --accent-300: #e5e7eb;
      --accent-400: #ffffff;
      --accent-500: #ffffff;
      --accent-border-20: rgba(255,255,255,0.26);
      --accent-border-30: rgba(255,255,255,0.34);
      --accent-border-50: rgba(255,255,255,0.55);
      --accent-soft: rgba(255,255,255,0.10);
      --glow-box-1: rgba(255,255,255,0.14);
      --glow-box-2: rgba(255,255,255,0.06);
      --particle-color: rgba(255,255,255,0.18);
      --scrollbar-thumb: #ffffff;
      --scrollbar-thumb-hover: #e5e7eb;
    }

    /* White theme: logo mug stroke should be white (match main site) */
    html[data-theme="white"] .mug-stroke,
    html[data-theme="white"] #logoMug rect,
    html[data-theme="white"] #logoMug path { stroke: rgba(255,255,255,0.85) !important; }

    /* White theme: fix amber gradient items (spin/add buttons) */
    html[data-theme="white"] .text-amber-200 { color: rgba(229,231,235,0.95) !important; }
    html[data-theme="white"] .border-amber-500\/20 { border-color: var(--accent-border-30) !important; }
    html[data-theme="white"] .border-amber-500\/10 { border-color: var(--accent-border-30) !important; }
    html[data-theme="white"] .hover\\:bg-amber-500\\/10:hover { background-color: rgba(255,255,255,0.08) !important; }

    /* Tailwind amber -> theme vars */
    .text-amber-400 { color: var(--accent-400) !important; }
    .text-amber-300 { color: var(--accent-300) !important; }
    .border-amber-500\/20 { border-color: var(--accent-border-20) !important; }
    .border-amber-500\/30 { border-color: var(--accent-border-30) !important; }
    .hover\\:bg-amber-500\\/10:hover { background-color: var(--accent-soft) !important; }

    .logo-text { font-family: var(--logo-font), 'Comfortaa', cursive; font-weight: 400; letter-spacing: 0.02em; }

    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: #111; }
    ::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--scrollbar-thumb-hover); }

    .bg-dark { background: #000; position: relative; }
    .bg-dark::before {
      content: '';
      position: fixed;
      inset: 0;
      background:
        radial-gradient(ellipse at 20% 0%, rgba(245, 158, 11, 0.06) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 100%, rgba(245, 158, 11, 0.04) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
    }

    .particles {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 1;
      overflow: hidden;
    }
    .particle {
      position: absolute;
      width: 3px;
      height: 3px;
      background: var(--particle-color);
      border-radius: 50%;
      animation: floatParticle 20s infinite;
    }
    @keyframes floatParticle {
      0% { transform: translateY(0) rotate(0deg); opacity: 0; }
      5% { opacity: 0.6; }
      95% { opacity: 0.6; }
      100% { transform: translateY(-100vh) rotate(720deg); opacity: 0; }
    }

    .glow { box-shadow: 0 0 20px var(--glow-box-1), 0 0 40px var(--glow-box-2); }

    @keyframes float { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-8px);} }
    .float { animation: float 4s ease-in-out infinite; }

    @keyframes pulse-glow {
      0%,100% { filter: drop-shadow(0 0 6px rgba(245,158,11,.6)); }
      50% { filter: drop-shadow(0 0 14px rgba(245,158,11,.9)) drop-shadow(0 0 28px rgba(245,158,11,.4)); }
    }
    @keyframes pulse-glow-white {
      0%,100% { filter: drop-shadow(0 0 6px rgba(255,255,255,.55)); }
      50% { filter: drop-shadow(0 0 14px rgba(255,255,255,.85)) drop-shadow(0 0 28px rgba(255,255,255,.35)); }
    }
    .pulse-glow { animation: pulse-glow 3s ease-in-out infinite; }
    html[data-theme="white"] .pulse-glow { animation-name: pulse-glow-white; }

    /* Roulette */
    /* Important for zoom/responsive: never exceed the column width */
    .wheel-wrap { position: relative; width: min(380px, 100%); max-width: 380px; margin: 0 auto; }

    /* Beer list scroll area: keep list scrollable even when card height is auto */
    .beerListScroll { max-height: min(55vh, 520px); overflow: auto; }
    @media (min-width: 1024px) {
      .beerListScroll { max-height: min(70vh, 640px); }
    }

    /* Pointer: DOWN */
    .pointer {
      position: absolute;
      /* Place the pointer so it doesn't extend above the wheel's top edge */
      top: 0px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 7;
      width: 0;
      height: 0;
      border-left: 12px solid transparent;
      border-right: 12px solid transparent;
      border-top: 18px solid rgba(255,255,255,0.92);
      filter: drop-shadow(0 6px 10px rgba(0,0,0,0.6));
    }
    html[data-theme="white"] .pointer {
      border-top-color: rgba(255,255,255,0.92);
      filter: drop-shadow(0 6px 10px rgba(255,255,255,0.08));
    }

    .wheel {
      width: 100%;
      aspect-ratio: 1 / 1;
      border-radius: 999px;
      border: 1px solid var(--accent-border-30);
      background: rgba(0,0,0,0.55);
      overflow: hidden;
      position: relative;
      transform: rotate(0deg);
      transition: transform 4.2s cubic-bezier(0.12, 0.78, 0.18, 1);
      box-shadow: 0 14px 40px rgba(0,0,0,0.55), 0 0 0 1px rgba(255,255,255,0.04) inset;
      will-change: transform;
    }
    .wheel::after {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.10), transparent 62%);
      pointer-events: none;
      mix-blend-mode: screen;
      opacity: 0.55;
    }

    #wheelCanvas {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      display: block;
    }

    /* Center overlay covers whole wheel to guarantee perfect centering */
    .wheel-center {
      position: absolute;
      inset: 0;
      z-index: 6;
      pointer-events: none;
      display: grid;
      place-items: center;
    }

    .spin-btn {
      pointer-events: auto;
      width: 112px;
      height: 112px;
      border-radius: 999px;
      border: 1px solid var(--accent-border-30);
      background: rgba(0,0,0,0.78);
      box-shadow: 0 18px 40px rgba(0,0,0,0.6);
      display: grid;
      place-items: center;
      transition: transform 0.18s ease, background 0.18s ease, border-color 0.18s ease, opacity 0.2s ease;
      user-select: none;
      transform: translateZ(0);
    }
    .spin-btn:hover { transform: scale(1.03); border-color: var(--accent-border-50); background: rgba(0,0,0,0.84); }
    .spin-btn:active { transform: scale(0.99); }
    .spin-btn[disabled] { opacity: 0.4; cursor: not-allowed; }

    .spin-btn .label {
      font-weight: 900;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      font-size: 12px;
      color: rgba(255,255,255,0.92);
    }

    .list-item:hover { background: var(--accent-soft); }

    /* Snow overlay */
    .snow {
      position: fixed;
      top: 0;
      left: 0;
      right: var(--sbw, 0px);
      bottom: 0;
      pointer-events: none;
      z-index: 40;
      overflow: hidden;
      background: rgba(0,0,0,0.01);
      transform: translateZ(0);
    }
    .snowflake {
      position: absolute;
      top: -32px;
      font-size: 16px;
      line-height: 1;
      color: rgba(255,255,255,0.9);
      text-shadow: 0 0 10px rgba(255,255,255,0.15);
      filter: drop-shadow(0 0 6px rgba(59,130,246,0.12));
      opacity: 0.8;
      animation-name: snowFall;
      animation-timing-function: linear;
      animation-iteration-count: infinite;
      will-change: transform;
    }
    @keyframes snowFall {
      from { transform: translate3d(0, -10px, 0) rotate(0deg); }
      to { transform: translate3d(var(--drift, 0px), 110vh, 0) rotate(360deg); }
    }
    @media (pointer: coarse) {
      .snowflake { text-shadow: 0 0 6px rgba(255,255,255,0.12); filter: none; opacity: 0.7; }
    }

    /* Robust list row layout: buttons strictly left (compact) */
    .beer-row {
      display: grid;
      grid-template-columns: 34px 1fr;
      align-items: center;
      gap: 8px;
    }

    /* Snow toggle (same as main) */
    .snow-toggle { display: inline-flex; align-items: center; gap: 10px; }
    .snow-switch {
      position: relative;
      width: 52px;
      height: 30px;
      border-radius: 999px;
      background: rgba(31, 41, 55, 0.85);
      border: 1px solid rgba(245, 158, 11, 0.22);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.03), 0 10px 30px rgba(0,0,0,0.35);
      transition: background 0.2s ease, border-color 0.2s ease;
      cursor: pointer;
      user-select: none;
    }
    .snow-switch input { position: absolute; opacity: 0; pointer-events: none; }
    .snow-thumb {
      position: absolute;
      left: 3px;
      top: 50%;
      width: 24px;
      height: 24px;
      border-radius: 999px;
      background: linear-gradient(180deg, rgba(255,255,255,0.96), rgba(229,231,235,0.96));
      box-shadow: 0 10px 20px rgba(0,0,0,0.35);
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
      color: rgba(37, 99, 235, 0.9);
      transform: translate3d(0, -50%, 0);
      transition: transform 0.22s cubic-bezier(0.2, 0.9, 0.2, 1), color 0.2s ease;
    }
    .snow-switch.on {
      background: linear-gradient(135deg, rgba(245,158,11,0.98), rgba(217,119,6,0.95));
      border-color: rgba(245, 158, 11, 0.55);
    }
    html[data-theme="white"] .snow-switch.on {
      background: linear-gradient(135deg, rgba(255,255,255,0.96), rgba(229,231,235,0.96));
      border-color: rgba(255,255,255,0.55);
    }
    .snow-switch.on .snow-thumb { transform: translate3d(22px, -50%, 0); color: rgba(120, 53, 15, 0.95); }
    html[data-theme="white"] .snow-switch.on .snow-thumb { color: rgba(37, 99, 235, 0.9); }
    .snow-icon {
      font-size: 18px;
      line-height: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      filter: drop-shadow(0 0 6px rgba(255,255,255,0.35));
    }
  </style>
</head>
<body class="bg-dark min-h-screen">
  <div class="particles" id="particles"></div>
  <div class="snow hidden" id="snow"></div>

  <header class="py-2 md:py-4 relative z-50 sticky top-0 bg-black/95 backdrop-blur-sm border-b border-amber-500/10">
    <div class="container mx-auto px-3 md:px-4 max-w-7xl flex flex-col md:flex-row justify-between items-center gap-2 md:gap-4">
      <div class="flex items-center gap-3 pl-2">
          <svg class="w-[220px] md:w-[360px] h-12 md:h-20 float pulse-glow flex-shrink-0" viewBox="0 0 580 120" style="overflow: visible;">
            <defs>
              <linearGradient id="beerGradRoulette" x1="0%" y1="0%" x2="0%" y2="100%">
                <stop offset="0%" style="stop-color:#fcd34d"/>
                <stop offset="50%" style="stop-color:#fbbf24"/>
                <stop offset="100%" style="stop-color:#d97706"/>
              </linearGradient>
              <linearGradient id="foamGradRoulette" x1="0%" y1="0%" x2="0%" y2="100%">
                <stop offset="0%" style="stop-color:#ffffff"/>
                <stop offset="100%" style="stop-color:#fef3c7"/>
              </linearGradient>
              <clipPath id="mugClipRoulette"><rect x="0" y="0" width="50" height="55" rx="3"/></clipPath>
              <filter id="glowRoulette"><feGaussianBlur stdDeviation="2" result="coloredBlur"/><feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
            </defs>

            <a href="index.html" aria-label="–ù–∞ –≥–ª–∞–≤–Ω—É—é" style="cursor:pointer;">
              <text id="logoText" x="28" y="78" text-anchor="start" class="logo-text" fill="var(--accent-500)" font-size="62" textLength="395" lengthAdjust="spacingAndGlyphs" filter="url(#glowRoulette)">–ö–ò–ù–û–°–†–ï–î–ê</text>
            </a>

            <g id="logoMug" transform="translate(438, 2)">
              <rect x="0" y="25" width="50" height="60" rx="5" fill="none" stroke="rgba(180,83,9,0.95)" class="mug-stroke" stroke-width="3"/>
              <g clip-path="url(#mugClipRoulette)" transform="translate(0, 30)">
                <rect x="0" y="55" height="0" width="50" fill="url(#beerGradRoulette)">
                  <animate attributeName="height" from="0" to="55" dur="2.5s" fill="freeze"/>
                  <animate attributeName="y" from="55" to="0" dur="2.5s" fill="freeze"/>
                </rect>
              </g>
              <g opacity="0"><animate attributeName="opacity" from="0" to="1" dur="0.5s" begin="2s" fill="freeze"/>
                <ellipse cx="25" cy="27" rx="27" ry="10" fill="url(#foamGradRoulette)"/>
                <circle cx="12" cy="24" r="6" fill="white" opacity="0.95"/>
                <circle cx="28" cy="22" r="5" fill="white" opacity="0.9"/>
                <circle cx="40" cy="25" r="5" fill="white" opacity="0.9"/>
              </g>
              <path d="M50 32 Q72 32 72 55 Q72 78 50 78" fill="none" stroke="#b45309" stroke-width="5" stroke-linecap="round"/>
            </g>
          </svg>

        <!-- Snow toggle (same as main) -->
        <div class="snow-toggle ml-1">
          <div class="snow-switch" id="snowSwitch" role="switch" aria-checked="false" tabindex="0" onclick="toggleSnow()">
            <input type="checkbox" id="snowToggle" aria-label="–°–Ω–µ–∂–∏–Ω–∫–∏">
            <div class="snow-thumb"><span class="snow-icon">‚ùÑ</span></div>
          </div>
        </div>
      </div>

      <div class="flex items-center gap-1 md:gap-3 flex-wrap justify-center">
        <a href="index.html" class="text-amber-400 hover:text-amber-300 transition font-medium text-xs md:text-sm px-2 md:px-3 py-1 md:py-2 rounded-lg hover:bg-amber-500/10 flex items-center gap-1 md:gap-2">
          <span>‚Üê</span> <span class="hidden sm:inline">–ù–∞ –≥–ª–∞–≤–Ω—É—é</span>
        </a>
        <a href="profile.html" class="text-amber-400 hover:text-amber-300 transition font-medium text-xs md:text-sm px-2 md:px-3 py-1 md:py-2 rounded-lg hover:bg-amber-500/10 flex items-center gap-1 md:gap-2" title="–ü—Ä–æ—Ñ–∏–ª—å">
          <span>üë§</span> <span id="profileName" class="hidden sm:inline"></span>
        </a>
        <button onclick="logout()" class="text-red-400 hover:text-red-300 transition font-medium text-xs md:text-sm px-2 md:px-3 py-1 md:py-2 rounded-lg hover:bg-red-500/10">
          <span class="sm:hidden">üö™</span><span class="hidden sm:inline">–í—ã–π—Ç–∏</span>
        </button>
      </div>
    </div>
  </header>

  <main class="relative z-10 container mx-auto max-w-7xl px-3 md:px-4 py-6">
    <div class="flex flex-col lg:flex-row gap-6 items-stretch">
      <!-- Left: Wheel -->
      <section class="w-full lg:w-1/2 flex">
        <div class="bg-black/60 backdrop-blur-sm rounded-2xl p-5 border border-amber-500/20 glow w-full flex flex-col">
          <div class="flex items-center justify-between mb-2">
            <h1 class="text-xl md:text-2xl font-bold text-amber-400">üéØ –ü–∏–≤–Ω–∞—è —Ä—É–ª–µ—Ç–∫–∞</h1>
          </div>

          <div class="flex justify-center flex-1 items-center py-3">
            <div class="wheel-wrap">
              <div class="pointer" aria-hidden="true"></div>
              <div id="wheel" class="wheel" aria-label="–†—É–ª–µ—Ç–∫–∞">
                <canvas id="wheelCanvas"></canvas>
                <div class="wheel-center" id="wheelCenter">
                  <button id="spinBtn" class="spin-btn" onclick="spinWheel()" aria-label="–ö—Ä—É—Ç–∏—Ç—å">
                    <div class="text-center">
                      <div class="label">–ö—Ä—É—Ç–∏—Ç—å</div>
                    </div>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div class="mt-2 text-center">
            <div class="text-gray-400 text-sm">–†–µ–∑—É–ª—å—Ç–∞—Ç:</div>
            <div id="result" class="text-white font-bold text-lg mt-1">‚Äî</div>
          </div>

          <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-2 justify-center">
            <button type="button" onclick="clearWheel()" class="w-full px-4 py-2 rounded-xl border border-gray-700 text-gray-200 hover:bg-white/5 transition">–û—á–∏—Å—Ç–∏—Ç—å</button>
            <button type="button" onclick="addRandomFromList()" class="w-full px-4 py-2 rounded-xl border border-amber-500/30 text-amber-200 hover:bg-amber-500/10 transition">–î–æ–±–∞–≤–∏—Ç—å —Å–ª—É—á–∞–π–Ω–æ–µ</button>
          </div>
        </div>
      </section>

      <!-- Right: Beer list -->
      <section class="w-full lg:w-1/2 flex">
        <div class="bg-black/60 backdrop-blur-sm rounded-2xl p-5 border border-amber-500/20 w-full flex flex-col">
          <div class="flex items-center justify-between mb-3 gap-3 flex-wrap">
            <h2 class="text-lg md:text-xl font-bold text-amber-400">üç∫ –°–ø–∏—Å–æ–∫ –ø–∏–≤–∞</h2>
            <input id="search" type="search" placeholder="–ü–æ–∏—Å–∫‚Ä¶" class="w-full sm:w-56 px-3 py-2 rounded-xl bg-gray-900/70 text-white placeholder-gray-500 border border-amber-500/25 focus:outline-none focus:border-amber-400 text-sm" oninput="renderBeerList()" />
          </div>

          <div id="beerList" class="beerListScroll rounded-xl border border-amber-500/10 bg-black/30"></div>
        </div>
      </section>
    </div>
  </main>

  <footer class="text-center py-6 text-gray-700 text-xs relative z-10">
    <p>üç∫ –ö–ò–ù–û–°–†–ï–î–ê ¬© 2025 ‚Ä¢ –°–¥–µ–ª–∞–Ω–æ —Å –ª—é–±–æ–≤—å—é –∫ –ø–∏–≤—É –∏ –∫–∏–Ω–æ üé¨</p>
  </footer>

  <script>
    // -----------------
    // Current user
    // -----------------
    const currentUser = (() => {
      try { return JSON.parse(localStorage.getItem('currentUser') || 'null'); } catch(_) { return null; }
    })();
    document.addEventListener('DOMContentLoaded', () => {
      const el = document.getElementById('profileName');
      if (el) el.textContent = currentUser?.name || '';
    });

    // -----------------
    // Logo font picker (shared)
    // -----------------
    const LOGO_FONT_LS_KEY = 'logoFontFamily';
    const LOGO_PRESETS = {
      'Train One': { family: 'Train One', size: 62, textLength: 395, y: 78, mugX: 438, mugY: 2 },
      'Rubik Wet Paint': { family: 'Rubik Wet Paint', size: 62, textLength: 395, y: 78, mugX: 438, mugY: 2 },
      'Rubik Moonrocks': { family: 'Rubik Moonrocks', size: 58, textLength: 395, y: 78, mugX: 438, mugY: 2 },
      'Rubik Microbe': { family: 'Rubik Microbe', size: 64, textLength: 395, y: 78, mugX: 438, mugY: 2 },
      'Rubik Puddles': { family: 'Rubik Puddles', size: 54, textLength: 395, y: 80, mugX: 438, mugY: 2 },
      'Stick': { family: 'Stick', size: 64, textLength: 395, y: 78, mugX: 438, mugY: 2 },
      'Press Start 2P': { family: 'Press Start 2P', size: 40, textLength: 395, y: 74, mugX: 438, mugY: 2 },
      'Reggae One': { family: 'Reggae One', size: 60, textLength: 395, y: 78, mugX: 438, mugY: 2 },
      'Dela Gothic One': { family: 'Dela Gothic One', size: 56, textLength: 395, y: 78, mugX: 438, mugY: 2 },
      'Amatic SC': { family: 'Amatic SC', size: 78, textLength: 395, y: 82, mugX: 438, mugY: 2 },
      'Underdog': { family: 'Underdog', size: 60, textLength: 395, y: 78, mugX: 438, mugY: 2 },
      'Stalinist One': { family: 'Stalinist One', size: 40, textLength: 395, y: 74, mugX: 438, mugY: 2 },
      'Lobster': { family: 'Lobster', size: 64, textLength: 395, y: 80, mugX: 438, mugY: 2 },
      'Kablammo': { family: 'Kablammo', size: 54, textLength: 395, y: 80, mugX: 438, mugY: 2 },
      'Comforter': { family: 'Comforter', size: 76, textLength: 395, y: 84, mugX: 438, mugY: 2 },
      'Pacifico': { family: 'Pacifico', size: 66, textLength: 395, y: 82, mugX: 438, mugY: 2 },
      'Ruslan Display': { family: 'Ruslan Display', size: 56, textLength: 395, y: 78, mugX: 438, mugY: 2 },
      'Caveat': { family: 'Caveat', size: 82, textLength: 395, y: 86, mugX: 438, mugY: 2 },
      'Rampart One': { family: 'Rampart One', size: 62, textLength: 395, y: 80, mugX: 438, mugY: 2 },
      'Rubik Scribble': { family: 'Rubik Scribble', size: 52, textLength: 395, y: 80, mugX: 438, mugY: 2 }
    };

    function getLogoFontChoice() {
      const saved = localStorage.getItem(LOGO_FONT_LS_KEY);
      return (saved && LOGO_PRESETS[saved]) ? saved : 'Rubik Wet Paint';
    }

    function applyLogoSettings() {
      const choice = getLogoFontChoice();
      const preset = LOGO_PRESETS[choice] || LOGO_PRESETS['Train One'];

      // Ensure the chosen font is requested (otherwise only size changes)
      try { window.__loadLogoFont && window.__loadLogoFont(preset.family); } catch(_) {}

      document.documentElement.style.setProperty('--logo-font', `'${preset.family}'`);
      const t = document.getElementById('logoText');
      if (t) {
        // SVG can ignore CSS font swap in some cases: set attribute too.
        t.style.fontFamily = `"${preset.family}", Comfortaa, cursive`;
        t.setAttribute('font-family', preset.family);
        t.setAttribute('font-size', String(preset.size));
        t.setAttribute('textLength', String(preset.textLength));
        t.setAttribute('y', String(preset.y));
      }
      const mug = document.getElementById('logoMug');
      if (mug) mug.setAttribute('transform', `translate(${preset.mugX}, ${preset.mugY})`);
    }

    applyLogoSettings();
    try { window.__loadLogoFont && window.__loadLogoFont(localStorage.getItem(LOGO_FONT_LS_KEY) || 'Rubik Wet Paint'); } catch(_) {}
    window.addEventListener('storage', (e) => {
      if (e.key === LOGO_FONT_LS_KEY) {
        const fam = localStorage.getItem(LOGO_FONT_LS_KEY) || 'Rubik Wet Paint';
        try { window.__loadLogoFont && window.__loadLogoFont(fam); } catch(_) {}
        Promise.resolve().then(applyLogoSettings);
      }
    });

    // Particles
    (function createParticles(){
      const container = document.getElementById('particles');
      for (let i = 0; i < 10; i++) {
        const p = document.createElement('div');
        p.className = 'particle';
        p.style.left = Math.random() * 100 + '%';
        p.style.bottom = '-10px';
        p.style.animationDelay = Math.random() * 15 + 's';
        p.style.animationDuration = (18 + Math.random() * 14) + 's';
        container.appendChild(p);
      }
    })();

    // Keep snow from covering scrollbar
    (function setScrollbarWidthVar(){
      try {
        const sbw = Math.max(0, window.innerWidth - document.documentElement.clientWidth);
        document.documentElement.style.setProperty('--sbw', sbw + 'px');
        window.addEventListener('resize', () => {
          const sbw2 = Math.max(0, window.innerWidth - document.documentElement.clientWidth);
          document.documentElement.style.setProperty('--sbw', sbw2 + 'px');
        });
      } catch(_) {}
    })();

    // Snow mode state (shared)
    const SNOW_LS_KEY = 'snowModeEnabled';
    let snowTimer = null;

    function setSnowUI(enabled) {
      const snow = document.getElementById('snow');
      const sw = document.getElementById('snowSwitch');
      const cb = document.getElementById('snowToggle');
      if (!snow || !sw || !cb) return;

      cb.checked = !!enabled;
      sw.classList.toggle('on', !!enabled);
      sw.setAttribute('aria-checked', enabled ? 'true' : 'false');

      if (enabled) { snow.classList.remove('hidden'); startSnow(); }
      else { stopSnow(); snow.classList.add('hidden'); }
    }

    function toggleSnow(force = null) {
      const current = localStorage.getItem(SNOW_LS_KEY) === '1';
      const next = (force === null) ? !current : !!force;
      localStorage.setItem(SNOW_LS_KEY, next ? '1' : '0');
      setSnowUI(next);
    }

    document.addEventListener('visibilitychange', () => {
      const enabled = localStorage.getItem(SNOW_LS_KEY) === '1';
      if (document.hidden) stopSnow();
      else if (enabled) startSnow();
    });

    function startSnow() {
      const snow = document.getElementById('snow');
      if (!snow) return;
      if (snowTimer) return;
      const isCoarse = window.matchMedia && window.matchMedia('(pointer: coarse)').matches;
      const initialCount = isCoarse ? 8 : 12;
      for (let i = 0; i < initialCount; i++) spawnSnowflake(true);
      const interval = isCoarse ? 780 : 520;
      snowTimer = setInterval(() => spawnSnowflake(false), interval);
    }

    function stopSnow() {
      const snow = document.getElementById('snow');
      if (snowTimer) { clearInterval(snowTimer); snowTimer = null; }
      snow?.replaceChildren();
    }

    function spawnSnowflake(isInitial) {
      const snow = document.getElementById('snow');
      if (!snow) return;
      const isCoarse = window.matchMedia && window.matchMedia('(pointer: coarse)').matches;
      const maxFlakes = isCoarse ? 22 : 40;
      if (snow.childElementCount >= maxFlakes) return;

      const flake = document.createElement('div');
      flake.className = 'snowflake';
      flake.textContent = '‚ùÑ';

      const left = Math.random() * 100;
      const size = isCoarse ? (8 + Math.random() * 6) : (10 + Math.random() * 10);
      const duration = isCoarse ? (12 + Math.random() * 12) : (10 + Math.random() * 10);
      const drift = isCoarse ? (Math.random() * 50 - 25).toFixed(0) + 'px' : (Math.random() * 90 - 45).toFixed(0) + 'px';
      const opacity = isCoarse ? (0.28 + Math.random() * 0.35) : (0.35 + Math.random() * 0.5);
      const delay = isInitial ? (Math.random() * (isCoarse ? 6 : 4)) : 0;

      flake.style.left = left + 'vw';
      flake.style.fontSize = size + 'px';
      flake.style.opacity = String(opacity);
      flake.style.animationDuration = duration + 's';
      flake.style.animationDelay = delay + 's';
      flake.style.setProperty('--drift', drift);

      setTimeout(() => flake.remove(), (duration + delay + 0.3) * 1000);
      snow.appendChild(flake);
    }

    try {
      setSnowUI(localStorage.getItem(SNOW_LS_KEY) === '1');
      const sw = document.getElementById('snowSwitch');
      if (sw) {
        sw.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            toggleSnow();
          }
        });
      }
    } catch(_) {}

    // Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBwp4ZNbJuUM5sY0qMffvZTHr2PDvc2iLc",
      authDomain: "kinosreda-ce8ef.firebaseapp.com",
      databaseURL: "https://kinosreda-ce8ef-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "kinosreda-ce8ef",
      storageBucket: "kinosreda-ce8ef.firebasestorage.app",
      messagingSenderId: "889337905300",
      appId: "1:889337905300:web:325aea2f3fb3c6b44a7481",
      measurementId: "G-MGW6GF67H3"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // State
    let allBeers = [];
    let wheelItems = [];
    let isSpinning = false;
    let currentRotation = 0;

    // Utils
    const collator = new Intl.Collator(['ru','en'], { sensitivity: 'base', numeric: false, ignorePunctuation: true });

    function logout() {
      localStorage.removeItem('currentUser');
      location.href = 'login.html';
    }

    function palette(i) {
      const hues = [28, 48, 210, 190, 275, 330, 150, 10, 235, 90, 200, 310];
      const h = hues[i % hues.length];
      return `hsl(${h} 85% 55%)`;
    }

    function normalizeBeerList(raw) {
      const arr = Array.isArray(raw) ? raw : Object.values(raw || {});
      return arr
        .filter(b => b && (b.name || '').trim())
        .map(b => ({ id: String(b.id || ''), name: String(b.name || '').trim() }));
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    function escapeJs(str) {
      return String(str).replace(/\\/g,'\\\\').replace(/'/g, "\\'");
    }

    function updateSpinButtonState() {
      const btn = document.getElementById('spinBtn');
      if (!btn) return;
      btn.disabled = isSpinning || wheelItems.length === 0;
    }

    function renderBeerList() {
      const q = (document.getElementById('search').value || '').trim().toLowerCase();
      let list = [...allBeers];
      if (q) list = list.filter(b => b.name.toLowerCase().includes(q));
      list.sort((a,b) => collator.compare(a.name, b.name));

      const el = document.getElementById('beerList');
      if (!list.length) {
        const hasAny = (allBeers && allBeers.length > 0);
        const msg = (hasAny && q) ? '–¢–∞–∫–æ–µ –ø–∏–≤–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.' : '–ü–æ–∫–∞ –Ω–µ—Ç –ø–∏–≤–∞ –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ.';
        el.innerHTML = `<div class="p-4 text-sm text-gray-500">${msg}</div>`;
        return;
      }

      el.innerHTML = list.map(b => {
        const already = wheelItems.some(x => x.toLowerCase() === b.name.toLowerCase());
        return `
          <div class="list-item beer-row px-3 py-2 border-b border-white/5">
            ${already ? `
              <button type="button" onclick="event.preventDefault(); event.stopPropagation(); removeFromWheel('${escapeJs(b.name)}')"
                class="w-8 h-8 rounded-lg border border-red-500/25 text-red-200 hover:bg-red-500/10 hover:border-red-400/40 transition flex items-center justify-center" title="–£–±—Ä–∞—Ç—å –∏–∑ —Ä—É–ª–µ—Ç–∫–∏">-
              </button>
            ` : `
              <button type="button" onclick="event.preventDefault(); event.stopPropagation(); addToWheel('${escapeJs(b.name)}')"
                class="w-8 h-8 rounded-lg border border-amber-500/30 text-amber-200 hover:bg-amber-500/10 hover:border-amber-400/40 transition flex items-center justify-center" title="–î–æ–±–∞–≤–∏—Ç—å –≤ —Ä—É–ª–µ—Ç–∫—É">+
              </button>
            `}
            <div class="min-w-0">
              <div class="text-white text-sm font-medium truncate" title="${escapeHtml(b.name)}">${escapeHtml(b.name)}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    function addToWheel(name) {
      if (!name) return;
      if (isSpinning) return;
      if (wheelItems.some(x => x.toLowerCase() === name.toLowerCase())) return;
      wheelItems.push(name);
      renderWheel();
      renderBeerList();
      document.getElementById('result').textContent = '‚Äî';
    }

    function removeFromWheel(name) {
      if (!name) return;
      if (isSpinning) return;
      wheelItems = wheelItems.filter(x => x.toLowerCase() !== name.toLowerCase());
      renderWheel();
      renderBeerList();
      document.getElementById('result').textContent = '‚Äî';
    }

    function snapWheelTo(deg) {
      const wheel = document.getElementById('wheel');
      if (!wheel) return;
      wheel.style.transitionProperty = 'none';
      wheel.style.transitionDuration = '0s';
      wheel.style.transitionTimingFunction = 'linear';
      wheel.style.transform = `rotate(${deg}deg)`;
      // restore next frames
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          wheel.style.transitionProperty = 'transform';
          wheel.style.transitionDuration = '4.2s';
          wheel.style.transitionTimingFunction = 'cubic-bezier(0.12, 0.78, 0.18, 1)';
        });
      });
    }

    function clearWheel() {
      if (isSpinning) return;
      wheelItems = [];
      currentRotation = 0;
      snapWheelTo(0);
      renderWheel();
      renderBeerList();
      document.getElementById('result').textContent = '‚Äî';
    }

    function addRandomFromList() {
      const candidates = allBeers
        .map(b => b.name)
        .filter(n => !wheelItems.some(x => x.toLowerCase() === n.toLowerCase()));
      if (!candidates.length) return;
      const pick = candidates[Math.floor(Math.random() * candidates.length)];
      addToWheel(pick);
    }

    // -----------------
    // Canvas wheel drawing (strict binding to slices)
    // -----------------
    const wheelCanvas = document.getElementById('wheelCanvas');
    const wheelEl = document.getElementById('wheel');
    let wheelCtx = null;

    function fitText(ctx, text, maxWidth) {
      if (!text) return '';
      const t = String(text);
      if (ctx.measureText(t).width <= maxWidth) return t;
      let s = t;
      while (s.length > 0 && ctx.measureText(s + '‚Ä¶').width > maxWidth) s = s.slice(0, -1);
      return s.length ? (s + '‚Ä¶') : '';
    }

    function ensureCanvasSize() {
      if (!wheelCanvas || !wheelEl) return false;
      const rect = wheelEl.getBoundingClientRect();
      const cssSize = Math.max(1, Math.floor(Math.min(rect.width, rect.height)));
      const dpr = window.devicePixelRatio || 1;
      const w = Math.round(cssSize * dpr);
      const h = Math.round(cssSize * dpr);
      if (wheelCanvas.width !== w || wheelCanvas.height !== h) {
        wheelCanvas.width = w;
        wheelCanvas.height = h;
      }
      wheelCtx = wheelCanvas.getContext('2d');
      wheelCtx.setTransform(dpr, 0, 0, dpr, 0, 0);
      return true;
    }

    function drawWheelCanvas() {
      if (!ensureCanvasSize() || !wheelCtx) return;
      const rect = wheelEl.getBoundingClientRect();
      const size = Math.max(1, Math.floor(Math.min(rect.width, rect.height)));
      const ctx = wheelCtx;

      ctx.clearRect(0, 0, size, size);

      const n = wheelItems.length;
      if (!n) return;

      const cx = size / 2;
      const cy = size / 2;
      const R = (size / 2) - 6;

      // Special case: single option
      if (n === 1) {
        ctx.save();
        ctx.translate(cx, cy);

        // Full circle sector
        ctx.beginPath();
        ctx.arc(0, 0, R, 0, Math.PI * 2);
        ctx.closePath();
        ctx.fillStyle = palette(0);
        ctx.fill();

        ctx.strokeStyle = 'rgba(255,255,255,0.14)';
        ctx.lineWidth = 1;
        ctx.stroke();

        // Label in the lower part of the circle, away from center button
        const fontSize1 = 14;
        ctx.font = `800 ${fontSize1}px Comfortaa, system-ui, -apple-system, Segoe UI, Arial`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';

        const label = wheelItems[0];
        const maxWidth = Math.max(24, R * 1.2);
        const fitted = fitText(ctx, label, maxWidth);

        ctx.lineWidth = 3;
        ctx.strokeStyle = 'rgba(0,0,0,0.35)';
        ctx.strokeText(fitted, 0, R * 0.72);
        ctx.fillStyle = 'rgba(255,255,255,0.96)';
        ctx.fillText(fitted, 0, R * 0.72);

        ctx.restore();
        return;
      }

      // Base slices start at -90deg (top)
      const start0 = -Math.PI / 2;
      const step = (Math.PI * 2) / n;

      // Font sizing (reduce a bit when there are many sectors)
      const fontSize = n <= 4 ? 14 : n <= 6 ? 12 : n <= 8 ? 11 : n <= 10 ? 10 : n <= 14 ? 9 : 8;

      // Place labels at the *centroid* of the circular sector (strictly centered inside each wedge).
      // Centroid radius for a circular sector of angle `step` and radius R:
      // r = 4R sin(step/2) / (3 step)
      // Clamp to keep text readable.
      const centroidRadius = (4 * R * Math.sin(step / 2)) / (3 * step);
      // Clamp so text sits comfortably inside the wedge for any N
      const textRadius = Math.min(R * 0.78, Math.max(R * 0.52, centroidRadius));

      ctx.save();
      ctx.translate(cx, cy);

      for (let i = 0; i < n; i++) {
        const a0 = start0 + i * step;
        const a1 = a0 + step;

        // Slice
        ctx.beginPath();
        ctx.moveTo(0, 0);
        ctx.arc(0, 0, R, a0, a1);
        ctx.closePath();
        ctx.fillStyle = palette(i);
        ctx.fill();

        // Subtle separator
        ctx.strokeStyle = 'rgba(255,255,255,0.14)';
        ctx.lineWidth = 1;
        ctx.stroke();

        // Label (tangential, near rim)
        ctx.save();

        const mid = a0 + step / 2;
        const deg = ((mid * 180) / Math.PI + 360) % 360;
        const flip = deg > 90 && deg < 270;

        // Place label at the sector center (polar coords: angle=mid, radius=textRadius)
        // Use +X axis as radial direction to avoid 90deg offset issues.
        ctx.rotate(mid);
        ctx.translate(textRadius, 0);

        // Tangential orientation (parallel to arc)
        // Flip direction so the line ‚Äúends‚Äù toward the wheel center (requested)
        ctx.rotate(-Math.PI / 2);
        if (flip) ctx.rotate(Math.PI);

        ctx.font = `800 ${fontSize}px Comfortaa, system-ui, -apple-system, Segoe UI, Arial`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';

        // Max width at this radius inside the wedge (chord length)
        const maxWidth = Math.max(24, 2 * textRadius * Math.sin(step / 2) - 18);
        const label = fitText(ctx, wheelItems[i], maxWidth);

        // Improve readability on bright slices
        ctx.lineWidth = 3;
        ctx.strokeStyle = 'rgba(0,0,0,0.35)';
        ctx.strokeText(label, 0, 0);
        ctx.fillStyle = 'rgba(255,255,255,0.96)';
        ctx.fillText(label, 0, 0);

        ctx.restore();
      }

      ctx.restore();
    }

    let wheelResizeObserver = null;
    function initWheelResizeObserver() {
      if (!wheelEl || !('ResizeObserver' in window)) return;
      wheelResizeObserver = new ResizeObserver(() => {
        drawWheelCanvas();
      });
      wheelResizeObserver.observe(wheelEl);
    }

    function renderWheel() {
      drawWheelCanvas();
      // Do not touch wheel transform here ‚Äî prevents visual "jump" when adding/removing items.
      updateSpinButtonState();
    }

    function computeWinner(rotationDeg) {
      const n = wheelItems.length;
      if (!n) return null;
      const step = 360 / n;
      const rot = ((rotationDeg % 360) + 360) % 360;
      const pointerAngle = (360 - rot) % 360;
      const idx = Math.floor(pointerAngle / step) % n;
      return wheelItems[idx];
    }

    function spinWheel() {
      if (isSpinning) return;
      if (wheelItems.length === 0) return;

      if (wheelItems.length === 1) {
        document.getElementById('result').textContent = `‚úÖ ${wheelItems[0]}`;
        return;
      }

      isSpinning = true;
      updateSpinButtonState();

      const wheel = wheelEl;
      const turns = 6 + Math.floor(Math.random() * 7);
      const offset = Math.random() * 360;
      const extra = turns * 360 + offset;

      const dur = 3.4 + Math.random() * 2.8;
      wheel.style.transitionProperty = 'transform';
      wheel.style.transitionDuration = dur + 's';
      const easings = [
        'cubic-bezier(0.12, 0.78, 0.18, 1)',
        'cubic-bezier(0.08, 0.85, 0.12, 1)',
        'cubic-bezier(0.10, 0.70, 0.20, 1)'
      ];
      wheel.style.transitionTimingFunction = easings[Math.floor(Math.random() * easings.length)];

      currentRotation = currentRotation + extra;
      wheel.style.transform = `rotate(${currentRotation}deg)`;

      const win = computeWinner(currentRotation);
      setTimeout(() => {
        isSpinning = false;
        updateSpinButtonState();
        document.getElementById('result').textContent = win ? `‚úÖ ${win}` : '‚Äî';
      }, (dur * 1000) + 80);
    }

    // Load beers from Firebase
    db.ref('beerRating').on('value', (snap) => {
      allBeers = normalizeBeerList(snap.val());
      renderBeerList();
    });

    // Init
    initWheelResizeObserver();
    renderWheel();
    updateSpinButtonState();
  </script>
</body>
</html>
